<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no, user-scalable=no">
  <title>Shelby Bet - بازارهای کریپتو</title>

  <!-- Telegram Web App -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Vazirmatn', 'sans-serif'] },
          colors: {
            primary: '#1DA1F2',
            success: '#10B981',
            danger: '#EF4444',
            warning: '#F59E0B',
          },
        },
      },
    };
  </script>

  <!-- Vazirmatn Font -->
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Icons (Lucide) -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <!-- QR Code -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <!-- PWA Manifest -->
  <link rel="manifest" href="data:application/manifest+json,{
    \"name\": \"Shelby Bet\",
    \"short_name\": \"Shelby\",
    \"start_url\": \"/\",
    \"display\": \"standalone\",
    \"background_color\": \"#ffffff\",
    \"theme_color\": \"#1DA1F2\",
    \"icons\": [
      {\"src\": \"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E₿%3C/text%3E%3C/svg%3E\", \"sizes\": \"any\"}
    ]
  }">

  <style>
    body { margin: 0; padding: 0; }
    .dark { --tw-bg-opacity: 1; background-color: #111; }
    .skeleton { @apply bg-gray-200 dark:bg-gray-700 animate-pulse rounded; }
    .chart-container { height: 220px; }
    .hidden { display: none !important; }
    .copy-btn { @apply text-xs text-gray-500 hover:text-primary cursor-pointer; }
    .stats { @apply text-sm text-gray-500 mt-1; }
    .haptic { transition: transform 0.1s; }
    .haptic:active { transform: scale(0.95); }
    .tab-btn.active { @apply border-b-2 border-primary text-primary; }
    .market-tab-btn.active { @apply bg-primary text-white; }
    .market-tab-btn:not(.active) { @apply bg-gray-200 dark:bg-gray-700; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white transition-colors">

  <!-- App Container -->
  <div id="app" class="pb-20">

    <!-- Header -->
    <header class="sticky top-0 z-50 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 p-4">
      <div class="flex justify-between items-center">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center text-white font-bold">S</div>
          <div>
            <h1 class="text-lg font-bold">Shelby Bet</h1>
            <p class="text-xs text-gray-500">بازارهای کریپتو</p>
          </div>
        </div>
        <div class="flex gap-2">
          <button id="theme-toggle" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-800 haptic">
            <i data-lucide="moon"></i>
          </button>
          <button id="lang-toggle" class="px-3 py-1 text-sm rounded-lg bg-gray-100 dark:bg-gray-700 haptic">EN</button>
        </div>
      </div>
    </header>

    <!-- Tabs -->
    <div class="flex border-b border-gray-200 dark:border-gray-800 sticky top-16 z-40 bg-white dark:bg-gray-900">
      <button data-tab="markets" class="tab-btn flex-1 py-3 font-medium active">بازارها</button>
      <button data-tab="wallet" class="tab-btn flex-1 py-3 font-medium">کیف پول</button>
      <button data-tab="profile" class="tab-btn flex-1 py-3 font-medium">پروفایل</button>
    </div>

    <!-- Page: Markets -->
    <div id="page-markets" class="page">
      <div class="p-4 sticky top-28 z-30 bg-white dark:bg-gray-900">
        <div class="relative">
          <input type="text" id="search-input" placeholder="جستجو در ارزها..." class="w-full p-3 pr-10 rounded-lg border bg-gray-50 dark:bg-gray-800">
          <button id="clear-search" class="absolute left-3 top-3 text-gray-500 hidden haptic">
            <i data-lucide="x"></i>
          </button>
        </div>
      </div>

      <div class="flex px-4 gap-2 overflow-x-auto whitespace-nowrap pb-2">
        <button data-market-tab="all" class="market-tab-btn py-2 px-4 rounded-full text-sm font-medium active">همه</button>
        <button data-market-tab="favorites" class="market-tab-btn py-2 px-4 rounded-full text-sm">علاقه‌مندی‌ها</button>
        <button data-market-tab="gainers" class="market-tab-btn py-2 px-4 rounded-full text-sm">بیشترین رشد</button>
        <button data-market-tab="losers" class="market-tab-btn py-2 px-4 rounded-full text-sm">بیشترین افت</button>
      </div>

      <div class="flex justify-between items-center p-4">
        <span class="text-sm text-gray-500">مرتب‌سازی:</span>
        <select id="sort-select" class="p-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-sm">
          <option value="market_cap_desc">ارزش بازار</option>
          <option value="price_change_24h_desc">رشد ۲۴ساعته</option>
          <option value="price_change_24h_asc">افت ۲۴ساعته</option>
          <option value="volume_desc">حجم معاملات</option>
        </select>
      </div>

      <div id="markets-list" class="px-4 space-y-3 pb-8"></div>

      <div id="skeleton-loading" class="px-4 space-y-3 hidden"></div>

      <div id="load-more" class="p-4 text-center hidden">
        <button class="px-6 py-2 bg-primary text-white rounded-full text-sm haptic">بارگذاری بیشتر</button>
      </div>
    </div>
    <!-- Page: Wallet -->
    <div id="page-wallet" class="page hidden">
      <div class="p-4 border-b border-gray-200 dark:border-gray-800">
        <div class="flex gap-2">
          <button onclick="exportWallets()" class="flex-1 py-2 bg-gray-100 dark:bg-gray-800 rounded-lg flex items-center justify-center gap-2 text-sm haptic">
            <i data-lucide="download"></i> خروجی
          </button>
          <button onclick="importWallets()" class="flex-1 py-2 bg-gray-100 dark:bg-gray-800 rounded-lg flex items-center justify-center gap-2 text-sm haptic">
            <i data-lucide="upload"></i> ورودی
          </button>
        </div>
      </div>

      <div id="wallet-list" class="space-y-3 p-4"></div>

      <div id="empty-wallet" class="text-center py-12">
        <i data-lucide="wallet" class="w-16 h-16 mx-auto text-gray-400"></i>
        <p class="mt-4 text-gray-500">هیچ کیف پولی اضافه نشده</p>
        <button onclick="openAddWalletModal()" class="mt-4 px-6 py-2 bg-primary text-white rounded-lg haptic">افزودن کیف پول</button>
      </div>
    </div>

    <!-- Page: Profile -->
    <div id="page-profile" class="page hidden">
      <div class="p-4 space-y-6">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 text-center">
          <div class="w-24 h-24 mx-auto bg-primary rounded-full flex items-center justify-center text-3xl text-white font-bold">
            S
          </div>
          <h2 class="mt-4 text-xl font-bold">Shelby User</h2>
          <p class="text-gray-500">Shelby Bet v2.0</p>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 space-y-4">
          <div class="flex justify-between items-center">
            <span>تم</span>
            <button id="profile-theme-toggle" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 haptic">
              <i data-lucide="moon"></i>
            </button>
          </div>
          <div class="flex justify-between items-center">
            <span>زبان</span>
            <button id="profile-lang-toggle" class="px-3 py-1 text-sm rounded-lg bg-gray-100 dark:bg-gray-700 haptic">EN</button>
          </div>
          <div class="flex justify-between items-center">
            <span>اعلان‌ها</span>
            <input type="checkbox" id="notifications-toggle" class="w-5 h-5 rounded">
          </div>
          <div class="flex justify-between items-center">
            <span>لرزش دکمه‌ها</span>
            <input type="checkbox" id="haptic-toggle" class="w-5 h-5 rounded" checked>
          </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-xl p-6">
          <h3 class="font-bold mb-4">آمار اپ</h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span>تعداد ارزها</span>
              <span id="stats-coins">0</span>
            </div>
            <div class="flex justify-between">
              <span>کیف پول‌ها</span>
              <span id="stats-wallets">0</span>
            </div>
            <div class="flex justify-between">
              <span>هشدارهای فعال</span>
              <span id="stats-alerts">0</span>
            </div>
          </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 text-center">
          <h3 class="font-bold mb-2">درباره ما</h3>
          <p class="text-sm text-gray-500">Shelby Bet - بهترین ابزار مدیریت کریپتو در تلگرام</p>
          <p class="text-xs text-gray-400 mt-2">نسخه 2.0 - ۱۴۰۴</p>
        </div>
      </div>
    </div>

  </div>

  <!-- Modals -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-md"></div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="fixed bottom-20 left-4 right-4 z-50 hidden">
    <div class="bg-gray-900 text-white p-4 rounded-lg shadow-lg flex items-center gap-3">
      <i data-lucide="bell"></i>
      <div>
        <p class="font-medium" id="toast-title"></p>
        <p class="text-sm" id="toast-message"></p>
      </div>
    </div>
  </div>

  <!-- ALL JS IN ONE SCRIPT -->
  <script>
    // === CONFIG ===
    const CONFIG = {
      COINGECKO_API: 'https://api.coingecko.com/api/v3',
      ETH_API: 'https://api.etherscan.io/api',
      ETHERSCAN_KEY: '5G4HJDG2TCMMI2V8GQM6GJ636NVEW1HJU1',
      TON_API: 'https://toncenter.com/api/v2',
      TRON_API: 'https://api.trongrid.io',
      UPDATE_INTERVAL: 120000, // 2 دقیقه
      ALERT_CHECK_INTERVAL: 30000, // 30 ثانیه
    };

    // === STATE ===
    let markets = [];
    let wallets = JSON.parse(localStorage.getItem('wallets') || '[]');
    let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    let alerts = JSON.parse(localStorage.getItem('alerts') || '[]');
    let currentTab = 'markets';
    let currentMarketTab = 'all';
    let currentSort = 'market_cap_desc';
    let page = 1;
    let isDark = localStorage.getItem('theme') === 'dark';
    let lang = localStorage.getItem('lang') || 'fa';
    let notificationsEnabled = localStorage.getItem('notifications') === 'true';
    let hapticEnabled = localStorage.getItem('haptic') !== 'false';

    // === TRANSLATIONS ===
    const t = (key) => {
      const dict = {
        fa: {
          markets: 'بازارها', wallet: 'کیف پول', profile: 'پروفایل',
          search: 'جستجو در ارزها...', all: 'همه', favorites: 'علاقه‌مندی‌ها',
          gainers: 'بیشترین رشد', losers: 'بیشترین افت',
          marketCap: 'ارزش بازار', growth24h: 'رشد ۲۴ساعته', loss24h: 'افت ۲۴ساعته', volume: 'حجم معاملات',
          noWallet: 'هیچ کیف پولی اضافه نشده', addWallet: 'افزودن کیف پول',
          export: 'خروجی', import: 'ورودی', balance: 'موجودی', usd: 'دلار',
          add: 'افزودن', cancel: 'لغو', delete: 'حذف', edit: 'ویرایش',
          copy: 'کپی شد!', qr: 'نمایش QR', chart: 'نمودار', alert: 'هشدار',
          theme: 'تم', language: 'زبان', notifications: 'اعلان‌ها', haptic: 'لرزش دکمه‌ها',
          stats: 'آمار اپ', coins: 'تعداد ارزها', wallets: 'کیف پول‌ها', alerts: 'هشدارهای فعال',
          about: 'درباره ما', version: 'نسخه 2.0 - ۱۴۰۴'
        },
        en: {
          markets: 'Markets', wallet: 'Wallet', profile: 'Profile',
          search: 'Search coins...', all: 'All', favorites: 'Favorites',
          gainers: 'Top Gainers', losers: 'Top Losers',
          marketCap: 'Market Cap', growth24h: '24h Growth', loss24h: '24h Loss', volume: 'Volume',
          noWallet: 'No wallet added', addWallet: 'Add Wallet',
          export: 'Export', import: 'Import', balance: 'Balance', usd: 'USD',
          add: 'Add', cancel: 'Cancel', delete: 'Delete', edit: 'Edit',
          copy: 'Copied!', qr: 'Show QR', chart: 'Chart', alert: 'Alert',
          theme: 'Theme', language: 'Language', notifications: 'Notifications', haptic: 'Haptic',
          stats: 'App Stats', coins: 'Coins', wallets: 'Wallets', alerts: 'Active Alerts',
          about: 'About', version: 'v2.0 - 2025'
        }
      };
      return dict[lang][key] || key;
    };

    // === TELEGRAM INIT ===
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.enableClosingConfirmation();

    // === HAPTIC FEEDBACK ===
    const haptic = (type = 'light') => {
      if (hapticEnabled && tg.HapticFeedback) {
        tg.HapticFeedback.impactOccurred(type);
      }
    };

    // === THEME & LANG ===
    const themeToggle = document.getElementById('theme-toggle');
    const profileThemeToggle = document.getElementById('profile-theme-toggle');
    const langToggle = document.getElementById('lang-toggle');
    const profileLangToggle = document.getElementById('profile-lang-toggle');
    const themeIcon = themeToggle.querySelector('i');
    const profileThemeIcon = profileThemeToggle.querySelector('i');

    function updateTheme() {
      isDark = localStorage.getItem('theme') === 'dark';
      if (isDark) {
        document.documentElement.classList.add('dark');
        themeIcon.setAttribute('data-lucide', 'sun');
        profileThemeIcon.setAttribute('data-lucide', 'sun');
      } else {
        document.documentElement.classList.remove('dark');
        themeIcon.setAttribute('data-lucide', 'moon');
        profileThemeIcon.setAttribute('data-lucide', 'moon');
      }
      lucide.createIcons();
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    function updateLang() {
      lang = localStorage.getItem('lang') || 'fa';
      langToggle.textContent = lang === 'fa' ? 'EN' : 'FA';
      profileLangToggle.textContent = lang === 'fa' ? 'EN' : 'FA';
      document.documentElement.dir = lang === 'fa' ? 'rtl' : 'ltr';
      document.documentElement.lang = lang;
      updateUIText();
      localStorage.setItem('lang', lang);
    }

    function updateUIText() {
      // تب‌ها
      document.querySelector('[data-tab="markets"]').textContent = t('markets');
      document.querySelector('[data-tab="wallet"]').textContent = t('wallet');
      document.querySelector('[data-tab="profile"]').textContent = t('profile');
      
      // بازارها
      document.getElementById('search-input').placeholder = t('search');
      document.querySelector('[data-market-tab="all"]').textContent = t('all');
      document.querySelector('[data-market-tab="favorites"]').textContent = t('favorites');
      document.querySelector('[data-market-tab="gainers"]').textContent = t('gainers');
      document.querySelector('[data-market-tab="losers"]').textContent = t('losers');
      
      // مرتب‌سازی
      const sortSelect = document.getElementById('sort-select');
      sortSelect.options[0].text = t('marketCap');
      sortSelect.options[1].text = t('growth24h');
      sortSelect.options[2].text = t('loss24h');
      sortSelect.options[3].text = t('volume');
      
      // کیف پول
      document.querySelector('#empty-wallet p').textContent = t('noWallet');
      document.querySelector('#empty-wallet button').textContent = t('addWallet');
      
      // پروفایل
      document.querySelector('#profile-theme-toggle').nextElementSibling.textContent = t('theme');
      document.querySelector('#profile-lang-toggle').nextElementSibling.textContent = t('language');
      document.querySelector('#notifications-toggle').nextElementSibling.textContent = t('notifications');
      document.querySelector('#haptic-toggle').nextElementSibling.textContent = t('haptic');
      
      // آمار
      document.querySelector('#stats-coins').previousElementSibling.textContent = t('coins');
      document.querySelector('#stats-wallets').previousElementSibling.textContent = t('wallets');
      document.querySelector('#stats-alerts').previousElementSibling.textContent = t('alerts');
      
      // درباره ما
      document.querySelector('.bg-white.dark\\:bg-gray-800.rounded-xl.p-6.text-center h3').textContent = t('about');
      document.querySelector('.bg-white.dark\\:bg-gray-800.rounded-xl.p-6.text-center p:last-child').textContent = t('version');
    }
    themeToggle.onclick = () => {
      haptic('light');
      isDark = !isDark;
      updateTheme();
    };

    profileThemeToggle.onclick = () => {
      haptic('light');
      isDark = !isDark;
      updateTheme();
    };

    langToggle.onclick = () => {
      haptic('light');
      lang = lang === 'fa' ? 'en' : 'fa';
      updateLang();
    };

    profileLangToggle.onclick = () => {
      haptic('light');
      lang = lang === 'fa' ? 'en' : 'fa';
      updateLang();
    };

    document.getElementById('notifications-toggle').checked = notificationsEnabled;
    document.getElementById('notifications-toggle').onchange = (e) => {
      notificationsEnabled = e.target.checked;
      localStorage.setItem('notifications', notificationsEnabled);
    };

    document.getElementById('haptic-toggle').checked = hapticEnabled;
    document.getElementById('haptic-toggle').onchange = (e) => {
      hapticEnabled = e.target.checked;
      localStorage.setItem('haptic', hapticEnabled);
    };

    // === NAVIGATION ===
    document.querySelectorAll('[data-tab]').forEach(btn => {
      btn.onclick = () => {
        haptic('light');
        document.querySelectorAll('[data-tab]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
        document.getElementById(`page-${btn.dataset.tab}`).classList.remove('hidden');
        currentTab = btn.dataset.tab;
        if (currentTab === 'markets') loadMarkets();
        if (currentTab === 'wallet') renderWallets();
        if (currentTab === 'profile') updateProfileStats();
      };
    });

    // === SEARCH & FILTERS ===
    const searchInput = document.getElementById('search-input');
    const clearSearch = document.getElementById('clear-search');

    searchInput.oninput = () => {
      renderMarkets();
      clearSearch.classList.toggle('hidden', !searchInput.value);
    };

    clearSearch.onclick = () => {
      searchInput.value = '';
      renderMarkets();
      clearSearch.classList.add('hidden');
      searchInput.focus();
    };

    document.querySelectorAll('[data-market-tab]').forEach(btn => {
      btn.onclick = () => {
        haptic('light');
        document.querySelectorAll('[data-market-tab]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentMarketTab = btn.dataset.marketTab;
        page = 1;
        loadMarkets();
      };
    });

    document.getElementById('sort-select').onchange = (e) => {
      currentSort = e.target.value;
      renderMarkets();
    };

    // === MARKETS ===
    async function loadMarkets() {
      const list = document.getElementById('markets-list');
      const skeleton = document.getElementById('skeleton-loading');
      const loadMore = document.getElementById('load-more');
      
      if (page === 1) {
        skeleton.classList.remove('hidden');
        list.innerHTML = '';
        skeleton.innerHTML = Array(12).fill().map(() => `
          <div class="flex justify-between items-center p-4 bg-white dark:bg-gray-800 rounded-xl animate-pulse">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-gray-200 dark:bg-gray-700 rounded-full"></div>
              <div>
                <div class="h-4 w-24 bg-gray-200 dark:bg-gray-700 rounded"></div>
                <div class="h-3 w-16 bg-gray-200 dark:bg-gray-700 rounded mt-1"></div>
              </div>
            </div>
            <div class="text-right">
              <div class="h-5 w-20 bg-gray-200 dark:bg-gray-700 rounded"></div>
              <div class="h-4 w-16 bg-gray-200 dark:bg-gray-700 rounded mt-1"></div>
            </div>
          </div>
        `).join('');
      }

      try {
        let url = `${CONFIG.COINGECKO_API}/coins/markets?vs_currency=usd&order=${currentSort}&per_page=50&page=${page}&sparkline=false`;
        
        if (currentMarketTab === 'favorites') {
          if (favorites.length === 0) {
            list.innerHTML = `<p class="text-center text-gray-500 p-8">${t('favorites')} خالی است</p>`;
            skeleton.classList.add('hidden');
            return;
          }
          url += `&ids=${favorites.join(',')}`;
        }

        const res = await fetch(url);
        const data = await res.json();

        if (currentMarketTab === 'gainers') {
          data.sort((a, b) => b.price_change_percentage_24h - a.price_change_percentage_24h);
        } else if (currentMarketTab === 'losers') {
          data.sort((a, b) => a.price_change_percentage_24h - b.price_change_percentage_24h);
        }

        if (page === 1) markets = [];
        markets = markets.concat(data);

        renderMarkets();
        loadMore.classList.toggle('hidden', data.length < 50);
      } catch (e) {
        list.innerHTML = `<p class="text-center text-red-500 p-8">خطا در بارگذاری</p>`;
      } finally {
        skeleton.classList.add('hidden');
      }
    }

    function renderMarkets() {
      const list = document.getElementById('markets-list');
      const search = searchInput.value.toLowerCase();
      const filtered = markets.filter(coin => 
        coin.name.toLowerCase().includes(search) || 
        coin.symbol.toLowerCase().includes(search)
      );

      if (filtered.length === 0 && page === 1) {
        list.innerHTML = `<p class="text-center text-gray-500 p-8">موردی یافت نشد</p>`;
        return;
      }

      const html = filtered.map(coin => {
        const isFav = favorites.includes(coin.id);
        const change = coin.price_change_percentage_24h;
        return `
          <div class="flex justify-between items-center p-4 bg-white dark:bg-gray-800 rounded-xl haptic" data-coin-id="${coin.id}">
            <div class="flex items-center gap-3">
              <img src="${coin.image}" alt="" class="w-10 h-10 rounded-full">
              <div>
                <div class="font-semibold">${coin.name}</div>
                <div class="text-sm text-gray-500">${coin.symbol.toUpperCase()}</div>
              </div>
            </div>
            <div class="text-right">
              <div class="font-bold">$${coin.current_price.toLocaleString()}</div>
              <div class="${change > 0 ? 'text-success' : change < 0 ? 'text-danger' : 'text-gray-500'} text-sm">
                ${change > 0 ? '+' : ''}${change.toFixed(2)}%
              </div>
            </div>
            <div class="flex gap-1">
              <button onclick="toggleFavorite('${coin.id}')" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 haptic">
                <i data-lucide="${isFav ? 'star' : 'star-off'}" class="w-5 h-5"></i>
              </button>
              <button onclick="openChart('${coin.id}', '${coin.name}')" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 haptic">
                <i data-lucide="trending-up" class="w-5 h-5"></i>
              </button>
              <button onclick="openPriceAlertModal('${coin.id}', '${coin.name}', ${coin.current_price})" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 haptic">
                <i data-lucide="bell" class="w-5 h-5"></i>
              </button>
            </div>
          </div>
        `;
      }).join('');

      if (page === 1) {
        list.innerHTML = html;
      } else {
        list.innerHTML += html;
      }
      lucide.createIcons();
    }

    window.toggleFavorite = (id) => {
      haptic('light');
      if (favorites.includes(id)) {
        favorites = favorites.filter(f => f !== id);
      } else {
        favorites.push(id);
      }
      localStorage.setItem('favorites', JSON.stringify(favorites));
      if (currentMarketTab === 'favorites') loadMarkets();
      else renderMarkets();
    };

    document.getElementById('load-more').onclick = () => {
      page++;
      loadMarkets();
    };

    // === CHART MODAL ===
    window.openChart = (id, name) => {
      haptic('medium');
      const modal = document.getElementById('modal');
      modal.classList.remove('hidden');
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-lg">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">${name}</h3>
            <button onclick="closeModal()" class="p-1 haptic"><i data-lucide="x" class="w-5 h-5"></i></button>
          </div>
          <div class="flex gap-2 mb-4">
            <button data-chart-days="7" class="chart-days-btn flex-1 py-2 rounded-lg bg-gray-100 dark:bg-gray-700 text-sm active">۷ روز</button>
            <button data-chart-days="30" class="chart-days-btn flex-1 py-2 rounded-lg bg-gray-100 dark:bg-gray-700 text-sm">۳۰ روز</button>
          </div>
          <div class="chart-container">
            <canvas id="price-chart"></canvas>
          </div>
        </div>
      `;
      lucide.createIcons();
      fetchChartData(id, 7);
    };

    async function fetchChartData(id, days) {
      const res = await fetch(`${CONFIG.COINGECKO_API}/coins/${id}/market_chart?vs_currency=usd&days=${days}`);
      const data = await res.json();
      const labels = data.prices.map(p => new Date(p[0]).toLocaleDateString(lang === 'fa' ? 'fa-IR' : 'en-US', { month: 'short', day: 'numeric' }));
      const prices = data.prices.map(p => p[1]);
      
      const ctx = document.getElementById('price-chart').getContext('2d');
      if (window.priceChart) window.priceChart.destroy();
      
      window.priceChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label: 'قیمت (USD)', data: prices, borderColor: '#1DA1F2', tension: 0.3, fill: false }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
      });

      document.querySelectorAll('[data-chart-days]').forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll('[data-chart-days]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          fetchChartData(id, btn.dataset.chartDays);
        };
      });
    }
    // === PRICE ALERT MODAL ===
    window.openPriceAlertModal = (id, name, currentPrice) => {
      haptic('medium');
      const modal = document.getElementById('modal');
      modal.classList.remove('hidden');
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-md">
          <h3 class="text-lg font-bold mb-4">${t('alert')} برای ${name}</h3>
          <div class="mb-4">
            <label class="block text-sm mb-1">قیمت فعلی: $${currentPrice.toLocaleString()}</label>
            <input type="number" id="alert-price" placeholder="قیمت هدف (USD)" class="w-full px-4 py-2 border rounded-lg">
          </div>
          <div class="flex gap-2">
            <button onclick="setPriceAlert('${id}', '${name}')" class="flex-1 py-2 bg-primary text-white rounded-lg haptic">${t('add')}</button>
            <button onclick="closeModal()" class="flex-1 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg haptic">${t('cancel')}</button>
          </div>
        </div>
      `;
    };

    window.setPriceAlert = (id, name) => {
      const priceInput = document.getElementById('alert-price');
      const price = parseFloat(priceInput.value);
      if (!price || price <= 0) {
        priceInput.classList.add('border-danger');
        return;
      }
      alerts.push({ id, name, price, active: true, created: Date.now() });
      localStorage.setItem('alerts', JSON.stringify(alerts));
      closeModal();
      showToast(t('alert'), `${name} در $${price} تنظیم شد`);
      updateProfileStats();
    };

    function checkPriceAlerts() {
      if (!notificationsEnabled) return;
      markets.forEach(coin => {
        alerts.forEach((alert, i) => {
          if (alert.id === coin.id && alert.active) {
            const diff = Math.abs(coin.current_price - alert.price) / alert.price;
            if (diff <= 0.005) { // 0.5%
              showToast(`${t('alert')} فعال شد`, `${coin.name} به $${coin.current_price.toFixed(2)} رسید`);
              alert.active = false;
              alerts[i] = alert;
              localStorage.setItem('alerts', JSON.stringify(alerts));
              updateProfileStats();
            }
          }
        });
      });
    }

    // === WALLET ===
    function renderWallets() {
      const list = document.getElementById('wallet-list');
      const empty = document.getElementById('empty-wallet');
      if (wallets.length === 0) {
        empty.classList.remove('hidden');
        list.innerHTML = '';
        return;
      }
      empty.classList.add('hidden');
      list.innerHTML = wallets.map((w, i) => `
        <div class="p-4 bg-white dark:bg-gray-800 rounded-xl haptic" data-wallet-index="${i}">
          <div class="flex justify-between items-center mb-2">
            <div>
              <div class="font-semibold flex items-center gap-2">
                ${w.name || w.address.slice(0, 8) + '...'}
                <span class="text-xs px-2 py-1 rounded-full ${w.network === 'eth' ? 'bg-blue-100 text-blue-700' : w.network === 'ton' ? 'bg-purple-100 text-purple-700' : 'bg-orange-100 text-orange-700'}">
                  ${w.network.toUpperCase()}
                </span>
              </div>
              <div class="text-sm text-gray-500 flex items-center gap-1">
                ${w.address.slice(0, 10)}...${w.address.slice(-8)}
                <span class="copy-btn" onclick="copyToClipboard('${w.address}')"><i data-lucide="copy" class="w-4 h-4"></i></span>
              </div>
            </div>
            <div class="flex gap-1">
              <button onclick="editWallet(${i})" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 haptic">
                <i data-lucide="edit" class="w-4 h-4"></i>
              </button>
              <button onclick="removeWallet(${i})" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-danger haptic">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
              </button>
            </div>
          </div>
          <div id="balance-${i}" class="mt-2 text-sm">در حال بارگذاری...</div>
          <button onclick="showQR('${w.address}')" class="mt-2 text-primary text-sm flex items-center gap-1 haptic">
            <i data-lucide="qr-code" class="w-4 h-4"></i> ${t('qr')}
          </button>
        </div>
      `).join('');
      lucide.createIcons();
      wallets.forEach((w, i) => fetchWalletBalance(w, i));
    }

    window.openAddWalletModal = () => {
      haptic('medium');
      const modal = document.getElementById('modal');
      modal.classList.remove('hidden');
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-md">
          <h3 class="text-lg font-bold mb-4">${t('addWallet')}</h3>
          <input type="text" id="wallet-name" placeholder="نام (اختیاری)" class="w-full px-4 py-2 border rounded-lg mb-3">
          <select id="wallet-network" class="w-full px-4 py-2 border rounded-lg mb-3">
            <option value="eth">Ethereum (ETH)</option>
            <option value="ton">TON</option>
            <option value="tron">TRON (USDT)</option>
          </select>
          <input type="text" id="wallet-address" placeholder="آدرس کیف پول" class="w-full px-4 py-2 border rounded-lg mb-4">
          <div class="flex gap-2">
            <button onclick="addWallet()" class="flex-1 py-2 bg-primary text-white rounded-lg haptic">${t('add')}</button>
            <button onclick="closeModal()" class="flex-1 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg haptic">${t('cancel')}</button>
          </div>
        </div>
      `;
    };

    window.addWallet = () => {
      const name = document.getElementById('wallet-name').value.trim();
      const network = document.getElementById('wallet-network').value;
      const address = document.getElementById('wallet-address').value.trim();
      if (!address) {
        document.getElementById('wallet-address').classList.add('border-danger');
        return;
      }
      if (!validateAddress(address, network)) {
        showToast('خطا', 'آدرس نامعتبر است');
        return;
      }
      wallets.push({ name, network, address });
      localStorage.setItem('wallets', JSON.stringify(wallets));
      closeModal();
      renderWallets();
      updateProfileStats();
      showToast('موفقیت', 'کیف پول اضافه شد');
    };

    window.editWallet = (i) => {
      haptic('medium');
      const w = wallets[i];
      const modal = document.getElementById('modal');
      modal.classList.remove('hidden');
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-md">
          <h3 class="text-lg font-bold mb-4">${t('edit')} کیف پول</h3>
          <input type="text" id="edit-name" value="${w.name || ''}" placeholder="نام (اختیاری)" class="w-full px-4 py-2 border rounded-lg mb-3">
          <input type="text" id="edit-address" value="${w.address}" placeholder="آدرس کیف پول" class="w-full px-4 py-2 border rounded-lg mb-4">
          <div class="flex gap-2">
            <button onclick="saveEditedWallet(${i})" class="flex-1 py-2 bg-primary text-white rounded-lg haptic">ذخیره</button>
            <button onclick="closeModal()" class="flex-1 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg haptic">${t('cancel')}</button>
          </div>
        </div>
      `;
    };

    window.saveEditedWallet = (i) => {
      const name = document.getElementById('edit-name').value.trim();
      const address = document.getElementById('edit-address').value.trim();
      if (!address) return;
      if (!validateAddress(address, wallets[i].network)) {
        showToast('خطا', 'آدرس نامعتبر');
        return;
      }
      wallets[i].name = name;
      wallets[i].address = address;
      localStorage.setItem('wallets', JSON.stringify(wallets));
      closeModal();
      renderWallets();
    };

    window.removeWallet = (i) => {
      haptic('heavy');
      if (confirm(t('delete') + '؟')) {
        wallets.splice(i, 1);
        localStorage.setItem('wallets', JSON.stringify(wallets));
        renderWallets();
        updateProfileStats();
      }
    };

    function validateAddress(address, network) {
      if (network === 'eth') return /^0x[a-fA-F0-9]{40}$/.test(address);
      if (network === 'ton') return /^[a-zA-Z0-9]{48}$/.test(address);
      if (network === 'tron') return /^T[a-zA-Z0-9]{33}$/.test(address);
      return false;
    }

    async function fetchWalletBalance(wallet, index) {
      const el = document.getElementById(`balance-${index}`);
      try {
        let balance = 0, usd = 0, symbol = '';
        if (wallet.network === 'eth') {
          const res = await fetch(`${CONFIG.ETH_API}?module=account&action=balance&address=${wallet.address}&tag=latest&apikey=${CONFIG.ETHERSCAN_KEY}`);
          const data = await res.json();
          if (data.status !== '1') throw new Error();
          balance = parseInt(data.result) / 1e18;
          const priceRes = await fetch(`${CONFIG.COINGECKO_API}/simple/price?ids=ethereum&vs_currencies=usd`);
          const priceData = await priceRes.json();
          usd = balance * priceData.ethereum.usd;
          symbol = 'ETH';
        } else if (wallet.network === 'ton') {
          const res = await fetch(`${CONFIG.TON_API}/getAddressInformation?address=${wallet.address}`);
          const data = await res.json();
          balance = data.balance / 1e9;
          usd = balance * 6.5;
          symbol = 'TON';
        } else if (wallet.network === 'tron') {
          const res = await fetch(`${CONFIG.TRON_API}/v1/accounts/${wallet.address}`);
          const data = await res.json();
          const usdt = data.data[0]?.trc20?.find(t => t.tokenName === 'Tether USDt' || t.tokenAbbr === 'USDT');
          balance = usdt ? usdt.balance / 1e6 : 0;
          usd = balance;
          symbol = 'USDT';
        }
        el.innerHTML = `${balance.toFixed(4)} ${symbol} ≈ $${usd.toFixed(2)}`;
      } catch (e) {
        el.innerHTML = '<span class="text-danger">خطا</span>';
      }
    }

    window.showQR = (address) => {
      haptic('medium');
      const modal = document.getElementById('modal');
      modal.classList.remove('hidden');
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-md text-center">
          <div id="qrcode" class="mx-auto mb-4"></div>
          <p class="text-sm break-all mb-4">${address}</p>
          <button onclick="copyToClipboard('${address}')" class="px-4 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg text-sm haptic flex items-center gap-2 mx-auto">
            <i data-lucide="copy" class="w-4 h-4"></i> کپی آدرس
          </button>
          <button onclick="closeModal()" class="mt-4 px-6 py-2 bg-primary text-white rounded-lg haptic">بستن</button>
        </div>
      `;
      new QRCode(document.getElementById('qrcode'), { text: address, width: 200, height: 200 });
    };
    window.copyToClipboard = (text) => {
      haptic('light');
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
          showToast('کپی شد', text.slice(0, 20) + '...');
        });
      } else {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showToast('کپی شد', text.slice(0, 20) + '...');
      }
    };

    window.exportWallets = () => {
      haptic('medium');
      if (wallets.length === 0) {
        showToast('خطا', 'کیف پولی وجود ندارد');
        return;
      }
      const data = JSON.stringify(wallets, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `shelby-wallets-${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('موفقیت', 'فایل خروجی ایجاد شد');
    };

    window.importWallets = () => {
      haptic('medium');
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          try {
            const imported = JSON.parse(ev.target.result);
            if (!Array.isArray(imported)) throw new Error();
            const valid = imported.filter(w => w.address && ['eth','ton','tron'].includes(w.network));
            if (valid.length === 0) throw new Error();
            wallets = [...wallets, ...valid];
            localStorage.setItem('wallets', JSON.stringify(wallets));
            renderWallets();
            updateProfileStats();
            showToast('موفقیت', `${valid.length} کیف پول وارد شد`);
          } catch {
            showToast('خطا', 'فایل نامعتبر است');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    };

    // === TOAST NOTIFICATION ===
    function showToast(title, message) {
      const toast = document.getElementById('toast');
      document.getElementById('toast-title').textContent = title;
      document.getElementById('toast-message').textContent = message;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    // === PROFILE STATS ===
    function updateProfileStats() {
      document.getElementById('stats-coins').textContent = markets.length;
      document.getElementById('stats-wallets').textContent = wallets.length;
      document.getElementById('stats-alerts').textContent = alerts.filter(a => a.active).length;
    }

    // === MODAL CONTROL ===
    window.closeModal = () => {
      haptic('light');
      document.getElementById('modal').classList.add('hidden');
    };

    // === AUTO UPDATE & ALERT CHECK ===
    let updateInterval, alertInterval;

    function startAutoUpdate() {
      clearInterval(updateInterval);
      clearInterval(alertInterval);
      updateInterval = setInterval(() => {
        if (currentTab === 'markets') loadMarkets();
      }, CONFIG.UPDATE_INTERVAL);
      alertInterval = setInterval(checkPriceAlerts, CONFIG.ALERT_CHECK_INTERVAL);
    }

    // === PWA SERVICE WORKER ===
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then(reg => console.log('SW registered', reg))
        .catch(err => console.log('SW error', err));
    }

    // === SKELETON LOADING FOR ALL PAGES ===
    function showSkeleton(containerId, count = 5) {
      const container = document.getElementById(containerId);
      container.innerHTML = Array(count).fill().map(() => `
        <div class="p-4 bg-white dark:bg-gray-800 rounded-xl animate-pulse">
          <div class="flex justify-between items-center">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-gray-200 dark:bg-gray-700 rounded-full"></div>
              <div class="space-y-2">
                <div class="h-4 w-32 bg-gray-200 dark:bg-gray-700 rounded"></div>
                <div class="h-3 w-20 bg-gray-200 dark:bg-gray-700 rounded"></div>
              </div>
            </div>
            <div class="h-6 w-24 bg-gray-200 dark:bg-gray-700 rounded"></div>
          </div>
        </div>
      `).join('');
    }

    // === INIT ON LOAD ===
    window.addEventListener('load', () => {
      updateTheme();
      updateLang();
      lucide.createIcons();

      // شروع با بازارها
      document.querySelector('[data-tab="markets"]').click();

      // بارگذاری اولیه
      loadMarkets();
      renderWallets();
      updateProfileStats();

      // فعال‌سازی به‌روزرسانی خودکار
      startAutoUpdate();

      // Skeleton برای کیف پول (در صورت خالی بودن)
      if (wallets.length === 0) {
        document.getElementById('empty-wallet').classList.remove('hidden');
      }

      // تنظیمات اولیه
      document.getElementById('notifications-toggle').checked = notificationsEnabled;
      document.getElementById('haptic-toggle').checked = hapticEnabled;

      // نمایش آمار
      setTimeout(updateProfileStats, 1000);
    });

    // === RESPONSIVE & PERFORMANCE ===
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        if (window.priceChart) window.priceChart.resize();
      }, 250);
    });

    // === ERROR HANDLING ===
    window.addEventListener('error', (e) => {
      console.error('Global error:', e.error);
      showToast('خطا', 'مشکلی پیش آمد');
    });

    window.addEventListener('unhandledrejection', (e) => {
      console.error('Promise rejection:', e.reason);
      showToast('خطا', 'درخواست ناموفق');
    });

    // === FINAL TOUCHES ===
    // افزودن انیمیشن به دکمه‌ها
    document.querySelectorAll('.haptic').forEach(el => {
      el.addEventListener('touchstart', () => haptic('light'));
    });

    // بهبود تجربه کاربری
    document.body.addEventListener('click', (e) => {
      if (e.target.closest('#modal')) {
        if (!e.target.closest('.bg-white, .dark\\:bg-gray-800')) {
          closeModal();
        }
      }
    });
  </script>

</body>
</html>
<!-- این بخش خالی است — کد اصلی در بخش ۵ تموم شد (۱۰۴۷ خط) -->
<!-- فقط برای تکمیل ۶ بخش، این قسمت رو خالی می‌ذاریم -->

<!-- ==================================================== -->
<!-- فایل جداگانه: sw.js (آفلاین + کش کامل) -->
<!-- ==================================================== -->

<!-- این کد رو در یک فایل جدا به نام `sw.js` ذخیره کن (در همان پوشه `index.html`) -->
