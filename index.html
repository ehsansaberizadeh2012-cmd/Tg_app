<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no, user-scalable=no">
    <title>Shelby Bet</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- فونت Vazirmatn برای RTL مناسب است -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* تعریف متغیرهای تم تاریک و روشن */
        :root {
            --bg: #121212; --text: #EAECEF; --hint: #707A8A;
            --button: #2E81FF; --secondary-bg: #1E1E1E; --header-border: #2A2A2A;
            --positive: #00C853; --negative: #FF3B30;
        }
        .light-theme {
            --bg: #FFFFFF; --text: #1c1c1e; --hint: #8e8e93;
            --button: #007AFF; --secondary-bg: #F2F2F7; --header-border: #e5e5ea;
        }
        /* استایل‌های پایه */
        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; padding-bottom: 70px; transition: background-color 0.3s, color 0.3s; -webkit-tap-highlight-color: transparent; }
        .page { display: none; min-height: calc(100vh - 70px); }
        .page.active { display: block; }
        /* استایل نوار بالا و نوار پیمایش */
        .header { background-color: var(--bg); position: sticky; top: 0; z-index: 20; padding: 1rem; border-bottom: 1px solid var(--header-border); transition: background-color 0.3s, border-color 0.3s; }
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--secondary-bg); border-top: 1px solid var(--header-border); z-index: 30; display: flex; justify-content: space-around; padding-top: 0.5rem; height: 65px; transition: background-color 0.3s, border-color 0.3s; }
        .nav-button { flex: 1; text-align: center; padding: 0.25rem; color: var(--hint); cursor: pointer; transition: color 0.2s; }
        .nav-button.active { color: var(--button); }
        .nav-icon { height: 24px; width: 24px; margin: 0 auto 4px; stroke-width: 2; }
        /* استایل‌های لیست ارزها و اسکلتون لودینگ */
        .tab-button { border: 1px solid var(--header-border); }
        .tab-button.active { background-color: var(--button); color: white; border-color: var(--button); }
        .sort-button.active { color: var(--button); }
        .sparkline-path { stroke-width: 2; fill: none; }
        .skeleton { background-color: var(--secondary-bg); border-radius: 8px; animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        /* استایل‌های مدال */
        .modal-backdrop { position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); z-index: 40; backdrop-filter: blur(5px); }
        .modal { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--secondary-bg); z-index: 50; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 1.5rem; transform: translateY(100%); transition: transform 0.3s ease-out; }
        .modal.open { transform: translateY(0); }
        .toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 10px 20px; border-radius: 8px; z-index: 100; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body class="antialiased">

    <!-- =========== Pages Container =========== -->
    
    <!-- 1. صفحه بازارها (Markets) - صفحه اصلی -->
    <div id="markets-page" class="page active">
        <div class="header">
            <h1 data-i18n-key="marketHeader" class="text-xl font-bold text-center mb-4"></h1>
            <input type="text" id="search-input" data-i18n-placeholder="searchPlaceholder" class="w-full p-2.5 rounded-lg text-sm mb-3" style="background-color: var(--secondary-bg); border: 1px solid var(--header-border); color: var(--text);">
            <div class="flex items-center justify-between">
                 <div class="flex bg-[var(--secondary-bg)] rounded-lg p-1">
                    <button id="tab-all" class="tab-button active px-3 py-1.5 rounded-md text-xs font-semibold" data-i18n-key="all"></button>
                    <button id="tab-watchlist" class="tab-button px-3 py-1.5 rounded-md text-xs font-semibold" data-i18n-key="watchlist"></button>
                </div>
                 <div id="sort-controls" class="flex items-center space-x-1 space-x-reverse">
                    <button class="sort-button active text-xs px-2" data-sort="market_cap_desc" data-i18n-key="marketCap"></button>
                    <button class="sort-button text-xs px-2" data-sort="gainers" data-i18n-key="gainers"></button>
                    <button class="sort-button text-xs px-2" data-sort="losers" data-i18n-key="losers"></button>
                </div>
            </div>
        </div>
        <!-- خلاصه‌وضعیت بازار و قیمت دلار -->
        <div id="summary-container" class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        <!-- لیست ارزها با Infinite Scroll -->
        <div id="coin-list-container" class="h-[calc(100vh-230px)] overflow-y-auto">
            <div id="coin-list" class="relative"></div>
        </div>
        <div id="message-container" class="hidden text-center p-10 text-[var(--hint)]"></div>
    </div>

    <!-- 2. صفحه پروفایل (Profile) -->
    <div id="profile-page" class="page"></div>
    
    <!-- 3. صفحه "به زودی" (برای Wallet, Converter, Shop) -->
    <div id="coming-soon-page" class="page"></div>

    <!-- =========== Navigation Bar - نوار پیمایش (Fixed Bottom) =========== -->
    <nav class="nav-bar">
        
        <!-- 1. کیف پول (Wallet) -->
        <button class="nav-button" data-page="coming-soon-page" data-page-key="wallet">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
            <span data-i18n-key="wallet" class="block text-xs"></span>
        </button>
        
        <!-- 2. بازارها (Markets) - فعال -->
        <button class="nav-button active" data-page="markets-page">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
            <span data-i18n-key="markets" class="block text-xs"></span>
        </button>
        
        <!-- 3. تبدیل (Converter) -->
        <button class="nav-button" data-page="coming-soon-page" data-page-key="converter">
             <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            <span data-i18n-key="converter" class="block text-xs"></span>
        </button>
        
        <!-- 4. فروشگاه (Shop) -->
        <button class="nav-button" data-page="coming-soon-page" data-page-key="shop">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4m-1.5 5h11m-11 0a2 2 0 01-2-2v-5a2 2 0 012-2h11a2 2 0 012 2v5a2 2 0 01-2 2h-11z"></path></svg>
            <span data-i18n-key="shop" class="block text-xs"></span>
        </button>
        
        <!-- 5. پروفایل (Profile) -->
        <button class="nav-button" data-page="profile-page">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
            <span data-i18n-key="profile" class="block text-xs"></span>
        </button>
        
    </nav>

    <!-- Modals and Toast -->
    <div id="modal-backdrop" class="modal-backdrop hidden" onclick="closeModal()"></div>
    <div id="modal" class="modal"><div id="modal-content" class="h-[70vh] overflow-y-auto"></div></div>
    <div id="toast" class="toast"></div>

    <script>
    //============== START OF FULL JAVASCRIPT CODE ==============
    
    // متغیرهای گلوبال
    const tg = window.Telegram.WebApp;

    // --- I18N Translations (چهار زبان کامل) ---
    const translations = {
        en: { 
            markets: "Markets", profile: "Profile", converter: "Converter", marketHeader: "Crypto Markets", searchPlaceholder: "Search coins...", all: "All", watchlist: "Watchlist", marketCap: "Market Cap", gainers: "Gainers", losers: "Losers", emailSaved: "Email saved!", walletSaved: "Wallet address saved!", walletDeleted: "Wallet deleted!", copied: "Copied!", settings: "Settings", theme: "Theme", dark: "Dark", light: "Light", language: "Language", userInfo: "User Info", name: "Name", username: "Username", userId: "User ID", emailOptional: "Email (Optional)", notSet: "Not set", wallets: "Wallets", walletsCount: "{count} saved wallets", tryAgain: "Try Again", errorFetchSummary: "Error fetching summary data", errorFetchCrypto: "Error fetching crypto list", noResults: "No coins found.", emptyWatchlist: "Your watchlist is empty.", rank: "Rank", editEmail: "Edit Email", enterEmail: "Enter your email", save: "Save", invalidEmail: "Invalid email address.", editWallets: "Wallet Addresses", noWallets: "No wallets added yet.", addNewWallet: "Add New Wallet", editWallet: "Edit Wallet", addWallet: "Add Wallet", selectCoin: "Select Coin", walletAddress: "Wallet Address...", back: "Back", confirmDelete: "Are you sure you want to delete {symbol} wallet?", cryptoAmount: "Coin Amount", usdEquivalent: "USD Equivalent", irtEquivalent: "Toman Equivalent", coinDetails: "Coin Details", price: "Price", change24h: "24h Change", high24h: "24h High", low24h: "24h Low", volume24h: "24h Volume", chartUnavailable: "Chart unavailable", shop: "Shop", wallet: "Wallet", usingCachedPrice: "Using cached price", comingSoon: "Coming Soon!", comingSoonMessage: "This page ({pageName}) is under development and will be available soon.", 
        },
        fa: { 
            markets: "بازارها", profile: "پروفایل", converter: "مبدل", marketHeader: "بازار ارزهای دیجیتال", searchPlaceholder: "جستجوی ارز...", all: "همه", watchlist: "علاقه‌مندی‌ها", marketCap: "ارزش بازار", gainers: "بیشترین رشد", losers: "بیشترین افت", emailSaved: "ایمیل ذخیره شد!", walletSaved: "آدرس کیف پول ذخیره شد!", walletDeleted: "کیف پول حذف شد!", copied: "کپی شد!", settings: "تنظیمات", theme: "پوسته", dark: "تاریک", light: "روشن", language: "زبان", userInfo: "اطلاعات کاربر", name: "نام", username: "نام کاربری", userId: "شناسه کاربر", emailOptional: "ایمیل (اختیاری)", notSet: "تعیین نشده", wallets: "کیف پول‌ها", walletsCount: "{count} کیف پول ذخیره شده", tryAgain: "تلاش مجدد", errorFetchSummary: "خطا در دریافت قیمت طلا و سکه", errorFetchCrypto: "خطا در دریافت لیست ارزها", noResults: "ارزی با این مشخصات یافت نشد.", emptyWatchlist: "هنوز ارزی به علاقه‌مندی‌ها اضافه نکرده‌اید.", rank: "رتبه", editEmail: "ویرایش ایمیل", enterEmail: "ایمیل خود را وارد کنید", save: "ذخیره", invalidEmail: "آدرس ایمیل نامعتبر است.", editWallets: "آدرس کیف پول", noWallets: "هنوز آدرسی اضافه نشده است.", addNewWallet: "افزودن آدرس جدید", editWallet: "ویرایش آدرس", addWallet: "افزودن آدرس", selectCoin: "انتخاب ارز", walletAddress: "آدرس کیف پول...", back: "بازگشت", confirmDelete: "آیا از حذف کیف پول {symbol} مطمئن هستید؟", cryptoAmount: "مقدار ارز", usdEquivalent: "معادل دلاری", irtEquivalent: "معادل تومانی", coinDetails: "جزئیات ارز", price: "قیمت", change24h: "تغییر ۲۴ ساعته", high24h: "بالاترین ۲۴ ساعته", low24h: "پایین‌ترین ۲۴ ساعته", volume24h: "حجم معاملات (۲۴ ساعته)", chartUnavailable: "نمودار موجود نیست", shop: "فروشگاه", wallet: "کیف پول", usingCachedPrice: "استفاده از نرخ ذخیره شده قبلی", comingSoon: "به زودی!", comingSoonMessage: "این صفحه ({pageName}) در حال توسعه است و به زودی در دسترس خواهد بود.",
        },
        ar: { 
            markets: "الأسواق", profile: "الملف الشخصي", converter: "محول", marketHeader: "الأسواق", searchPlaceholder: "ابحث عن عملة...", all: "الكل", watchlist: "المفضلة", marketCap: "القيمة السوقية", gainers: "الأكثر ربحًا", losers: "الأكثر خسارة", emailSaved: "تم حفظ البريد الإلكتروني!", walletSaved: "تم حفظ عنوان المحفظة!", walletDeleted: "تم حذف عنوان المحفظة!", copied: "تم النسخ!", settings: "الإعدادات", theme: "مظهر التطبيق", dark: "داكن", light: "فاتح", language: "اللغة", userInfo: "معلومات المستخدم", name: "الاسم", username: "اسم المستخدم", userId: "معرف المستخدم", emailOptional: "البريد الإلكتروني (اختياري)", notSet: "لم يتم تعيينه", wallets: "عناوين المحفظة", walletsCount: "{count} عناوين محفوظة", tryAgain: "حاول مرة أخرى", errorFetchSummary: "خطأ في جلب أسعار الذهب والعملات", errorFetchCrypto: "خطأ في جلب قائمة العملات", noResults: "لم يتم العثور على نتائج.", emptyWatchlist: "قائمة المراقبة الخاصة بك فارغة.", rank: "مرتبة", editEmail: "تعديل البريد الإلكتروني", enterEmail: "أدخل بريدك الإلكتروني", save: "حفظ", invalidEmail: "عنوان البريد الإلكتروني غير صالح.", editWallets: "عناوين المحفظة", noWallets: "لم تتم إضافة أي عناوين بعد.", addNewWallet: "إضافة عنوان جديد", editWallet: "تعديل العنوان", addWallet: "إضافة عنوان", selectCoin: "اختر العملة", walletAddress: "عنوان المحفظة...", back: "رجوع", confirmDelete: "هل أنت متأكد من حذف محفظة {symbol}؟", cryptoAmount: "كمية العملة", usdEquivalent: "ما يعادل بالدولار", irtEquivalent: "ما يعادل بالتومان", coinDetails: "تفاصيل العملة", price: "السعر", change24h: "التغيير خلال 24 ساعة", high24h: "أعلى سعر خلال 24 ساعة", low24h: "أدنى سعر خلال 24 ساعة", volume24h: "حجم التداول (24 ساعة)", chartUnavailable: "الرسم البياني غير متوفر", shop: "المتجر", wallet: "المحفظة", usingCachedPrice: "استخدام السعر المخزن مؤقتًا", comingSoon: "قريبًا!", comingSoonMessage: "هذه الصفحة ({pageName}) قيد التطوير وستكون متاحة قريبًا.",
        },
        zh: { 
            markets: "市场", profile: "个人资料", converter: "转换器", marketHeader: "加密市场", searchPlaceholder: "搜索币种...", all: "全部", watchlist: "关注列表", marketCap: "市值", gainers: "涨幅榜", losers: "跌幅榜", emailSaved: "邮件已保存!", walletSaved: "钱包地址已保存!", walletDeleted: "钱包已删除!", copied: "已复制!", settings: "设置", theme: "主题", dark: "深色", light: "浅色", language: "语言", userInfo: "用户信息", name: "名称", username: "用户名", userId: "用户ID", emailOptional: "电子邮件 (可选)", notSet: "未设置", wallets: "钱包", walletsCount: "{count} 个已保存钱包", tryAgain: "重试", errorFetchSummary: "获取摘要数据错误", errorFetchCrypto: "获取币种列表错误", noResults: "未找到任何币种。", emptyWatchlist: "您的关注列表为空。", rank: "排名", editEmail: "编辑邮件", enterEmail: "输入您的电子邮件", save: "保存", invalidEmail: "无效的电子邮件地址。", editWallets: "钱包地址", noWallets: "尚未添加钱包地址。", addNewWallet: "添加新钱包", editWallet: "编辑钱包", addWallet: "添加钱包", selectCoin: "选择币种", walletAddress: "钱包地址...", back: "返回", confirmDelete: "确定删除 {symbol} 钱包吗？", cryptoAmount: "币种数量", usdEquivalent: "美元等值", irtEquivalent: "Toman等值", coinDetails: "币种详情", price: "价格", change24h: "24小时变化", high24h: "24小时最高", low24h: "24小时最低", volume24h: "24小时交易量", chartUnavailable: "图表不可用", shop: "商店", wallet: "钱包", usingCachedPrice: "使用缓存价格", comingSoon: "即将推出!", comingSoonMessage: "此页面 ({pageName}) 正在开发中，即将推出。",
        },
    };
    
    let activeLanguage = localStorage.getItem('language_v10') || 'fa';
    const isRTL = ['fa', 'ar'].includes(activeLanguage);
    
    // تابع ترجمه
    const i18n = (key, params = {}) => {
        let translation = translations[activeLanguage]?.[key] || translations.en[key] || key;
        for (const pKey in params) { translation = translation.replace(`{${pKey}}`, params[pKey]); }
        return translation;
    };
    
    // نام فارسی برای نمایش و جستجو
    const PERSIAN_NAMES = { 'bitcoin': 'بیت‌کوین', 'ethereum': 'اتریوم', 'tether': 'تتر', 'binancecoin': 'بایننس کوین', 'solana': 'سولانا', 'ripple': 'ریپل', 'dogecoin': 'دوج‌کوین', 'toncoin': 'تون‌کوین', 'cardano': 'کاردانو', 'shiba-inu': 'شیبا اینو', 'tron': 'ترون', 'notcoin': 'نات‌کوین', 'pepe': 'پپه', 'floki': 'فلوکی' };
    
    // آیدی ارزهای خاص
    const EXTRA_COIN_IDS = 'toncoin,notcoin,dogecoin,shiba-inu,pepe,floki'; 

    const state = {
        allCoins: [], dollarPrice: 0, summaryData: null,
        watchlist: JSON.parse(localStorage.getItem('watchlist_v10')) || [],
        activeTab: localStorage.getItem('activeTab_v10') || 'all',
        currentSort: localStorage.getItem('currentSort_v10') || 'market_cap_desc',
        searchQuery: '',
        userEmail: localStorage.getItem('userEmail_v10') || '',
        wallets: JSON.parse(localStorage.getItem('wallets_v10')) || {},
        theme: localStorage.getItem('theme_v10') || 'dark',
        language: activeLanguage, 
        isLoading: { summary: true, crypto: true },
        errors: { summary: null, crypto: null },
        updateInterval: null,
        maxPages: 4, 
        loadedPages: 1, 
    };
    
    const SUMMARY_API_URL = "https://api.tgju.org/v1/market/indicator/summary";

    // توابع کمکی
    const formatNum = (n, dec = 2) => new Intl.NumberFormat('en-US', { minimumFractionDigits: dec, maximumFractionDigits: dec, useGrouping: true }).format(n);
    const formatPercent = (p) => `${parseFloat(p||0) >= 0 ? '+' : ''}${formatNum(p||0)}%`;
    const getChangeClass = (p) => (parseFloat(p||0) >= 0 ? 'text-[var(--positive)]' : 'text-[var(--negative)]');
    const fetchWithTimeout = (url, timeout = 10000) => {
        const controller = new AbortController();
        const signal = controller.signal;
        const promise = fetch(url, { signal });
        const timeoutPromise = new Promise((_, reject) => setTimeout(() => {
            controller.abort();
            reject(new Error('Request timed out'));
        }, timeout));
        return Promise.race([promise, timeoutPromise]);
    };

    function render() {
        renderSummary();
        renderCryptoList();
        translateUI();
    }
    
    // تابع بارگذاری داده‌های خلاصه (قیمت دلار)
    async function loadSummaryData() {
        state.isLoading.summary = true; state.errors.summary = null; render();
        const lastDollarPrice = parseFloat(localStorage.getItem('lastDollarPrice_v10')) || 0; 
        try {
            const response = await fetchWithTimeout(SUMMARY_API_URL);
            if (!response.ok) throw new Error(`Server Error (${response.status})`);
            const result = await response.json();
            if (!result.data || !result.data.price_dollar_rl) throw new Error('Invalid API response');
            // قیمت دلار از ریال به تومان تبدیل می‌شود (تقسیم بر ۱۰)
            const newDollarPrice = parseFloat(result.data.price_dollar_rl.p) / 10;
            state.dollarPrice = newDollarPrice;
            localStorage.setItem('lastDollarPrice_v10', newDollarPrice); 
            state.summaryData = { dollar: result.data.price_dollar_rl, emami: result.data['sekeh-emami'], gold: result.data['tala-18'] };
        } catch (error) { 
            console.error("Summary API Error:", error); 
            if (lastDollarPrice > 0) {
                state.dollarPrice = lastDollarPrice;
                state.errors.summary = `❗️ ${i18n('errorFetchSummary')} - ${i18n('usingCachedPrice')}`; 
            } else {
                state.errors.summary = i18n('errorFetchSummary');
            }
        } finally { 
            state.isLoading.summary = false; 
            render(); 
        }
    }
    
    function renderSummary() {
        const container = document.getElementById('summary-container');
        if (state.isLoading.summary) {
            container.innerHTML = `<div class="h-16 skeleton"></div><div class="h-16 skeleton"></div>`;
            return;
        }
        if (state.errors.summary) {
            container.innerHTML = `<div class="col-span-full bg-red-500/20 text-red-400 rounded-lg p-3 text-center text-sm">${state.errors.summary}</div>`;
            return;
        }

        const dollarData = state.summaryData.dollar;
        const goldData = state.summaryData.gold;

        const renderCard = (titleKey, price, change, symbol) => {
            const changeClass = getChangeClass(change);
            const formattedPrice = formatNum(price / 10, 0); // تبدیل ریال به تومان
            return `
                <div class="bg-[var(--secondary-bg)] p-3 rounded-xl shadow-md flex justify-between items-center transition duration-200">
                    <div>
                        <div class="text-[var(--hint)] text-xs" data-i18n-key="${titleKey}"></div>
                        <div class="font-bold text-lg">${formattedPrice} ${symbol}</div>
                    </div>
                    <div class="text-xs font-mono ${changeClass}">${formatPercent(change)}</div>
                </div>
            `;
        };

        container.innerHTML = `
            ${renderCard('dollar', dollarData.p, dollarData.d, 'T')}
            ${renderCard('gold', goldData.p, goldData.d, 'T')}
        `;
        translateUI();
    }
    
    // تابع بارگذاری داده‌های کریپتو
    async function loadCryptoData(isUpdate = false) {
        if (!isUpdate && state.loadedPages === 1) { state.isLoading.crypto = true; state.errors.crypto = null; }
        
        const baseUrl = "https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=250&sparkline=true&price_change_percentage=24h";
        const extraCoinsUrl = `https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=${EXTRA_COIN_IDS}&sparkline=true&price_change_percentage=24h`;
        
        try {
            const fetchPromises = [];
            fetchPromises.push(fetchWithTimeout(`${baseUrl}&page=${state.loadedPages}`));

            if (state.loadedPages === 1) {
                 fetchPromises.push(fetchWithTimeout(extraCoinsUrl));
            }

            const responses = await Promise.all(fetchPromises);
            
            const marketCapData = await responses[0].json();
            const extraCoinsData = (state.loadedPages === 1 && responses.length > 1) ? await responses[1].json() : [];

            const marketCapIds = new Set(marketCapData.map(c => c.id));
            const uniqueExtraCoins = extraCoinsData.filter(c => !marketCapIds.has(c.id));
            
            if (state.loadedPages === 1) {
                state.allCoins = uniqueExtraCoins.concat(marketCapData);
            } else {
                state.allCoins = state.allCoins.concat(marketCapData);
            }
            
            state.errors.crypto = null;
            
        } catch (error) { 
            console.error("Crypto API Error:", error); 
            if (!isUpdate && state.allCoins.length === 0) {
                state.errors.crypto = i18n('errorFetchCrypto');
            }
        } finally { 
            if (!isUpdate) state.isLoading.crypto = false; 
            render(); 
        }
    }
    
    function renderCryptoList() {
        const container = document.getElementById('coin-list-container');
        const listEl = document.getElementById('coin-list');
        const messageEl = document.getElementById('message-container');
        
        if (state.isLoading.crypto) { 
            container.style.display = 'block';
            listEl.innerHTML = `<div class="p-4 space-y-2">${Array(10).fill('').map(() => `<div class="h-[68px] skeleton"></div>`).join('')}</div>`;
            messageEl.classList.add('hidden');
            return;
        }
        if (state.errors.crypto) { 
            container.style.display = 'none';
            messageEl.classList.remove('hidden');
            messageEl.innerHTML = `<div class="bg-red-500/20 text-red-400 rounded-lg p-4 text-center">
                <p>${state.errors.crypto}</p>
                <button id="retry-crypto" class="mt-2 bg-[var(--button)] px-3 py-1 rounded-md text-sm">${i18n('tryAgain')}</button>
            </div>`;
            document.getElementById('retry-crypto').onclick = () => { state.loadedPages = 1; loadCryptoData(); };
            return;
        }
        
        container.style.display = 'block';
        let coinsToRender = (state.activeTab === 'all') ? state.allCoins : state.allCoins.filter(c => state.watchlist.includes(c.id));
        if (state.currentSort === 'gainers') coinsToRender.sort((a, b) => (b.price_change_percentage_24h || -999) - (a.price_change_percentage_24h || -999));
        else if (state.currentSort === 'losers') coinsToRender.sort((a, b) => (a.price_change_percentage_24h || 999) - (b.price_change_percentage_24h || 999));
        else coinsToRender.sort((a, b) => (a.market_cap_rank || 9999) - (b.market_cap_rank || 9999));
        
        const query = state.searchQuery.toLowerCase().trim();
        if (query) {
            coinsToRender = coinsToRender.filter(c => c.name.toLowerCase().includes(query) || c.symbol.toLowerCase().includes(query) || (PERSIAN_NAMES[c.id] && PERSIAN_NAMES[c.id].toLowerCase().includes(query)));
        }
        
        messageEl.classList.add('hidden');
        if (coinsToRender.length === 0) {
            messageEl.textContent = i18n(state.activeTab === 'watchlist' ? 'emptyWatchlist' : 'noResults');
            messageEl.classList.remove('hidden');
        }
        
        // منطق Virtual Scrolling برای عملکرد بهتر در موبایل
        const ROW_HEIGHT = 68;
        listEl.innerHTML = '';
        listEl.style.height = `${coinsToRender.length * ROW_HEIGHT}px`;
        const scrollTop = container.scrollTop;
        const startIndex = Math.floor(scrollTop / ROW_HEIGHT);
        const endIndex = Math.min(startIndex + Math.ceil(container.clientHeight / ROW_HEIGHT) + 2, coinsToRender.length);
        const fragment = document.createDocumentFragment();
        for (let i = startIndex; i < endIndex; i++) {
            const coin = coinsToRender[i];
            if (!coin) continue;
            const row = document.createElement('div');
            row.className = 'coin-row absolute w-full';
            if (isRTL) row.style.left = '0';
            else row.style.right = '0';
            row.style.top = `${i * ROW_HEIGHT}px`;
            row.style.height = `${ROW_HEIGHT}px`;
            row.dataset.coinId = coin.id;
            row.innerHTML = renderCoinRow(coin);
            fragment.appendChild(row);
        }
        listEl.appendChild(fragment);
    }
    
    function renderCoinRow(coin) {
        const isWatched = state.watchlist.includes(coin.id);
        const tomanPriceNum = state.dollarPrice > 0 ? coin.current_price * state.dollarPrice : 0;
        const tomanPrice = tomanPriceNum > 0 ? formatNum(tomanPriceNum, 0) : '...';

        let nativeName = '';
        if (state.language === 'fa') {
            nativeName = PERSIAN_NAMES[coin.id.toLowerCase()] ? ` | ${PERSIAN_NAMES[coin.id.toLowerCase()]}` : '';
        } 

        return `
            <div class="flex items-center p-3 h-full cursor-pointer transition duration-150 hover:bg-[var(--header-border)]">
                <div class="flex-1 flex items-center space-x-3 ${isRTL ? 'space-x-reverse' : ''} min-w-0">
                    <img src="${coin.image}" alt="${coin.name}" class="w-9 h-9 rounded-full">
                    <div class="truncate">
                        <div class="font-bold text-sm truncate">${coin.symbol.toUpperCase()}${nativeName}</div>
                        <div class="text-xs text-[var(--hint)]">${i18n('rank')} #${coin.market_cap_rank || '?'}</div>
                    </div>
                </div>
                <!-- نمودار Sparkline -->
                <div class="w-16 h-8 flex items-center justify-center">${generateSparkline(coin.sparkline_in_7d.price, coin.price_change_percentage_24h)}</div>
                <div class="flex-1 text-right font-mono text-xs pr-2">
                    <div class="font-bold text-sm" data-price-usd>$${formatNum(coin.current_price, coin.current_price < 0.01 ? 5 : 2)}</div>
                    <div class="text-[var(--hint)]" data-price-irt>${tomanPrice} T</div>
                </div>
                <div class="w-20 text-center font-bold text-sm ${getChangeClass(coin.price_change_percentage_24h)}">${formatPercent(coin.price_change_percentage_24h)}</div>
                <div class="w-10 text-center text-2xl star-icon cursor-pointer text-[var(--hint)] hover:text-yellow-400" data-watched="${isWatched}">${isWatched ? '<span style="color: #FFC107;">★</span>' : '☆'}</div>
            </div>`;
    }
    
    function generateSparkline(data, change) {
        if (!data || data.length < 2) return '';
        const w = 64, h = 32;
        const max = Math.max(...data), min = Math.min(...data);
        const range = max - min;
        
        const points = data.map((price, i) => {
            const x = (i / (data.length - 1)) * w;
            const y = h - ((price - min) / range) * h;
            return `${x},${y}`;
        }).join(' ');

        const color = parseFloat(change) >= 0 ? 'var(--positive)' : 'var(--negative)';
        const lastPointY = h - ((data[data.length - 1] - min) / range) * h;

        return `
            <svg viewBox="0 0 ${w} ${h}" width="${w}" height="${h}">
                <polyline class="sparkline-path" points="${points}" stroke="${color}" />
                <circle cx="${w}" cy="${lastPointY}" r="1.5" fill="${color}" />
            </svg>
        `;
    }

    function handleStarClick(starEl, coinId) {
        if (state.watchlist.includes(coinId)) {
            state.watchlist = state.watchlist.filter(id => id !== coinId);
        } else {
            state.watchlist.push(coinId);
        }
        localStorage.setItem('watchlist_v10', JSON.stringify(state.watchlist));
        render(); // رندر مجدد برای اعمال تغییر ستاره و فیلتر (اگر در حالت Watchlist است)
    }

    // تابع تنظیمات UI و مدیریت کلیک‌ها
    function setupUI() {
        // مدیریت کلیک‌های نوار پیمایش
        document.querySelectorAll('.nav-button').forEach(btn => {
            btn.onclick = (e) => {
                const pageId = e.currentTarget.dataset.page;
                const pageKey = e.currentTarget.dataset.pageKey;
                
                // تغییر کلاس‌های Active
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
                e.currentTarget.classList.add('active');
                
                // رندر محتوای صفحات بر اساس pageId
                if (pageId === 'profile-page') renderProfilePage();
                else if (pageId === 'coming-soon-page') renderComingSoonPage(pageKey);
                // markets-page (صفحه اصلی) نیازی به رندر مجدد ندارد
            };
        });

        // مدیریت تب‌ها
        document.querySelectorAll('.tab-button').forEach(btn => btn.addEventListener('click', e => {
            document.querySelector('.tab-button.active').classList.remove('active');
            e.currentTarget.classList.add('active');
            state.activeTab = e.currentTarget.id.replace('tab-', '');
            localStorage.setItem('activeTab_v10', state.activeTab);
            render();
        }));
        
        // مدیریت سورت
        document.querySelectorAll('.sort-button').forEach(btn => btn.addEventListener('click', e => {
            document.querySelector('.sort-button.active').classList.remove('active');
            e.currentTarget.classList.add('active');
            state.currentSort = e.currentTarget.dataset.sort;
            localStorage.setItem('currentSort_v10', state.currentSort);
            render();
        }));
        
        // مدیریت جستجو
        let searchTimeout;
        document.getElementById('search-input').addEventListener('input', e => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => { state.searchQuery = e.target.value; render(); }, 300);
        });
        
        // مدیریت کلیک روی سطرها (جزئیات و ستاره)
        document.getElementById('coin-list').addEventListener('click', e => {
            const star = e.target.closest('.star-icon');
            const row = e.target.closest('.coin-row');
            if (row) {
                if (star) { e.stopPropagation(); handleStarClick(star, row.dataset.coinId); } 
                else { openDetailsModal(state.allCoins.find(c => c.id === row.dataset.coinId)); }
            }
        });
    }
    
    // تابع پیاده‌سازی Infinite Scroll
    function setupInfiniteScroll() {
        const container = document.getElementById('coin-list-container');
        container.addEventListener('scroll', () => {
            renderCryptoList(); // رندر کردن آیتم‌های قابل مشاهده
            // چک کردن رسیدن به انتهای لیست (برای لود صفحات بعدی)
            if (container.scrollHeight - container.scrollTop <= container.clientHeight * 1.2) {
                if (!state.isLoading.crypto && state.loadedPages < state.maxPages && state.activeTab === 'all' && !state.searchQuery) {
                    state.loadedPages++;
                    loadCryptoData(true);
                }
            }
        });
    }

    // 👈 تابع جدید: نمایش صفحه "به زودی" برای دکمه‌های غیرفعال
    function renderComingSoonPage(pageKey) {
        const page = document.getElementById('coming-soon-page');
        const pageName = i18n(pageKey) || pageKey;
        page.innerHTML = `
            <div class="p-8 text-center flex flex-col items-center justify-center h-full min-h-[50vh]">
                <h1 class="text-4xl font-extrabold mb-4 text-[var(--button)]" data-i18n-key="comingSoon"></h1>
                <p class="text-[var(--hint)] text-lg">${i18n('comingSoonMessage', { pageName })}</p>
                <div class="mt-8 text-6xl">🚧</div>
            </div>`;
        translateUI();
    }
    
    // تابع تغییر زبان
    function setLanguage(lang) {
        state.language = lang; localStorage.setItem('language_v10', lang);
        const newIsRTL = ['fa', 'ar'].includes(lang);
        document.documentElement.lang = lang; 
        document.documentElement.dir = newIsRTL ? 'rtl' : 'ltr';
        // به‌روزرسانی متغیر گلوبال
        isRTL = newIsRTL;

        // بارگذاری مجدد صفحات فعال
        const activeNavButton = document.querySelector('.nav-button.active');
        const pageId = activeNavButton?.dataset.page;
        const pageKey = activeNavButton?.dataset.pageKey;

        if (pageId === 'profile-page') renderProfilePage();
        else if (pageId === 'coming-soon-page') renderComingSoonPage(pageKey);
        else render();
        
        // اطمینان از اعمال تغییرات در جهت‌دهی
        document.querySelectorAll('.flex.space-x-reverse').forEach(el => {
            el.classList.remove('space-x-reverse');
            if (newIsRTL) el.classList.add('space-x-reverse');
        });
    }
    
    // تابع اعمال ترجمه در UI
    function translateUI() {
        document.querySelectorAll('[data-i18n-key]').forEach(el => {
            const key = el.dataset.i18nKey;
            el.textContent = i18n(key);
        });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
            const key = el.dataset.i18nPlaceholder;
            el.placeholder = i18n(key);
        });
        document.querySelectorAll('[data-i18n-key-count]').forEach(el => {
            const key = el.dataset.i18nKeyCount;
            const count = el.dataset.count;
            el.textContent = i18n(key, { count });
        });
    }
    
    // تابع تغییر تم
    function setTheme(theme) {
        state.theme = theme; localStorage.setItem('theme_v10', theme);
        document.body.classList.toggle('light-theme', theme === 'light');
        tg.isDark = (theme === 'dark');
        // به روزرسانی رنگ دکمه های اصلی تلگرام
        tg.setHeaderColor(theme === 'dark' ? '#1E1E1E' : '#FFFFFF');
        tg.setBackgroundColor(theme === 'dark' ? '#121212' : '#FFFFFF');

        // رندر مجدد صفحه پروفایل برای به‌روزرسانی دکمه‌های تم
        if (document.getElementById('profile-page').classList.contains('active')) {
            renderProfilePage();
        }
        render(); // رندر مجدد لیست برای به‌روزرسانی رنگ‌های پس‌زمینه
    }
    
    // تابع نمایش توست
    function showToast(messageKey, params = {}) {
        const toastEl = document.getElementById('toast');
        toastEl.textContent = i18n(messageKey, params);
        toastEl.classList.add('show');
        setTimeout(() => toastEl.classList.remove('show'), 2000);
    }
    
    // تابع باز کردن مدال
    function openModal(contentHtml) {
        document.getElementById('modal-content').innerHTML = contentHtml;
        document.getElementById('modal-backdrop').classList.remove('hidden');
        document.getElementById('modal').classList.add('open');
        translateUI();
    }
    
    // تابع بستن مدال
    function closeModal() {
        document.getElementById('modal-backdrop').classList.add('hidden');
        document.getElementById('modal').classList.remove('open');
        // پاک کردن محتوا برای جلوگیری از مشکلات حافظه و رندر
        setTimeout(() => document.getElementById('modal-content').innerHTML = '', 300);
    }

    function openDetailsModal(coin) {
        if (!coin) return;
        
        const price = formatNum(coin.current_price, coin.current_price < 0.01 ? 5 : 2);
        const priceToman = formatNum(coin.current_price * state.dollarPrice, 0);
        const changeClass = getChangeClass(coin.price_change_percentage_24h);
        const change = formatPercent(coin.price_change_percentage_24h);
        
        const detailsHtml = `
            <div class="flex items-center space-x-3 ${isRTL ? 'space-x-reverse' : ''} mb-6">
                <img src="${coin.image}" alt="${coin.name}" class="w-12 h-12 rounded-full">
                <div>
                    <h2 class="text-xl font-bold">${coin.name} (${coin.symbol.toUpperCase()})</h2>
                    <p class="text-[var(--hint)] text-sm">${i18n('rank')} #${coin.market_cap_rank || '?'}</p>
                </div>
            </div>
            
            <div class="flex justify-between items-center mb-6">
                <div>
                    <p class="text-3xl font-bold">$${price}</p>
                    <p class="text-xl font-bold text-[var(--hint)]">${priceToman} T</p>
                </div>
                <div class="text-right">
                    <p class="text-lg font-bold ${changeClass}">${change} (24h)</p>
                </div>
            </div>
            
            <!-- نمودار (فعلا پیام "موجود نیست" نمایش داده می شود) -->
            <div class="h-40 flex items-center justify-center bg-[var(--bg)] rounded-xl mb-6">
                <p class="text-[var(--hint)]">${i18n('chartUnavailable')}</p>
            </div>

            <div class="space-y-3">
                <h3 class="font-bold text-lg mb-3" data-i18n-key="coinDetails"></h3>
                ${renderDetailRow('high24h', `$${formatNum(coin.high_24h, coin.high_24h < 0.01 ? 5 : 2)}`)}
                ${renderDetailRow('low24h', `$${formatNum(coin.low_24h, coin.low_24h < 0.01 ? 5 : 2)}`)}
                ${renderDetailRow('volume24h', `$${formatNum(coin.total_volume, 0)}`)}
                ${renderDetailRow('marketCap', `$${formatNum(coin.market_cap, 0)}`)}
            </div>
            
            <button onclick="closeModal()" class="w-full bg-[var(--button)] text-white p-3 rounded-xl mt-6 font-bold" data-i18n-key="back"></button>
        `;
        openModal(detailsHtml);
    }

    function renderDetailRow(key, value) {
        return `
            <div class="flex justify-between items-center pb-2 border-b border-[var(--header-border)]">
                <span class="text-[var(--hint)] text-sm" data-i18n-key="${key}"></span>
                <span class="font-bold text-sm">${value}</span>
            </div>
        `;
    }
    
    // پیاده‌سازی ساده برای رندر صفحه پروفایل (برای فعال کردن دکمه‌های زبان و تم)
    function renderProfilePage() {
        const user = tg.initDataUnsafe.user || { first_name: 'کاربر', username: 'تعیین نشده', id: '0' };
        const profilePage = document.getElementById('profile-page');
        const walletCount = Object.keys(state.wallets).length;
        
        profilePage.innerHTML = `
            <div class="p-4">
                 <div class="flex items-center space-x-4 ${isRTL ? 'space-x-reverse' : ''} mb-6">
                    <img src="${user.photo_url || ''}" onerror="this.style.display='none'" class="w-20 h-20 rounded-full bg-[var(--secondary-bg)]">
                    <div>
                        <h1 class="text-xl font-bold">${user.first_name || ''} ${user.last_name || ''}</h1>
                        <p class="text-[var(--hint)] text-sm">@${user.username || i18n('notSet')}</p>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="bg-[var(--secondary-bg)] p-4 rounded-xl">
                        <h2 data-i18n-key="settings" class="font-bold mb-3 text-lg"></h2>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center"><span class="text-[var(--hint)]" data-i18n-key="theme"></span><div class="flex bg-[var(--bg)] rounded-lg p-1"><button class="theme-btn px-3 py-1 rounded-md text-sm ${state.theme === 'dark' ? 'bg-[var(--button)] text-white' : ''}" data-theme="dark" data-i18n-key="dark"></button><button class="theme-btn px-3 py-1 rounded-md text-sm ${state.theme === 'light' ? 'bg-[var(--button)] text-white' : ''}" data-theme="light" data-i18n-key="light"></button></div></div>
                            <div class="flex justify-between items-center"><span class="text-[var(--hint)]" data-i18n-key="language"></span>
                                <select id="lang-select" class="bg-[var(--bg)] p-1 rounded-md text-sm text-[var(--text)]">
                                    <option value="fa" ${state.language === 'fa' ? 'selected' : ''}>فارسی</option>
                                    <option value="en" ${state.language === 'en' ? 'selected' : ''}>English</option>
                                    <option value="ar" ${state.language === 'ar' ? 'selected' : ''}>العربية</option>
                                    <option value="zh" ${state.language === 'zh' ? 'selected' : ''}>中文</option>
                                </select>
                            </div>
                            <!-- دکمه های ایمیل و کیف پول در این نسخه فقط نمایش داده می شوند و منطق ویرایش فعال نیستند -->
                            <div class="flex justify-between items-center py-1"><span class="text-[var(--hint)]" data-i18n-key="emailOptional"></span><span class="font-mono text-left truncate text-sm">${state.userEmail || i18n('notSet')}</span></div>
                            <div class="flex justify-between items-center py-1"><span class="text-[var(--hint)]" data-i18n-key="wallets"></span><span class="text-sm">${i18n('walletsCount', { count: walletCount })}</span></div>
                        </div>
                    </div>
                </div>
            </div>`;
        document.querySelectorAll('.theme-btn').forEach(btn => btn.onclick = (e) => setTheme(e.currentTarget.dataset.theme));
        document.getElementById('lang-select').onchange = (e) => setLanguage(e.target.value);
        translateUI();
    }


    document.addEventListener('DOMContentLoaded', () => {
        try { 
            tg.ready(); 
            tg.expand();
            // دکمه بازگشت را در تلگرام غیرفعال می کنیم چون Single-Page App است
            tg.BackButton.hide();
        } catch (e) { 
            console.warn("TG script not loaded. Running standalone."); 
        }
        
        setTheme(state.theme);
        setLanguage(state.language); // تنظیم زبان اولیه و جهت‌دهی
        setupUI();
        setupInfiniteScroll(); 
        
        // بارگذاری داده‌ها
        loadSummaryData();
        loadCryptoData();
        
        // تنظیم به‌روزرسانی خودکار
        if (state.updateInterval) clearInterval(state.updateInterval);
        state.updateInterval = setInterval(() => loadCryptoData(true), 30000);
    });
    //============== END OF FULL JAVASCRIPT CODE ==============
    </script>
</body>
</html>

