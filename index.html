<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no, user-scalable=no">
    <title>Shelby Bet</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --tg-bg: #121212; --tg-text: #EAECEF; --tg-hint: #707A8A;
            --tg-button: #2E81FF; --tg-secondary-bg: #1E1E1E; --tg-header-border: #2A2A2A;
            --positive: #00C853; --negative: #FF3B30;
        }
        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--tg-bg); color: var(--tg-text); margin: 0; padding: 0; }
        .header { background-color: var(--tg-bg); position: sticky; top: 0; z-index: 20; padding: 1rem; border-bottom: 1px solid var(--tg-header-border); }
        #search-input { background-color: var(--tg-secondary-bg); border: 1px solid var(--tg-header-border); color: var(--tg-text); }
        .tab-button.active { background-color: var(--tg-button); color: white; border-color: var(--tg-button); }
        .sort-button.active { color: var(--tg-button); }
        .coin-row { border-bottom: 1px solid var(--tg-header-border); }
        .price-up { animation: price-up-flash 0.7s; } .price-down { animation: price-down-flash 0.7s; }
        @keyframes price-up-flash { 0% { background-color: rgba(0, 200, 83, 0.2); } 100% { background-color: transparent; } }
        @keyframes price-down-flash { 0% { background-color: rgba(255, 59, 48, 0.2); } 100% { background-color: transparent; } }
        .loader { border: 4px solid var(--tg-secondary-bg); border-top: 4px solid var(--tg-button); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .skeleton { background-color: var(--tg-secondary-bg); border-radius: 8px; animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="antialiased">
    <div class="header">
        <h1 class="text-xl font-bold text-center mb-4">Shelby bet</h1>
        <input type="text" id="search-input" placeholder="جستجوی نام ارز..." class="w-full p-2.5 rounded-lg text-sm mb-3">
        <div class="flex items-center justify-between">
             <div class="flex bg-[var(--tg-secondary-bg)] rounded-lg p-1">
                <button id="tab-all" class="tab-button active px-4 py-1.5 rounded-md text-sm font-semibold">همه</button>
                <button id="tab-watchlist" class="tab-button px-4 py-1.5 rounded-md text-sm font-semibold">علاقه‌مندی‌ها</button>
            </div>
             <div id="sort-controls" class="flex items-center space-x-2 space-x-reverse">
                <button class="sort-button active text-xs" data-sort="market_cap_desc">ارزش بازار</button>
                <button class="sort-button text-xs" data-sort="gainers">بیشترین رشد</button>
                <button class="sort-button text-xs" data-sort="losers">بیشترین ریزش</button>
            </div>
        </div>
    </div>

    <div id="summary-container" class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    <div id="coin-list-container" class="h-[calc(100vh-150px)] overflow-y-auto">
        <div id="coin-list" class="relative"></div>
    </div>
    <div id="message-container" class="hidden text-center p-10 text-[var(--tg-hint)]"></div>

    <script>
        const tg = window.Telegram.WebApp;

        // --- APIs & Config ---
        const CRYPTO_API_URL = "https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=100&page=1&sparkline=false&price_change_percentage=24h";
        // FIX: Using a new reliable proxy and API for Gold/Dollar
        const SUMMARY_API_URL = "https://api.allorigins.win/raw?url=https://haji-api.ir/arz/";
        const PERSIAN_NAMES = { 'bitcoin': 'بیت‌کوین', 'ethereum': 'اتریوم', 'tether': 'تتر', 'binancecoin': 'بایننس کوین', 'solana': 'سولانا', 'ripple': 'ریپل', 'dogecoin': 'دوج‌کوین', 'toncoin': 'تون‌کوین', 'cardano': 'کاردانو', 'shiba-inu': 'شیبا اینو', 'tron': 'ترون' };

        // --- DOM Elements ---
        const summaryContainer = document.getElementById('summary-container');
        const coinListContainer = document.getElementById('coin-list-container');
        const coinList = document.getElementById('coin-list');
        const messageContainer = document.getElementById('message-container');

        // --- State ---
        let state = {
            allCoins: [],
            dollarPrice: 0,
            watchlist: JSON.parse(localStorage.getItem('watchlist_v3')) || [],
            activeTab: localStorage.getItem('activeTab_v3') || 'all',
            currentSort: localStorage.getItem('currentSort_v3') || 'market_cap_desc',
            searchQuery: '',
            updateInterval: null
        };
        
        const formatNum = (n, dec = 2) => new Intl.NumberFormat('en-US', { minimumFractionDigits: dec, maximumFractionDigits: dec }).format(n);
        const formatPercent = (p) => `${parseFloat(p||0) >= 0 ? '+' : ''}${formatNum(p||0)}%`;
        const getChangeClass = (p) => (parseFloat(p||0) >= 0 ? 'text-[var(--positive)]' : 'text-[var(--negative)]');

        function render() {
            let coinsToRender = (state.activeTab === 'all') ? state.allCoins : state.allCoins.filter(c => state.watchlist.includes(c.id));
            
            if (state.currentSort === 'gainers') coinsToRender.sort((a, b) => (b.price_change_percentage_24h || -999) - (a.price_change_percentage_24h || -999));
            else if (state.currentSort === 'losers') coinsToRender.sort((a, b) => (a.price_change_percentage_24h || 999) - (b.price_change_percentage_24h || 999));
            else coinsToRender.sort((a, b) => (a.market_cap_rank || 9999) - (b.market_cap_rank || 9999));

            const query = state.searchQuery.toLowerCase().trim();
            if (query) {
                coinsToRender = coinsToRender.filter(c => 
                    c.name.toLowerCase().includes(query) || c.symbol.toLowerCase().includes(query) || (PERSIAN_NAMES[c.id] && PERSIAN_NAMES[c.id].includes(query))
                );
            }
            
            messageContainer.classList.add('hidden');
            if (coinsToRender.length === 0 && state.allCoins.length > 0) {
                messageContainer.textContent = state.activeTab === 'watchlist' ? 'هنوز ارزی به علاقه‌مندی‌ها اضافه نکرده‌اید.' : 'ارزی با این مشخصات یافت نشد.';
                messageContainer.classList.remove('hidden');
            }

            const ROW_HEIGHT = 76;
            coinList.innerHTML = '';
            coinList.style.height = `${coinsToRender.length * ROW_HEIGHT}px`;

            const scrollTop = coinListContainer.scrollTop;
            const startIndex = Math.floor(scrollTop / ROW_HEIGHT);
            const endIndex = Math.min(startIndex + Math.ceil(coinListContainer.clientHeight / ROW_HEIGHT) + 2, coinsToRender.length);

            const fragment = document.createDocumentFragment();
            for (let i = startIndex; i < endIndex; i++) {
                const coin = coinsToRender[i];
                const row = document.createElement('div');
                row.className = 'coin-row absolute w-full';
                row.style.top = `${i * ROW_HEIGHT}px`;
                row.style.height = `${ROW_HEIGHT}px`;
                row.dataset.coinId = coin.id;
                row.innerHTML = renderCoinRow(coin);
                fragment.appendChild(row);
            }
            coinList.appendChild(fragment);
        }

        function renderCoinRow(coin) {
            const isWatched = state.watchlist.includes(coin.id);
            // FIX: Correctly parse Toman price from string
            const tomanPriceNum = state.dollarPrice > 0 ? coin.current_price * state.dollarPrice : 0;
            const tomanPrice = tomanPriceNum > 0 ? formatNum(tomanPriceNum, 0) : '...';
            
            return `
                <div class="flex items-center p-4 h-full">
                    <div class="flex-1 flex items-center space-x-3 space-x-reverse min-w-0">
                        <img src="${coin.image}" alt="${coin.name}" class="w-10 h-10 rounded-full">
                        <div class="truncate">
                            <div class="font-bold text-base truncate">${coin.symbol.toUpperCase()} | ${PERSIAN_NAMES[coin.id.toLowerCase()] || coin.name}</div>
                            <div class="text-xs text-[var(--tg-hint)]">رتبه #${coin.market_cap_rank}</div>
                        </div>
                    </div>
                    <div class="flex-1 text-right font-mono text-sm">
                        <div class="font-bold text-base" data-price-usd>$${formatNum(coin.current_price, coin.current_price < 0.01 ? 5 : 2)}</div>
                        <div class="text-xs text-[var(--tg-hint)]" data-price-irt>${tomanPrice} تومان</div>
                    </div>
                    <div class="w-20 text-center font-bold ${getChangeClass(coin.price_change_percentage_24h)}" data-change>${formatPercent(coin.price_change_percentage_24h)}</div>
                    <div class="w-10 text-center text-2xl star-icon cursor-pointer" data-watched="${isWatched}">${isWatched ? '★' : '☆'}</div>
                </div>`;
        }
        
        async function initialLoad() {
            renderSkeleton();
            const [cryptoRes, summaryRes] = await Promise.allSettled([ fetch(CRYPTO_API_URL), fetch(SUMMARY_API_URL) ]);

            if (summaryRes.status === 'fulfilled') {
                const data = await summaryRes.value.json();
                // FIX: Correctly parse string price from Haji API
                const dollarStr = data.data.freeCurrency.data.find(c => c.id === 200000).close.replace(/,/g, '');
                state.dollarPrice = parseFloat(dollarStr) / 10; // Convert Rial to Toman
                renderSummary(data.data);
            } else { summaryContainer.innerHTML = `<div class="bg-[var(--tg-secondary-bg)] rounded-lg p-4 text-center text-[var(--negative)]">خطا در دریافت قیمت طلا و سکه</div>`; }
            
            if (cryptoRes.status === 'fulfilled') {
                state.allCoins = await cryptoRes.value.json();
            } else { 
                document.getElementById('coin-list-container').innerHTML = `<div class="text-center p-10 text-[var(--negative)]">خطا در دریافت لیست ارزها</div>`;
            }
            
            render();
            if (state.updateInterval) clearInterval(state.updateInterval);
            state.updateInterval = setInterval(liveUpdate, 20000);
        }
        
        async function liveUpdate() {
            try {
                const res = await fetch(CRYPTO_API_URL);
                state.allCoins = await res.json();
                render();
            } catch (e) { console.error("Live update failed", e); }
        }

        function setupUI() {
            document.querySelector(`#tab-${state.activeTab}`).classList.add('active');
            document.querySelectorAll('.tab-button:not(.active)').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.sort-button').forEach(b => b.classList.remove('active'));
            document.querySelector(`.sort-button[data-sort="${state.currentSort}"]`).classList.add('active');
            
            document.querySelectorAll('.tab-button').forEach(btn => btn.addEventListener('click', e => {
                document.querySelector('.tab-button.active').classList.remove('active');
                e.currentTarget.classList.add('active');
                state.activeTab = e.currentTarget.id.replace('tab-', '');
                localStorage.setItem('activeTab_v3', state.activeTab);
                render();
            }));
            document.querySelectorAll('.sort-button').forEach(btn => btn.addEventListener('click', e => {
                document.querySelector('.sort-button.active').classList.remove('active');
                e.currentTarget.classList.add('active');
                state.currentSort = e.currentTarget.dataset.sort;
                localStorage.setItem('currentSort_v3', state.currentSort);
                render();
            }));

            let searchTimeout;
            document.getElementById('search-input').addEventListener('input', e => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    state.searchQuery = e.target.value;
                    render();
                }, 300);
            });
            
            coinListContainer.addEventListener('scroll', render);
            coinList.addEventListener('click', e => {
                const star = e.target.closest('.star-icon');
                if (star) {
                    e.stopPropagation();
                    const row = e.target.closest('.coin-row');
                    handleStarClick(star, row.dataset.coinId);
                }
            });
        }
        
        function handleStarClick(star, coinId) {
            if (state.watchlist.includes(coinId)) state.watchlist = state.watchlist.filter(id => id !== coinId);
            else state.watchlist.push(coinId);
            localStorage.setItem('watchlist_v3', JSON.stringify(state.watchlist));
            render();
        }

        function renderSummary(data) {
             summaryContainer.innerHTML = `
                <div class="bg-[var(--tg-secondary-bg)] rounded-lg p-4">
                    <h2 class="font-bold mb-2">دلار آزاد</h2>
                    <div class="flex justify-between items-center">
                        <span>${data.freeCurrency.data.find(c => c.id === 200000).persianName}</span>
                        <span class="font-mono font-bold">${formatNum(state.dollarPrice, 0)} <span class="text-xs">T</span></span>
                    </div>
                </div>
                <div class="bg-[var(--tg-secondary-bg)] rounded-lg p-4">
                     <h2 class="font-bold mb-2">سکه امامی</h2>
                    <div class="flex justify-between items-center">
                        <span>${data.coin.data.find(c => c.id === 100001).persianName}</span>
                        <span class="font-mono font-bold">${formatNum(data.coin.data.find(c => c.id === 100001).close / 10, 0)} <span class="text-xs">T</span></span>
                    </div>
                </div>
             `;
        }
        
        function renderSkeleton() {
            summaryContainer.innerHTML = Array(2).fill('').map(() => `<div class="h-24 skeleton"></div>`).join('');
            coinListContainer.innerHTML = `<div class="p-4 space-y-2">${Array(10).fill('').map(() => `<div class="h-16 skeleton"></div>`).join('')}</div>`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            tg.ready(); tg.expand();
            tg.setHeaderColor('#121212'); tg.setBackgroundColor('#121212');
            setupUI();
            initialLoad();
        });
    </script>
</body>
</html>

