<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no, user-scalable=no">
  <title>Shelby Bet - بازارهای کریپتو</title>

  <!-- Telegram Web App -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Vazirmatn', 'sans-serif'] },
          colors: {
            primary: '#1DA1F2',
            success: '#10B981',
            danger: '#EF4444',
            warning: '#F59E0B',
            info: '#3B82F6',
            gray: '#6B7280',
            light: '#F3F4F6',
            dark: '#1F2937',
          },
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'fade-in': 'fadeIn 0.3s ease-in-out',
            'slide-up': 'slideUp 0.4s ease-out',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            slideUp: {
              '0%': { transform: 'translateY(20px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            },
          },
        },
      },
    };
  </script>

  <!-- Vazirmatn Font -->
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <!-- QR Code -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <!-- PWA Manifest -->
  <link rel="manifest" href="data:application/manifest+json,{
    \"name\": \"Shelby Bet\",
    \"short_name\": \"Shelby\",
    \"start_url\": \"/\",
    \"display\": \"standalone\",
    \"background_color\": \"#ffffff\",
    \"theme_color\": \"#1DA1F2\",
    \"orientation\": \"portrait-primary\",
    \"icons\": [
      {\"src\": \"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E₿%3C/text%3E%3C/svg%3E\", \"sizes\": \"any\"}
    ]
  }">

  <style>
    :root {
      --primary: #1DA1F2;
      --success: #10B981;
      --danger: #EF4444;
      --warning: #F59E0B;
      --info: #3B82F6;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Vazirmatn', sans-serif;
      background: #f9fafb;
      color: #111;
      transition: background-color 0.3s, color 0.3s;
    }

    .dark {
      background-color: #111;
      color: #f5f5f5;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
      padding-bottom: 80px;
    }

    .skeleton {
      @apply bg-gray-200 dark:bg-gray-700 animate-pulse rounded;
    }

    .chart-container {
      position: relative;
      height: 240px;
      margin: 16px 0;
    }

    .hidden { display: none !important; }

    .copy-btn {
      @apply text-xs text-gray-500 hover:text-primary cursor-pointer transition-colors;
    }

    .stats {
      @apply text-sm text-gray-500 dark:text-gray-400 mt-1;
    }

    .haptic {
      transition: transform 0.1s ease;
    }

    .haptic:active {
      transform: scale(0.95);
    }

    .tab-btn {
      @apply flex-1 py-3 font-medium text-center transition-colors;
    }

    .tab-btn.active {
      @apply border-b-2 border-primary text-primary;
    }

    .market-tab-btn {
      @apply py-2 px-4 rounded-full text-sm font-medium transition-all;
    }

    .market-tab-btn.active {
      @apply bg-primary text-white;
    }

    .market-tab-btn:not(.active) {
      @apply bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300;
    }

    .modal {
      animation: fadeIn 0.3s ease-out;
    }

    .toast {
      animation: slideUp 0.4s ease-out;
    }

    .badge {
      @apply px-2 py-1 text-xs rounded-full font-medium;
    }

    .badge-eth { @apply bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300; }
    .badge-ton { @apply bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300; }
    .badge-tron { @apply bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300; }

    .price-up { @apply text-success; }
    .price-down { @apply text-danger; }
    .price-flat { @apply text-gray-500; }

    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #e5e7eb;
      border-top: 2px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white transition-colors">

  <div class="container">

    <!-- Header -->
    <header class="sticky top-0 z-50 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 p-4 backdrop-blur-sm bg-opacity-90">
      <div class="flex justify-between items-center">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center text-white font-bold text-lg shadow-lg">S</div>
          <div>
            <h1 class="text-lg font-bold">Shelby Bet</h1>
            <p class="text-xs text-gray-500 dark:text-gray-400">بازارهای کریپتو</p>
          </div>
        </div>
        <div class="flex gap-2">
          <button id="theme-toggle" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-800 haptic shadow-sm">
            <i data-lucide="moon" class="w-5 h-5"></i>
          </button>
          <button id="lang-toggle" class="px-3 py-1 text-sm rounded-lg bg-gray-100 dark:bg-gray-700 haptic shadow-sm">EN</button>
        </div>
      </div>
    </header>

    <!-- Tabs -->
    <div class="flex border-b border-gray-200 dark:border-gray-800 sticky top-16 z-40 bg-white dark:bg-gray-900 backdrop-blur-sm bg-opacity-90">
      <button data-tab="markets" class="tab-btn active">بازارها</button>
      <button data-tab="wallet" class="tab-btn">کیف پول</button>
      <button data-tab="profile" class="tab-btn">پروفایل</button>
    </div>
    <!-- Page: Markets -->
    <div id="page-markets" class="page">
      <!-- Search Bar -->
      <div class="p-4 sticky top-28 z-30 bg-white dark:bg-gray-900 backdrop-blur-sm bg-opacity-90 border-b border-gray-200 dark:border-gray-800">
        <div class="relative">
          <input 
            type="text" 
            id="search-input" 
            placeholder="جستجو در ارزها..." 
            class="w-full p-3 pr-10 rounded-xl border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
          >
          <button id="clear-search" class="absolute left-3 top-3 text-gray-500 dark:text-gray-400 hidden haptic">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
          <div class="absolute right-3 top-3 text-gray-400">
            <i data-lucide="search" class="w-5 h-5"></i>
          </div>
        </div>
      </div>

      <!-- Market Tabs -->
      <div class="flex px-4 gap-2 overflow-x-auto whitespace-nowrap py-3 border-b border-gray-200 dark:border-gray-800 scrollbar-hide">
        <button data-market-tab="all" class="market-tab-btn active">همه</button>
        <button data-market-tab="favorites" class="market-tab-btn">علاقه‌مندی‌ها</button>
        <button data-market-tab="gainers" class="market-tab-btn">بیشترین رشد</button>
        <button data-market-tab="losers" class="market-tab-btn">بیشترین افت</button>
        <button data-market-tab="volume" class="market-tab-btn">حجم بالا</button>
      </div>

      <!-- Sort & Refresh -->
      <div class="flex justify-between items-center px-4 py-3 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800">
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-600 dark:text-gray-400">مرتب‌سازی:</span>
          <select id="sort-select" class="p-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-sm focus:outline-none focus:ring-1 focus:ring-primary">
            <option value="market_cap_desc">ارزش بازار (نزولی)</option>
            <option value="market_cap_asc">ارزش بازار (صعودی)</option>
            <option value="price_change_24h_desc">رشد ۲۴ساعته</option>
            <option value="price_change_24h_asc">افت ۲۴ساعته</option>
            <option value="volume_24h_desc">حجم معاملات</option>
            <option value="name_asc">نام (الفبا)</option>
          </select>
        </div>
        <button id="refresh-markets" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-800 haptic">
          <i data-lucide="refresh-cw" class="w-5 h-5"></i>
        </button>
      </div>

      <!-- Markets List -->
      <div id="markets-list" class="px-4 space-y-3 py-4"></div>

      <!-- Skeleton Loading -->
      <div id="skeleton-loading" class="px-4 space-y-3 py-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm animate-pulse">
          <div class="flex justify-between items-center">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-gray-200 dark:bg-gray-700 rounded-full"></div>
              <div class="space-y-2">
                <div class="h-4 w-32 bg-gray-200 dark:bg-gray-700 rounded"></div>
                <div class="h-3 w-20 bg-gray-200 dark:bg-gray-700 rounded"></div>
              </div>
            </div>
            <div class="text-right space-y-2">
              <div class="h-5 w-24 bg-gray-200 dark:bg-gray-700 rounded"></div>
              <div class="h-4 w-16 bg-gray-200 dark:bg-gray-700 rounded"></div>
            </div>
          </div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm animate-pulse">
          <div class="flex justify-between items-center">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-gray-200 dark:bg-gray-700 rounded-full"></div>
              <div class="space-y-2">
                <div class="h-4 w-28 bg-gray-200 dark:bg-gray-700 rounded"></div>
              </div>
            </div>
            <div class="text-right space-y-2">
              <div class="h-5 w-20 bg-gray-200 dark:bg-gray-700 rounded"></div>
              <div class="h-4 w-14 bg-gray-200 dark:bg-gray-700 rounded"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Load More -->
      <div id="load-more" class="p-4 text-center hidden">
        <button class="px-6 py-2 bg-primary text-white rounded-full text-sm font-medium haptic shadow-md flex items-center gap-2 mx-auto">
          <i data-lucide="plus" class="w-4 h-4"></i>
          بارگذاری بیشتر
        </button>
      </div>

      <!-- Empty State -->
      <div id="empty-markets" class="text-center py-16 hidden">
        <i data-lucide="search" class="w-16 h-16 mx-auto text-gray-400 mb-4"></i>
        <p class="text-gray-500 dark:text-gray-400">موردی یافت نشد</p>
      </div>
    </div>

    <!-- Page: Wallet -->
    <div id="page-wallet" class="page hidden">
      <!-- Wallet Actions -->
      <div class="p-4 border-b border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900">
        <div class="flex gap-2">
          <button onclick="exportWallets()" class="flex-1 py-2 bg-gray-100 dark:bg-gray-800 rounded-xl flex items-center justify-center gap-2 text-sm font-medium haptic shadow-sm">
            <i data-lucide="download" class="w-4 h-4"></i>
            خروجی
          </button>
          <button onclick="importWallets()" class="flex-1 py-2 bg-gray-100 dark:bg-gray-800 rounded-xl flex items-center justify-center gap-2 text-sm font-medium haptic shadow-sm">
            <i data-lucide="upload" class="w-4 h-4"></i>
            ورودی
          </button>
          <button onclick="openAddWalletModal()" class="flex-1 py-2 bg-primary text-white rounded-xl flex items-center justify-center gap-2 text-sm font-medium haptic shadow-md">
            <i data-lucide="plus" class="w-4 h-4"></i>
            افزودن
          </button>
        </div>
      </div>

      <!-- Wallet List -->
      <div id="wallet-list" class="space-y-3 p-4"></div>

      <!-- Empty Wallet -->
      <div id="empty-wallet" class="text-center py-20">
        <div class="w-24 h-24 mx-auto bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-4">
          <i data-lucide="wallet" class="w-12 h-12 text-gray-400"></i>
        </div>
        <p class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">هیچ کیف پولی اضافه نشده</p>
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">برای شروع، یک کیف پول جدید اضافه کنید</p>
        <button onclick="openAddWalletModal()" class="px-6 py-3 bg-primary text-white rounded-xl font-medium haptic shadow-lg">
          افزودن کیف پول
        </button>
      </div>
    </div>
    <!-- Page: Profile -->
    <div id="page-profile" class="page hidden">
      <div class="p-4 space-y-5">

        <!-- User Card -->
        <div class="bg-gradient-to-br from-primary to-blue-600 rounded-2xl p-6 text-white shadow-xl">
          <div class="flex items-center gap-4">
            <div class="w-20 h-20 bg-white bg-opacity-20 rounded-full flex items-center justify-center text-3xl font-bold backdrop-blur-sm">
              <span id="profile-initial">S</span>
            </div>
            <div class="flex-1">
              <h2 class="text-xl font-bold" id="profile-name">Shelby User</h2>
              <p class="text-sm opacity-90" id="profile-id">ID: ...</p>
              <p class="text-xs opacity-80 mt-1" id="profile-username">@username</p>
            </div>
          </div>
          <div class="mt-4 flex justify-between text-xs">
            <div>
              <p class="opacity-80">عضو از</p>
              <p class="font-medium" id="profile-joined">۱۴۰۴</p>
            </div>
            <div>
              <p class="opacity-80">نسخه</p>
              <p class="font-medium">v2.0</p>
            </div>
          </div>
        </div>

        <!-- Settings Card -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg space-y-5">
          <h3 class="font-bold text-lg flex items-center gap-2">
            <i data-lucide="settings" class="w-5 h-5"></i>
            تنظیمات
          </h3>

          <div class="space-y-4">
            <!-- Theme -->
            <div class="flex justify-between items-center">
              <div class="flex items-center gap-3">
                <i data-lucide="moon" class="w-5 h-5 text-gray-600 dark:text-gray-400"></i>
                <div>
                  <p class="font-medium">تم</p>
                  <p class="text-xs text-gray-500 dark:text-gray-400">تیره / روشن</p>
                </div>
              </div>
              <button id="profile-theme-toggle" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 haptic shadow-sm">
                <i data-lucide="moon" class="w-5 h-5"></i>
              </button>
            </div>

            <!-- Language -->
            <div class="flex justify-between items-center">
              <div class="flex items-center gap-3">
                <i data-lucide="globe" class="w-5 h-5 text-gray-600 dark:text-gray-400"></i>
                <div>
                  <p class="font-medium">زبان</p>
                  <p class="text-xs text-gray-500 dark:text-gray-400">فارسی / English</p>
                </div>
              </div>
              <button id="profile-lang-toggle" class="px-3 py-1 text-sm rounded-lg bg-gray-100 dark:bg-gray-700 haptic shadow-sm">EN</button>
            </div>

            <!-- Notifications -->
            <div class="flex justify-between items-center">
              <div class="flex items-center gap-3">
                <i data-lucide="bell" class="w-5 h-5 text-gray-600 dark:text-gray-400"></i>
                <div>
                  <p class="font-medium">اعلان‌ها</p>
                  <p class="text-xs text-gray-500 dark:text-gray-400">هشدار قیمت</p>
                </div>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="notifications-toggle" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
              </label>
            </div>

            <!-- Haptic -->
            <div class="flex justify-between items-center">
              <div class="flex items-center gap-3">
                <i data-lucide="zap" class="w-5 h-5 text-gray-600 dark:text-gray-400"></i>
                <div>
                  <p class="font-medium">لرزش دکمه‌ها</p>
                  <p class="text-xs text-gray-500 dark:text-gray-400">بازخورد لمسی</p>
                </div>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="haptic-toggle" class="sr-only peer" checked>
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
              </label>
            </div>
          </div>
        </div>

        <!-- Stats Card -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg">
          <h3 class="font-bold text-lg flex items-center gap-2 mb-5">
            <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
            آمار اپ
          </h3>
          <div class="grid grid-cols-2 gap-4">
            <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4 text-center">
              <p class="text-2xl font-bold text-primary" id="stats-coins">0</p>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">تعداد ارزها</p>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4 text-center">
              <p class="text-2xl font-bold text-success" id="stats-wallets">0</p>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">کیف پول‌ها</p>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4 text-center">
              <p class="text-2xl font-bold text-warning" id="stats-alerts">0</p>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">هشدار فعال</p>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4 text-center">
              <p class="text-2xl font-bold text-info" id="stats-total">$0</p>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">کل موجودی</p>
            </div>
          </div>
        </div>

        <!-- About Card -->
        <div class="bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-800 dark:to-gray-900 rounded-2xl p-6 shadow-lg text-center">
          <h3 class="font-bold text-lg mb-3">درباره Shelby Bet</h3>
          <p class="text-sm text-gray-600 dark:text-gray-300 leading-relaxed">
            بهترین ابزار مدیریت کریپتو در تلگرام<br>
            با پشتیبانی از ETH، TON، TRON و USDT
          </p>
          <div class="mt-5 flex justify-center gap-3">
            <a href="#" class="p-2 bg-white dark:bg-gray-700 rounded-lg shadow-sm haptic">
              <i data-lucide="github" class="w-5 h-5"></i>
            </a>
            <a href="#" class="p-2 bg-white dark:bg-gray-700 rounded-lg shadow-sm haptic">
              <i data-lucide="twitter" class="w-5 h-5"></i>
            </a>
            <a href="#" class="p-2 bg-white dark:bg-gray-700 rounded-lg shadow-sm haptic">
              <i data-lucide="globe" class="w-5 h-5"></i>
            </a>
          </div>
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-5">نسخه 2.0 - ۱۴۰۴</p>
        </div>

      </div>
    </div>

  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-md shadow-2xl modal">
      <div id="modal-content"></div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-20 left-4 right-4 z-50 hidden max-w-sm mx-auto">
    <div class="bg-gray-900 text-white p-4 rounded-2xl shadow-2xl flex items-center gap-3 toast">
      <div class="w-10 h-10 bg-primary bg-opacity-20 rounded-full flex items-center justify-center">
        <i data-lucide="bell" class="w-5 h-5 text-primary"></i>
      </div>
      <div class="flex-1">
        <p class="font-medium" id="toast-title"></p>
        <p class="text-sm opacity-90" id="toast-message"></p>
      </div>
      <button onclick="closeToast()" class="p-1 haptic">
        <i data-lucide="x" class="w-4 h-4"></i>
      </button>
    </div>
  </div>
  <!-- ALL JS IN ONE SCRIPT -->
  <script>
    // === CONFIG & CONSTANTS ===
    const CONFIG = {
      COINGECKO_API: 'https://api.coingecko.com/api/v3',
      ETH_API: 'https://api.etherscan.io/api',
      ETHERSCAN_KEY: '5G4HJDG2TCMMI2V8GQM6GJ636NVEW1HJU1',
      TON_API: 'https://toncenter.com/api/v2',
      TRON_API: 'https://api.trongrid.io',
      UPDATE_INTERVAL: 120000, // 2 دقیقه
      ALERT_CHECK_INTERVAL: 30000, // 30 ثانیه
      CHART_DAYS: [7, 30],
      PRICE_ALERT_THRESHOLD: 0.005, // 0.5%
      CURRENCY: 'usd',
      LOCALE: 'fa-IR',
    };

    // === STATE ===
    let state = {
      markets: [],
      wallets: JSON.parse(localStorage.getItem('wallets') || '[]'),
      favorites: JSON.parse(localStorage.getItem('favorites') || '[]'),
      alerts: JSON.parse(localStorage.getItem('alerts') || '[]'),
      currentTab: 'markets',
      currentMarketTab: 'all',
      currentSort: 'market_cap_desc',
      page: 1,
      hasMore: true,
      loading: false,
      isDark: localStorage.getItem('theme') === 'dark',
      lang: localStorage.getItem('lang') || 'fa',
      notificationsEnabled: localStorage.getItem('notifications') === 'true',
      hapticEnabled: localStorage.getItem('haptic') !== 'false',
      user: null,
      totalBalance: 0,
    };

    // === TRANSLATIONS (FA & EN) ===
    const translations = {
      fa: {
        markets: 'بازارها', wallet: 'کیف پول', profile: 'پروفایل',
        search: 'جستجو در ارزها...', all: 'همه', favorites: 'علاقه‌مندی‌ها',
        gainers: 'بیشترین رشد', losers: 'بیشترین افت', volume: 'حجم بالا',
        marketCap: 'ارزش بازار (نزولی)', marketCapAsc: 'ارزش بازار (صعودی)',
        growth24h: 'رشد ۲۴ساعته', loss24h: 'افت ۲۴ساعته', volume24h: 'حجم معاملات',
        nameAsc: 'نام (الفبا)',
        noWallet: 'هیچ کیف پولی اضافه نشده', addWallet: 'افزودن کیف پول',
        export: 'خروجی', import: 'ورودی', balance: 'موجودی', usd: 'دلار',
        add: 'افزودن', cancel: 'لغو', delete: 'حذف', edit: 'ویرایش',
        copy: 'کپی شد!', qr: 'نمایش QR', chart: 'نمودار', alert: 'هشدار',
        theme: 'تم', language: 'زبان', notifications: 'اعلان‌ها', haptic: 'لرزش دکمه‌ها',
        stats: 'آمار اپ', coins: 'تعداد ارزها', wallets: 'کیف پول‌ها', alerts: 'هشدار فعال',
        totalBalance: 'کل موجودی', about: 'درباره ما', version: 'نسخه 2.0 - ۱۴۰۴',
        days7: '۷ روز', days30: '۳۰ روز', priceTarget: 'قیمت هدف (USD)',
        currentPrice: 'قیمت فعلی', alertSet: 'هشدار تنظیم شد',
        alertTriggered: 'هشدار فعال شد', copied: 'کپی شد',
        exportSuccess: 'فایل خروجی ایجاد شد', importSuccess: 'کیف پول وارد شد',
        invalidAddress: 'آدرس نامعتبر است', error: 'خطا',
        loading: 'در حال بارگذاری...', refresh: 'تازه‌سازی',
        noResults: 'موردی یافت نشد', loadMore: 'بارگذاری بیشتر',
        memberSince: 'عضو از', versionLabel: 'نسخه',
        eth: 'اتریوم', ton: 'تون', tron: 'ترون', usdt: 'تتر',
        balanceLoading: 'در حال بارگذاری...', balanceError: 'خطا',
        network: 'شبکه', address: 'آدرس', name: 'نام (اختیاری)',
        editWallet: 'ویرایش کیف پول', save: 'ذخیر',
        deleteConfirm: 'آیا مطمئن هستید؟', yes: 'بله', no: 'خیر',
        importFile: 'فایل JSON را انتخاب کنید', importError: 'فایل نامعتبر',
      },
      en: {
        markets: 'Markets', wallet: 'Wallet', profile: 'Profile',
        search: 'Search coins...', all: 'All', favorites: 'Favorites',
        gainers: 'Top Gainers', losers: 'Top Losers', volume: 'High Volume',
        marketCap: 'Market Cap (Desc)', marketCapAsc: 'Market Cap (Asc)',
        growth24h: '24h Growth', loss24h: '24h Loss', volume24h: 'Volume',
        nameAsc: 'Name (A-Z)',
        noWallet: 'No wallet added', addWallet: 'Add Wallet',
        export: 'Export', import: 'Import', balance: 'Balance', usd: 'USD',
        add: 'Add', cancel: 'Cancel', delete: 'Delete', edit: 'Edit',
        copy: 'Copied!', qr: 'Show QR', chart: 'Chart', alert: 'Alert',
        theme: 'Theme', language: 'Language', notifications: 'Notifications', haptic: 'Haptic',
        stats: 'App Stats', coins: 'Coins', wallets: 'Wallets', alerts: 'Active Alerts',
        totalBalance: 'Total Balance', about: 'About', version: 'v2.0 - 2025',
        days7: '7 Days', days30: '30 Days', priceTarget: 'Target Price (USD)',
        currentPrice: 'Current Price', alertSet: 'Alert set',
        alertTriggered: 'Alert triggered', copied: 'Copied',
        exportSuccess: 'Export file created', importSuccess: 'Wallet imported',
        invalidAddress: 'Invalid address', error: 'Error',
        loading: 'Loading...', refresh: 'Refresh',
        noResults: 'No results found', loadMore: 'Load More',
        memberSince: 'Member since', versionLabel: 'Version',
        eth: 'Ethereum', ton: 'TON', tron: 'TRON', usdt: 'USDT',
        balanceLoading: 'Loading...', balanceError: 'Error',
        network: 'Network', address: 'Address', name: 'Name (optional)',
        editWallet: 'Edit Wallet', save: 'Save',
        deleteConfirm: 'Are you sure?', yes: 'Yes', no: 'No',
        importFile: 'Select JSON file', importError: 'Invalid file',
      }
    };

    const t = (key) => translations[state.lang][key] || key;

    // === TELEGRAM WEB APP INIT ===
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.enableClosingConfirmation();

    // === USER DATA FROM TELEGRAM ===
    function initUser() {
      const user = tg.initDataUnsafe?.user;
      if (user) {
        state.user = user;
        document.getElementById('profile-name').textContent = 
          user.first_name + (user.last_name ? ' ' + user.last_name : '');
        document.getElementById('profile-id').textContent = `ID: ${user.id}`;
        document.getElementById('profile-username').textContent = 
          user.username ? `@${user.username}` : '—';
        document.getElementById('profile-initial').textContent = 
          (user.first_name?.[0] || 'S').toUpperCase();
      }
    }

    // === HAPTIC FEEDBACK ===
    const haptic = (type = 'light') => {
      if (state.hapticEnabled && tg.HapticFeedback) {
        tg.HapticFeedback.impactOccurred(type);
      }
    };

    // === THEME & LANGUAGE ===
    const themeToggle = document.getElementById('theme-toggle');
    const profileThemeToggle = document.getElementById('profile-theme-toggle');
    const langToggle = document.getElementById('lang-toggle');
    const profileLangToggle = document.getElementById('profile-lang-toggle');

    function updateTheme() {
      state.isDark = localStorage.getItem('theme') === 'dark';
      if (state.isDark) {
        document.documentElement.classList.add('dark');
        themeToggle.querySelector('i').setAttribute('data-lucide', 'sun');
        profileThemeToggle.querySelector('i').setAttribute('data-lucide', 'sun');
      } else {
        document.documentElement.classList.remove('dark');
        themeToggle.querySelector('i').setAttribute('data-lucide', 'moon');
        profileThemeToggle.querySelector('i').setAttribute('data-lucide', 'moon');
      }
      lucide.createIcons();
      localStorage.setItem('theme', state.isDark ? 'dark' : 'light');
    }

    function updateLanguage() {
      state.lang = localStorage.getItem('lang') || 'fa';
      langToggle.textContent = state.lang === 'fa' ? 'EN' : 'FA';
      profileLangToggle.textContent = state.lang === 'fa' ? 'EN' : 'FA';
      document.documentElement.dir = state.lang === 'fa' ? 'rtl' : 'ltr';
      document.documentElement.lang = state.lang;
      updateUIText();
      localStorage.setItem('lang', state.lang);
    }

    function updateUIText() {
      // تب‌ها
      document.querySelector('[data-tab="markets"]').textContent = t('markets');
      document.querySelector('[data-tab="wallet"]').textContent = t('wallet');
      document.querySelector('[data-tab="profile"]').textContent = t('profile');

      // جستجو
      document.getElementById('search-input').placeholder = t('search');

      // تب‌های بازار
      document.querySelector('[data-market-tab="all"]').textContent = t('all');
      document.querySelector('[data-market-tab="favorites"]').textContent = t('favorites');
      document.querySelector('[data-market-tab="gainers"]').textContent = t('gainers');
      document.querySelector('[data-market-tab="losers"]').textContent = t('losers');
      document.querySelector('[data-market-tab="volume"]').textContent = t('volume');

      // مرتب‌سازی
      const sortSelect = document.getElementById('sort-select');
      sortSelect.options[0].text = t('marketCap');
      sortSelect.options[1].text = t('marketCapAsc');
      sortSelect.options[2].text = t('growth24h');
      sortSelect.options[3].text = t('loss24h');
      sortSelect.options[4].text = t('volume24h');
      sortSelect.options[5].text = t('nameAsc');

      // کیف پول
      document.querySelector('#empty-wallet p').textContent = t('noWallet');
      document.querySelector('#empty-wallet button').textContent = t('addWallet');

      // پروفایل
      document.querySelector('#profile-theme-toggle').previousElementSibling.querySelector('div p').textContent = t('theme');
      document.querySelector('#profile-lang-toggle').previousElementSibling.querySelector('div p').textContent = t('language');
      document.querySelector('#notifications-toggle').previousElementSibling.querySelector('div p').textContent = t('notifications');
      document.querySelector('#haptic-toggle').previousElementSibling.querySelector('div p').textContent = t('haptic');

      // آمار
      document.querySelector('#stats-coins').nextElementSibling.textContent = t('coins');
      document.querySelector('#stats-wallets').nextElementSibling.textContent = t('wallets');
      document.querySelector('#stats-alerts').nextElementSibling.textContent = t('alerts');
      document.querySelector('#stats-total').nextElementSibling.textContent = t('totalBalance');

      // درباره ما
      document.querySelector('#page-profile h3').textContent = t('about');
      document.querySelector('#page-profile p:last-child').textContent = t('version');
    }

    // Event Listeners
    themeToggle.onclick = () => {
      haptic('light');
      state.isDark = !state.isDark;
      updateTheme();
    };

    profileThemeToggle.onclick = () => {
      haptic('light');
      state.isDark = !state.isDark;
      updateTheme();
    };

    langToggle.onclick = () => {
      haptic('light');
      state.lang = state.lang === 'fa' ? 'en' : 'fa';
      updateLanguage();
    };

    profileLangToggle.onclick = () => {
      haptic('light');
      state.lang = state.lang === 'fa' ? 'en' : 'fa';
      updateLanguage();
    };

    document.getElementById('notifications-toggle').checked = state.notificationsEnabled;
    document.getElementById('notifications-toggle').onchange = (e) => {
      state.notificationsEnabled = e.target.checked;
      localStorage.setItem('notifications', state.notificationsEnabled);
    };

    document.getElementById('haptic-toggle').checked = state.hapticEnabled;
    document.getElementById('haptic-toggle').onchange = (e) => {
      state.hapticEnabled = e.target.checked;
      localStorage.setItem('haptic', state.hapticEnabled);
    };
    // === NAVIGATION & TABS ===
    document.querySelectorAll('[data-tab]').forEach(btn => {
      btn.onclick = () => {
        haptic('light');
        document.querySelectorAll('[data-tab]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
        document.getElementById(`page-${btn.dataset.tab}`).classList.remove('hidden');
        state.currentTab = btn.dataset.tab;

        if (state.currentTab === 'markets') {
          loadMarkets();
        } else if (state.currentTab === 'wallet') {
          renderWallets();
        } else if (state.currentTab === 'profile') {
          updateProfileStats();
        }
      };
    });

    // === SEARCH & FILTERS ===
    const searchInput = document.getElementById('search-input');
    const clearSearch = document.getElementById('clear-search');

    searchInput.oninput = () => {
      renderMarkets();
      clearSearch.classList.toggle('hidden', !searchInput.value.trim());
    };

    clearSearch.onclick = () => {
      haptic('light');
      searchInput.value = '';
      renderMarkets();
      clearSearch.classList.add('hidden');
      searchInput.focus();
    };

    document.querySelectorAll('[data-market-tab]').forEach(btn => {
      btn.onclick = () => {
        haptic('light');
        document.querySelectorAll('[data-market-tab]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.currentMarketTab = btn.dataset.marketTab;
        state.page = 1;
        state.hasMore = true;
        loadMarkets();
      };
    });

    document.getElementById('sort-select').onchange = (e) => {
      state.currentSort = e.target.value;
      state.page = 1;
      state.hasMore = true;
      renderMarkets();
    };

    document.getElementById('refresh-markets').onclick = () => {
      haptic('medium');
      state.page = 1;
      state.hasMore = true;
      loadMarkets();
    };

    // === MARKETS DATA & RENDERING ===
    async function loadMarkets() {
      if (state.loading) return;
      state.loading = true;

      const list = document.getElementById('markets-list');
      const skeleton = document.getElementById('skeleton-loading');
      const loadMore = document.getElementById('load-more');
      const empty = document.getElementById('empty-markets');

      if (state.page === 1) {
        skeleton.classList.remove('hidden');
        list.innerHTML = '';
        empty.classList.add('hidden');
        loadMore.classList.add('hidden');

        // Show 12 skeleton items
        skeleton.innerHTML = Array(12).fill().map(() => `
          <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm animate-pulse">
            <div class="flex justify-between items-center">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-gray-200 dark:bg-gray-700 rounded-full"></div>
                <div class="space-y-2">
                  <div class="h-4 w-32 bg-gray-200 dark:bg-gray-700 rounded"></div>
                  <div class="h-3 w-20 bg-gray-200 dark:bg-gray-700 rounded"></div>
                </div>
              </div>
              <div class="text-right space-y-2">
                <div class="h-5 w-24 bg-gray-200 dark:bg-gray-700 rounded"></div>
                <div class="h-4 w-16 bg-gray-200 dark:bg-gray-700 rounded"></div>
              </div>
            </div>
          </div>
        `).join('');
      }

      try {
        let url = `${CONFIG.COINGECKO_API}/coins/markets?vs_currency=${CONFIG.CURRENCY}&order=${state.currentSort}&per_page=50&page=${state.page}&sparkline=false&locale=${state.lang === 'fa' ? 'en' : 'en'}`;

        if (state.currentMarketTab === 'favorites' && state.favorites.length > 0) {
          url += `&ids=${state.favorites.join(',')}`;
        }

        const res = await fetch(url, {
          headers: { 'accept': 'application/json' }
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();

        // Special sorting for gainers/losers/volume
        if (state.currentMarketTab === 'gainers') {
          data.sort((a, b) => (b.price_change_percentage_24h || 0) - (a.price_change_percentage_24h || 0));
        } else if (state.currentMarketTab === 'losers') {
          data.sort((a, b) => (a.price_change_percentage_24h || 0) - (b.price_change_percentage_24h || 0));
        } else if (state.currentMarketTab === 'volume') {
          data.sort((a, b) => (b.total_volume || 0) - (a.total_volume || 0));
        }

        if (state.page === 1) {
          state.markets = [];
        }

        state.markets = state.markets.concat(data);
        state.hasMore = data.length === 50;

        renderMarkets();
        loadMore.classList.toggle('hidden', !state.hasMore);
      } catch (err) {
        console.error('Market load error:', err);
        if (state.page === 1) {
          list.innerHTML = `
            <div class="text-center py-12">
              <i data-lucide="wifi-off" class="w-16 h-16 mx-auto text-gray-400 mb-4"></i>
              <p class="text-red-500 font-medium">${t('error')}</p>
              <button onclick="loadMarkets()" class="mt-4 px-6 py-2 bg-primary text-white rounded-xl haptic">
                ${t('refresh')}
              </button>
            </div>
          `;
          lucide.createIcons();
        }
      } finally {
        skeleton.classList.add('hidden');
        state.loading = false;
      }
    }

    function renderMarkets() {
      const list = document.getElementById('markets-list');
      const empty = document.getElementById('empty-markets');
      const search = searchInput.value.toLowerCase().trim();

      let filtered = state.markets;

      if (search) {
        filtered = filtered.filter(coin =>
          coin.name.toLowerCase().includes(search) ||
          coin.symbol.toLowerCase().includes(search)
        );
      }

      if (filtered.length === 0 && state.page === 1) {
        empty.classList.remove('hidden');
        list.innerHTML = '';
        return;
      } else {
        empty.classList.add('hidden');
      }

      const html = filtered.map(coin => {
        const isFav = state.favorites.includes(coin.id);
        const change = coin.price_change_percentage_24h || 0;
        const priceClass = change > 0 ? 'price-up' : change < 0 ? 'price-down' : 'price-flat';
        const changeSign = change > 0 ? '+' : '';

        return `
          <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm haptic transition-all hover:shadow-md" data-coin-id="${coin.id}">
            <div class="flex justify-between items-center">
              <div class="flex items-center gap-3">
                <img src="${coin.image}" alt="${coin.name}" class="w-12 h-12 rounded-full object-contain bg-white p-1 shadow-sm">
                <div>
                  <div class="font-bold text-lg">${coin.name}</div>
                  <div class="text-sm text-gray-500 dark:text-gray-400">${coin.symbol.toUpperCase()}</div>
                </div>
              </div>
              <div class="text-right">
                <div class="font-bold text-lg">$${coin.current_price?.toLocaleString() || '—'}</div>
                <div class="${priceClass} text-sm font-medium">
                  ${changeSign}${change.toFixed(2)}%
                </div>
              </div>
            </div>
            <div class="flex justify-end gap-1 mt-3">
              <button onclick="toggleFavorite('${coin.id}')" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 haptic">
                <i data-lucide="${isFav ? 'star' : 'star-off'}" class="w-5 h-5 ${isFav ? 'text-yellow-500' : ''}"></i>
              </button>
              <button onclick="openChart('${coin.id}', '${coin.name}')" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 haptic">
                <i data-lucide="trending-up" class="w-5 h-5"></i>
              </button>
              <button onclick="openPriceAlertModal('${coin.id}', '${coin.name}', ${coin.current_price})" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 haptic">
                <i data-lucide="bell" class="w-5 h-5"></i>
              </button>
            </div>
          </div>
        `;
      }).join('');

      if (state.page === 1) {
        list.innerHTML = html;
      } else {
        list.innerHTML += html;
      }

      lucide.createIcons();
    }

    window.toggleFavorite = (id) => {
      haptic('light');
      const index = state.favorites.indexOf(id);
      if (index > -1) {
        state.favorites.splice(index, 1);
      } else {
        state.favorites.push(id);
      }
      localStorage.setItem('favorites', JSON.stringify(state.favorites));
      if (state.currentMarketTab === 'favorites') {
        state.page = 1;
        loadMarkets();
      } else {
        renderMarkets();
      }
    };

    document.getElementById('load-more').onclick = () => {
      haptic('medium');
      state.page++;
      loadMarkets();
    };
    // === CHART MODAL ===
    window.openChart = (id, name) => {
      haptic('medium');
      const modal = document.getElementById('modal');
      modal.classList.remove('hidden');
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-lg shadow-2xl">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold flex items-center gap-2">
              <i data-lucide="trending-up" class="w-5 h-5 text-primary"></i>
              نمودار ${name}
            </h3>
            <button onclick="closeModal()" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 haptic">
              <i data-lucide="x" class="w-5 h-5"></i>
            </button>
          </div>
          <div class="flex gap-2 mb-4">
            <button data-chart-days="7" class="chart-days-btn flex-1 py-2 rounded-xl bg-primary text-white text-sm font-medium active">۷ روز</button>
            <button data-chart-days="30" class="chart-days-btn flex-1 py-2 rounded-xl bg-gray-100 dark:bg-gray-700 text-sm">۳۰ روز</button>
          </div>
          <div class="chart-container">
            <canvas id="price-chart"></canvas>
          </div>
          <div class="mt-4 text-center text-sm text-gray-500 dark:text-gray-400">
            آخرین به‌روزرسانی: <span id="chart-updated">—</span>
          </div>
        </div>
      `;
      lucide.createIcons();
      fetchChartData(id, 7);
    };

    async function fetchChartData(id, days) {
      const btn7 = document.querySelector('[data-chart-days="7"]');
      const btn30 = document.querySelector('[data-chart-days="30"]');
      const updatedEl = document.getElementById('chart-updated');
      const ctx = document.getElementById('price-chart').getContext('2d');

      btn7.classList.toggle('active', days === 7);
      btn30.classList.toggle('active', days === 30);

      try {
        const res = await fetch(`${CONFIG.COINGECKO_API}/coins/${id}/market_chart?vs_currency=usd&days=${days}&precision=2`);
        if (!res.ok) throw new Error();
        const data = await res.json();

        const labels = data.prices.map(p => {
          const date = new Date(p[0]);
          return state.lang === 'fa' 
            ? date.toLocaleDateString('fa-IR', { month: 'short', day: 'numeric' })
            : date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });
        const prices = data.prices.map(p => p[1]);

        updatedEl.textContent = new Date().toLocaleTimeString(state.lang === 'fa' ? 'fa-IR' : 'en-US');

        if (window.priceChart) window.priceChart.destroy();

        window.priceChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'قیمت (USD)',
              data: prices,
              borderColor: '#1DA1F2',
              backgroundColor: 'rgba(29, 161, 242, 0.1)',
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.3,
              fill: true,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                mode: 'index',
                intersect: false,
                callbacks: {
                  label: ctx => `$${ctx.parsed.y.toFixed(2)}`
                }
              }
            },
            scales: {
              x: { display: false },
              y: { display: true, ticks: { callback: v => `$${v}` } }
            },
            interaction: { mode: 'nearest', axis: 'x', intersect: false }
          }
        });
      } catch (err) {
        console.error('Chart error:', err);
        document.querySelector('.chart-container').innerHTML = `
          <div class="text-center py-8">
            <i data-lucide="alert-circle" class="w-12 h-12 mx-auto text-red-500 mb-2"></i>
            <p class="text-sm text-red-500">${t('error')}</p>
          </div>
        `;
        lucide.createIcons();
      }

      document.querySelectorAll('[data-chart-days]').forEach(btn => {
        btn.onclick = () => {
          haptic('light');
          fetchChartData(id, parseInt(btn.dataset.chartDays));
        };
      });
    }

    // === PRICE ALERT MODAL ===
    window.openPriceAlertModal = (id, name, currentPrice) => {
      haptic('medium');
      const modal = document.getElementById('modal');
      modal.classList.remove('hidden');
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-md shadow-2xl">
          <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
            <i data-lucide="bell" class="w-5 h-5 text-primary"></i>
            ${t('alert')} برای ${name}
          </h3>
          <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4 mb-4">
            <p class="text-sm text-gray-600 dark:text-gray-400">${t('currentPrice')}: <span class="font-bold">$${currentPrice?.toLocaleString() || '—'}</span></p>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium mb-2">${t('priceTarget')}</label>
            <input type="number" id="alert-price" placeholder="مثلاً ۶۵۰۰۰" step="0.01" class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
          </div>
          <div class="flex gap-2">
            <button onclick="setPriceAlert('${id}', '${name}')" class="flex-1 py-3 bg-primary text-white rounded-xl font-medium haptic shadow-md">
              ${t('add')}
            </button>
            <button onclick="closeModal()" class="flex-1 py-3 bg-gray-100 dark:bg-gray-700 rounded-xl font-medium haptic">
              ${t('cancel')}
            </button>
          </div>
        </div>
      `;
    };

    window.setPriceAlert = (id, name) => {
      const input = document.getElementById('alert-price');
      const price = parseFloat(input.value);
      if (!price || price <= 0) {
        input.classList.add('border-red-500');
        return;
      }
      const alert = {
        id,
        name,
        price,
        active: true,
        created: Date.now(),
        notified: false
      };
      state.alerts.push(alert);
      localStorage.setItem('alerts', JSON.stringify(state.alerts));
      closeModal();
      showToast(t('alert'), `${name} در $${price.toLocaleString()} ${t('alertSet')}`);
      updateProfileStats();
    };

    function checkPriceAlerts() {
      if (!state.notificationsEnabled || state.markets.length === 0) return;

      state.alerts.forEach((alert, i) => {
        if (!alert.active || alert.notified) return;

        const coin = state.markets.find(c => c.id === alert.id);
        if (!coin) return;

        const diff = Math.abs(coin.current_price - alert.price) / alert.price;
        if (diff <= CONFIG.PRICE_ALERT_THRESHOLD) {
          showToast(`${t('alertTriggered')}!`, `${coin.name} به $${coin.current_price.toFixed(2)} رسید`);
          state.alerts[i].active = false;
          state.alerts[i].notified = true;
          localStorage.setItem('alerts', JSON.stringify(state.alerts));
          updateProfileStats();
        }
      });
    }

    // === WALLET MANAGEMENT ===
    function renderWallets() {
      const list = document.getElementById('wallet-list');
      const empty = document.getElementById('empty-wallet');

      if (state.wallets.length === 0) {
        empty.classList.remove('hidden');
        list.innerHTML = '';
        return;
      }

      empty.classList.add('hidden');
      list.innerHTML = state.wallets.map((w, i) => `
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-5 shadow-lg haptic" data-wallet-index="${i}">
          <div class="flex justify-between items-start mb-3">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <h4 class="font-bold text-lg">${w.name || w.address.slice(0, 8) + '...'}</h4>
                <span class="badge badge-${w.network}">${getNetworkLabel(w.network)}</span>
              </div>
              <div class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
                <span class="truncate max-w-48">${w.address}</span>
                <button class="copy-btn" onclick="copyToClipboard('${w.address}')">
                  <i data-lucide="copy" class="w-4 h-4"></i>
                </button>
              </div>
            </div>
            <div class="flex gap-1">
              <button onclick="editWallet(${i})" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 haptic">
                <i data-lucide="edit" class="w-4 h-4"></i>
              </button>
              <button onclick="removeWallet(${i})" class="p-2 rounded-lg bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-400 haptic">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
              </button>
            </div>
          </div>
          <div id="balance-${i}" class="flex items-center justify-between">
            <span class="text-sm text-gray-500">${t('balanceLoading')}</span>
            <div class="loading-spinner"></div>
          </div>
          <button onclick="showQR('${w.address}', '${w.name || w.address.slice(0, 8) + '...'}')" class="mt-3 w-full py-2 bg-primary text-white rounded-xl text-sm font-medium haptic flex items-center justify-center gap-2">
            <i data-lucide="qr-code" class="w-4 h-4"></i>
            ${t('qr')}
          </button>
        </div>
      `).join('');

      lucide.createIcons();
      state.wallets.forEach((w, i) => fetchWalletBalance(w, i));
      calculateTotalBalance();
    }

    function getNetworkLabel(network) {
      return { eth: 'ETH', ton: 'TON', tron: 'USDT' }[network] || network.toUpperCase();
    }
    window.openAddWalletModal = () => {
      haptic('medium');
      const modal = document.getElementById('modal');
      modal.classList.remove('hidden');
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-md shadow-2xl">
          <h3 class="text-lg font-bold mb-5 flex items-center gap-2">
            <i data-lucide="plus-circle" class="w-5 h-5 text-primary"></i>
            ${t('addWallet')}
          </h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-2">${t('name')}</label>
              <input type="text" id="wallet-name" placeholder="مثلاً: کیف اصلی" class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">${t('network')}</label>
              <select id="wallet-network" class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                <option value="eth">${t('eth')}</option>
                <option value="ton">${t('ton')}</option>
                <option value="tron">${t('tron')} (${t('usdt')})</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">${t('address')}</label>
              <input type="text" id="wallet-address" placeholder="0x..." class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
          </div>
          <div class="flex gap-2 mt-6">
            <button onclick="addWallet()" class="flex-1 py-3 bg-primary text-white rounded-xl font-medium haptic shadow-md">
              ${t('add')}
            </button>
            <button onclick="closeModal()" class="flex-1 py-3 bg-gray-100 dark:bg-gray-700 rounded-xl font-medium haptic">
              ${t('cancel')}
            </button>
          </div>
        </div>
      `;
    };

    window.addWallet = () => {
      const name = document.getElementById('wallet-name').value.trim();
      const network = document.getElementById('wallet-network').value;
      const address = document.getElementById('wallet-address').value.trim();

      if (!address) {
        document.getElementById('wallet-address').classList.add('border-red-500');
        return;
      }

      if (!validateAddress(address, network)) {
        showToast(t('error'), t('invalidAddress'));
        return;
      }

      const wallet = { name, network, address };
      state.wallets.push(wallet);
      localStorage.setItem('wallets', JSON.stringify(state.wallets));
      closeModal();
      renderWallets();
      updateProfileStats();
      showToast('موفقیت', `${name || address.slice(0, 8) + '...'} اضافه شد`);
    };

    window.editWallet = (i) => {
      haptic('medium');
      const w = state.wallets[i];
      const modal = document.getElementById('modal');
      modal.classList.remove('hidden');
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-md shadow-2xl">
          <h3 class="text-lg font-bold mb-5 flex items-center gap-2">
            <i data-lucide="edit" class="w-5 h-5 text-primary"></i>
            ${t('editWallet')}
          </h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-2">${t('name')}</label>
              <input type="text" id="edit-name" value="${w.name || ''}" class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">${t('address')}</label>
              <input type="text" id="edit-address" value="${w.address}" class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
          </div>
          <div class="flex gap-2 mt-6">
            <button onclick="saveEditedWallet(${i})" class="flex-1 py-3 bg-primary text-white rounded-xl font-medium haptic shadow-md">
              ${t('save')}
            </button>
            <button onclick="closeModal()" class="flex-1 py-3 bg-gray-100 dark:bg-gray-700 rounded-xl font-medium haptic">
              ${t('cancel')}
            </button>
          </div>
        </div>
      `;
    };

    window.saveEditedWallet = (i) => {
      const name = document.getElementById('edit-name').value.trim();
      const address = document.getElementById('edit-address').value.trim();

      if (!address) return;

      if (!validateAddress(address, state.wallets[i].network)) {
        showToast(t('error'), t('invalidAddress'));
        return;
      }

      state.wallets[i].name = name;
      state.wallets[i].address = address;
      localStorage.setItem('wallets', JSON.stringify(state.wallets));
      closeModal();
      renderWallets();
    };

    window.removeWallet = (i) => {
      haptic('heavy');
      const w = state.wallets[i];
      const modal = document.getElementById('modal');
      modal.classList.remove('hidden');
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-md shadow-2xl text-center">
          <i data-lucide="alert-triangle" class="w-16 h-16 mx-auto text-red-500 mb-4"></i>
          <h3 class="text-lg font-bold mb-3">${t('deleteConfirm')}</h3>
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">
            ${w.name || w.address.slice(0, 8) + '...'} حذف شود؟
          </p>
          <div class="flex gap-2">
            <button onclick="confirmRemoveWallet(${i})" class="flex-1 py-3 bg-red-500 text-white rounded-xl font-medium haptic">
              ${t('yes')}
            </button>
            <button onclick="closeModal()" class="flex-1 py-3 bg-gray-100 dark:bg-gray-700 rounded-xl font-medium haptic">
              ${t('no')}
            </button>
          </div>
        </div>
      `;
      lucide.createIcons();
    };

    window.confirmRemoveWallet = (i) => {
      state.wallets.splice(i, 1);
      localStorage.setItem('wallets', JSON.stringify(state.wallets));
      closeModal();
      renderWallets();
      updateProfileStats();
    };

    function validateAddress(address, network) {
      if (network === 'eth') return /^0x[a-fA-F0-9]{40}$/.test(address);
      if (network === 'ton') return /^[a-zA-Z0-9]{48}$/.test(address);
      if (network === 'tron') return /^T[a-zA-Z0-9]{33}$/.test(address);
      return false;
    }

    async function fetchWalletBalance(wallet, index) {
      const el = document.getElementById(`balance-${index}`);
      if (!el) return;

      try {
        let balance = 0, usd = 0, symbol = '';

        if (wallet.network === 'eth') {
          const res = await fetch(`${CONFIG.ETH_API}?module=account&action=balance&address=${wallet.address}&tag=latest&apikey=${CONFIG.ETHERSCAN_KEY}`);
          const data = await res.json();
          if (data.status !== '1') throw new Error();
          balance = parseInt(data.result) / 1e18;
          const priceRes = await fetch(`${CONFIG.COINGECKO_API}/simple/price?ids=ethereum&vs_currencies=usd`);
          const priceData = await priceRes.json();
          usd = balance * priceData.ethereum.usd;
          symbol = 'ETH';
        } else if (wallet.network === 'ton') {
          const res = await fetch(`${CONFIG.TON_API}/getAddressInformation?address=${wallet.address}`);
          const data = await res.json();
          balance = data.balance / 1e9;
          usd = balance * 6.5; // تقریبی
          symbol = 'TON';
        } else if (wallet.network === 'tron') {
          const res = await fetch(`${CONFIG.TRON_API}/v1/accounts/${wallet.address}`);
          const data = await res.json();
          const usdt = data.data[0]?.trc20?.find(t => t.tokenName === 'Tether USDt' || t.tokenAbbr === 'USDT');
          balance = usdt ? usdt.balance / 1e6 : 0;
          usd = balance;
          symbol = 'USDT';
        }

        el.innerHTML = `
          <div>
            <p class="font-bold">${balance.toFixed(4)} ${symbol}</p>
            <p class="text-sm text-gray-500 dark:text-gray-400">≈ $${usd.toFixed(2)}</p>
          </div>
        `;
        calculateTotalBalance();
      } catch (e) {
        el.innerHTML = `<span class="text-red-500 text-sm">${t('balanceError')}</span>`;
      }
    }

    function calculateTotalBalance() {
      let total = 0;
      document.querySelectorAll('[id^="balance-"]').forEach(el => {
        const text = el.innerText;
        const match = text.match(/\$([\d,]+\.?\d*)/);
        if (match) total += parseFloat(match[1].replace(/,/g, ''));
      });
      state.totalBalance = total;
      document.getElementById('stats-total').textContent = `$${total.toFixed(2)}`;
    }
    // === QR CODE MODAL ===
    window.showQR = (address, title) => {
      haptic('medium');
      const modal = document.getElementById('modal');
      modal.classList.remove('hidden');
      modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-md shadow-2xl text-center">
          <h3 class="text-lg font-bold mb-4 flex items-center justify-center gap-2">
            <i data-lucide="qr-code" class="w-5 h-5 text-primary"></i>
            QR کد ${title}
          </h3>
          <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6 mb-4">
            <div id="qrcode" class="mx-auto"></div>
          </div>
          <div class="flex items-center justify-center gap-2 mb-4">
            <p class="text-sm text-gray-600 dark:text-gray-400 truncate max-w-64">${address}</p>
            <button class="p-1 haptic" onclick="copyToClipboard('${address}')">
              <i data-lucide="copy" class="w-4 h-4 text-primary"></i>
            </button>
          </div>
          <button onclick="closeModal()" class="w-full py-3 bg-primary text-white rounded-xl font-medium haptic shadow-md">
            بستن
          </button>
        </div>
      `;

      // Clear previous QR
      document.getElementById('qrcode').innerHTML = '';
      new QRCode(document.getElementById('qrcode'), {
        text: address,
        width: 200,
        height: 200,
        colorDark: state.isDark ? '#ffffff' : '#000000',
        colorLight: state.isDark ? '#1f2937' : '#ffffff',
        correctLevel: QRCode.CorrectLevel.H
      });
    };

    // === COPY TO CLIPBOARD ===
    window.copyToClipboard = (text) => {
      haptic('light');
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
          showToast(t('copy'), t('copied'));
        }).catch(() => {
          fallbackCopy(text);
        });
      } else {
        fallbackCopy(text);
      }
    };

    function fallbackCopy(text) {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand('copy');
        showToast(t('copy'), t('copied'));
      } catch (err) {
        showToast(t('error'), 'کپی نشد');
      }
      document.body.removeChild(textarea);
    }

    // === EXPORT / IMPORT WALLETS ===
    window.exportWallets = () => {
      haptic('medium');
      if (state.wallets.length === 0) {
        showToast(t('error'), 'هیچ کیف پولی وجود ندارد');
        return;
      }
      const data = JSON.stringify(state.wallets, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `shelby-wallets-${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('موفقیت', t('exportSuccess'));
    };

    window.importWallets = () => {
      haptic('medium');
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          try {
            const imported = JSON.parse(ev.target.result);
            if (!Array.isArray(imported)) throw new Error();
            const valid = imported.filter(w => 
              w.address && ['eth','ton','tron'].includes(w.network) && validateAddress(w.address, w.network)
            );
            if (valid.length === 0) throw new Error();
            state.wallets = [...state.wallets, ...valid];
            localStorage.setItem('wallets', JSON.stringify(state.wallets));
            renderWallets();
            updateProfileStats();
            showToast('موفقیت', `${valid.length} ${t('importSuccess')}`);
          } catch {
            showToast(t('error'), t('importError'));
          }
        };
        reader.readAsText(file);
      };
      input.click();
    };

    // === MODAL CONTROL ===
    window.closeModal = () => {
      haptic('light');
      const modal = document.getElementById('modal');
      modal.classList.add('hidden');
      modal.innerHTML = '';
      if (window.priceChart) {
        window.priceChart.destroy();
        window.priceChart = null;
      }
    };

    // === TOAST NOTIFICATION ===
    function showToast(title, message) {
      const toast = document.getElementById('toast');
      document.getElementById('toast-title').textContent = title;
      document.getElementById('toast-message').textContent = message;
      toast.classList.remove('hidden');
      setTimeout(() => {
        toast.classList.add('hidden');
      }, 3000);
    }

    window.closeToast = () => {
      document.getElementById('toast').classList.add('hidden');
    };

    // === PROFILE STATS ===
    function updateProfileStats() {
      document.getElementById('stats-coins').textContent = state.markets.length;
      document.getElementById('stats-wallets').textContent = state.wallets.length;
      document.getElementById('stats-alerts').textContent = state.alerts.filter(a => a.active).length;
      document.getElementById('stats-total').textContent = `$${state.totalBalance.toFixed(2)}`;
    }

    // === AUTO UPDATE & ALERT CHECK ===
    let updateInterval, alertInterval;

    function startAutoUpdate() {
      clearInterval(updateInterval);
      clearInterval(alertInterval);
      updateInterval = setInterval(() => {
        if (state.currentTab === 'markets' && state.currentMarketTab !== 'favorites') {
          state.page = 1;
          loadMarkets();
        }
      }, CONFIG.UPDATE_INTERVAL);

      alertInterval = setInterval(checkPriceAlerts, CONFIG.ALERT_CHECK_INTERVAL);
    }

    // === PWA SERVICE WORKER ===
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => console.log('SW registered', reg))
          .catch(err => console.log('SW error', err));
      });
    }

    // === SKELETON LOADING FOR ALL PAGES ===
    function showSkeleton(containerId, count = 5) {
      const container = document.getElementById(containerId);
      container.innerHTML = Array(count).fill().map(() => `
        <div class="p-4 bg-white dark:bg-gray-800 rounded-xl animate-pulse shadow-sm">
          <div class="flex justify-between items-center">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-gray-200 dark:bg-gray-700 rounded-full"></div>
              <div class="space-y-2">
                <div class="h-4 w-32 bg-gray-200 dark:bg-gray-700 rounded"></div>
                <div class="h-3 w-20 bg-gray-200 dark:bg-gray-700 rounded"></div>
              </div>
            </div>
            <div class="h-6 w-24 bg-gray-200 dark:bg-gray-700 rounded"></div>
          </div>
        </div>
      `).join('');
    }
    // === INIT ON LOAD ===
    window.addEventListener('load', () => {
      // Initialize Telegram WebApp
      tg.ready();
      tg.expand();

      // Initialize user profile
      initUser();

      // Load saved settings
      updateTheme();
      updateLanguage();

      // Create Lucide icons
      lucide.createIcons();

      // Start with markets tab
      document.querySelector('[data-tab="markets"]').click();

      // Initial data load
      loadMarkets();
      renderWallets();
      updateProfileStats();

      // Start auto-update intervals
      startAutoUpdate();

      // Show empty wallet if none
      if (state.wallets.length === 0) {
        document.getElementById('empty-wallet').classList.remove('hidden');
      }

      // Load saved toggles
      document.getElementById('notifications-toggle').checked = state.notificationsEnabled;
      document.getElementById('haptic-toggle').checked = state.hapticEnabled;

      // Set joined date
      const joined = new Date().toLocaleDateString(state.lang === 'fa' ? 'fa-IR' : 'en-US', { year: 'numeric', month: 'long' });
      document.getElementById('profile-joined').textContent = joined;

      // Performance: Resize chart on window resize
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          if (window.priceChart) {
            window.priceChart.resize();
          }
        }, 250);
      });

      // Global error handling
      window.addEventListener('error', (e) => {
        console.error('Global error:', e.error);
        showToast(t('error'), 'مشکلی پیش آمد');
      });

      window.addEventListener('unhandledrejection', (e) => {
        console.error('Promise rejection:', e.reason);
        showToast(t('error'), 'درخواست ناموفق');
      });

      // Add haptic to all buttons with .haptic class
      document.querySelectorAll('.haptic').forEach(el => {
        el.addEventListener('touchstart', () => haptic('light'));
      });

      // Close modal on backdrop click
      document.getElementById('modal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('modal')) {
          closeModal();
        }
      });

      // PWA Install Prompt (if supported)
      let deferredPrompt;
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        // Optionally show install button
      });

      // Install button (optional)
      // const installBtn = document.createElement('button');
      // installBtn.textContent = 'نصب اپ';
      // installBtn.className = 'fixed bottom-20 right-4 bg-primary text-white px-4 py-2 rounded-full shadow-lg z-50 haptic';
      // installBtn.onclick = () => {
      //   if (deferredPrompt) {
      //     deferredPrompt.prompt();
      //     deferredPrompt.userChoice.then(() => {
      //       deferredPrompt = null;
      //       installBtn.remove();
      //     });
      //   }
      // };
      // document.body.appendChild(installBtn);

      console.log('Shelby Bet v2.0 loaded successfully');
    });

    // === FINAL TOUCHES & PERFORMANCE ===
    // Debounce search input
    let searchTimeout;
    document.getElementById('search-input').addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        state.page = 1;
        renderMarkets();
      }, 300);
    });

    // Optimize rendering
    let renderTimeout;
    const debouncedRender = () => {
      clearTimeout(renderTimeout);
      renderTimeout = setTimeout(renderMarkets, 100);
    };

    // Use Intersection Observer for load more
    let observer;
    function initLoadMoreObserver() {
      const loadMore = document.getElementById('load-more');
      if (!loadMore) return;

      observer = new IntersectionObserver(entries => {
        if (entries[0].isIntersecting && state.hasMore && !state.loading) {
          state.page++;
          loadMarkets();
        }
      }, { threshold: 0.1 });

      observer.observe(loadMore);
    }

    // Call after first render
    setTimeout(initLoadMoreObserver, 1000);

    // Cleanup on tab change
    document.querySelectorAll('[data-tab]').forEach(btn => {
      btn.addEventListener('click', () => {
        if (observer) observer.disconnect();
        if (state.currentTab === 'markets') {
          setTimeout(initLoadMoreObserver, 500);
        }
      });
    });

    // Cache busting for API calls
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
      const url = args[0];
      if (typeof url === 'string' && url.includes('coingecko.com')) {
        args[0] = url + (url.includes('?') ? '&' : '?') + '_=' + Date.now();
      }
      return originalFetch.apply(this, args);
    };

    // Memory management
    setInterval(() => {
      if (state.markets.length > 500) {
        state.markets = state.markets.slice(0, 200);
      }
    }, 60000);

    // === END OF SCRIPT ===
  </script>

</body>
                                                                               </html>
