<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no, user-scalable=no">
    <title>Shelby Crypto Tracker</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --tg-bg: #181A20; /* Dark BG */
            --tg-text: #EAECEF; /* Light Text */
            --tg-hint: #707A8A;
            --tg-button: #2481cc;
            --tg-button-text: #ffffff;
            --tg-secondary-bg: #1E2026;
            --tg-header-border: #2B3139;
            --positive: #10B981;
            --negative: #EF4444;
        }
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: var(--tg-bg);
            color: var(--tg-text);
            transition: background-color 0.3s, color 0.3s;
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .header {
            background-color: var(--tg-bg);
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 1rem;
            border-bottom: 1px solid var(--tg-header-border);
        }
        #search-input {
            background-color: var(--tg-secondary-bg);
            border: 1px solid var(--tg-header-border);
            color: var(--tg-text);
        }
        #search-input::placeholder {
            color: var(--tg-hint);
        }
        .coin-row {
            border-bottom: 1px solid var(--tg-header-border);
            transition: background-color 0.2s;
        }
        .coin-row:last-child {
            border-bottom: none;
        }
        .price-up { animation: price-up-flash 0.7s ease-out; }
        .price-down { animation: price-down-flash 0.7s ease-out; }
        @keyframes price-up-flash {
            0% { background-color: rgba(16, 185, 129, 0.2); }
            100% { background-color: transparent; }
        }
        @keyframes price-down-flash {
            0% { background-color: rgba(239, 68, 68, 0.2); }
            100% { background-color: transparent; }
        }
        #loader-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 70vh;
        }
        .loader {
            border: 5px solid var(--tg-secondary-bg);
            border-top: 5px solid var(--tg-button);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">
    <div class="header">
        <h1 class="text-xl font-bold text-center mb-4">Shelby Developer Tracker</h1>
        <input type="text" id="search-input" placeholder="جستجوی نام ارز..." class="w-full p-2 rounded-lg text-sm">
    </div>

    <div id="loader-container">
        <div class="loader"></div>
    </div>

    <div id="coin-list" class="px-4">
        <!-- Coin rows will be injected here -->
    </div>

    <script>
        const tg = window.Telegram.WebApp;

        const API_URL = "https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=100&page=1&sparkline=false";
        
        const loaderContainer = document.getElementById('loader-container');
        const coinListContainer = document.getElementById('coin-list');
        const searchInput = document.getElementById('search-input');
        
        let coinData = [];
        let updateInterval;

        const formatNum = (num, decimals = 2) => {
             if (num === null || num === undefined) return 'N/A';
             const options = {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals,
             };
             if (num > 1000) options.notation = 'compact';
             return new Intl.NumberFormat('en-US', options).format(num);
        };
        const formatPercent = (percent) => `${percent > 0 ? '+' : ''}${percent.toFixed(2)}%`;
        
        function renderCoinRow(coin) {
            const priceChangeClass = coin.price_change_percentage_24h >= 0 ? 'bg-green-600/90' : 'bg-red-600/90';
            const priceChange = coin.price_change_percentage_24h;

            return `
                <div class="coin-row flex items-center justify-between p-3" data-coin-id="${coin.id}">
                    <div class="flex items-center space-x-3 space-x-reverse">
                        <img src="${coin.image}" alt="${coin.name}" class="w-8 h-8 rounded-full">
                        <div>
                            <div class="font-bold text-sm">${coin.symbol.toUpperCase()}</div>
                            <div class="text-xs" style="color: var(--tg-hint);">${coin.name}</div>
                        </div>
                    </div>
                    <div class="text-left font-mono text-sm">
                        <div class="font-medium" data-price>$${formatNum(coin.current_price, coin.current_price < 0.01 ? 6 : 2)}</div>
                    </div>
                    <div class="w-20 text-center text-sm font-bold text-white py-1 rounded-md ${priceChangeClass}" data-change>
                        ${formatPercent(priceChange)}
                    </div>
                </div>
            `;
        }
        
        function updateCoinRow(element, newCoinData) {
            const oldPrice = parseFloat(element.querySelector('[data-price]').textContent.replace(/[^0-9.-]+/g,""));
            const newPrice = newCoinData.current_price;

            if (oldPrice !== newPrice) {
                 element.querySelector('[data-price]').textContent = `$${formatNum(newPrice, newPrice < 0.01 ? 6 : 2)}`;
                 element.classList.remove('price-up', 'price-down');
                 void element.offsetWidth; // Trigger reflow
                 element.classList.add(newPrice > oldPrice ? 'price-up' : 'price-down');
            }

            const changeEl = element.querySelector('[data-change]');
            const newChange = newCoinData.price_change_percentage_24h;
            changeEl.textContent = formatPercent(newChange);
            changeEl.className = `w-20 text-center text-sm font-bold text-white py-1 rounded-md ${newChange >= 0 ? 'bg-green-600/90' : 'bg-red-600/90'}`;
        }

        async function fetchData() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error('Network response was not ok');
                return await response.json();
            } catch (error) {
                console.error("Fetch Error:", error);
                tg.showAlert('خطا در دریافت اطلاعات از سرور. لطفاً اتصال اینترنت خود را بررسی کنید.');
                return null;
            }
        }

        async function initialLoad() {
            const data = await fetchData();
            if (data) {
                coinData = data;
                loaderContainer.style.display = 'none';
                coinListContainer.innerHTML = coinData.map(renderCoinRow).join('');
                
                // Start live updates after initial load
                if (updateInterval) clearInterval(updateInterval);
                updateInterval = setInterval(liveUpdate, 10000); // Update every 10 seconds
            }
        }
        
        async function liveUpdate() {
             const newData = await fetchData();
             if(newData) {
                 newData.forEach(newCoin => {
                     const rowElement = document.querySelector(`.coin-row[data-coin-id="${newCoin.id}"]`);
                     if(rowElement) {
                         updateCoinRow(rowElement, newCoin);
                         // Update local data store
                         const coinIndex = coinData.findIndex(c => c.id === newCoin.id);
                         if (coinIndex !== -1) coinData[coinIndex] = newCoin;
                     }
                 });
             }
        }
        
        function filterCoins() {
            const query = searchInput.value.toLowerCase();
            const rows = document.querySelectorAll('.coin-row');
            rows.forEach(row => {
                const coinId = row.dataset.coinId;
                const coin = coinData.find(c => c.id === coinId);
                const name = coin.name.toLowerCase();
                const symbol = coin.symbol.toLowerCase();

                if (name.includes(query) || symbol.includes(query)) {
                    row.style.display = 'flex';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            tg.ready();
            tg.expand();
            
            // Override theme for a consistent dark mode look
            document.documentElement.style.setProperty('--tg-bg', '#181A20');
            document.documentElement.style.setProperty('--tg-text', '#EAECEF');
            document.documentElement.style.setProperty('--tg-secondary-bg', '#1E2026');
            tg.setHeaderColor('#181A20');
            tg.setBackgroundColor('#181A20');

            initialLoad();
            searchInput.addEventListener('input', filterCoins);
        });
    </script>
</body>
</html>

