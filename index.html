<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no, user-scalable=no">
    <title>Shelby Bet Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --tg-bg: #121212; --tg-text: #EAECEF; --tg-hint: #707A8A;
            --tg-button: #2E81FF; --tg-secondary-bg: #1E1E1E; --tg-header-border: #2A2A2A;
            --positive: #00C853; --negative: #FF3B30;
        }
        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--tg-bg); color: var(--tg-text); margin: 0; padding: 0; }
        .header { background-color: var(--tg-bg); position: sticky; top: 0; z-index: 20; padding: 1rem; border-bottom: 1px solid var(--tg-header-border); }
        #search-input { background-color: var(--tg-secondary-bg); border: 1px solid var(--tg-header-border); color: var(--tg-text); }
        .tab-button.active { background-color: var(--tg-button); color: white; border-color: var(--tg-button); }
        .sort-button.active { color: var(--tg-button); }
        .coin-row { border-bottom: 1px solid var(--tg-header-border); }
        .price-up { animation: price-up-flash 0.7s; } .price-down { animation: price-down-flash 0.7s; }
        @keyframes price-up-flash { 0% { background-color: rgba(0, 200, 83, 0.2); } 100% { background-color: transparent; } }
        @keyframes price-down-flash { 0% { background-color: rgba(255, 59, 48, 0.2); } 100% { background-color: transparent; } }
        .loader { border: 4px solid var(--tg-secondary-bg); border-top: 4px solid var(--tg-button); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-backdrop { position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); z-index: 40; backdrop-filter: blur(5px); }
        .modal { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--tg-secondary-bg); z-index: 50; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 1.5rem; transform: translateY(100%); transition: transform 0.3s ease-out; }
        .modal.open { transform: translateY(0); }
        .skeleton { background-color: var(--tg-secondary-bg); border-radius: 8px; animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .sparkline-path { stroke-width: 2; fill: none; }
    </style>
</head>
<body class="antialiased">
    <div class="header">
        <div class="flex justify-between items-center mb-4">
             <h1 class="text-xl font-bold">Shelby bet</h1>
             <button id="converter-btn" class="text-2xl">🧮</button>
        </div>
        <input type="text" id="search-input" placeholder="جستجوی نام ارز..." class="w-full p-2.5 rounded-lg text-sm mb-3">
        <div class="flex items-center justify-between">
             <div class="flex bg-[var(--tg-secondary-bg)] rounded-lg p-1">
                <button id="tab-all" class="tab-button active px-4 py-1.5 rounded-md text-sm font-semibold">همه</button>
                <button id="tab-watchlist" class="tab-button px-4 py-1.5 rounded-md text-sm font-semibold">علاقه‌مندی‌ها</button>
            </div>
             <div id="sort-controls" class="flex items-center space-x-2 space-x-reverse">
                <button class="sort-button active text-xs" data-sort="market_cap_desc">ارزش بازار</button>
                <button class="sort-button text-xs" data-sort="gainers">بیشترین رشد</button>
                <button class="sort-button text-xs" data-sort="losers">بیشترین ریزش</button>
            </div>
        </div>
    </div>

    <div id="summary-container" class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    <div id="coin-list-container" class="h-[calc(100vh-170px)] overflow-y-auto">
        <div id="coin-list" class="relative"></div>
    </div>
    <div id="message-container" class="hidden text-center p-10 text-[var(--tg-hint)]"></div>

    <!-- Details Modal -->
    <div id="details-modal-backdrop" class="modal-backdrop hidden"></div>
    <div id="details-modal" class="modal"><div id="details-modal-content"></div></div>
    
    <!-- Converter Modal -->
    <div id="converter-modal-backdrop" class="modal-backdrop hidden"></div>
    <div id="converter-modal" class="modal"><div id="converter-modal-content"></div></div>


    <script>
        const tg = window.Telegram.WebApp;

        // --- APIs & Config ---
        const CRYPTO_API_URL = "https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=100&page=1&sparkline=true&price_change_percentage=24h";
        const SUMMARY_API_URL = "https://api.tgju.org/v1/market/indicator/summary";
        const PERSIAN_NAMES = { 'bitcoin': 'بیت‌کوین', 'ethereum': 'اتریوم', 'tether': 'تتر', 'binancecoin': 'بایننس کوین', 'solana': 'سولانا', 'ripple': 'ریپل', 'dogecoin': 'دوج‌کوین', 'toncoin': 'تون‌کوین', 'cardano': 'کاردانو', 'shiba-inu': 'شیبا اینو', 'tron': 'ترون' };

        // --- State ---
        let state = { allCoins: [], dollarPrice: 0, watchlist: JSON.parse(localStorage.getItem('watchlist_v5')) || [], activeTab: 'all', currentSort: 'market_cap_desc', searchQuery: '', updateInterval: null };
        
        const formatNum = (n, dec = 2) => new Intl.NumberFormat('en-US', { minimumFractionDigits: dec, maximumFractionDigits: dec }).format(n);
        const formatPercent = (p) => `${parseFloat(p||0) >= 0 ? '+' : ''}${formatNum(p||0)}%`;
        const getChangeClass = (p) => (parseFloat(p||0) >= 0 ? 'text-[var(--positive)]' : 'text-[var(--negative)]');

        // --- Main Render Function ---
        function render() {
            // Logic for filtering, sorting... (omitted for brevity, same as before)
            let coinsToRender = (state.activeTab === 'all') ? state.allCoins : state.allCoins.filter(c => state.watchlist.includes(c.id));
            if (state.currentSort === 'gainers') coinsToRender.sort((a, b) => (b.price_change_percentage_24h || -999) - (a.price_change_percentage_24h || -999));
            else if (state.currentSort === 'losers') coinsToRender.sort((a, b) => (a.price_change_percentage_24h || 999) - (b.price_change_percentage_24h || 999));
            else coinsToRender.sort((a, b) => (a.market_cap_rank || 9999) - (b.market_cap_rank || 9999));
            const query = state.searchQuery.toLowerCase().trim();
            if (query) {
                coinsToRender = coinsToRender.filter(c => c.name.toLowerCase().includes(query) || c.symbol.toLowerCase().includes(query) || (PERSIAN_NAMES[c.id] && PERSIAN_NAMES[c.id].includes(query)));
            }
            
            const messageContainer = document.getElementById('message-container');
            messageContainer.classList.add('hidden');
            if (coinsToRender.length === 0 && state.allCoins.length > 0) {
                messageContainer.textContent = state.activeTab === 'watchlist' ? 'هنوز ارزی به علاقه‌مندی‌ها اضافه نکرده‌اید.' : 'ارزی با این مشخصات یافت نشد.';
                messageContainer.classList.remove('hidden');
            }

            const coinList = document.getElementById('coin-list');
            const coinListContainer = document.getElementById('coin-list-container');
            const ROW_HEIGHT = 76;
            coinList.innerHTML = '';
            coinList.style.height = `${coinsToRender.length * ROW_HEIGHT}px`;

            const scrollTop = coinListContainer.scrollTop;
            const startIndex = Math.floor(scrollTop / ROW_HEIGHT);
            const endIndex = Math.min(startIndex + Math.ceil(coinListContainer.clientHeight / ROW_HEIGHT) + 2, coinsToRender.length);

            const fragment = document.createDocumentFragment();
            for (let i = startIndex; i < endIndex; i++) {
                const coin = coinsToRender[i];
                const row = document.createElement('div');
                row.className = 'coin-row absolute w-full';
                row.style.top = `${i * ROW_HEIGHT}px`;
                row.style.height = `${ROW_HEIGHT}px`;
                row.dataset.coinId = coin.id;
                row.innerHTML = renderCoinRow(coin);
                fragment.appendChild(row);
            }
            coinList.appendChild(fragment);
        }

        function renderCoinRow(coin) {
            const isWatched = state.watchlist.includes(coin.id);
            const tomanPriceNum = state.dollarPrice > 0 ? coin.current_price * state.dollarPrice : 0;
            const tomanPrice = tomanPriceNum > 0 ? formatNum(tomanPriceNum, 0) : '...';
            
            return `
                <div class="flex items-center p-4 h-full">
                    <div class="flex-1 flex items-center space-x-3 space-x-reverse min-w-0">
                        <img src="${coin.image}" alt="${coin.name}" class="w-10 h-10 rounded-full">
                        <div class="truncate">
                            <div class="font-bold text-base truncate">${coin.symbol.toUpperCase()} | ${PERSIAN_NAMES[coin.id.toLowerCase()] || coin.name}</div>
                            <div class="text-xs text-[var(--tg-hint)]">رتبه #${coin.market_cap_rank || '?'}</div>
                        </div>
                    </div>
                    <div class="flex-1 text-right font-mono text-sm">
                        <div class="font-bold text-base" data-price-usd>$${formatNum(coin.current_price, coin.current_price < 0.01 ? 5 : 2)}</div>
                        <div class="text-xs text-[var(--tg-hint)]" data-price-irt>${tomanPrice} تومان</div>
                    </div>
                    <div class="w-20 text-center font-bold ${getChangeClass(coin.price_change_percentage_24h)}" data-change>${formatPercent(coin.price_change_percentage_24h)}</div>
                    <div class="w-10 text-center text-2xl star-icon cursor-pointer" data-watched="${isWatched}">${isWatched ? '★' : '☆'}</div>
                </div>`;
        }
        
        // --- API Calls ---
        async function initialLoad() {
            renderSkeleton();
            const [cryptoRes, summaryRes] = await Promise.allSettled([ fetch(CRYPTO_API_URL), fetch(SUMMARY_API_URL) ]);

            if (summaryRes.status === 'fulfilled') {
                const result = await summaryRes.value.json();
                if (result.data && result.data.price_dollar_rl) {
                    state.dollarPrice = parseFloat(result.data.price_dollar_rl.p) / 10;
                    renderSummary(result.data);
                } else {
                    document.getElementById('summary-container').innerHTML = `<div class="bg-[var(--tg-secondary-bg)] rounded-lg p-4 text-center text-[var(--negative)]">خطا در دریافت قیمت خلاصه</div>`;
                }
            } else { document.getElementById('summary-container').innerHTML = `<div class="bg-[var(--tg-secondary-bg)] rounded-lg p-4 text-center text-[var(--negative)]">خطا در دریافت قیمت طلا و سکه</div>`; }
            
            if (cryptoRes.status === 'fulfilled') {
                state.allCoins = await cryptoRes.value.json();
            } else { document.getElementById('coin-list-container').innerHTML = `<div class="text-center p-10 text-[var(--negative)]">خطا در دریافت لیست ارزها</div>`; }
            
            render();
            if (state.updateInterval) clearInterval(state.updateInterval);
            state.updateInterval = setInterval(liveUpdate, 20000);
        }
        
        async function liveUpdate() {
            try {
                const res = await fetch(CRYPTO_API_URL);
                state.allCoins = await res.json();
                render();
            } catch (e) { console.error("Live update failed", e); }
        }

        // --- UI Setup ---
        function setupUI() {
            // ... (Event listeners for tabs, sort, search)
            let searchTimeout;
            document.getElementById('search-input').addEventListener('input', e => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    state.searchQuery = e.target.value;
                    render();
                }, 300);
            });
            document.getElementById('coin-list-container').addEventListener('scroll', render);
            document.getElementById('coin-list').addEventListener('click', e => {
                const star = e.target.closest('.star-icon');
                const row = e.target.closest('.coin-row');
                if (star) {
                    e.stopPropagation();
                    handleStarClick(star, row.dataset.coinId);
                } else if (row) {
                    openDetailsModal(state.allCoins.find(c => c.id === row.dataset.coinId));
                }
            });
            document.getElementById('converter-btn').addEventListener('click', openConverterModal);
        }

        function handleStarClick(star, coinId) {
            // ... (Watchlist logic)
            if (state.watchlist.includes(coinId)) state.watchlist = state.watchlist.filter(id => id !== coinId);
            else state.watchlist.push(coinId);
            localStorage.setItem('watchlist_v5', JSON.stringify(state.watchlist));
            render();
        }

        function renderSummary(data) {
            // ... (Summary rendering logic)
            const items = { dollar: data.price_dollar_rl, emami: data['sekeh-emami'], gold: data['tala-18'] };
            document.getElementById('summary-container').innerHTML = `
                <div class="bg-[var(--tg-secondary-bg)] rounded-lg p-4 col-span-1 md:col-span-2">
                    <div class="flex justify-between items-center">
                        <span class="font-bold">${items.dollar.title}</span>
                        <div class="text-right font-mono">
                            <span class="font-bold">${formatNum(state.dollarPrice, 0)} <span class="text-xs">T</span></span>
                            <span class="text-xs block ${getChangeClass(items.dollar.c_p)}">${formatPercent(items.dollar.c_p)}</span>
                        </div>
                    </div>
                </div>
                <div class="bg-[var(--tg-secondary-bg)] rounded-lg p-4"><div class="flex justify-between items-center"><span class="font-bold">${items.emami.title}</span><div class="text-right font-mono"><span class="font-bold">${formatNum(items.emami.p / 10, 0)} <span class="text-xs">T</span></span><span class="text-xs block ${getChangeClass(items.emami.c_p)}">${formatPercent(items.emami.c_p)}</span></div></div></div>
                <div class="bg-[var(--tg-secondary-bg)] rounded-lg p-4"><div class="flex justify-between items-center"><span class="font-bold">${items.gold.title}</span><div class="text-right font-mono"><span class="font-bold">${formatNum(items.gold.p / 10, 0)} <span class="text-xs">T</span></span><span class="text-xs block ${getChangeClass(items.gold.c_p)}">${formatPercent(items.gold.c_p)}</span></div></div></div>`;
        }
        
        function renderSkeleton() { /* ... */ }

        // --- Sparkline & Modals ---
        function generateSparkline(prices) {
            const width = 120, height = 40;
            const max = Math.max(...prices), min = Math.min(...prices);
            const len = prices.length;
            const points = prices.map((p, i) => {
                const x = (i / (len - 1)) * width;
                const y = height - ((p - min) / (max - min) * height);
                return `${x},${y}`;
            }).join(' ');
            const color = prices[len - 1] > prices[0] ? 'var(--positive)' : 'var(--negative)';
            return `<svg viewbox="0 0 ${width} ${height}" class="w-full h-10"><polyline class="sparkline-path" points="${points}" stroke="${color}" /></svg>`;
        }

        function openDetailsModal(coin) {
            const modal = document.getElementById('details-modal');
            const backdrop = document.getElementById('details-modal-backdrop');
            const chart = coin.sparkline_in_7d.price ? generateSparkline(coin.sparkline_in_7d.price) : '<div class="h-10 text-center text-sm text-[var(--tg-hint)]">نمودار موجود نیست</div>';
            document.getElementById('details-modal-content').innerHTML = `
                <div class="flex items-center mb-4">
                    <img src="${coin.image}" class="w-12 h-12 rounded-full mr-4">
                    <div><h2 class="text-2xl font-bold">${PERSIAN_NAMES[coin.id] || coin.name}</h2><p class="text-[var(--tg-hint)]">${coin.symbol.toUpperCase()}</p></div>
                </div>
                ${chart}
                <div class="grid grid-cols-2 gap-4 text-sm mt-4">
                    <div class="bg-[var(--tg-bg)] p-3 rounded-lg"><p class="text-[var(--tg-hint)]">قیمت</p><p class="font-bold text-lg">$${formatNum(coin.current_price, 4)}</p></div>
                    <div class="bg-[var(--tg-bg)] p-3 rounded-lg"><p class="text-[var(--tg-hint)]">تغییرات ۲۴ ساعت</p><p class="font-bold text-lg ${getChangeClass(coin.price_change_percentage_24h)}">${formatPercent(coin.price_change_percentage_24h)}</p></div>
                </div>`;
            backdrop.classList.remove('hidden');
            modal.classList.add('open');
            backdrop.onclick = () => { modal.classList.remove('open'); backdrop.classList.add('hidden'); };
        }
        
        function openConverterModal() {
            const modal = document.getElementById('converter-modal');
            const backdrop = document.getElementById('converter-modal-backdrop');
            const options = state.allCoins.map(c => `<option value="${c.id}">${PERSIAN_NAMES[c.id] || c.name}</option>`).join('');
            document.getElementById('converter-modal-content').innerHTML = `
                <h2 class="text-xl font-bold mb-4">مبدل ارز</h2>
                <div class="space-y-3">
                    <div>
                        <select id="converter-coin" class="w-full p-3 bg-[var(--tg-bg)] rounded-lg">${options}</select>
                    </div>
                    <div class="flex items-center bg-[var(--tg-bg)] rounded-lg"><input type="number" id="converter-amount-crypto" class="w-full p-3 bg-transparent" placeholder="مقدار ارز"><span id="converter-symbol" class="pl-3 text-[var(--tg-hint)]">BTC</span></div>
                    <div class="flex items-center bg-[var(--tg-bg)] rounded-lg"><input type="number" id="converter-amount-usd" class="w-full p-3 bg-transparent" placeholder="معادل دلار"><span class="pl-3 text-[var(--tg-hint)]">$</span></div>
                    <div class="flex items-center bg-[var(--tg-bg)] rounded-lg"><input type="number" id="converter-amount-irt" class="w-full p-3 bg-transparent" placeholder="معادل تومان"><span class="pl-3 text-[var(--tg-hint)]">T</span></div>
                </div>`;
            
            backdrop.classList.remove('hidden');
            modal.classList.add('open');
            backdrop.onclick = () => { modal.classList.remove('open'); backdrop.classList.add('hidden'); };
            
            // Attach converter logic
            const coinSelect = document.getElementById('converter-coin');
            const cryptoInput = document.getElementById('converter-amount-crypto');
            const usdInput = document.getElementById('converter-amount-usd');
            const irtInput = document.getElementById('converter-amount-irt');
            const symbolSpan = document.getElementById('converter-symbol');
            
            let activeInput = null;
            
            function calculate() {
                const coin = state.allCoins.find(c => c.id === coinSelect.value);
                if (!coin) return;
                
                const cryptoAmount = parseFloat(cryptoInput.value) || 0;
                const usdAmount = parseFloat(usdInput.value) || 0;
                const irtAmount = parseFloat(irtInput.value) || 0;

                if (activeInput === 'crypto') {
                    usdInput.value = formatNum(cryptoAmount * coin.current_price, 2).replace(/,/g, '');
                    irtInput.value = formatNum(cryptoAmount * coin.current_price * state.dollarPrice, 0).replace(/,/g, '');
                } else if (activeInput === 'usd') {
                    cryptoInput.value = formatNum(usdAmount / coin.current_price, 6).replace(/,/g, '');
                    irtInput.value = formatNum(usdAmount * state.dollarPrice, 0).replace(/,/g, '');
                } else if (activeInput === 'irt') {
                    const usdVal = irtAmount / state.dollarPrice;
                    usdInput.value = formatNum(usdVal, 2).replace(/,/g, '');
                    cryptoInput.value = formatNum(usdVal / coin.current_price, 6).replace(/,/g, '');
                }
            }
            
            coinSelect.onchange = () => {
                const coin = state.allCoins.find(c => c.id === coinSelect.value);
                symbolSpan.textContent = coin.symbol.toUpperCase();
                calculate();
            };
            cryptoInput.onfocus = () => activeInput = 'crypto';
            usdInput.onfocus = () => activeInput = 'usd';
            irtInput.onfocus = () => activeInput = 'irt';
            
            cryptoInput.oninput = calculate;
            usdInput.oninput = calculate;
            irtInput.oninput = calculate;

            coinSelect.dispatchEvent(new Event('change'));
        }

        // --- App Init ---
        document.addEventListener('DOMContentLoaded', () => {
            tg.ready(); tg.expand();
            tg.setHeaderColor('#121212'); tg.setBackgroundColor('#121212');
            setupUI();
            initialLoad();
        });
    </script>
</body>
</html>

