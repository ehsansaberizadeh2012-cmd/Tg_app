<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no, user-scalable=no">
    <title>Shelby Bet</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ÙÙˆÙ†Øª Vazirmatn Ø¨Ø±Ø§ÛŒ RTL Ù…Ù†Ø§Ø³Ø¨ Ø§Ø³Øª -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ØªØ¹Ø±ÛŒÙ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ ØªÙ… ØªØ§Ø±ÛŒÚ© Ùˆ Ø±ÙˆØ´Ù† */
        :root {
            --bg: #121212; --text: #EAECEF; --hint: #707A8A;
            --button: #2E81FF; --secondary-bg: #1E1E1E; --header-border: #2A2A2A;
            --positive: #00C853; --negative: #FF3B30;
        }
        .light-theme {
            --bg: #FFFFFF; --text: #1c1c1e; --hint: #8e8e93;
            --button: #007AFF; --secondary-bg: #F2F2F7; --header-border: #e5e5ea;
        }
        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡ */
        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; padding-bottom: 70px; transition: background-color 0.3s, color 0.3s; -webkit-tap-highlight-color: transparent; }
        .page { display: none; min-height: calc(100vh - 70px); }
        .page.active { display: block; }
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ù†ÙˆØ§Ø± Ø¨Ø§Ù„Ø§ Ùˆ Ù†ÙˆØ§Ø± Ù¾ÛŒÙ…Ø§ÛŒØ´ */
        .header { background-color: var(--bg); position: sticky; top: 0; z-index: 20; padding: 1rem; border-bottom: 1px solid var(--header-border); transition: background-color 0.3s, border-color 0.3s; }
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--secondary-bg); border-top: 1px solid var(--header-border); z-index: 30; display: flex; justify-content: space-around; padding-top: 0.5rem; height: 65px; transition: background-color 0.3s, border-color 0.3s; }
        .nav-button { flex: 1; text-align: center; padding: 0.25rem; color: var(--hint); cursor: pointer; transition: color 0.2s; }
        .nav-button.active { color: var(--button); }
        .nav-icon { height: 24px; width: 24px; margin: 0 auto 4px; stroke-width: 2; }
        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù„ÛŒØ³Øª Ø§Ø±Ø²Ù‡Ø§ Ùˆ Ø§Ø³Ú©Ù„ØªÙˆÙ† Ù„ÙˆØ¯ÛŒÙ†Ú¯ */
        .tab-button { border: 1px solid var(--header-border); }
        .tab-button.active { background-color: var(--button); color: white; border-color: var(--button); }
        .sort-button.active { color: var(--button); }
        .sparkline-path { stroke-width: 2; fill: none; }
        .skeleton { background-color: var(--secondary-bg); border-radius: 8px; animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ø¯Ø§Ù„ */
        .modal-backdrop { position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); z-index: 40; backdrop-filter: blur(5px); }
        .modal { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--secondary-bg); z-index: 50; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 1.5rem; transform: translateY(100%); transition: transform 0.3s ease-out; }
        .modal.open { transform: translateY(0); }
        .toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 10px 20px; border-radius: 8px; z-index: 100; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body class="antialiased">

    <!-- =========== Pages Container =========== -->
    
    <!-- 1. ØµÙØ­Ù‡ Ø¨Ø§Ø²Ø§Ø±Ù‡Ø§ (Markets) - ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ -->
    <div id="markets-page" class="page active">
        <div class="header">
            <h1 data-i18n-key="marketHeader" class="text-xl font-bold text-center mb-4"></h1>
            <input type="text" id="search-input" data-i18n-placeholder="searchPlaceholder" class="w-full p-2.5 rounded-lg text-sm mb-3" style="background-color: var(--secondary-bg); border: 1px solid var(--header-border); color: var(--text);">
            <div class="flex items-center justify-between">
                 <div class="flex bg-[var(--secondary-bg)] rounded-lg p-1">
                    <button id="tab-all" class="tab-button active px-3 py-1.5 rounded-md text-xs font-semibold" data-i18n-key="all"></button>
                    <button id="tab-watchlist" class="tab-button px-3 py-1.5 rounded-md text-xs font-semibold" data-i18n-key="watchlist"></button>
                </div>
                 <div id="sort-controls" class="flex items-center space-x-1 space-x-reverse">
                    <button class="sort-button active text-xs px-2" data-sort="market_cap_desc" data-i18n-key="marketCap"></button>
                    <button class="sort-button text-xs px-2" data-sort="gainers" data-i18n-key="gainers"></button>
                    <button class="sort-button text-xs px-2" data-sort="losers" data-i18n-key="losers"></button>
                </div>
            </div>
        </div>
        <!-- Ø®Ù„Ø§ØµÙ‡â€ŒÙˆØ¶Ø¹ÛŒØª Ø¨Ø§Ø²Ø§Ø± Ùˆ Ù‚ÛŒÙ…Øª Ø¯Ù„Ø§Ø± -->
        <div id="summary-container" class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        <!-- Ù„ÛŒØ³Øª Ø§Ø±Ø²Ù‡Ø§ Ø¨Ø§ Infinite Scroll -->
        <div id="coin-list-container" class="h-[calc(100vh-230px)] overflow-y-auto">
            <div id="coin-list" class="relative"></div>
        </div>
        <div id="message-container" class="hidden text-center p-10 text-[var(--hint)]"></div>
    </div>

    <!-- 2. ØµÙØ­Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ (Profile) -->
    <div id="profile-page" class="page"></div>
    
    <!-- 3. ØµÙØ­Ù‡ "Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ" (Ø¨Ø±Ø§ÛŒ Wallet, Converter, Shop) -->
    <div id="coming-soon-page" class="page"></div>

    <!-- =========== Navigation Bar - Ù†ÙˆØ§Ø± Ù¾ÛŒÙ…Ø§ÛŒØ´ (Fixed Bottom) =========== -->
    <nav class="nav-bar">
        
        <!-- 1. Ú©ÛŒÙ Ù¾ÙˆÙ„ (Wallet) -->
        <button class="nav-button" data-page="coming-soon-page" data-page-key="wallet">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
            <span data-i18n-key="wallet" class="block text-xs"></span>
        </button>
        
        <!-- 2. Ø¨Ø§Ø²Ø§Ø±Ù‡Ø§ (Markets) - ÙØ¹Ø§Ù„ -->
        <button class="nav-button active" data-page="markets-page">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
            <span data-i18n-key="markets" class="block text-xs"></span>
        </button>
        
        <!-- 3. ØªØ¨Ø¯ÛŒÙ„ (Converter) -->
        <button class="nav-button" data-page="coming-soon-page" data-page-key="converter">
             <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            <span data-i18n-key="converter" class="block text-xs"></span>
        </button>
        
        <!-- 4. ÙØ±ÙˆØ´Ú¯Ø§Ù‡ (Shop) -->
        <button class="nav-button" data-page="coming-soon-page" data-page-key="shop">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4m-1.5 5h11m-11 0a2 2 0 01-2-2v-5a2 2 0 012-2h11a2 2 0 012 2v5a2 2 0 01-2 2h-11z"></path></svg>
            <span data-i18n-key="shop" class="block text-xs"></span>
        </button>
        
        <!-- 5. Ù¾Ø±ÙˆÙØ§ÛŒÙ„ (Profile) -->
        <button class="nav-button" data-page="profile-page">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
            <span data-i18n-key="profile" class="block text-xs"></span>
        </button>
        
    </nav>

    <!-- Modals and Toast -->
    <div id="modal-backdrop" class="modal-backdrop hidden" onclick="closeModal()"></div>
    <div id="modal" class="modal"><div id="modal-content" class="h-[70vh] overflow-y-auto"></div></div>
    <div id="toast" class="toast"></div>

    <script>
    //============== START OF FULL JAVASCRIPT CODE ==============
    
    // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ú¯Ù„ÙˆØ¨Ø§Ù„
    const tg = window.Telegram.WebApp;

    // --- I18N Translations (Ú†Ù‡Ø§Ø± Ø²Ø¨Ø§Ù† Ú©Ø§Ù…Ù„) ---
    const translations = {
        en: { 
            markets: "Markets", profile: "Profile", converter: "Converter", marketHeader: "Crypto Markets", searchPlaceholder: "Search coins...", all: "All", watchlist: "Watchlist", marketCap: "Market Cap", gainers: "Gainers", losers: "Losers", emailSaved: "Email saved!", walletSaved: "Wallet address saved!", walletDeleted: "Wallet deleted!", copied: "Copied!", settings: "Settings", theme: "Theme", dark: "Dark", light: "Light", language: "Language", userInfo: "User Info", name: "Name", username: "Username", userId: "User ID", emailOptional: "Email (Optional)", notSet: "Not set", wallets: "Wallets", walletsCount: "{count} saved wallets", tryAgain: "Try Again", errorFetchSummary: "Error fetching summary data", errorFetchCrypto: "Error fetching crypto list", noResults: "No coins found.", emptyWatchlist: "Your watchlist is empty.", rank: "Rank", editEmail: "Edit Email", enterEmail: "Enter your email", save: "Save", invalidEmail: "Invalid email address.", editWallets: "Wallet Addresses", noWallets: "No wallets added yet.", addNewWallet: "Add New Wallet", editWallet: "Edit Wallet", addWallet: "Add Wallet", selectCoin: "Select Coin", walletAddress: "Wallet Address...", back: "Back", confirmDelete: "Are you sure you want to delete {symbol} wallet?", cryptoAmount: "Coin Amount", usdEquivalent: "USD Equivalent", irtEquivalent: "Toman Equivalent", coinDetails: "Coin Details", price: "Price", change24h: "24h Change", high24h: "24h High", low24h: "24h Low", volume24h: "24h Volume", chartUnavailable: "Chart unavailable", shop: "Shop", wallet: "Wallet", usingCachedPrice: "Using cached price", comingSoon: "Coming Soon!", comingSoonMessage: "This page ({pageName}) is under development and will be available soon.", 
        },
        fa: { 
            markets: "Ø¨Ø§Ø²Ø§Ø±Ù‡Ø§", profile: "Ù¾Ø±ÙˆÙØ§ÛŒÙ„", converter: "Ù…Ø¨Ø¯Ù„", marketHeader: "Ø¨Ø§Ø²Ø§Ø± Ø§Ø±Ø²Ù‡Ø§ÛŒ Ø¯ÛŒØ¬ÛŒØªØ§Ù„", searchPlaceholder: "Ø¬Ø³ØªØ¬ÙˆÛŒ Ø§Ø±Ø²...", all: "Ù‡Ù…Ù‡", watchlist: "Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§", marketCap: "Ø§Ø±Ø²Ø´ Ø¨Ø§Ø²Ø§Ø±", gainers: "Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø±Ø´Ø¯", losers: "Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø§ÙØª", emailSaved: "Ø§ÛŒÙ…ÛŒÙ„ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!", walletSaved: "Ø¢Ø¯Ø±Ø³ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!", walletDeleted: "Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø­Ø°Ù Ø´Ø¯!", copied: "Ú©Ù¾ÛŒ Ø´Ø¯!", settings: "ØªÙ†Ø¸ÛŒÙ…Ø§Øª", theme: "Ù¾ÙˆØ³ØªÙ‡", dark: "ØªØ§Ø±ÛŒÚ©", light: "Ø±ÙˆØ´Ù†", language: "Ø²Ø¨Ø§Ù†", userInfo: "Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±", name: "Ù†Ø§Ù…", username: "Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ", userId: "Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±", emailOptional: "Ø§ÛŒÙ…ÛŒÙ„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)", notSet: "ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡", wallets: "Ú©ÛŒÙ Ù¾ÙˆÙ„â€ŒÙ‡Ø§", walletsCount: "{count} Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡", tryAgain: "ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯", errorFetchSummary: "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù‚ÛŒÙ…Øª Ø·Ù„Ø§ Ùˆ Ø³Ú©Ù‡", errorFetchCrypto: "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø§Ø±Ø²Ù‡Ø§", noResults: "Ø§Ø±Ø²ÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ù…Ø´Ø®ØµØ§Øª ÛŒØ§ÙØª Ù†Ø´Ø¯.", emptyWatchlist: "Ù‡Ù†ÙˆØ² Ø§Ø±Ø²ÛŒ Ø¨Ù‡ Ø¹Ù„Ø§Ù‚Ù‡â€ŒÙ…Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.", rank: "Ø±ØªØ¨Ù‡", editEmail: "ÙˆÛŒØ±Ø§ÛŒØ´ Ø§ÛŒÙ…ÛŒÙ„", enterEmail: "Ø§ÛŒÙ…ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯", save: "Ø°Ø®ÛŒØ±Ù‡", invalidEmail: "Ø¢Ø¯Ø±Ø³ Ø§ÛŒÙ…ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.", editWallets: "Ø¢Ø¯Ø±Ø³ Ú©ÛŒÙ Ù¾ÙˆÙ„", noWallets: "Ù‡Ù†ÙˆØ² Ø¢Ø¯Ø±Ø³ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.", addNewWallet: "Ø§ÙØ²ÙˆØ¯Ù† Ø¢Ø¯Ø±Ø³ Ø¬Ø¯ÛŒØ¯", editWallet: "ÙˆÛŒØ±Ø§ÛŒØ´ Ø¢Ø¯Ø±Ø³", addWallet: "Ø§ÙØ²ÙˆØ¯Ù† Ø¢Ø¯Ø±Ø³", selectCoin: "Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø±Ø²", walletAddress: "Ø¢Ø¯Ø±Ø³ Ú©ÛŒÙ Ù¾ÙˆÙ„...", back: "Ø¨Ø§Ø²Ú¯Ø´Øª", confirmDelete: "Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ú©ÛŒÙ Ù¾ÙˆÙ„ {symbol} Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ", cryptoAmount: "Ù…Ù‚Ø¯Ø§Ø± Ø§Ø±Ø²", usdEquivalent: "Ù…Ø¹Ø§Ø¯Ù„ Ø¯Ù„Ø§Ø±ÛŒ", irtEquivalent: "Ù…Ø¹Ø§Ø¯Ù„ ØªÙˆÙ…Ø§Ù†ÛŒ", coinDetails: "Ø¬Ø²Ø¦ÛŒØ§Øª Ø§Ø±Ø²", price: "Ù‚ÛŒÙ…Øª", change24h: "ØªØºÛŒÛŒØ± Û²Û´ Ø³Ø§Ø¹ØªÙ‡", high24h: "Ø¨Ø§Ù„Ø§ØªØ±ÛŒÙ† Û²Û´ Ø³Ø§Ø¹ØªÙ‡", low24h: "Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ±ÛŒÙ† Û²Û´ Ø³Ø§Ø¹ØªÙ‡", volume24h: "Ø­Ø¬Ù… Ù…Ø¹Ø§Ù…Ù„Ø§Øª (Û²Û´ Ø³Ø§Ø¹ØªÙ‡)", chartUnavailable: "Ù†Ù…ÙˆØ¯Ø§Ø± Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª", shop: "ÙØ±ÙˆØ´Ú¯Ø§Ù‡", wallet: "Ú©ÛŒÙ Ù¾ÙˆÙ„", usingCachedPrice: "Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù†Ø±Ø® Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ Ù‚Ø¨Ù„ÛŒ", comingSoon: "Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ!", comingSoonMessage: "Ø§ÛŒÙ† ØµÙØ­Ù‡ ({pageName}) Ø¯Ø± Ø­Ø§Ù„ ØªÙˆØ³Ø¹Ù‡ Ø§Ø³Øª Ùˆ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø®ÙˆØ§Ù‡Ø¯ Ø¨ÙˆØ¯.",
        },
        ar: { 
            markets: "Ø§Ù„Ø£Ø³ÙˆØ§Ù‚", profile: "Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ", converter: "Ù…Ø­ÙˆÙ„", marketHeader: "Ø§Ù„Ø£Ø³ÙˆØ§Ù‚", searchPlaceholder: "Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…Ù„Ø©...", all: "Ø§Ù„ÙƒÙ„", watchlist: "Ø§Ù„Ù…ÙØ¶Ù„Ø©", marketCap: "Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø³ÙˆÙ‚ÙŠØ©", gainers: "Ø§Ù„Ø£ÙƒØ«Ø± Ø±Ø¨Ø­Ù‹Ø§", losers: "Ø§Ù„Ø£ÙƒØ«Ø± Ø®Ø³Ø§Ø±Ø©", emailSaved: "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ!", walletSaved: "ØªÙ… Ø­ÙØ¸ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©!", walletDeleted: "ØªÙ… Ø­Ø°Ù Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©!", copied: "ØªÙ… Ø§Ù„Ù†Ø³Ø®!", settings: "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", theme: "Ù…Ø¸Ù‡Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚", dark: "Ø¯Ø§ÙƒÙ†", light: "ÙØ§ØªØ­", language: "Ø§Ù„Ù„ØºØ©", userInfo: "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", name: "Ø§Ù„Ø§Ø³Ù…", username: "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", userId: "Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", emailOptional: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)", notSet: "Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ†Ù‡", wallets: "Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ù…Ø­ÙØ¸Ø©", walletsCount: "{count} Ø¹Ù†Ø§ÙˆÙŠÙ† Ù…Ø­ÙÙˆØ¸Ø©", tryAgain: "Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰", errorFetchSummary: "Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø°Ù‡Ø¨ ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Øª", errorFetchCrypto: "Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Øª", noResults: "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬.", emptyWatchlist: "Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ ÙØ§Ø±ØºØ©.", rank: "Ù…Ø±ØªØ¨Ø©", editEmail: "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ", enterEmail: "Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ", save: "Ø­ÙØ¸", invalidEmail: "Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­.", editWallets: "Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ù…Ø­ÙØ¸Ø©", noWallets: "Ù„Ù… ØªØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ø¹Ù†Ø§ÙˆÙŠÙ† Ø¨Ø¹Ø¯.", addNewWallet: "Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯", editWallet: "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†", addWallet: "Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ÙˆØ§Ù†", selectCoin: "Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„Ø©", walletAddress: "Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©...", back: "Ø±Ø¬ÙˆØ¹", confirmDelete: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù…Ø­ÙØ¸Ø© {symbol}ØŸ", cryptoAmount: "ÙƒÙ…ÙŠØ© Ø§Ù„Ø¹Ù…Ù„Ø©", usdEquivalent: "Ù…Ø§ ÙŠØ¹Ø§Ø¯Ù„ Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±", irtEquivalent: "Ù…Ø§ ÙŠØ¹Ø§Ø¯Ù„ Ø¨Ø§Ù„ØªÙˆÙ…Ø§Ù†", coinDetails: "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø©", price: "Ø§Ù„Ø³Ø¹Ø±", change24h: "Ø§Ù„ØªØºÙŠÙŠØ± Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©", high24h: "Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø± Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©", low24h: "Ø£Ø¯Ù†Ù‰ Ø³Ø¹Ø± Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©", volume24h: "Ø­Ø¬Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„ (24 Ø³Ø§Ø¹Ø©)", chartUnavailable: "Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ ØºÙŠØ± Ù…ØªÙˆÙØ±", shop: "Ø§Ù„Ù…ØªØ¬Ø±", wallet: "Ø§Ù„Ù…Ø­ÙØ¸Ø©", usingCachedPrice: "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø®Ø²Ù† Ù…Ø¤Ù‚ØªÙ‹Ø§", comingSoon: "Ù‚Ø±ÙŠØ¨Ù‹Ø§!", comingSoonMessage: "Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ({pageName}) Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ± ÙˆØ³ØªÙƒÙˆÙ† Ù…ØªØ§Ø­Ø© Ù‚Ø±ÙŠØ¨Ù‹Ø§.",
        },
        zh: { 
            markets: "å¸‚åœº", profile: "ä¸ªäººèµ„æ–™", converter: "è½¬æ¢å™¨", marketHeader: "åŠ å¯†å¸‚åœº", searchPlaceholder: "æœç´¢å¸ç§...", all: "å…¨éƒ¨", watchlist: "å…³æ³¨åˆ—è¡¨", marketCap: "å¸‚å€¼", gainers: "æ¶¨å¹…æ¦œ", losers: "è·Œå¹…æ¦œ", emailSaved: "é‚®ä»¶å·²ä¿å­˜!", walletSaved: "é’±åŒ…åœ°å€å·²ä¿å­˜!", walletDeleted: "é’±åŒ…å·²åˆ é™¤!", copied: "å·²å¤åˆ¶!", settings: "è®¾ç½®", theme: "ä¸»é¢˜", dark: "æ·±è‰²", light: "æµ…è‰²", language: "è¯­è¨€", userInfo: "ç”¨æˆ·ä¿¡æ¯", name: "åç§°", username: "ç”¨æˆ·å", userId: "ç”¨æˆ·ID", emailOptional: "ç”µå­é‚®ä»¶ (å¯é€‰)", notSet: "æœªè®¾ç½®", wallets: "é’±åŒ…", walletsCount: "{count} ä¸ªå·²ä¿å­˜é’±åŒ…", tryAgain: "é‡è¯•", errorFetchSummary: "è·å–æ‘˜è¦æ•°æ®é”™è¯¯", errorFetchCrypto: "è·å–å¸ç§åˆ—è¡¨é”™è¯¯", noResults: "æœªæ‰¾åˆ°ä»»ä½•å¸ç§ã€‚", emptyWatchlist: "æ‚¨çš„å…³æ³¨åˆ—è¡¨ä¸ºç©ºã€‚", rank: "æ’å", editEmail: "ç¼–è¾‘é‚®ä»¶", enterEmail: "è¾“å…¥æ‚¨çš„ç”µå­é‚®ä»¶", save: "ä¿å­˜", invalidEmail: "æ— æ•ˆçš„ç”µå­é‚®ä»¶åœ°å€ã€‚", editWallets: "é’±åŒ…åœ°å€", noWallets: "å°šæœªæ·»åŠ é’±åŒ…åœ°å€ã€‚", addNewWallet: "æ·»åŠ æ–°é’±åŒ…", editWallet: "ç¼–è¾‘é’±åŒ…", addWallet: "æ·»åŠ é’±åŒ…", selectCoin: "é€‰æ‹©å¸ç§", walletAddress: "é’±åŒ…åœ°å€...", back: "è¿”å›", confirmDelete: "ç¡®å®šåˆ é™¤ {symbol} é’±åŒ…å—ï¼Ÿ", cryptoAmount: "å¸ç§æ•°é‡", usdEquivalent: "ç¾å…ƒç­‰å€¼", irtEquivalent: "Tomanç­‰å€¼", coinDetails: "å¸ç§è¯¦æƒ…", price: "ä»·æ ¼", change24h: "24å°æ—¶å˜åŒ–", high24h: "24å°æ—¶æœ€é«˜", low24h: "24å°æ—¶æœ€ä½", volume24h: "24å°æ—¶äº¤æ˜“é‡", chartUnavailable: "å›¾è¡¨ä¸å¯ç”¨", shop: "å•†åº—", wallet: "é’±åŒ…", usingCachedPrice: "ä½¿ç”¨ç¼“å­˜ä»·æ ¼", comingSoon: "å³å°†æ¨å‡º!", comingSoonMessage: "æ­¤é¡µé¢ ({pageName}) æ­£åœ¨å¼€å‘ä¸­ï¼Œå³å°†æ¨å‡ºã€‚",
        },
    };
    
    let activeLanguage = localStorage.getItem('language_v10') || 'fa';
    const isRTL = ['fa', 'ar'].includes(activeLanguage);
    
    // ØªØ§Ø¨Ø¹ ØªØ±Ø¬Ù…Ù‡
    const i18n = (key, params = {}) => {
        let translation = translations[activeLanguage]?.[key] || translations.en[key] || key;
        for (const pKey in params) { translation = translation.replace(`{${pKey}}`, params[pKey]); }
        return translation;
    };
    
    // Ù†Ø§Ù… ÙØ§Ø±Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ùˆ Ø¬Ø³ØªØ¬Ùˆ
    const PERSIAN_NAMES = { 'bitcoin': 'Ø¨ÛŒØªâ€ŒÚ©ÙˆÛŒÙ†', 'ethereum': 'Ø§ØªØ±ÛŒÙˆÙ…', 'tether': 'ØªØªØ±', 'binancecoin': 'Ø¨Ø§ÛŒÙ†Ù†Ø³ Ú©ÙˆÛŒÙ†', 'solana': 'Ø³ÙˆÙ„Ø§Ù†Ø§', 'ripple': 'Ø±ÛŒÙ¾Ù„', 'dogecoin': 'Ø¯ÙˆØ¬â€ŒÚ©ÙˆÛŒÙ†', 'toncoin': 'ØªÙˆÙ†â€ŒÚ©ÙˆÛŒÙ†', 'cardano': 'Ú©Ø§Ø±Ø¯Ø§Ù†Ùˆ', 'shiba-inu': 'Ø´ÛŒØ¨Ø§ Ø§ÛŒÙ†Ùˆ', 'tron': 'ØªØ±ÙˆÙ†', 'notcoin': 'Ù†Ø§Øªâ€ŒÚ©ÙˆÛŒÙ†', 'pepe': 'Ù¾Ù¾Ù‡', 'floki': 'ÙÙ„ÙˆÚ©ÛŒ' };
    
    // Ø¢ÛŒØ¯ÛŒ Ø§Ø±Ø²Ù‡Ø§ÛŒ Ø®Ø§Øµ
    const EXTRA_COIN_IDS = 'toncoin,notcoin,dogecoin,shiba-inu,pepe,floki'; 

    const state = {
        allCoins: [], dollarPrice: 0, summaryData: null,
        watchlist: JSON.parse(localStorage.getItem('watchlist_v10')) || [],
        activeTab: localStorage.getItem('activeTab_v10') || 'all',
        currentSort: localStorage.getItem('currentSort_v10') || 'market_cap_desc',
        searchQuery: '',
        userEmail: localStorage.getItem('userEmail_v10') || '',
        wallets: JSON.parse(localStorage.getItem('wallets_v10')) || {},
        theme: localStorage.getItem('theme_v10') || 'dark',
        language: activeLanguage, 
        isLoading: { summary: true, crypto: true },
        errors: { summary: null, crypto: null },
        updateInterval: null,
        maxPages: 4, 
        loadedPages: 1, 
    };
    
    const SUMMARY_API_URL = "https://api.tgju.org/v1/market/indicator/summary";

    // ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ
    const formatNum = (n, dec = 2) => new Intl.NumberFormat('en-US', { minimumFractionDigits: dec, maximumFractionDigits: dec, useGrouping: true }).format(n);
    const formatPercent = (p) => `${parseFloat(p||0) >= 0 ? '+' : ''}${formatNum(p||0)}%`;
    const getChangeClass = (p) => (parseFloat(p||0) >= 0 ? 'text-[var(--positive)]' : 'text-[var(--negative)]');
    const fetchWithTimeout = (url, timeout = 10000) => {
        const controller = new AbortController();
        const signal = controller.signal;
        const promise = fetch(url, { signal });
        const timeoutPromise = new Promise((_, reject) => setTimeout(() => {
            controller.abort();
            reject(new Error('Request timed out'));
        }, timeout));
        return Promise.race([promise, timeoutPromise]);
    };

    function render() {
        renderSummary();
        renderCryptoList();
        translateUI();
    }
    
    // ØªØ§Ø¨Ø¹ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø®Ù„Ø§ØµÙ‡ (Ù‚ÛŒÙ…Øª Ø¯Ù„Ø§Ø±)
    async function loadSummaryData() {
        state.isLoading.summary = true; state.errors.summary = null; render();
        const lastDollarPrice = parseFloat(localStorage.getItem('lastDollarPrice_v10')) || 0; 
        try {
            const response = await fetchWithTimeout(SUMMARY_API_URL);
            if (!response.ok) throw new Error(`Server Error (${response.status})`);
            const result = await response.json();
            if (!result.data || !result.data.price_dollar_rl) throw new Error('Invalid API response');
            // Ù‚ÛŒÙ…Øª Ø¯Ù„Ø§Ø± Ø§Ø² Ø±ÛŒØ§Ù„ Ø¨Ù‡ ØªÙˆÙ…Ø§Ù† ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒØ´ÙˆØ¯ (ØªÙ‚Ø³ÛŒÙ… Ø¨Ø± Û±Û°)
            const newDollarPrice = parseFloat(result.data.price_dollar_rl.p) / 10;
            state.dollarPrice = newDollarPrice;
            localStorage.setItem('lastDollarPrice_v10', newDollarPrice); 
            state.summaryData = { dollar: result.data.price_dollar_rl, emami: result.data['sekeh-emami'], gold: result.data['tala-18'] };
        } catch (error) { 
            console.error("Summary API Error:", error); 
            if (lastDollarPrice > 0) {
                state.dollarPrice = lastDollarPrice;
                state.errors.summary = `â—ï¸ ${i18n('errorFetchSummary')} - ${i18n('usingCachedPrice')}`; 
            } else {
                state.errors.summary = i18n('errorFetchSummary');
            }
        } finally { 
            state.isLoading.summary = false; 
            render(); 
        }
    }
    
    function renderSummary() {
        const container = document.getElementById('summary-container');
        if (state.isLoading.summary) {
            container.innerHTML = `<div class="h-16 skeleton"></div><div class="h-16 skeleton"></div>`;
            return;
        }
        if (state.errors.summary) {
            container.innerHTML = `<div class="col-span-full bg-red-500/20 text-red-400 rounded-lg p-3 text-center text-sm">${state.errors.summary}</div>`;
            return;
        }

        const dollarData = state.summaryData.dollar;
        const goldData = state.summaryData.gold;

        const renderCard = (titleKey, price, change, symbol) => {
            const changeClass = getChangeClass(change);
            const formattedPrice = formatNum(price / 10, 0); // ØªØ¨Ø¯ÛŒÙ„ Ø±ÛŒØ§Ù„ Ø¨Ù‡ ØªÙˆÙ…Ø§Ù†
            return `
                <div class="bg-[var(--secondary-bg)] p-3 rounded-xl shadow-md flex justify-between items-center transition duration-200">
                    <div>
                        <div class="text-[var(--hint)] text-xs" data-i18n-key="${titleKey}"></div>
                        <div class="font-bold text-lg">${formattedPrice} ${symbol}</div>
                    </div>
                    <div class="text-xs font-mono ${changeClass}">${formatPercent(change)}</div>
                </div>
            `;
        };

        container.innerHTML = `
            ${renderCard('dollar', dollarData.p, dollarData.d, 'T')}
            ${renderCard('gold', goldData.p, goldData.d, 'T')}
        `;
        translateUI();
    }
    
    // ØªØ§Ø¨Ø¹ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø±ÛŒÙ¾ØªÙˆ
    async function loadCryptoData(isUpdate = false) {
        if (!isUpdate && state.loadedPages === 1) { state.isLoading.crypto = true; state.errors.crypto = null; }
        
        const baseUrl = "https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=250&sparkline=true&price_change_percentage=24h";
        const extraCoinsUrl = `https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=${EXTRA_COIN_IDS}&sparkline=true&price_change_percentage=24h`;
        
        try {
            const fetchPromises = [];
            fetchPromises.push(fetchWithTimeout(`${baseUrl}&page=${state.loadedPages}`));

            if (state.loadedPages === 1) {
                 fetchPromises.push(fetchWithTimeout(extraCoinsUrl));
            }

            const responses = await Promise.all(fetchPromises);
            
            const marketCapData = await responses[0].json();
            const extraCoinsData = (state.loadedPages === 1 && responses.length > 1) ? await responses[1].json() : [];

            const marketCapIds = new Set(marketCapData.map(c => c.id));
            const uniqueExtraCoins = extraCoinsData.filter(c => !marketCapIds.has(c.id));
            
            if (state.loadedPages === 1) {
                state.allCoins = uniqueExtraCoins.concat(marketCapData);
            } else {
                state.allCoins = state.allCoins.concat(marketCapData);
            }
            
            state.errors.crypto = null;
            
        } catch (error) { 
            console.error("Crypto API Error:", error); 
            if (!isUpdate && state.allCoins.length === 0) {
                state.errors.crypto = i18n('errorFetchCrypto');
            }
        } finally { 
            if (!isUpdate) state.isLoading.crypto = false; 
            render(); 
        }
    }
    
    function renderCryptoList() {
        const container = document.getElementById('coin-list-container');
        const listEl = document.getElementById('coin-list');
        const messageEl = document.getElementById('message-container');
        
        if (state.isLoading.crypto) { 
            container.style.display = 'block';
            listEl.innerHTML = `<div class="p-4 space-y-2">${Array(10).fill('').map(() => `<div class="h-[68px] skeleton"></div>`).join('')}</div>`;
            messageEl.classList.add('hidden');
            return;
        }
        if (state.errors.crypto) { 
            container.style.display = 'none';
            messageEl.classList.remove('hidden');
            messageEl.innerHTML = `<div class="bg-red-500/20 text-red-400 rounded-lg p-4 text-center">
                <p>${state.errors.crypto}</p>
                <button id="retry-crypto" class="mt-2 bg-[var(--button)] px-3 py-1 rounded-md text-sm">${i18n('tryAgain')}</button>
            </div>`;
            document.getElementById('retry-crypto').onclick = () => { state.loadedPages = 1; loadCryptoData(); };
            return;
        }
        
        container.style.display = 'block';
        let coinsToRender = (state.activeTab === 'all') ? state.allCoins : state.allCoins.filter(c => state.watchlist.includes(c.id));
        if (state.currentSort === 'gainers') coinsToRender.sort((a, b) => (b.price_change_percentage_24h || -999) - (a.price_change_percentage_24h || -999));
        else if (state.currentSort === 'losers') coinsToRender.sort((a, b) => (a.price_change_percentage_24h || 999) - (b.price_change_percentage_24h || 999));
        else coinsToRender.sort((a, b) => (a.market_cap_rank || 9999) - (b.market_cap_rank || 9999));
        
        const query = state.searchQuery.toLowerCase().trim();
        if (query) {
            coinsToRender = coinsToRender.filter(c => c.name.toLowerCase().includes(query) || c.symbol.toLowerCase().includes(query) || (PERSIAN_NAMES[c.id] && PERSIAN_NAMES[c.id].toLowerCase().includes(query)));
        }
        
        messageEl.classList.add('hidden');
        if (coinsToRender.length === 0) {
            messageEl.textContent = i18n(state.activeTab === 'watchlist' ? 'emptyWatchlist' : 'noResults');
            messageEl.classList.remove('hidden');
        }
        
        // Ù…Ù†Ø·Ù‚ Virtual Scrolling Ø¨Ø±Ø§ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¨Ù‡ØªØ± Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„
        const ROW_HEIGHT = 68;
        listEl.innerHTML = '';
        listEl.style.height = `${coinsToRender.length * ROW_HEIGHT}px`;
        const scrollTop = container.scrollTop;
        const startIndex = Math.floor(scrollTop / ROW_HEIGHT);
        const endIndex = Math.min(startIndex + Math.ceil(container.clientHeight / ROW_HEIGHT) + 2, coinsToRender.length);
        const fragment = document.createDocumentFragment();
        for (let i = startIndex; i < endIndex; i++) {
            const coin = coinsToRender[i];
            if (!coin) continue;
            const row = document.createElement('div');
            row.className = 'coin-row absolute w-full';
            if (isRTL) row.style.left = '0';
            else row.style.right = '0';
            row.style.top = `${i * ROW_HEIGHT}px`;
            row.style.height = `${ROW_HEIGHT}px`;
            row.dataset.coinId = coin.id;
            row.innerHTML = renderCoinRow(coin);
            fragment.appendChild(row);
        }
        listEl.appendChild(fragment);
    }
    
    function renderCoinRow(coin) {
        const isWatched = state.watchlist.includes(coin.id);
        const tomanPriceNum = state.dollarPrice > 0 ? coin.current_price * state.dollarPrice : 0;
        const tomanPrice = tomanPriceNum > 0 ? formatNum(tomanPriceNum, 0) : '...';

        let nativeName = '';
        if (state.language === 'fa') {
            nativeName = PERSIAN_NAMES[coin.id.toLowerCase()] ? ` | ${PERSIAN_NAMES[coin.id.toLowerCase()]}` : '';
        } 

        return `
            <div class="flex items-center p-3 h-full cursor-pointer transition duration-150 hover:bg-[var(--header-border)]">
                <div class="flex-1 flex items-center space-x-3 ${isRTL ? 'space-x-reverse' : ''} min-w-0">
                    <img src="${coin.image}" alt="${coin.name}" class="w-9 h-9 rounded-full">
                    <div class="truncate">
                        <div class="font-bold text-sm truncate">${coin.symbol.toUpperCase()}${nativeName}</div>
                        <div class="text-xs text-[var(--hint)]">${i18n('rank')} #${coin.market_cap_rank || '?'}</div>
                    </div>
                </div>
                <!-- Ù†Ù…ÙˆØ¯Ø§Ø± Sparkline -->
                <div class="w-16 h-8 flex items-center justify-center">${generateSparkline(coin.sparkline_in_7d.price, coin.price_change_percentage_24h)}</div>
                <div class="flex-1 text-right font-mono text-xs pr-2">
                    <div class="font-bold text-sm" data-price-usd>$${formatNum(coin.current_price, coin.current_price < 0.01 ? 5 : 2)}</div>
                    <div class="text-[var(--hint)]" data-price-irt>${tomanPrice} T</div>
                </div>
                <div class="w-20 text-center font-bold text-sm ${getChangeClass(coin.price_change_percentage_24h)}">${formatPercent(coin.price_change_percentage_24h)}</div>
                <div class="w-10 text-center text-2xl star-icon cursor-pointer text-[var(--hint)] hover:text-yellow-400" data-watched="${isWatched}">${isWatched ? '<span style="color: #FFC107;">â˜…</span>' : 'â˜†'}</div>
            </div>`;
    }
    
    function generateSparkline(data, change) {
        if (!data || data.length < 2) return '';
        const w = 64, h = 32;
        const max = Math.max(...data), min = Math.min(...data);
        const range = max - min;
        
        const points = data.map((price, i) => {
            const x = (i / (data.length - 1)) * w;
            const y = h - ((price - min) / range) * h;
            return `${x},${y}`;
        }).join(' ');

        const color = parseFloat(change) >= 0 ? 'var(--positive)' : 'var(--negative)';
        const lastPointY = h - ((data[data.length - 1] - min) / range) * h;

        return `
            <svg viewBox="0 0 ${w} ${h}" width="${w}" height="${h}">
                <polyline class="sparkline-path" points="${points}" stroke="${color}" />
                <circle cx="${w}" cy="${lastPointY}" r="1.5" fill="${color}" />
            </svg>
        `;
    }

    function handleStarClick(starEl, coinId) {
        if (state.watchlist.includes(coinId)) {
            state.watchlist = state.watchlist.filter(id => id !== coinId);
        } else {
            state.watchlist.push(coinId);
        }
        localStorage.setItem('watchlist_v10', JSON.stringify(state.watchlist));
        render(); // Ø±Ù†Ø¯Ø± Ù…Ø¬Ø¯Ø¯ Ø¨Ø±Ø§ÛŒ Ø§Ø¹Ù…Ø§Ù„ ØªØºÛŒÛŒØ± Ø³ØªØ§Ø±Ù‡ Ùˆ ÙÛŒÙ„ØªØ± (Ø§Ú¯Ø± Ø¯Ø± Ø­Ø§Ù„Øª Watchlist Ø§Ø³Øª)
    }

    // ØªØ§Ø¨Ø¹ ØªÙ†Ø¸ÛŒÙ…Ø§Øª UI Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù„ÛŒÚ©â€ŒÙ‡Ø§
    function setupUI() {
        // Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù„ÛŒÚ©â€ŒÙ‡Ø§ÛŒ Ù†ÙˆØ§Ø± Ù¾ÛŒÙ…Ø§ÛŒØ´
        document.querySelectorAll('.nav-button').forEach(btn => {
            btn.onclick = (e) => {
                const pageId = e.currentTarget.dataset.page;
                const pageKey = e.currentTarget.dataset.pageKey;
                
                // ØªØºÛŒÛŒØ± Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ÛŒ Active
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
                e.currentTarget.classList.add('active');
                
                // Ø±Ù†Ø¯Ø± Ù…Ø­ØªÙˆØ§ÛŒ ØµÙØ­Ø§Øª Ø¨Ø± Ø§Ø³Ø§Ø³ pageId
                if (pageId === 'profile-page') renderProfilePage();
                else if (pageId === 'coming-soon-page') renderComingSoonPage(pageKey);
                // markets-page (ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ) Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ Ø±Ù†Ø¯Ø± Ù…Ø¬Ø¯Ø¯ Ù†Ø¯Ø§Ø±Ø¯
            };
        });

        // Ù…Ø¯ÛŒØ±ÛŒØª ØªØ¨â€ŒÙ‡Ø§
        document.querySelectorAll('.tab-button').forEach(btn => btn.addEventListener('click', e => {
            document.querySelector('.tab-button.active').classList.remove('active');
            e.currentTarget.classList.add('active');
            state.activeTab = e.currentTarget.id.replace('tab-', '');
            localStorage.setItem('activeTab_v10', state.activeTab);
            render();
        }));
        
        // Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÙˆØ±Øª
        document.querySelectorAll('.sort-button').forEach(btn => btn.addEventListener('click', e => {
            document.querySelector('.sort-button.active').classList.remove('active');
            e.currentTarget.classList.add('active');
            state.currentSort = e.currentTarget.dataset.sort;
            localStorage.setItem('currentSort_v10', state.currentSort);
            render();
        }));
        
        // Ù…Ø¯ÛŒØ±ÛŒØª Ø¬Ø³ØªØ¬Ùˆ
        let searchTimeout;
        document.getElementById('search-input').addEventListener('input', e => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => { state.searchQuery = e.target.value; render(); }, 300);
        });
        
        // Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø³Ø·Ø±Ù‡Ø§ (Ø¬Ø²Ø¦ÛŒØ§Øª Ùˆ Ø³ØªØ§Ø±Ù‡)
        document.getElementById('coin-list').addEventListener('click', e => {
            const star = e.target.closest('.star-icon');
            const row = e.target.closest('.coin-row');
            if (row) {
                if (star) { e.stopPropagation(); handleStarClick(star, row.dataset.coinId); } 
                else { openDetailsModal(state.allCoins.find(c => c.id === row.dataset.coinId)); }
            }
        });
    }
    
    // ØªØ§Ø¨Ø¹ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Infinite Scroll
    function setupInfiniteScroll() {
        const container = document.getElementById('coin-list-container');
        container.addEventListener('scroll', () => {
            renderCryptoList(); // Ø±Ù†Ø¯Ø± Ú©Ø±Ø¯Ù† Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ù‚Ø§Ø¨Ù„ Ù…Ø´Ø§Ù‡Ø¯Ù‡
            // Ú†Ú© Ú©Ø±Ø¯Ù† Ø±Ø³ÛŒØ¯Ù† Ø¨Ù‡ Ø§Ù†ØªÙ‡Ø§ÛŒ Ù„ÛŒØ³Øª (Ø¨Ø±Ø§ÛŒ Ù„ÙˆØ¯ ØµÙØ­Ø§Øª Ø¨Ø¹Ø¯ÛŒ)
            if (container.scrollHeight - container.scrollTop <= container.clientHeight * 1.2) {
                if (!state.isLoading.crypto && state.loadedPages < state.maxPages && state.activeTab === 'all' && !state.searchQuery) {
                    state.loadedPages++;
                    loadCryptoData(true);
                }
            }
        });
    }

    // ğŸ‘ˆ ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: Ù†Ù…Ø§ÛŒØ´ ØµÙØ­Ù‡ "Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ" Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„
    function renderComingSoonPage(pageKey) {
        const page = document.getElementById('coming-soon-page');
        const pageName = i18n(pageKey) || pageKey;
        page.innerHTML = `
            <div class="p-8 text-center flex flex-col items-center justify-center h-full min-h-[50vh]">
                <h1 class="text-4xl font-extrabold mb-4 text-[var(--button)]" data-i18n-key="comingSoon"></h1>
                <p class="text-[var(--hint)] text-lg">${i18n('comingSoonMessage', { pageName })}</p>
                <div class="mt-8 text-6xl">ğŸš§</div>
            </div>`;
        translateUI();
    }
    
    // ØªØ§Ø¨Ø¹ ØªØºÛŒÛŒØ± Ø²Ø¨Ø§Ù†
    function setLanguage(lang) {
        state.language = lang; localStorage.setItem('language_v10', lang);
        const newIsRTL = ['fa', 'ar'].includes(lang);
        document.documentElement.lang = lang; 
        document.documentElement.dir = newIsRTL ? 'rtl' : 'ltr';
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ØªØºÛŒØ± Ú¯Ù„ÙˆØ¨Ø§Ù„
        isRTL = newIsRTL;

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ ØµÙØ­Ø§Øª ÙØ¹Ø§Ù„
        const activeNavButton = document.querySelector('.nav-button.active');
        const pageId = activeNavButton?.dataset.page;
        const pageKey = activeNavButton?.dataset.pageKey;

        if (pageId === 'profile-page') renderProfilePage();
        else if (pageId === 'coming-soon-page') renderComingSoonPage(pageKey);
        else render();
        
        // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§Ø¹Ù…Ø§Ù„ ØªØºÛŒÛŒØ±Ø§Øª Ø¯Ø± Ø¬Ù‡Øªâ€ŒØ¯Ù‡ÛŒ
        document.querySelectorAll('.flex.space-x-reverse').forEach(el => {
            el.classList.remove('space-x-reverse');
            if (newIsRTL) el.classList.add('space-x-reverse');
        });
    }
    
    // ØªØ§Ø¨Ø¹ Ø§Ø¹Ù…Ø§Ù„ ØªØ±Ø¬Ù…Ù‡ Ø¯Ø± UI
    function translateUI() {
        document.querySelectorAll('[data-i18n-key]').forEach(el => {
            const key = el.dataset.i18nKey;
            el.textContent = i18n(key);
        });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
            const key = el.dataset.i18nPlaceholder;
            el.placeholder = i18n(key);
        });
        document.querySelectorAll('[data-i18n-key-count]').forEach(el => {
            const key = el.dataset.i18nKeyCount;
            const count = el.dataset.count;
            el.textContent = i18n(key, { count });
        });
    }
    
    // ØªØ§Ø¨Ø¹ ØªØºÛŒÛŒØ± ØªÙ…
    function setTheme(theme) {
        state.theme = theme; localStorage.setItem('theme_v10', theme);
        document.body.classList.toggle('light-theme', theme === 'light');
        tg.isDark = (theme === 'dark');
        // Ø¨Ù‡ Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø±Ù†Ú¯ Ø¯Ú©Ù…Ù‡ Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ ØªÙ„Ú¯Ø±Ø§Ù…
        tg.setHeaderColor(theme === 'dark' ? '#1E1E1E' : '#FFFFFF');
        tg.setBackgroundColor(theme === 'dark' ? '#121212' : '#FFFFFF');

        // Ø±Ù†Ø¯Ø± Ù…Ø¬Ø¯Ø¯ ØµÙØ­Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙ…
        if (document.getElementById('profile-page').classList.contains('active')) {
            renderProfilePage();
        }
        render(); // Ø±Ù†Ø¯Ø± Ù…Ø¬Ø¯Ø¯ Ù„ÛŒØ³Øª Ø¨Ø±Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡
    }
    
    // ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ ØªÙˆØ³Øª
    function showToast(messageKey, params = {}) {
        const toastEl = document.getElementById('toast');
        toastEl.textContent = i18n(messageKey, params);
        toastEl.classList.add('show');
        setTimeout(() => toastEl.classList.remove('show'), 2000);
    }
    
    // ØªØ§Ø¨Ø¹ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…Ø¯Ø§Ù„
    function openModal(contentHtml) {
        document.getElementById('modal-content').innerHTML = contentHtml;
        document.getElementById('modal-backdrop').classList.remove('hidden');
        document.getElementById('modal').classList.add('open');
        translateUI();
    }
    
    // ØªØ§Ø¨Ø¹ Ø¨Ø³ØªÙ† Ù…Ø¯Ø§Ù„
    function closeModal() {
        document.getElementById('modal-backdrop').classList.add('hidden');
        document.getElementById('modal').classList.remove('open');
        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù…Ø­ØªÙˆØ§ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù…Ø´Ú©Ù„Ø§Øª Ø­Ø§ÙØ¸Ù‡ Ùˆ Ø±Ù†Ø¯Ø±
        setTimeout(() => document.getElementById('modal-content').innerHTML = '', 300);
    }

    function openDetailsModal(coin) {
        if (!coin) return;
        
        const price = formatNum(coin.current_price, coin.current_price < 0.01 ? 5 : 2);
        const priceToman = formatNum(coin.current_price * state.dollarPrice, 0);
        const changeClass = getChangeClass(coin.price_change_percentage_24h);
        const change = formatPercent(coin.price_change_percentage_24h);
        
        const detailsHtml = `
            <div class="flex items-center space-x-3 ${isRTL ? 'space-x-reverse' : ''} mb-6">
                <img src="${coin.image}" alt="${coin.name}" class="w-12 h-12 rounded-full">
                <div>
                    <h2 class="text-xl font-bold">${coin.name} (${coin.symbol.toUpperCase()})</h2>
                    <p class="text-[var(--hint)] text-sm">${i18n('rank')} #${coin.market_cap_rank || '?'}</p>
                </div>
            </div>
            
            <div class="flex justify-between items-center mb-6">
                <div>
                    <p class="text-3xl font-bold">$${price}</p>
                    <p class="text-xl font-bold text-[var(--hint)]">${priceToman} T</p>
                </div>
                <div class="text-right">
                    <p class="text-lg font-bold ${changeClass}">${change} (24h)</p>
                </div>
            </div>
            
            <!-- Ù†Ù…ÙˆØ¯Ø§Ø± (ÙØ¹Ù„Ø§ Ù¾ÛŒØ§Ù… "Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª" Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒ Ø´ÙˆØ¯) -->
            <div class="h-40 flex items-center justify-center bg-[var(--bg)] rounded-xl mb-6">
                <p class="text-[var(--hint)]">${i18n('chartUnavailable')}</p>
            </div>

            <div class="space-y-3">
                <h3 class="font-bold text-lg mb-3" data-i18n-key="coinDetails"></h3>
                ${renderDetailRow('high24h', `$${formatNum(coin.high_24h, coin.high_24h < 0.01 ? 5 : 2)}`)}
                ${renderDetailRow('low24h', `$${formatNum(coin.low_24h, coin.low_24h < 0.01 ? 5 : 2)}`)}
                ${renderDetailRow('volume24h', `$${formatNum(coin.total_volume, 0)}`)}
                ${renderDetailRow('marketCap', `$${formatNum(coin.market_cap, 0)}`)}
            </div>
            
            <button onclick="closeModal()" class="w-full bg-[var(--button)] text-white p-3 rounded-xl mt-6 font-bold" data-i18n-key="back"></button>
        `;
        openModal(detailsHtml);
    }

    function renderDetailRow(key, value) {
        return `
            <div class="flex justify-between items-center pb-2 border-b border-[var(--header-border)]">
                <span class="text-[var(--hint)] text-sm" data-i18n-key="${key}"></span>
                <span class="font-bold text-sm">${value}</span>
            </div>
        `;
    }
    
    // Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø±Ù†Ø¯Ø± ØµÙØ­Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ (Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø²Ø¨Ø§Ù† Ùˆ ØªÙ…)
    function renderProfilePage() {
        const user = tg.initDataUnsafe.user || { first_name: 'Ú©Ø§Ø±Ø¨Ø±', username: 'ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡', id: '0' };
        const profilePage = document.getElementById('profile-page');
        const walletCount = Object.keys(state.wallets).length;
        
        profilePage.innerHTML = `
            <div class="p-4">
                 <div class="flex items-center space-x-4 ${isRTL ? 'space-x-reverse' : ''} mb-6">
                    <img src="${user.photo_url || ''}" onerror="this.style.display='none'" class="w-20 h-20 rounded-full bg-[var(--secondary-bg)]">
                    <div>
                        <h1 class="text-xl font-bold">${user.first_name || ''} ${user.last_name || ''}</h1>
                        <p class="text-[var(--hint)] text-sm">@${user.username || i18n('notSet')}</p>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="bg-[var(--secondary-bg)] p-4 rounded-xl">
                        <h2 data-i18n-key="settings" class="font-bold mb-3 text-lg"></h2>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center"><span class="text-[var(--hint)]" data-i18n-key="theme"></span><div class="flex bg-[var(--bg)] rounded-lg p-1"><button class="theme-btn px-3 py-1 rounded-md text-sm ${state.theme === 'dark' ? 'bg-[var(--button)] text-white' : ''}" data-theme="dark" data-i18n-key="dark"></button><button class="theme-btn px-3 py-1 rounded-md text-sm ${state.theme === 'light' ? 'bg-[var(--button)] text-white' : ''}" data-theme="light" data-i18n-key="light"></button></div></div>
                            <div class="flex justify-between items-center"><span class="text-[var(--hint)]" data-i18n-key="language"></span>
                                <select id="lang-select" class="bg-[var(--bg)] p-1 rounded-md text-sm text-[var(--text)]">
                                    <option value="fa" ${state.language === 'fa' ? 'selected' : ''}>ÙØ§Ø±Ø³ÛŒ</option>
                                    <option value="en" ${state.language === 'en' ? 'selected' : ''}>English</option>
                                    <option value="ar" ${state.language === 'ar' ? 'selected' : ''}>Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                                    <option value="zh" ${state.language === 'zh' ? 'selected' : ''}>ä¸­æ–‡</option>
                                </select>
                            </div>
                            <!-- Ø¯Ú©Ù…Ù‡ Ù‡Ø§ÛŒ Ø§ÛŒÙ…ÛŒÙ„ Ùˆ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø¯Ø± Ø§ÛŒÙ† Ù†Ø³Ø®Ù‡ ÙÙ‚Ø· Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒ Ø´ÙˆÙ†Ø¯ Ùˆ Ù…Ù†Ø·Ù‚ ÙˆÛŒØ±Ø§ÛŒØ´ ÙØ¹Ø§Ù„ Ù†ÛŒØ³ØªÙ†Ø¯ -->
                            <div class="flex justify-between items-center py-1"><span class="text-[var(--hint)]" data-i18n-key="emailOptional"></span><span class="font-mono text-left truncate text-sm">${state.userEmail || i18n('notSet')}</span></div>
                            <div class="flex justify-between items-center py-1"><span class="text-[var(--hint)]" data-i18n-key="wallets"></span><span class="text-sm">${i18n('walletsCount', { count: walletCount })}</span></div>
                        </div>
                    </div>
                </div>
            </div>`;
        document.querySelectorAll('.theme-btn').forEach(btn => btn.onclick = (e) => setTheme(e.currentTarget.dataset.theme));
        document.getElementById('lang-select').onchange = (e) => setLanguage(e.target.value);
        translateUI();
    }


    document.addEventListener('DOMContentLoaded', () => {
        try { 
            tg.ready(); 
            tg.expand();
            // Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø²Ú¯Ø´Øª Ø±Ø§ Ø¯Ø± ØªÙ„Ú¯Ø±Ø§Ù… ØºÛŒØ±ÙØ¹Ø§Ù„ Ù…ÛŒ Ú©Ù†ÛŒÙ… Ú†ÙˆÙ† Single-Page App Ø§Ø³Øª
            tg.BackButton.hide();
        } catch (e) { 
            console.warn("TG script not loaded. Running standalone."); 
        }
        
        setTheme(state.theme);
        setLanguage(state.language); // ØªÙ†Ø¸ÛŒÙ… Ø²Ø¨Ø§Ù† Ø§ÙˆÙ„ÛŒÙ‡ Ùˆ Ø¬Ù‡Øªâ€ŒØ¯Ù‡ÛŒ
        setupUI();
        setupInfiniteScroll(); 
        
        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
        loadSummaryData();
        loadCryptoData();
        
        // ØªÙ†Ø¸ÛŒÙ… Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±
        if (state.updateInterval) clearInterval(state.updateInterval);
        state.updateInterval = setInterval(() => loadCryptoData(true), 30000);
    });
    //============== END OF FULL JAVASCRIPT CODE ==============
    </script>
</body>
</html>

