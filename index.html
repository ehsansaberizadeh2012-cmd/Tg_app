<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no, user-scalable=no">
    <title>صرافی شلبی - بازارهای ارز دیجیتال</title>
    
    <!-- Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- QR Code -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
    
    <!-- فونت وزیر -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* متغیرهای تم */
        :root {
            --bg: #121212; --text: #EAECEF; --hint: #707A8A;
            --button: #2E81FF; --secondary-bg: #1E1E1E; --header-border: #2A2A2A;
            --positive: #00C853; --negative: #FF3B30; --primary: #1DA1F2;
            --success: #10B981; --danger: #EF4444; --warning: #F59E0B;
            --card-bg: #1E1E1E; --card-border: #2A2A2A;
        }
        .light-theme {
            --bg: #FFFFFF; --text: #1c1c1e; --hint: #8e8e93;
            --button: #007AFF; --secondary-bg: #F2F2F7; --header-border: #e5e5ea;
            --positive: #00C853; --negative: #FF3B30; --primary: #1DA1F2;
            --success: #10B981; --danger: #EF4444; --warning: #F59E0B;
            --card-bg: #F2F2F7; --card-border: #e5e5ea;
        }

        /* استایل‌های پایه */
        body { 
            font-family: 'Vazirmatn', sans-serif; 
            background-color: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 0; 
            padding-bottom: 70px; 
            transition: all 0.3s; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        /* صفحات */
        .page { display: none; min-height: calc(100vh - 70px); }
        .page.active { display: block; }
        
        /* هدر و ناوبری */
        .header { 
            background-color: var(--bg); 
            position: sticky; 
            top: 0; 
            z-index: 20; 
            padding: 1rem; 
            border-bottom: 1px solid var(--header-border); 
            transition: all 0.3s; 
        }
        
        .nav-bar { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background-color: var(--secondary-bg); 
            border-top: 1px solid var(--header-border); 
            z-index: 30; 
            display: flex; 
            justify-content: space-around; 
            padding-top: 0.5rem; 
            height: 65px; 
            transition: all 0.3s; 
        }
        
        .nav-button { 
            flex: 1; 
            text-align: center; 
            padding: 0.25rem; 
            color: var(--hint); 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        
        .nav-button.active { 
            color: var(--button); 
        }
        
        .nav-icon { 
            height: 24px; 
            width: 24px; 
            margin: 0 auto 4px; 
            stroke-width: 2; 
        }
        
        /* دکمه‌ها و تب‌ها */
        .tab-button { 
            border: 1px solid var(--header-border); 
            transition: all 0.3s;
        }
        
        .tab-button.active { 
            background-color: var(--button); 
            color: white; 
            border-color: var(--button); 
        }
        
        .sort-button.active { 
            color: var(--button); 
        }
        
        /* اسکلتون لودینگ */
        .skeleton { 
            background-color: var(--secondary-bg); 
            border-radius: 8px; 
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; 
        }
        
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.5; } 
        }
        
        /* مدال و توست */
        .modal-backdrop { 
            position: fixed; 
            inset: 0; 
            background-color: rgba(0,0,0,0.7); 
            z-index: 40; 
            backdrop-filter: blur(5px); 
        }
        
        .modal { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background-color: var(--secondary-bg); 
            z-index: 50; 
            border-top-left-radius: 20px; 
            border-top-right-radius: 20px; 
            padding: 1.5rem; 
            transform: translateY(100%); 
            transition: transform 0.3s ease-out; 
            max-height: 90vh; 
            overflow-y: auto; 
        }
        
        .modal.open { 
            transform: translateY(0); 
        }
        
        .toast { 
            position: fixed; 
            bottom: 90px; 
            left: 50%; 
            transform: translateX(-50%); 
            background-color: #333; 
            color: white; 
            padding: 10px 20px; 
            border-radius: 8px; 
            z-index: 100; 
            opacity: 0; 
            transition: opacity 0.3s; 
            pointer-events: none; 
        }
        
        .toast.show { 
            opacity: 1; 
        }
        
        /* کارت‌ها */
        .market-card, .wallet-card, .alert-item, .order-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.3s;
            border: 1px solid var(--card-border);
        }
        
        .market-card:hover, .wallet-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        /* FAB Button */
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            box-shadow: 0 4px 16px rgba(29, 161, 242, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            z-index: 25;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .fab:hover {
            transform: scale(1.1);
        }
        
        .sparkline-path { 
            stroke-width: 2; 
            fill: none; 
        }
        
        .search-clear { 
            display: none; 
            position: absolute; 
            right: 10px; 
            top: 50%; 
            transform: translateY(-50%); 
            background: none; 
            border: none; 
            color: var(--hint); 
            cursor: pointer; 
        }
        
        .search-clear.show { 
            display: block; 
        }
        
        .menu-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--secondary-bg);
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .menu-item:hover {
            background: var(--header-border);
        }
        
        .network-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .network-eth { background: #627EEA; color: white; }
        .network-ton { background: #0088CC; color: white; }
        .network-tron { background: #FF060A; color: white; }
        .network-btc { background: #F7931A; color: white; }
        .network-bsc { background: #F0B90B; color: black; }
        .network-sol { background: #00FFA3; color: black; }
        
        .chart-container {
            height: 200px;
            margin: 10px 0;
        }
        
        .order-book {
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .bid-row, .ask-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .bid-row {
            background: rgba(0, 200, 83, 0.1);
        }
        
        .ask-row {
            background: rgba(255, 59, 48, 0.1);
        }
        
        .trade-history {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .trade-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 8px;
            border-bottom: 1px solid var(--header-border);
        }
        
        .price-up {
            color: var(--positive);
        }
        
        .price-down {
            color: var(--negative);
        }
        
        .depth-chart {
            height: 150px;
            position: relative;
            margin: 10px 0;
        }
        
        .depth-bid {
            position: absolute;
            bottom: 0;
            right: 0;
            background: rgba(0, 200, 83, 0.3);
            transition: width 0.3s;
        }
        
        .depth-ask {
            position: absolute;
            bottom: 0;
            left: 0;
            background: rgba(255, 59, 48, 0.3);
            transition: width 0.3s;
        }
        
        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .order-type-selector {
            display: flex;
            background: var(--secondary-bg);
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 12px;
        }
        
        .order-type {
            flex: 1;
            text-align: center;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .order-type.active {
            background: var(--button);
            color: white;
        }
        
        .input-group {
            margin-bottom: 12px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 4px;
            font-size: 14px;
            color: var(--hint);
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--header-border);
            background: var(--bg);
            color: var(--text);
        }
        
        .btn-primary {
            background: var(--button);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            width: 100%;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary:hover {
            opacity: 0.9;
        }
        
        .btn-secondary {
            background: var(--secondary-bg);
            color: var(--text);
            border: 1px solid var(--header-border);
            padding: 12px;
            border-radius: 8px;
            width: 100%;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-secondary:hover {
            background: var(--header-border);
        }
        
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .badge-success {
            background: var(--success);
            color: white;
        }
        
        .badge-warning {
            background: var(--warning);
            color: black;
        }
        
        .badge-danger {
            background: var(--danger);
            color: white;
        }
        
        .badge-info {
            background: var(--primary);
            color: white;
        }
        
        .wallet-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .wallet-action-btn {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .wallet-deposit {
            background: rgba(46, 129, 255, 0.2);
            color: var(--button);
            border: 1px solid var(--button);
        }
        
        .wallet-withdraw {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
        }
        
        .wallet-transfer {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid var(--card-border);
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            margin: 4px 0;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--hint);
        }
        
        .progress-bar {
            height: 6px;
            background: var(--secondary-bg);
            border-radius: 3px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }
        
        .progress-success {
            background: var(--success);
        }
        
        .progress-warning {
            background: var(--warning);
        }
        
        .progress-danger {
            background: var(--danger);
        }
        
        .tab-header {
            display: flex;
            border-bottom: 1px solid var(--header-border);
            margin-bottom: 16px;
        }
        
        .tab-header-item {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .tab-header-item.active {
            border-bottom-color: var(--button);
            color: var(--button);
        }
        
        .order-status {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .status-filled {
            background: var(--success);
            color: white;
        }
        
        .status-partial {
            background: var(--warning);
            color: black;
        }
        
        .status-pending {
            background: var(--primary);
            color: white;
        }
        
        .status-cancelled {
            background: var(--hint);
            color: white;
        }
        
        .status-rejected {
            background: var(--danger);
            color: white;
        }
        
        .notification-item {
            padding: 12px;
            border-bottom: 1px solid var(--header-border);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .notification-item:hover {
            background: var(--secondary-bg);
        }
        
        .notification-item.unread {
            background: rgba(46, 129, 255, 0.1);
        }
        
        .notification-time {
            font-size: 12px;
            color: var(--hint);
        }
        
        .security-level {
            display: flex;
            align-items: center;
            margin: 16px 0;
        }
        
        .security-indicator {
            flex: 1;
            height: 6px;
            background: var(--secondary-bg);
            border-radius: 3px;
            margin: 0 8px;
            overflow: hidden;
        }
        
        .security-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }
        
        .security-weak {
            background: var(--danger);
            width: 33%;
        }
        
        .security-medium {
            background: var(--warning);
            width: 66%;
        }
        
        .security-strong {
            background: var(--success);
            width: 100%;
        }
        
        .security-label {
            font-size: 12px;
            min-width: 60px;
            text-align: center;
        }
        
        .two-factor-setup {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            border: 1px solid var(--card-border);
        }
        
        .qr-code-container {
            text-align: center;
            margin: 16px 0;
        }
        
        .backup-phrase {
            background: var(--bg);
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            border: 1px solid var(--card-border);
            font-family: monospace;
            text-align: center;
            line-height: 1.8;
        }
        
        .backup-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning);
            border-radius: 8px;
            padding: 12px;
            margin: 16px 0;
            color: var(--warning);
            font-size: 14px;
        }
        
        .api-key-item {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid var(--card-border);
        }
        
        .api-key-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .api-key-action {
            flex: 1;
            padding: 6px;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
            cursor: pointer;
        }
        
        .api-key-edit {
            background: rgba(46, 129, 255, 0.2);
            color: var(--button);
            border: 1px solid var(--button);
        }
        
        .api-key-revoke {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
        }
        
        .fee-tier {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid var(--card-border);
        }
        
        .fee-tier.active {
            border-color: var(--button);
            background: rgba(46, 129, 255, 0.1);
        }
        
        .tier-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .tier-name {
            font-weight: bold;
        }
        
        .tier-requirements {
            font-size: 12px;
            color: var(--hint);
        }
        
        .tier-fees {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }
        
        .referral-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .referral-link {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 16px;
            border: 1px solid var(--card-border);
        }
        
        .link-container {
            display: flex;
            margin-top: 8px;
        }
        
        .link-value {
            flex: 1;
            background: var(--bg);
            border: 1px solid var(--header-border);
            border-radius: 8px 0 0 8px;
            padding: 8px 12px;
            font-family: monospace;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .link-copy {
            background: var(--button);
            color: white;
            border: none;
            border-radius: 0 8px 8px 0;
            padding: 8px 12px;
            cursor: pointer;
        }
        
        .affiliate-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .affiliate-stat {
            text-align: center;
            padding: 12px;
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--card-border);
        }
        
        .affiliate-value {
            font-size: 18px;
            font-weight: bold;
            margin: 4px 0;
        }
        
        .affiliate-label {
            font-size: 12px;
            color: var(--hint);
        }
        
        .transaction-history {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .transaction-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid var(--header-border);
        }
        
        .transaction-details {
            flex: 1;
        }
        
        .transaction-amount {
            text-align: right;
        }
        
        .transaction-positive {
            color: var(--success);
        }
        
        .transaction-negative {
            color: var(--danger);
        }
        
        .transaction-neutral {
            color: var(--hint);
        }
        
        .transaction-status {
            font-size: 12px;
            margin-top: 4px;
        }
        
        .loan-application {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--card-border);
        }
        
        .loan-terms {
            background: var(--bg);
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
            border: 1px solid var(--card-border);
        }
        
        .loan-term {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .loan-term:last-child {
            margin-bottom: 0;
        }
        
        .staking-pool {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--card-border);
        }
        
        .pool-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .pool-apy {
            font-size: 18px;
            font-weight: bold;
            color: var(--success);
        }
        
        .pool-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .pool-detail {
            text-align: center;
        }
        
        .pool-value {
            font-size: 16px;
            font-weight: bold;
            margin: 4px 0;
        }
        
        .pool-label {
            font-size: 12px;
            color: var(--hint);
        }
        
        .pool-actions {
            display: flex;
            gap: 8px;
        }
        
        .pool-action {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
        }
        
        .pool-stake {
            background: var(--button);
            color: white;
        }
        
        .pool-unstake {
            background: var(--secondary-bg);
            color: var(--text);
            border: 1px solid var(--header-border);
        }
        
        .insurance-policy {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--card-border);
        }
        
        .policy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .policy-premium {
            font-size: 18px;
            font-weight: bold;
        }
        
        .policy-details {
            margin-bottom: 12px;
        }
        
        .policy-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .policy-actions {
            display: flex;
            gap: 8px;
        }
        
        .policy-action {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
        }
        
        .policy-buy {
            background: var(--button);
            color: white;
        }
        
        .policy-details-btn {
            background: var(--secondary-bg);
            color: var(--text);
            border: 1px solid var(--header-border);
        }
        
        .news-item {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--card-border);
        }
        
        .news-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .news-title {
            font-weight: bold;
            flex: 1;
            margin-right: 12px;
        }
        
        .news-time {
            font-size: 12px;
            color: var(--hint);
            white-space: nowrap;
        }
        
        .news-content {
            color: var(--hint);
            line-height: 1.5;
        }
        
        .news-source {
            font-size: 12px;
            color: var(--button);
            margin-top: 8px;
        }
        
        .education-course {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--card-border);
        }
        
        .course-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .course-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--button);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 12px;
            color: white;
            font-size: 18px;
        }
        
        .course-title {
            flex: 1;
            font-weight: bold;
        }
        
        .course-duration {
            font-size: 12px;
            color: var(--hint);
        }
        
        .course-description {
            color: var(--hint);
            margin-bottom: 12px;
            line-height: 1.5;
        }
        
        .course-progress {
            margin-bottom: 12px;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        
        .course-action {
            background: var(--button);
            color: white;
            border: none;
            padding: 8px;
            border-radius: 6px;
            width: 100%;
            cursor: pointer;
        }
        
        .support-ticket {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--card-border);
        }
        
        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .ticket-title {
            font-weight: bold;
            flex: 1;
        }
        
        .ticket-status {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .ticket-open {
            background: var(--success);
            color: white;
        }
        
        .ticket-pending {
            background: var(--warning);
            color: black;
        }
        
        .ticket-closed {
            background: var(--hint);
            color: white;
        }
        
        .ticket-message {
            color: var(--hint);
            margin-bottom: 12px;
            line-height: 1.5;
        }
        
        .ticket-actions {
            display: flex;
            gap: 8px;
        }
        
        .ticket-action {
            flex: 1;
            padding: 6px;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
            cursor: pointer;
        }
        
        .ticket-reply {
            background: var(--button);
            color: white;
        }
        
        .ticket-view {
            background: var(--secondary-bg);
            color: var(--text);
            border: 1px solid var(--header-border);
        }
        
        .market-indicators {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .indicator {
            flex: 1;
            text-align: center;
            padding: 12px;
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--card-border);
        }
        
        .indicator-value {
            font-size: 16px;
            font-weight: bold;
            margin: 4px 0;
        }
        
        .indicator-label {
            font-size: 12px;
            color: var(--hint);
        }
        
        .market-sentiment {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .sentiment-bar {
            flex: 1;
            height: 8px;
            background: var(--secondary-bg);
            border-radius: 4px;
            overflow: hidden;
            margin: 0 8px;
        }
        
        .sentiment-bullish {
            height: 100%;
            background: var(--success);
            border-radius: 4px 0 0 4px;
        }
        
        .sentiment-bearish {
            height: 100%;
            background: var(--danger);
            border-radius: 0 4px 4px 0;
        }
        
        .sentiment-label {
            font-size: 12px;
            min-width: 60px;
            text-align: center;
        }
        
        .trading-pairs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .trading-pair {
            padding: 8px;
            background: var(--card-bg);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--card-border);
        }
        
        .trading-pair:hover {
            background: var(--secondary-bg);
        }
        
        .trading-pair.active {
            border-color: var(--button);
            background: rgba(46, 129, 255, 0.1);
        }
        
        .pair-symbol {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .pair-price {
            font-size: 12px;
            color: var(--hint);
        }
        
        .pair-change {
            font-size: 12px;
        }
        
        .market-overview {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .overview-item {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid var(--card-border);
        }
        
        .overview-value {
            font-size: 18px;
            font-weight: bold;
            margin: 4px 0;
        }
        
        .overview-label {
            font-size: 12px;
            color: var(--hint);
        }
        
        .overview-change {
            font-size: 12px;
        }
        
        .price-alert {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid var(--card-border);
        }
        
        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .alert-symbol {
            font-weight: bold;
        }
        
        .alert-condition {
            font-size: 12px;
            color: var(--hint);
        }
        
        .alert-price {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .alert-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .alert-action {
            flex: 1;
            padding: 6px;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
            cursor: pointer;
        }
        
        .alert-edit {
            background: rgba(46, 129, 255, 0.2);
            color: var(--button);
            border: 1px solid var(--button);
        }
        
        .alert-delete {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid var(--danger);
        }
        
        .portfolio-allocation {
            margin-bottom: 16px;
        }
        
        .allocation-chart {
            height: 200px;
            margin: 16px 0;
        }
        
        .allocation-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .allocation-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--header-border);
        }
        
        .allocation-symbol {
            font-weight: bold;
        }
        
        .allocation-percentage {
            color: var(--hint);
        }
        
        .allocation-value {
            font-weight: bold;
        }
        
        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .metric {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid var(--card-border);
        }
        
        .metric-value {
            font-size: 18px;
            font-weight: bold;
            margin: 4px 0;
        }
        
        .metric-label {
            font-size: 12px;
            color: var(--hint);
        }
        
        .metric-change {
            font-size: 12px;
        }
        
        .tax-report {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--card-border);
        }
        
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .report-title {
            font-weight: bold;
        }
        
        .report-period {
            font-size: 12px;
            color: var(--hint);
        }
        
        .report-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .report-item {
            text-align: center;
        }
        
        .report-value {
            font-size: 16px;
            font-weight: bold;
            margin: 4px 0;
        }
        
        .report-label {
            font-size: 12px;
            color: var(--hint);
        }
        
        .report-actions {
            display: flex;
            gap: 8px;
        }
        
        .report-action {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
        }
        
        .report-download {
            background: var(--button);
            color: white;
        }
        
        .report-share {
            background: var(--secondary-bg);
            color: var(--text);
            border: 1px solid var(--header-border);
        }
        
        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--secondary-bg);
            transition: .4s;
            border-radius: 34px;
            border: 1px solid var(--header-border);
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 3px;
            background-color: var(--text);
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--button);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        /* اسکرول بار */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--secondary-bg);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--button);
            border-radius: 3px;
        }
        
        /* حالت RTL */
        .rtl-flex-row-reverse { 
            display: flex;
            flex-direction: row-reverse;
        }
        
        .rtl-space-x-reverse > * + * {
            margin-right: 0.75rem;
            margin-left: 0;
        }
    </style>
</head>
<body class="antialiased">

    <!-- سوئیچ تم تاریک/روشن -->
    <div class="dark-mode-toggle">
        <label class="toggle-switch">
            <input type="checkbox" id="theme-toggle">
            <span class="toggle-slider"></span>
        </label>
    </div>

    <!-- صفحه بازارها -->
    <div id="markets-page" class="page active">
        <div class="header">
            <h1 class="text-xl font-bold text-center mb-4">بازار ارزهای دیجیتال شلبی</h1>
            <div class="relative">
                <input type="text" id="search-input" placeholder="جستجوی ارز..." class="w-full p-2.5 rounded-xl text-sm mb-3 pr-10" style="background-color: var(--secondary-bg); border: 1px solid var(--header-border); color: var(--text);">
                <button id="search-clear" class="search-clear">✕</button>
            </div>
            <div class="flex items-center justify-between">
                <div class="flex bg-[var(--secondary-bg)] rounded-xl p-1">
                    <button id="tab-all" class="tab-button active px-3 py-1.5 rounded-lg text-xs font-semibold">همه</button>
                    <button id="tab-watchlist" class="tab-button px-3 py-1.5 rounded-lg text-xs font-semibold">علاقه‌مندی‌ها</button>
                    <button id="tab-gainers" class="tab-button px-3 py-1.5 rounded-lg text-xs font-semibold">برترین‌ها</button>
                    <button id="tab-losers" class="tab-button px-3 py-1.5 rounded-lg text-xs font-semibold">بدترین‌ها</button>
                </div>
                <div id="sort-controls" class="flex items-center space-x-1 space-x-reverse">
                    <button class="sort-button active text-xs px-2 py-1.5" data-sort="market_cap_desc">ارزش بازار</button>
                    <button class="sort-button text-xs px-2 py-1.5" data-sort="volume">حجم معاملات</button>
                    <button class="sort-button text-xs px-2 py-1.5" data-sort="price">قیمت</button>
                </div>
            </div>
        </div>
        
        <!-- خلاصه بازار -->
        <div id="summary-container" class="p-4 grid grid-cols-2 gap-3">
            <div class="h-16 skeleton rounded-xl"></div>
            <div class="h-16 skeleton rounded-xl"></div>
        </div>
        
        <!-- شاخص‌های بازار -->
        <div class="market-indicators px-4">
            <div class="indicator">
                <div class="indicator-label">شاخص ترس و طمع</div>
                <div class="indicator-value">42</div>
                <div class="text-xs text-[var(--warning)]">ترس</div>
            </div>
            <div class="indicator">
                <div class="indicator-label">تعداد ارزها</div>
                <div class="indicator-value">12,456</div>
                <div class="text-xs text-[var(--hint)]">+24 جدید</div>
            </div>
            <div class="indicator">
                <div class="indicator-label">حجم 24h</div>
                <div class="indicator-value">$84.2B</div>
                <div class="text-xs text-[var(--positive)]">+5.2%</div>
            </div>
        </div>
        
        <!-- احساسات بازار -->
        <div class="market-sentiment px-4 mb-4">
            <div class="sentiment-label">خرسی</div>
            <div class="sentiment-bar">
                <div class="sentiment-bullish" style="width: 65%"></div>
                <div class="sentiment-bearish" style="width: 35%"></div>
            </div>
            <div class="sentiment-label">گاوی</div>
        </div>
        
        <!-- لیست ارزها -->
        <div id="coin-list-container" class="h-[calc(100vh-350px)] overflow-y-auto">
            <div id="coin-list" class="relative">
                <div class="p-4 space-y-2">
                    ${Array(10).fill('').map(() => `<div class="h-[68px] skeleton"></div>`).join('')}
                </div>
            </div>
        </div>
        
        <div id="message-container" class="hidden text-center p-10 text-[var(--hint)]"></div>
    </div>

    <!-- صفحه معاملات -->
    <div id="trading-page" class="page">
        <div class="header">
            <h1 class="text-xl font-bold text-center mb-4">معاملات</h1>
            <div class="trading-pairs">
                <div class="trading-pair active">
                    <div class="pair-symbol">BTC/USDT</div>
                    <div class="pair-price">$42,150</div>
                    <div class="pair-change text-[var(--positive)]">+2.3%</div>
                </div>
                <div class="trading-pair">
                    <div class="pair-symbol">ETH/USDT</div>
                    <div class="pair-price">$2,850</div>
                    <div class="pair-change text-[var(--positive)]">+1.7%</div>
                </div>
                <div class="trading-pair">
                    <div class="pair-symbol">SOL/USDT</div>
                    <div class="pair-price">$102.5</div>
                    <div class="pair-change text-[var(--negative)]">-0.8%</div>
                </div>
            </div>
        </div>
        
        <div class="p-4">
            <!-- نمودار قیمت -->
            <div class="chart-container mb-4">
                <canvas id="trading-chart"></canvas>
            </div>
            
            <!-- اطلاعات بازار -->
            <div class="market-overview mb-4">
                <div class="overview-item">
                    <div class="overview-label">قیمت فعلی</div>
                    <div class="overview-value">$42,150</div>
                    <div class="overview-change text-[var(--positive)]">+2.3%</div>
                </div>
                <div class="overview-item">
                    <div class="overview-label">تغییر 24h</div>
                    <div class="overview-value">+$950</div>
                    <div class="overview-change text-[var(--positive)]">+2.3%</div>
                </div>
                <div class="overview-item">
                    <div class="overview-label">بالاترین 24h</div>
                    <div class="overview-value">$42,500</div>
                </div>
                <div class="overview-item">
                    <div class="overview-label">پایین‌ترین 24h</div>
                    <div class="overview-value">$41,200</div>
                </div>
            </div>
            
            <!-- عمق بازار -->
            <div class="depth-chart mb-4">
                <div class="depth-bid" style="width: 60%"></div>
                <div class="depth-ask" style="width: 40%"></div>
            </div>
            
            <!-- دفتر سفارشات -->
            <div class="mb-4">
                <h3 class="font-bold mb-2">دفتر سفارشات</h3>
                <div class="order-book">
                    <div class="ask-row">
                        <span>42,200</span>
                        <span>0.85</span>
                        <span class="text-[var(--negative)]">$42,200</span>
                    </div>
                    <div class="ask-row">
                        <span>42,180</span>
                        <span>1.25</span>
                        <span class="text-[var(--negative)]">$42,180</span>
                    </div>
                    <div class="ask-row">
                        <span>42,160</span>
                        <span>2.10</span>
                        <span class="text-[var(--negative)]">$42,160</span>
                    </div>
                    <div class="text-center my-2 font-bold">$42,150</div>
                    <div class="bid-row">
                        <span>42,140</span>
                        <span>1.75</span>
                        <span class="text-[var(--positive)]">$42,140</span>
                    </div>
                    <div class="bid-row">
                        <span>42,120</span>
                        <span>2.30</span>
                        <span class="text-[var(--positive)]">$42,120</span>
                    </div>
                    <div class="bid-row">
                        <span>42,100</span>
                        <span>3.15</span>
                        <span class="text-[var(--positive)]">$42,100</span>
                    </div>
                </div>
            </div>
            
            <!-- تاریخچه معاملات -->
            <div class="mb-4">
                <h3 class="font-bold mb-2">تاریخچه معاملات</h3>
                <div class="trade-history">
                    <div class="trade-row">
                        <span>14:23:05</span>
                        <span class="price-up">$42,155</span>
                        <span>0.25 BTC</span>
                    </div>
                    <div class="trade-row">
                        <span>14:22:47</span>
                        <span class="price-down">$42,148</span>
                        <span>0.18 BTC</span>
                    </div>
                    <div class="trade-row">
                        <span>14:22:30</span>
                        <span class="price-up">$42,152</span>
                        <span>0.42 BTC</span>
                    </div>
                    <div class="trade-row">
                        <span>14:22:15</span>
                        <span class="price-up">$42,150</span>
                        <span>0.31 BTC</span>
                    </div>
                    <div class="trade-row">
                        <span>14:21:58</span>
                        <span class="price-down">$42,145</span>
                        <span>0.27 BTC</span>
                    </div>
                </div>
            </div>
            
            <!-- فرم سفارش -->
            <div>
                <h3 class="font-bold mb-2">سفارش جدید</h3>
                <div class="order-type-selector">
                    <div class="order-type active">خرید</div>
                    <div class="order-type">فروش</div>
                </div>
                
                <div class="input-group">
                    <label for="order-amount">مقدار (BTC)</label>
                    <input type="number" id="order-amount" placeholder="0.00" step="0.001">
                </div>
                
                <div class="input-group">
                    <label for="order-price">قیمت (USDT)</label>
                    <input type="number" id="order-price" placeholder="0.00" step="0.01" value="42150">
                </div>
                
                <div class="input-group">
                    <label for="order-total">مجموع (USDT)</label>
                    <input type="number" id="order-total" placeholder="0.00" readonly>
                </div>
                
                <button class="btn-primary mb-2">ثبت سفارش خرید</button>
                <button class="btn-secondary">پیش‌نمایش سفارش</button>
            </div>
        </div>
    </div>

    <!-- صفحه کیف پول -->
    <div id="wallet-page" class="page">
        <div class="header">
            <h1 class="text-xl font-bold text-center mb-4">کیف پول‌های من</h1>
        </div>
        
        <!-- موجودی کلی -->
        <div class="p-4">
            <div class="bg-gradient-to-l from-[var(--primary)] to-blue-600 rounded-2xl p-6 text-white mb-6 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-white/10 to-transparent"></div>
                <div class="relative z-10">
                    <div class="text-white/80 text-sm">موجودی کل</div>
                    <div class="text-2xl font-bold">$12,458.75</div>
                    <div class="text-white/80 text-sm mt-1">+2.3% (24h)</div>
                </div>
            </div>
            
            <!-- آمار سریع -->
            <div class="stats-grid mb-6">
                <div class="stat-card">
                    <div class="stat-label">سرمایه‌گذاری شده</div>
                    <div class="stat-value">$10,250</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">سود/زیان</div>
                    <div class="stat-value text-[var(--positive)]">+$2,208.75</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">سود روزانه</div>
                    <div class="stat-value text-[var(--positive)]">+$285.50</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">تعداد دارایی‌ها</div>
                    <div class="stat-value">8</div>
                </div>
            </div>
            
            <!-- تخصیص پرتفوی -->
            <div class="portfolio-allocation mb-6">
                <h3 class="font-bold mb-3">تخصیص پرتفوی</h3>
                <div class="allocation-chart">
                    <canvas id="allocation-chart"></canvas>
                </div>
                <div class="allocation-list">
                    <div class="allocation-item">
                        <div class="allocation-symbol">بیت‌کوین</div>
                        <div class="allocation-percentage">42%</div>
                        <div class="allocation-value">$5,230</div>
                    </div>
                    <div class="allocation-item">
                        <div class="allocation-symbol">اتریوم</div>
                        <div class="allocation-percentage">28%</div>
                        <div class="allocation-value">$3,488</div>
                    </div>
                    <div class="allocation-item">
                        <div class="allocation-symbol">سولانا</div>
                        <div class="allocation-percentage">15%</div>
                        <div class="allocation-value">$1,869</div>
                    </div>
                    <div class="allocation-item">
                        <div class="allocation-symbol">سایر</div>
                        <div class="allocation-percentage">15%</div>
                        <div class="allocation-value">$1,871</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- لیست کیف پول‌ها -->
        <div id="wallet-content" class="p-4">
            <!-- کیف پول‌ها اینجا رندر می‌شوند -->
        </div>
        
        <!-- حالت خالی -->
        <div id="wallet-empty" class="text-center p-8">
            <div class="w-20 h-20 bg-[var(--secondary-bg)] rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="text-2xl">👛</span>
            </div>
            <p class="text-lg font-bold mb-2">هیچ کیف پولی اضافه نشده</p>
            <p class="text-[var(--hint)] mb-6">برای شروع، یک کیف پول جدید اضافه کنید</p>
            <button id="add-wallet-btn" class="bg-[var(--button)] text-white px-6 py-3 rounded-xl font-bold">افزودن کیف پول</button>
        </div>
    </div>

    <!-- صفحه هشدارها -->
    <div id="alerts-page" class="page">
        <div class="header">
            <h1 class="text-xl font-bold text-center mb-4">هشدارهای قیمت</h1>
        </div>
        
        <div class="p-4">
            <!-- فرم ایجاد هشدار جدید -->
            <div class="bg-[var(--card-bg)] rounded-xl p-4 mb-6 border border-[var(--card-border)]">
                <h3 class="font-bold mb-3">ایجاد هشدار جدید</h3>
                
                <div class="input-group">
                    <label for="alert-coin">ارز</label>
                    <select id="alert-coin">
                        <option value="bitcoin">بیت‌کوین (BTC)</option>
                        <option value="ethereum">اتریوم (ETH)</option>
                        <option value="solana">سولانا (SOL)</option>
                        <option value="cardano">کاردانو (ADA)</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="alert-condition">شرط</label>
                    <select id="alert-condition">
                        <option value="above">بالاتر از</option>
                        <option value="below">پایین‌تر از</option>
                        <option value="percent_up">افزایش %</option>
                        <option value="percent_down">کاهش %</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="alert-price">قیمت هدف ($)</label>
                    <input type="number" id="alert-price" placeholder="0.00" step="0.01">
                </div>
                
                <button class="btn-primary">ایجاد هشدار</button>
            </div>
            
            <!-- لیست هشدارها -->
            <div id="alerts-list">
                <!-- هشدارها اینجا رندر می‌شوند -->
            </div>
        </div>
        
        <!-- حالت خالی -->
        <div id="alerts-empty" class="text-center p-8">
            <div class="w-20 h-20 bg-[var(--secondary-bg)] rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="text-2xl">🔔</span>
            </div>
            <p class="text-lg font-bold mb-2">هیچ هشداری تنظیم نشده</p>
            <p class="text-[var(--hint)] mb-6">برای قیمت‌های خاص هشدار ایجاد کنید</p>
            <button id="create-alert-btn" class="bg-[var(--button)] text-white px-6 py-3 rounded-xl font-bold">ایجاد هشدار</button>
        </div>
    </div>

    <!-- صفحه مبدل -->
    <div id="converter-page" class="page">
        <div class="header">
            <h1 class="text-xl font-bold text-center mb-4">مبدل ارز</h1>
        </div>
        
        <div class="p-4">
            <div id="converter" class="bg-[var(--card-bg)] rounded-xl p-4 mb-6 border border-[var(--card-border)]">
                <div class="flex gap-3 items-center mb-4">
                    <input type="number" id="convert-from" placeholder="0.00" class="flex-1 p-3 rounded-xl border border-[var(--header-border)] bg-[var(--bg)]">
                    <select id="from-currency" class="p-3 rounded-xl border border-[var(--header-border)] bg-[var(--bg)]"></select>
                </div>
                
                <div class="text-center my-3">
                    <button id="swap-currencies" class="bg-[var(--button)] text-white w-10 h-10 rounded-full flex items-center justify-center mx-auto">⇅</button>
                </div>
                
                <div class="flex gap-3 items-center">
                    <input type="number" id="convert-to" placeholder="0.00" readonly class="flex-1 p-3 rounded-xl border border-[var(--header-border)] bg-[var(--secondary-bg)]">
                    <select id="to-currency" class="p-3 rounded-xl border border-[var(--header-border)] bg-[var(--bg)]"></select>
                </div>
            </div>
            
            <!-- نرخ‌های برتر -->
            <div class="grid grid-cols-2 gap-3 mb-6">
                <div class="bg-[var(--card-bg)] p-3 rounded-xl text-center border border-[var(--card-border)]">
                    <div class="text-[var(--hint)] text-sm">نرخ دلار</div>
                    <div class="font-bold" id="usd-rate">---</div>
                </div>
                <div class="bg-[var(--card-bg)] p-3 rounded-xl text-center border border-[var(--card-border)]">
                    <div class="text-[var(--hint)] text-sm">نرخ طلا</div>
                    <div class="font-bold" id="gold-rate">---</div>
                </div>
                <div class="bg-[var(--card-bg)] p-3 rounded-xl text-center border border-[var(--card-border)]">
                    <div class="text-[var(--hint)] text-sm">نرخ یورو</div>
                    <div class="font-bold" id="eur-rate">---</div>
                </div>
                <div class="bg-[var(--card-bg)] p-3 rounded-xl text-center border border-[var(--card-border)]">
                    <div class="text-[var(--hint)] text-sm">نرخ پوند</div>
                    <div class="font-bold" id="gbp-rate">---</div>
                </div>
            </div>
            
            <!-- نمودار تبدیل -->
            <div class="chart-container">
                <canvas id="conversion-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- صفحه پروفایل -->
    <div id="profile-page" class="page">
        <div class="header">
            <h1 class="text-xl font-bold text-center mb-4">پروفایل کاربر</h1>
        </div>
        
        <div class="p-4">
            <!-- کارت پروفایل -->
            <div class="bg-gradient-to-l from-[var(--primary)] to-blue-600 rounded-2xl p-6 text-white mb-6 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-white/10 to-transparent"></div>
                <div class="relative z-10 flex items-center gap-4">
                    <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center text-2xl font-bold">ش</div>
                    <div>
                        <h2 class="text-xl font-bold">کاربر شلبی</h2>
                        <p class="text-white/80 text-sm" id="profile-id">ID: در حال بارگذاری...</p>
                    </div>
                </div>
                <div class="relative z-10 mt-4 text-center" id="portfolio-value">
                    <div class="text-white/80 text-sm">ارزش کل پرتفوی</div>
                    <div class="text-2xl font-bold">---</div>
                </div>
            </div>
            
            <!-- منو پروفایل -->
            <div class="space-y-3">
                <div class="menu-item" data-action="wallets">
                    <span>👛</span>
                    <span>مدیریت کیف پول‌ها</span>
                </div>
                
                <div class="menu-item" data-action="alerts">
                    <span>🔔</span>
                    <span>مدیریت هشدارها</span>
                </div>
                
                <div class="menu-item" data-action="orders">
                    <span>📊</span>
                    <span>تاریخچه معاملات</span>
                </div>
                
                <div class="menu-item" data-action="security">
                    <span>🔒</span>
                    <span>امنیت و حریم خصوصی</span>
                </div>
                
                <div class="menu-item" data-action="notifications">
                    <span>📢</span>
                    <span>اعلان‌ها</span>
                    <span class="notification-badge">3</span>
                </div>
                
                <div class="menu-item" data-action="api">
                    <span>🔑</span>
                    <span>API Keys</span>
                </div>
                
                <div class="menu-item" data-action="fees">
                    <span>💸</span>
                    <span>کارمزدها</span>
                </div>
                
                <div class="menu-item" data-action="referral">
                    <span>👥</span>
                    <span>دعوت از دوستان</span>
                </div>
                
                <div class="menu-item" data-action="export">
                    <span>📤</span>
                    <span>خروجی داده‌ها</span>
                </div>
                
                <div class="menu-item" data-action="import">
                    <span>📥</span>
                    <span>ورودی داده‌ها</span>
                </div>
                
                <div class="menu-item" data-action="backup">
                    <span>💾</span>
                    <span>پشتیبان‌گیری</span>
                </div>
                
                <div class="menu-item" data-action="settings">
                    <span>⚙️</span>
                    <span>تنظیمات</span>
                </div>
                
                <div class="menu-item" data-action="about">
                    <span>ℹ️</span>
                    <span>درباره شلبی</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ناوبری پایین -->
    <nav class="nav-bar">
        <button class="nav-button" data-page="wallet-page">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
            </svg>
            <span class="block text-xs">کیف پول</span>
        </button>
        
        <button class="nav-button" data-page="trading-page">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            <span class="block text-xs">معاملات</span>
        </button>
        
        <button class="nav-button active" data-page="markets-page">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
            </svg>
            <span class="block text-xs">بازارها</span>
        </button>
        
        <button class="nav-button" data-page="alerts-page">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-5 5v-5zM4.93 4.93l9.07 9.07-9.07 9.07L4.93 4.93z"></path>
            </svg>
            <span class="block text-xs">هشدارها</span>
        </button>
        
        <button class="nav-button" data-page="profile-page">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
            <span class="block text-xs">پروفایل</span>
        </button>
    </nav>

    <!-- دکمه FAB برای افزودن سریع -->
    <button class="fab" id="fab-add" title="افزودن جدید">+</button>

    <!-- مدال -->
    <div id="modal-backdrop" class="modal-backdrop hidden"></div>
    <div id="modal" class="modal">
        <div id="modal-content"></div>
    </div>

    <!-- توست -->
    <div id="toast" class="toast"></div>

    <script>
        // === کانفیگ و ثابت‌ها ===
        const CONFIG = {
            API: {
                COINGECKO: 'https://api.coingecko.com/api/v3',
                ETHERSCAN: 'https://api.etherscan.io/api',
                BSCSCAN: 'https://api.bscscan.com/api',
                TONCENTER: 'https://toncenter.com/api/v2',
                TRONGRID: 'https://api.trongrid.io',
                BLOCKCHAIN: 'https://blockchain.info',
                DOGECHAIN: 'https://dogechain.info/api/v1',
                EXCHANGE_RATE: 'https://api.exchangerate-api.com/v4/latest/USD'
            },
            API_KEYS: {
                ETHERSCAN: 'FREE_KEY',
                BSCSCAN: 'FREE_KEY'
            },
            LIMIT: 100,
            UPDATE_INTERVAL: 60000,
            CHART_DAYS: 7,
            CURRENCY: 'usd',
            LOCALE: 'fa-IR'
        };

        // === وضعیت برنامه ===
        const STATE = {
            // داده‌های بازار
            markets: [],
            favorites: new Set(JSON.parse(localStorage.getItem('favorites')) || []),
            watchlist: JSON.parse(localStorage.getItem('watchlist')) || [],
            
            // کیف پول‌ها
            wallets: JSON.parse(localStorage.getItem('wallets')) || [],
            
            // هشدارها
            alerts: JSON.parse(localStorage.getItem('alerts')) || [],
            
            // سفارشات
            orders: JSON.parse(localStorage.getItem('orders')) || [],
            
            // تنظیمات
            theme: localStorage.getItem('theme') || 'dark',
            language: 'fa',
            userId: null,
            hasNotifications: false,
            
            // نرخ‌های ارز
            exchangeRates: {
                usd: parseInt(localStorage.getItem('usd_rate')) || 42000,
                eur: parseInt(localStorage.getItem('eur_rate')) || 45000,
                gbp: parseInt(localStorage.getItem('gbp_rate')) || 53000,
                gold: parseInt(localStorage.getItem('gold_rate')) || 2800000
            },
            
            // وضعیت لودینگ
            isLoading: {
                markets: true,
                summary: true
            },
            
            // جفت معاملاتی فعال
            activeTradingPair: 'BTC/USDT'
        };

        // === شبکه‌های پشتیبانی شده ===
        const NETWORKS = {
            eth: { name: 'اتریوم', symbol: 'ETH', explorer: 'https://etherscan.io/address/', color: 'network-eth' },
            btc: { name: 'بیت‌کوین', symbol: 'BTC', explorer: 'https://blockchain.com/btc/address/', color: 'network-btc' },
            ton: { name: 'TON', symbol: 'TON', explorer: 'https://tonviewer.com/', color: 'network-ton' },
            tron: { name: 'ترون', symbol: 'TRX', explorer: 'https://tronscan.org/#/address/', color: 'network-tron' },
            bsc: { name: 'BSC', symbol: 'BSC', explorer: 'https://bscscan.com/address/', color: 'network-bsc' },
            sol: { name: 'سولانا', symbol: 'SOL', explorer: 'https://solscan.io/account/', color: 'network-sol' }
        };

        // === ابزارک‌ها ===
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        const formatNumber = (num, decimals = 2) => {
            if (!num && num !== 0) return '---';
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(num);
        };

        const formatPrice = (price) => {
            if (price >= 1) return `$${formatNumber(price, 2)}`;
            if (price >= 0.01) return `$${formatNumber(price, 4)}`;
            return `$${formatNumber(price, 6)}`;
        };

        const formatChange = (change) => {
            const sign = change >= 0 ? '+' : '';
            return `<span class="${change >= 0 ? 'text-[var(--positive)]' : 'text-[var(--negative)]'}">${sign}${formatNumber(change, 2)}%</span>`;
        };

        const showToast = (message, duration = 3000) => {
            const toast = $('#toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), duration);
        };

        const copyToClipboard = async (text) => {
            try {
                await navigator.clipboard.writeText(text);
                showToast('کپی شد!');
            } catch (err) {
                showToast('خطا در کپی');
            }
        };

        // === مدیریت تم ===
        const initTheme = () => {
            const isDark = STATE.theme === 'dark';
            document.body.classList.toggle('light-theme', !isDark);
            $('#theme-toggle').checked = isDark;
        };

        const toggleTheme = () => {
            STATE.theme = STATE.theme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', STATE.theme);
            initTheme();
        };

        // === مدیریت مدال ===
        const openModal = (content) => {
            $('#modal-content').innerHTML = content;
            $('#modal-backdrop').classList.remove('hidden');
            $('#modal').classList.add('open');
        };

        const closeModal = () => {
            $('#modal-backdrop').classList.add('hidden');
            $('#modal').classList.remove('open');
        };

        // === مدیریت صفحات ===
        const showPage = (pageId) => {
            $$('.page').forEach(page => page.classList.remove('active'));
            $$('.nav-button').forEach(btn => btn.classList.remove('active'));
            
            $(`#${pageId}`).classList.add('active');
            $(`[data-page="${pageId}"]`).classList.add('active');
            
            // لود محتوای خاص هر صفحه
            if (pageId === 'markets-page') loadMarkets();
            if (pageId === 'trading-page') initTradingPage();
            if (pageId === 'wallet-page') renderWallets();
            if (pageId === 'alerts-page') renderAlerts();
            if (pageId === 'converter-page') initConverter();
            if (pageId === 'profile-page') renderProfile();
        };

        // === داده‌های بازار با نمودار ===
        const loadMarkets = async () => {
            STATE.isLoading.markets = true;
            
            try {
                const response = await fetch(`${CONFIG.API.COINGECKO}/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=${CONFIG.LIMIT}&page=1&sparkline=true&price_change_percentage=24h`);
                const data = await response.json();
                
                STATE.markets = data.map(coin => ({
                    id: coin.id,
                    symbol: coin.symbol.toUpperCase(),
                    name: coin.name,
                    image: coin.image,
                    price: coin.current_price,
                    change24h: coin.price_change_percentage_24h,
                    marketCap: coin.market_cap,
                    volume: coin.total_volume,
                    sparkline: coin.sparkline_in_7d?.price || []
                }));
                
                renderMarkets();
            } catch (error) {
                console.error('Error loading markets:', error);
                showToast('خطا در بارگذاری بازارها');
            } finally {
                STATE.isLoading.markets = false;
            }
        };

        // تولید نمودار sparkline
        const generateSparkline = (data, change, w = 60, h = 30) => {
            if (!data || data.length < 2) return '';
            
            const max = Math.max(...data);
            const min = Math.min(...data);
            const range = max - min || 1;
            
            const points = data.map((price, i) => {
                const x = (i / (data.length - 1)) * w;
                const y = h - ((price - min) / range) * h;
                return `${x},${y}`;
            }).join(' ');
            
            const color = parseFloat(change) >= 0 ? 'var(--positive)' : 'var(--negative)';
            
            return `
                <svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" class="sparkline">
                    <polyline class="sparkline-path" points="${points}" stroke="${color}" />
                </svg>
            `;
        };

        const renderMarkets = () => {
            const container = $('#coin-list');
            
            if (STATE.isLoading.markets) {
                container.innerHTML = '<div class="p-4 space-y-2">' + 
                    Array(10).fill('').map(() => '<div class="h-16 skeleton"></div>').join('') + 
                    '</div>';
                return;
            }
            
            const filteredCoins = STATE.markets.filter(coin => {
                const searchQuery = $('#search-input').value.toLowerCase();
                if (searchQuery) {
                    return coin.name.toLowerCase().includes(searchQuery) || 
                           coin.symbol.toLowerCase().includes(searchQuery);
                }
                return true;
            });
            
            if (filteredCoins.length === 0) {
                container.innerHTML = '<div class="text-center p-8 text-[var(--hint)]">هیچ ارزی یافت نشد</div>';
                return;
            }
            
            container.innerHTML = filteredCoins.map(coin => {
                const isFavorite = STATE.favorites.has(coin.id);
                const tomanPrice = coin.price * STATE.exchangeRates.usd;
                const sparkline = generateSparkline(coin.sparkline, coin.change24h);
                
                return `
                    <div class="market-card" data-coin-id="${coin.id}">
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex items-center gap-3">
                                <img class="w-10 h-10 rounded-full" src="${coin.image}" alt="${coin.name}">
                                <div>
                                    <div class="font-bold text-sm">${coin.symbol}</div>
                                    <div class="text-xs text-[var(--hint)]">${coin.name}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-sm">${formatPrice(coin.price)}</div>
                                <div class="text-xs text-[var(--hint)]">${formatNumber(tomanPrice, 0)} تومان</div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <div class="text-sm font-bold ${coin.change24h >= 0 ? 'text-[var(--positive)]' : 'text-[var(--negative)]'}">
                                    ${coin.change24h >= 0 ? '+' : ''}${formatNumber(coin.change24h, 2)}%
                                </div>
                                ${sparkline}
                            </div>
                            <div class="flex gap-2">
                                <button class="favorite-btn ${isFavorite ? 'text-yellow-400' : 'text-[var(--hint)]'}" onclick="toggleFavorite('${coin.id}')">
                                    ${isFavorite ? '★' : '☆'}
                                </button>
                                <button class="text-[var(--hint)] hover:text-[var(--button)]" onclick="openAlertModal('${coin.id}')">
                                    🔔
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        };

        // === جزئیات ارز با نمودار کامل ===
        const openCoinDetails = async (coinId) => {
            try {
                const response = await fetch(`${CONFIG.API.COINGECKO}/coins/${coinId}?localization=false&tickers=false&market_data=true&community_data=false&developer_data=false&sparkline=false`);
                const coin = await response.json();
                
                const chartResponse = await fetch(`${CONFIG.API.COINGECKO}/coins/${coinId}/market_chart?vs_currency=usd&days=${CONFIG.CHART_DAYS}`);
                const chartData = await chartResponse.json();
                
                const modalContent = `
                    <div class="p-4">
                        <div class="flex items-center gap-3 mb-4">
                            <img src="${coin.image.large}" alt="${coin.name}" class="w-12 h-12 rounded-full">
                            <div>
                                <h2 class="text-xl font-bold">${coin.name} (${coin.symbol.toUpperCase()})</h2>
                                <p class="text-[var(--hint)]">رتبه: ${coin.market_cap_rank || '---'}</p>
                            </div>
                        </div>
                        
                        <div class="bg-[var(--secondary-bg)] rounded-xl p-4 mb-4">
                            <div class="grid grid-cols-2 gap-4 text-center">
                                <div>
                                    <p class="text-[var(--hint)] text-sm">قیمت فعلی</p>
                                    <p class="font-bold text-lg">${formatPrice(coin.market_data.current_price.usd)}</p>
                                </div>
                                <div>
                                    <p class="text-[var(--hint)] text-sm">تغییر 24h</p>
                                    <p class="font-bold text-lg ${coin.market_data.price_change_percentage_24h >= 0 ? 'text-[var(--positive)]' : 'text-[var(--negative)]'}">
                                        ${formatNumber(coin.market_data.price_change_percentage_24h, 2)}%
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <canvas id="coin-chart"></canvas>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3 mt-4">
                            <div class="bg-[var(--secondary-bg)] p-3 rounded-xl">
                                <p class="text-[var(--hint)] text-sm">بالاترین 24h</p>
                                <p class="font-bold">${formatPrice(coin.market_data.high_24h.usd)}</p>
                            </div>
                            <div class="bg-[var(--secondary-bg)] p-3 rounded-xl">
                                <p class="text-[var(--hint)] text-sm">پایین‌ترین 24h</p>
                                <p class="font-bold">${formatPrice(coin.market_data.low_24h.usd)}</p>
                            </div>
                            <div class="bg-[var(--secondary-bg)] p-3 rounded-xl">
                                <p class="text-[var(--hint)] text-sm">حجم معاملات</p>
                                <p class="font-bold">${formatNumber(coin.market_data.total_volume.usd, 0)}</p>
                            </div>
                            <div class="bg-[var(--secondary-bg)] p-3 rounded-xl">
                                <p class="text-[var(--hint)] text-sm">ارزش بازار</p>
                                <p class="font-bold">${formatNumber(coin.market_data.market_cap.usd, 0)}</p>
                            </div>
                        </div>
                        
                        <button onclick="closeModal()" class="w-full bg-[var(--button)] text-white p-3 rounded-xl mt-4 font-bold">بستن</button>
                    </div>
                `;
                
                openModal(modalContent);
                
                // رسم نمودار
                setTimeout(() => {
                    const ctx = document.getElementById('coin-chart').getContext('2d');
                    const prices = chartData.prices.map(price => price[1]);
                    const labels = chartData.prices.map((_, index) => {
                        const date = new Date(chartData.prices[index][0]);
                        return date.toLocaleDateString('fa-IR');
                    });
                    
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'قیمت (USD)',
                                data: prices,
                                borderColor: coin.market_data.price_change_percentage_24h >= 0 ? '#00C853' : '#FF3B30',
                                backgroundColor: coin.market_data.price_change_percentage_24h >= 0 ? 'rgba(0, 200, 83, 0.1)' : 'rgba(255, 59, 48, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                x: {
                                    display: false
                                },
                                y: {
                                    display: false
                                }
                            }
                        }
                    });
                }, 100);
                
            } catch (error) {
                console.error('Error loading coin details:', error);
                showToast('خطا در بارگذاری جزئیات ارز');
            }
        };

        // === صفحه معاملات ===
        const initTradingPage = () => {
            // تنظیم نمودار معاملات
            setTimeout(() => {
                const ctx = document.getElementById('trading-chart').getContext('2d');
                
                // داده‌های نمونه برای نمودار
                const data = {
                    labels: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                    datasets: [{
                        label: 'قیمت BTC/USDT',
                        data: [42100, 42150, 42200, 42180, 42120, 42080, 42100, 42150, 42220, 42250, 42200, 42150, 42100, 42120, 42150, 42180, 42200, 42150, 42100, 42050, 42100, 42150, 42200, 42150],
                        borderColor: '#2E81FF',
                        backgroundColor: 'rgba(46, 129, 255, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                };
                
                new Chart(ctx, {
                    type: 'line',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                display: false
                            },
                            y: {
                                display: false
                            }
                        }
                    }
                });
                
                // تنظیم نمودار تخصیص
                const allocationCtx = document.getElementById('allocation-chart').getContext('2d');
                
                new Chart(allocationCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['بیت‌کوین', 'اتریوم', 'سولانا', 'سایر'],
                        datasets: [{
                            data: [42, 28, 15, 15],
                            backgroundColor: [
                                '#F7931A',
                                '#627EEA',
                                '#00FFA3',
                                '#8E8E93'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }, 100);
            
            // تنظیم رویدادهای فرم سفارش
            $('#order-amount').addEventListener('input', updateOrderTotal);
            $('#order-price').addEventListener('input', updateOrderTotal);
            
            // تنظیم رویدادهای جفت‌های معاملاتی
            $$('.trading-pair').forEach(pair => {
                pair.addEventListener('click', function() {
                    $$('.trading-pair').forEach(p => p.classList.remove('active'));
                    this.classList.add('active');
                    STATE.activeTradingPair = this.querySelector('.pair-symbol').textContent;
                    // در اینجا می‌توانید داده‌های جدید برای جفت معاملاتی انتخاب شده بارگذاری کنید
                });
            });
        };

        const updateOrderTotal = () => {
            const amount = parseFloat($('#order-amount').value) || 0;
            const price = parseFloat($('#order-price').value) || 0;
            $('#order-total').value = formatNumber(amount * price, 2);
        };

        // === کیف پول‌ها ===
        const renderWallets = () => {
            const emptyState = $('#wallet-empty');
            const content = $('#wallet-content');
            
            if (STATE.wallets.length === 0) {
                emptyState.classList.remove('hidden');
                content.classList.add('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            content.classList.remove('hidden');
            
            content.innerHTML = STATE.wallets.map((wallet, index) => {
                const network = NETWORKS[wallet.network];
                const shortAddress = `${wallet.address.slice(0, 8)}...${wallet.address.slice(-6)}`;
                
                return `
                    <div class="wallet-card" data-wallet-index="${index}">
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex items-center gap-3">
                                <div class="network-badge ${network.color}">${network.symbol}</div>
                                <div>
                                    <div class="font-bold text-sm">${network.name}</div>
                                    <div class="text-xs text-[var(--hint)]">${shortAddress}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-sm wallet-balance">${wallet.balance || '0.0000'} ${network.symbol}</div>
                                <div class="text-xs text-[var(--hint)] wallet-value">${formatNumber((parseFloat(wallet.balance) || 0) * STATE.exchangeRates.usd, 0)} تومان</div>
                            </div>
                        </div>
                        <div class="wallet-actions">
                            <div class="wallet-action-btn wallet-deposit" onclick="depositToWallet(${index})">واریز</div>
                            <div class="wallet-action-btn wallet-withdraw" onclick="withdrawFromWallet(${index})">برداشت</div>
                            <div class="wallet-action-btn wallet-transfer" onclick="transferFromWallet(${index})">انتقال</div>
                        </div>
                    </div>
                `;
            }).join('');
        };

        // === هشدارها ===
        const renderAlerts = () => {
            const emptyState = $('#alerts-empty');
            const content = $('#alerts-list');
            
            if (STATE.alerts.length === 0) {
                emptyState.classList.remove('hidden');
                content.classList.add('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            content.classList.remove('hidden');
            
            content.innerHTML = STATE.alerts.map((alert, index) => {
                const coin = STATE.markets.find(c => c.id === alert.coinId);
                if (!coin) return '';
                
                return `
                    <div class="price-alert" data-alert-index="${index}">
                        <div class="alert-header">
                            <div class="alert-symbol">${coin.symbol}</div>
                            <div class="alert-condition">${alert.condition === 'above' ? 'بالاتر از' : 'پایین‌تر از'}</div>
                        </div>
                        <div class="alert-price">$${formatNumber(alert.targetPrice, 2)}</div>
                        <div class="text-xs text-[var(--hint)]">ایجاد شده در ${new Date(alert.createdAt).toLocaleDateString('fa-IR')}</div>
                        <div class="alert-actions">
                            <div class="alert-action alert-edit" onclick="editAlert(${index})">ویرایش</div>
                            <div class="alert-action alert-delete" onclick="deleteAlert(${index})">حذف</div>
                        </div>
                    </div>
                `;
            }).join('');
        };

        // === مبدل ارز ===
        const initConverter = () => {
            // آپدیت نرخ‌ها
            $('#usd-rate').textContent = `${formatNumber(STATE.exchangeRates.usd, 0)} تومان`;
            $('#eur-rate').textContent = `${formatNumber(STATE.exchangeRates.eur, 0)} تومان`;
            $('#gbp-rate').textContent = `${formatNumber(STATE.exchangeRates.gbp, 0)} تومان`;
            $('#gold-rate').textContent = `${formatNumber(STATE.exchangeRates.gold, 0)} تومان`;
            
            // پر کردن لیست ارزها
            const currencies = ['USD', 'EUR', 'GBP', 'IRT', 'BTC', 'ETH', 'SOL', 'TON', 'TRX'];
            const options = currencies.map(currency => `<option value="${currency}">${currency}</option>`).join('');
            
            $('#from-currency').innerHTML = options;
            $('#to-currency').innerHTML = options;
            
            $('#from-currency').value = 'IRT';
            $('#to-currency').value = 'USD';
            
            // رویدادهای مبدل
            $('#convert-from').addEventListener('input', convertCurrency);
            $('#from-currency').addEventListener('change', convertCurrency);
            $('#to-currency').addEventListener('change', convertCurrency);
            $('#swap-currencies').addEventListener('click', swapCurrencies);
            
            // تنظیم نمودار تبدیل
            setTimeout(() => {
                const ctx = document.getElementById('conversion-chart').getContext('2d');
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['دی', 'بهمن', 'اسفند', 'فروردین', 'اردیبهشت', 'خرداد'],
                        datasets: [{
                            label: 'نرخ دلار',
                            data: [38000, 39000, 41000, 42000, 41500, 42000],
                            borderColor: '#2E81FF',
                            backgroundColor: 'rgba(46, 129, 255, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }, 100);
            
            convertCurrency();
        };

        const convertCurrency = () => {
            const amount = parseFloat($('#convert-from').value) || 0;
            const from = $('#from-currency').value;
            const to = $('#to-currency').value;
            
            if (amount === 0) {
                $('#convert-to').value = '';
                return;
            }
            
            let result = 0;
            
            // تبدیل ساده (در حالت واقعی باید از API استفاده شود)
            if (from === 'IRT' && to === 'USD') {
                result = amount / STATE.exchangeRates.usd;
            } else if (from === 'USD' && to === 'IRT') {
                result = amount * STATE.exchangeRates.usd;
            } else {
                result = amount; // برای سادگی
            }
            
            $('#convert-to').value = formatNumber(result, 6);
        };

        const swapCurrencies = () => {
            const from = $('#from-currency').value;
            const to = $('#to-currency').value;
            const amount = $('#convert-from').value;
            
            $('#from-currency').value = to;
            $('#to-currency').value = from;
            $('#convert-from').value = $('#convert-to').value;
            
            convertCurrency();
        };

        // === پروفایل ===
        const renderProfile = () => {
            const tg = window.Telegram?.WebApp;
            const user = tg?.initDataUnsafe?.user;
            
            if (user) {
                $('#profile-id').textContent = `ID: ${user.id}`;
            }
            
            // محاسبه ارزش کل پرتفوی
            const totalValue = STATE.wallets.reduce((total, wallet) => {
                const balance = parseFloat(wallet.balance) || 0;
                return total + (balance * STATE.exchangeRates.usd);
            }, 0);
            
            $('#portfolio-value .text-2xl').textContent = `${formatNumber(totalValue, 0)} تومان`;
            
            // رویدادهای منو
            $$('.menu-item').forEach(item => {
                item.addEventListener('click', () => {
                    const action = item.dataset.action;
                    handleProfileAction(action);
                });
            });
        };

        const handleProfileAction = (action) => {
            switch (action) {
                case 'wallets':
                    showPage('wallet-page');
                    break;
                case 'alerts':
                    showPage('alerts-page');
                    break;
                case 'orders':
                    openOrdersHistory();
                    break;
                case 'security':
                    openSecuritySettings();
                    break;
                case 'notifications':
                    openNotifications();
                    break;
                case 'api':
                    openApiManagement();
                    break;
                case 'fees':
                    openFeeSettings();
                    break;
                case 'referral':
                    openReferralProgram();
                    break;
                case 'export':
                    exportData();
                    break;
                case 'import':
                    importData();
                    break;
                case 'backup':
                    backupData();
                    break;
                case 'settings':
                    openSettings();
                    break;
                case 'about':
                    openAbout();
                    break;
            }
        };

        // === راه‌اندازی اولیه ===
        document.addEventListener('DOMContentLoaded', () => {
            // تنظیم تم
            initTheme();
            
            // رویداد تغییر تم
            $('#theme-toggle').addEventListener('change', toggleTheme);
            
            // راه‌اندازی تلگرام
            try {
                const tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
                STATE.userId = tg.initDataUnsafe?.user?.id || 'anonymous';
            } catch (error) {
                console.warn('Telegram Web App not available');
            }
            
            // رویدادهای ناوبری
            $$('.nav-button').forEach(button => {
                button.addEventListener('click', () => {
                    showPage(button.dataset.page);
                });
            });
            
            // رویدادهای جستجو
            $('#search-input').addEventListener('input', renderMarkets);
            $('#search-clear').addEventListener('click', () => {
                $('#search-input').value = '';
                renderMarkets();
            });
            
            // رویداد کلیک روی کارت ارز برای نمایش جزئیات
            $('#coin-list').addEventListener('click', (e) => {
                const card = e.target.closest('.market-card');
                if (card && !e.target.closest('button')) {
                    openCoinDetails(card.dataset.coinId);
                }
            });
            
            // رویداد FAB
            $('#fab-add').addEventListener('click', () => {
                const activePage = $('.page.active').id;
                if (activePage === 'wallet-page') openAddWalletModal();
                else if (activePage === 'alerts-page') openAlertModal(STATE.markets[0]?.id);
                else if (activePage === 'trading-page') openNewOrderModal();
                else showPage('wallet-page');
            });
            
            // رویداد مدال
            $('#modal-backdrop').addEventListener('click', closeModal);
            
            // لود اولیه داده‌ها
            loadSummary();
            loadMarkets();
            renderWallets();
            renderAlerts();
            
            // آپدیت دوره‌ای
            setInterval(() => {
                loadSummary();
                loadMarkets();
            }, CONFIG.UPDATE_INTERVAL);
        });

        // === توابع کمکی ===
        const toggleFavorite = (coinId) => {
            if (STATE.favorites.has(coinId)) {
                STATE.favorites.delete(coinId);
            } else {
                STATE.favorites.add(coinId);
            }
            localStorage.setItem('favorites', JSON.stringify([...STATE.favorites]));
            renderMarkets();
        };

        const openAddWalletModal = () => {
            const networks = Object.keys(NETWORKS).map(key => 
                `<option value="${key}">${NETWORKS[key].name} (${NETWORKS[key].symbol})</option>`
            ).join('');
            
            const modalContent = `
                <h2 class="text-xl font-bold mb-4 text-center">افزودن کیف پول</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">شبکه</label>
                        <select id="wallet-network" class="w-full p-3 rounded-xl border border-[var(--header-border)] bg-[var(--bg)]">
                            ${networks}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">آدرس کیف پول</label>
                        <input type="text" id="wallet-address" placeholder="آدرس کیف پول را وارد کنید" class="w-full p-3 rounded-xl border border-[var(--header-border)] bg-[var(--bg)]">
                    </div>
                    <button onclick="addWallet()" class="w-full bg-[var(--button)] text-white p-3 rounded-xl font-bold">افزودن</button>
                    <button onclick="closeModal()" class="w-full text-[var(--hint)] p-3">انصراف</button>
                </div>
            `;
            
            openModal(modalContent);
        };

        const addWallet = () => {
            const network = $('#wallet-network').value;
            const address = $('#wallet-address').value.trim();
            
            if (!network || !address) {
                showToast('لطفاً شبکه و آدرس را وارد کنید');
                return;
            }
            
            // بررسی تکراری نبودن آدرس
            if (STATE.wallets.some(w => w.address === address)) {
                showToast('این آدرس قبلاً اضافه شده است');
                return;
            }
            
            const newWallet = {
                id: Date.now().toString(),
                network,
                address,
                balance: '0',
                addedAt: Date.now()
            };
            
            STATE.wallets.push(newWallet);
            localStorage.setItem('wallets', JSON.stringify(STATE.wallets));
            
            closeModal();
            showToast('کیف پول اضافه شد');
            renderWallets();
        };

        const openAlertModal = (coinId) => {
            const coin = STATE.markets.find(c => c.id === coinId);
            if (!coin) return;
            
            const modalContent = `
                <h2 class="text-xl font-bold mb-4 text-center">ایجاد هشدار برای ${coin.symbol}</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">شرط هشدار</label>
                        <select id="alert-condition" class="w-full p-3 rounded-xl border border-[var(--header-border)] bg-[var(--bg)]">
                            <option value="above">بالاتر از</option>
                            <option value="below">پایین‌تر از</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">قیمت هدف (دلار)</label>
                        <input type="number" id="alert-price" value="${formatNumber(coin.price, 2)}" step="0.0001" class="w-full p-3 rounded-xl border border-[var(--header-border)] bg-[var(--bg)]">
                    </div>
                    <button onclick="createAlert('${coinId}')" class="w-full bg-[var(--button)] text-white p-3 rounded-xl font-bold">ایجاد هشدار</button>
                    <button onclick="closeModal()" class="w-full text-[var(--hint)] p-3">انصراف</button>
                </div>
            `;
            
            openModal(modalContent);
        };

        const createAlert = (coinId) => {
            const condition = $('#alert-condition').value;
            const targetPrice = parseFloat($('#alert-price').value);
            
            if (!targetPrice || targetPrice <= 0) {
                showToast('لطفاً قیمت معتبر وارد کنید');
                return;
            }
            
            const newAlert = {
                id: Date.now().toString(),
                coinId,
                condition,
                targetPrice,
                active: true,
                createdAt: Date.now()
            };
            
            STATE.alerts.push(newAlert);
            localStorage.setItem('alerts', JSON.stringify(STATE.alerts));
            
            closeModal();
            showToast('هشدار ایجاد شد');
            renderAlerts();
        };

        const openNewOrderModal = () => {
            const modalContent = `
                <h2 class="text-xl font-bold mb-4 text-center">سفارش جدید</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">نوع سفارش</label>
                        <select id="order-type" class="w-full p-3 rounded-xl border border-[var(--header-border)] bg-[var(--bg)]">
                            <option value="market">Market</option>
                            <option value="limit">Limit</option>
                            <option value="stop">Stop-Limit</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">سمت</label>
                        <select id="order-side" class="w-full p-3 rounded-xl border border-[var(--header-border)] bg-[var(--bg)]">
                            <option value="buy">خرید</option>
                            <option value="sell">فروش</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">مقدار</label>
                        <input type="number" id="order-amount-modal" placeholder="0.00" step="0.001" class="w-full p-3 rounded-xl border border-[var(--header-border)] bg-[var(--bg)]">
                    </div>
                    <div id="price-input" class="hidden">
                        <label class="block text-sm font-medium mb-2">قیمت</label>
                        <input type="number" id="order-price-modal" placeholder="0.00" step="0.01" class="w-full p-3 rounded-xl border border-[var(--header-border)] bg-[var(--bg)]">
                    </div>
                    <button onclick="submitOrder()" class="w-full bg-[var(--button)] text-white p-3 rounded-xl font-bold">ثبت سفارش</button>
                    <button onclick="closeModal()" class="w-full text-[var(--hint)] p-3">انصراف</button>
                </div>
            `;
            
            openModal(modalContent);
            
            // نمایش/پنهان کردن فیلد قیمت بر اساس نوع سفارش
            $('#order-type').addEventListener('change', function() {
                $('#price-input').classList.toggle('hidden', this.value === 'market');
            });
        };

        const submitOrder = () => {
            const type = $('#order-type').value;
            const side = $('#order-side').value;
            const amount = parseFloat($('#order-amount-modal').value) || 0;
            const price = type === 'market' ? 0 : parseFloat($('#order-price-modal').value) || 0;
            
            if (amount <= 0) {
                showToast('لطفاً مقدار معتبر وارد کنید');
                return;
            }
            
            if (type !== 'market' && price <= 0) {
                showToast('لطفاً قیمت معتبر وارد کنید');
                return;
            }
            
            const newOrder = {
                id: Date.now().toString(),
                pair: STATE.activeTradingPair,
                type,
                side,
                amount,
                price,
                status: 'pending',
                createdAt: Date.now()
            };
            
            STATE.orders.push(newOrder);
            localStorage.setItem('orders', JSON.stringify(STATE.orders));
            
            closeModal();
            showToast('سفارش ثبت شد');
        };

        // قرار دادن توابع در scope全局
        window.toggleTheme = toggleTheme;
        window.openAddWalletModal = openAddWalletModal;
        window.addWallet = addWallet;
        window.removeWallet = removeWallet;
        window.copyWalletAddress = copyWalletAddress;
        window.showQRCode = showQRCode;
        window.openAlertModal = openAlertModal;
        window.createAlert = createAlert;
        window.removeAlert = removeAlert;
        window.toggleFavorite = toggleFavorite;
        window.convertCurrency = convertCurrency;
        window.swapCurrencies = swapCurrencies;
        window.closeModal = closeModal;
        window.openModal = openModal;
        window.handleProfileAction = handleProfileAction;
        window.exportData = exportData;
        window.importData = importData;
        window.backupData = backupData;
        window.openSettings = openSettings;
        window.openAbout = openAbout;
        window.openCoinDetails = openCoinDetails;
        window.openNewOrderModal = openNewOrderModal;
        window.submitOrder = submitOrder;
        window.updateOrderTotal = updateOrderTotal;
    </script>
</body>
    </html>
