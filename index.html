<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Shelby Bet</title>

  <!-- Telegram Web App -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- PWA Manifest -->
  <link rel="manifest" href="data:application/manifest+json,{
    \"name\": \"Shelby Bet\",
    \"short_name\": \"Shelby\",
    \"start_url\": \"/\",
    \"display\": \"standalone\",
    \"background_color\": \"#0f0f0f\",
    \"theme_color\": \"#1DA1F2\",
    \"icons\": [{\"src\": \"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E%E2%82%BF%3C/text%3E%3C/svg%3E\", \"sizes\": \"any\"}]
  }">

  <style>
    /* === iOS 26 Haptic Bubble Style === */
    :root {
      --primary: #1DA1F2;
      --success: #10B981;
      --danger: #EF4444;
      --bg: #0f0f0f;
      --card: #1a1a1a;
      --text: #f5f5f5;
      --text-secondary: #a0a0a0;
      --border: #2a2a2a;
      --bubble: rgba(255,255,255,0.08);
      --shadow: 0 8px 32px rgba(0,0,0,0.4);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
      padding-bottom: 90px;
      transition: background 0.3s ease;
    }

    .container { max-width: 480px; margin: 0 auto; padding: 0 16px; }

    /* Header */
    .header {
      position: sticky; top: 0; z-index: 100;
      backdrop-filter: blur(12px);
      background: rgba(15,15,15,0.8);
      border-bottom: 1px solid var(--border);
      padding: 16px;
    }
    .header .row {
      display: flex; justify-content: space-between; align-items: center;
    }
    .header .logo {
      display: flex; align-items: center; gap: 12px;
    }
    .header .logo span {
      width: 40px; height: 40px;
      background: var(--primary);
      border-radius: 16px;
      display: flex; align-items: center; justify-content: center;
      font-weight: 900; color: white; font-size: 20px;
      box-shadow: var(--shadow);
    }
    .header .logo h1 {
      font-size: 18px; font-weight: 700;
    }
    .header .logo p {
      font-size: 12px; color: var(--text-secondary);
    }
    .header .actions {
      display: flex; gap: 8px;
    }
    .header .btn {
      width: 36px; height: 36px;
      background: var(--bubble);
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      backdrop-filter: blur(10px);
      transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
      font-size: 18px;
    }
    .header .btn:active {
      transform: scale(0.9);
      background: var(--primary);
      color: white;
    }

    /* Tabs */
    .tabs {
      display: flex; background: var(--card); border-radius: 16px;
      margin: 16px; padding: 6px; gap: 8px;
      box-shadow: var(--shadow);
    }
    .tab {
      flex: 1; padding: 12px; border-radius: 12px;
      text-align: center; font-weight: 600; font-size: 14px;
      transition: all 0.3s ease;
      position: relative;
    }
    .tab.active {
      background: var(--primary); color: white;
      box-shadow: 0 4px 12px rgba(29,161,242,0.4);
    }
    .tab::after {
      content: ''; position: absolute; bottom: 0; left: 50%; width: 0; height: 3px;
      background: var(--primary); border-radius: 2px; transition: all 0.3s ease;
      transform: translateX(-50%);
    }
    .tab.active::after { width: 60%; }

    /* Search */
    .search {
      margin: 16px; position: relative;
    }
    .search input {
      width: 100%; padding: 14px 48px 14px 16px;
      background: var(--card); border: none; border-radius: 16px;
      color: var(--text); font-size: 16px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }
    .search input::placeholder { color: var(--text-secondary); }
    .search .icon {
      position: absolute; right: 16px; top: 14px; color: var(--text-secondary);
      font-size: 18px;
    }

    /* Skeleton */
    .skeleton {
      background: var(--card); border-radius: 20px; padding: 16px; margin: 12px 16px;
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- Header -->
    <header class="header">
      <div class="row">
        <div class="logo">
          <span>S</span>
          <div>
            <h1>Shelby Bet</h1>
            <p>بازارهای کریپتو</p>
          </div>
        </div>
        <div class="actions">
          <button class="btn" id="theme-toggle">Moon</button>
          <button class="btn" id="lang-toggle">EN</button>
        </div>
      </div>
    </header>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" data-tab="markets">بازارها</div>
      <div class="tab" data-tab="wallet">کیف پول</div>
      <div class="tab" data-tab="profile">پروفایل</div>
    </div>

    <!-- Search -->
    <div class="search">
      <input type="text" id="search" placeholder="جستجو در ارزها...">
      <div class="icon">Search</div>
    </div>

    <!-- Skeleton Loading -->
    <div id="skeleton">
      ${Array(6).fill().map(() => `
        <div class="skeleton">
          <div style="display:flex;gap:12px;align-items:center;">
            <div style="width:44px;height:44px;background:#333;border-radius:50%;"></div>
            <div style="flex:1;">
              <div style="height:16px;background:#333;border-radius:8px;width:60%;margin-bottom:8px;"></div>
              <div style="height:12px;background:#333;border-radius:8px;width:40%;"></div>
            </div>
            <div style="text-align:right;">
              <div style="height:18px;background:#333;border-radius:8px;width:70px;margin-bottom:8px;"></div>
              <div style="height:12px;background:#333;border-radius:8px;width:50px;"></div>
            </div>
          </div>
        </div>
      `).join('')}
    </div>
 <!-- Markets Page -->
    <div id="page-markets">
      <div id="markets-list"></div>
    </div>

    <!-- Market Card Template (CSS) -->
    <style>
      /* Market Card */
      .market-card {
        background: var(--card); border-radius: 20px; padding: 16px;
        margin: 12px 16px; box-shadow: var(--shadow);
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        backdrop-filter: blur(12px);
      }
      .market-card:active { transform: scale(0.98); }
      .market-card .row {
        display: flex; justify-content: space-between; align-items: center;
      }
      .market-card .coin {
        display: flex; align-items: center; gap: 12px;
      }
      .market-card .coin img {
        width: 44px; height: 44px; border-radius: 50%; object-fit: cover;
        background: white; padding: 2px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      }
      .market-card .coin-name {
        font-weight: 700; font-size: 16px;
      }
      .market-card .coin-symbol {
        color: var(--text-secondary); font-size: 13px;
      }
      .market-card .price {
        text-align: right;
      }
      .market-card .price-main {
        font-weight: 700; font-size: 18px;
      }
      .market-card .price-change {
        font-size: 13px; font-weight: 600; margin-top: 4px;
      }
      .up { color: var(--success); }
      .down { color: var(--danger); }

      /* Actions */
      .actions {
        display: flex; gap: 8px; margin-top: 12px;
      }
      .actions button {
        flex: 1; height: 40px; border-radius: 12px;
        background: var(--bubble); display: flex; align-items: center; justify-content: center;
        transition: all 0.2s ease; font-size: 18px;
      }
      .actions button:active { 
        transform: scale(0.92); 
        background: var(--primary); 
        color: white; 
      }

      /* Empty State */
      .empty {
        text-align: center; padding: 60px 20px;
      }
      .empty-icon {
        width: 80px; height: 80px; background: var(--bubble);
        border-radius: 50%; margin: 0 auto 20px;
        display: flex; align-items: center; justify-content: center;
        font-size: 36px;
      }
      .empty-title {
        font-size: 18px; font-weight: 600; margin-bottom: 8px;
      }
      .empty-desc {
        color: var(--text-secondary); font-size: 14px; margin-bottom: 24px;
      }
      .btn-primary {
        padding: 14px 32px; background: var(--primary); color: white;
        border: none; border-radius: 16px; font-weight: 600;
        box-shadow: 0 4px 12px rgba(29,161,242,0.4);
      }

      /* Modal */
      .modal {
        position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000;
        display: flex; align-items: center; justify-content: center; padding: 20px;
        backdrop-filter: blur(12px);
      }
      .modal-content {
        background: var(--card); border-radius: 24px; width: 100%; max-width: 400px;
        padding: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        animation: modalIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
      @keyframes modalIn {
        from { transform: scale(0.8); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
      }
      .modal-title {
        font-size: 18px; font-weight: 700; margin-bottom: 16px;
        display: flex; align-items: center; gap: 8px;
      }
      .modal-close {
        position: absolute; top: 16px; left: 16px;
        width: 36px; height: 36px; background: var(--bubble);
        border-radius: 12px; display: flex; align-items: center; justify-content: center;
      }

      /* Toast */
      .toast {
        position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
        background: var(--card); color: white; padding: 12px 20px;
        border-radius: 16px; box-shadow: var(--shadow); z-index: 1001;
        display: flex; align-items: center; gap: 12px; font-size: 14px;
        animation: toastIn 0.3s ease;
      }
      @keyframes toastIn {
        from { transform: translateX(-50%) translateY(20px); opacity: 0; }
        to { transform: translateX(-50%) translateY(0); opacity: 1; }
      }
      .toast-icon { font-size: 18px; }

      /* Hidden */
      .hidden { display: none !important; }
    </style>
  </div>

  <!-- Modal -->
  <div id="modal" class="hidden modal" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <button class="modal-close" onclick="closeModal()">Close</button>
      <div id="modal-body"></div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="hidden toast">
    <div class="toast-icon">Check</div>
    <div id="toast-msg">موفقیت!</div>
  </div>
  <!-- Wallet Page -->
    <div id="page-wallet" class="hidden">
      <div class="empty">
        <div class="empty-icon">Wallet</div>
        <p class="empty-title">هیچ کیف پولی اضافه نشده</p>
        <p class="empty-desc">برای شروع، یک کیف پول جدید اضافه کنید</p>
        <button class="btn-primary" onclick="openAddWallet()">افزودن کیف پول</button>
      </div>
    </div>

    <!-- Profile Page -->
    <div id="page-profile" class="hidden">
      <!-- User Card -->
      <div style="background:linear-gradient(135deg, var(--primary), #0d8bd9);border-radius:24px;margin:16px;padding:24px;color:white;position:relative;overflow:hidden;">
        <div style="position:absolute;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1), transparent 50%);"></div>
        <div style="position:relative;z-index:1;display:flex;gap:16px;align-items:center;">
          <div id="profile-avatar" style="width:72px;height:72px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:900;backdrop-filter:blur(8px);">
            S
          </div>
          <div>
            <h2 id="profile-name" style="font-size:20px;font-weight:700;">Shelby User</h2>
            <p id="profile-id" style="font-size:13px;opacity:0.9;">ID: ...</p>
            <p id="profile-username" style="font-size:12px;opacity:0.8;margin-top:4px;">@username</p>
          </div>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:20px;font-size:12px;">
          <div>
            <p style="opacity:0.8;">عضو از</p>
            <p id="profile-joined" style="font-weight:600;">۱۴۰۴</p>
          </div>
          <div>
            <p style="opacity:0.8;">نسخه</p>
            <p style="font-weight:600;">v3.0</p>
          </div>
        </div>
      </div>

      <!-- Settings -->
      <div style="background:var(--card);border-radius:20px;margin:16px;padding:20px;box-shadow:var(--shadow);">
        <h3 style="font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
          Settings تنظیمات
        </h3>

        <!-- Theme -->
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <div style="display:flex;gap:12px;align-items:center;">
            Moon تم
            <p style="color:var(--text-secondary);font-size:13px;">تیره / روشن</p>
          </div>
          <button id="profile-theme-toggle" class="btn">Moon</button>
        </div>

        <!-- Language -->
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <div style="display:flex;gap:12px;align-items:center;">
            Globe زبان
            <p style="color:var(--text-secondary);font-size:13px;">فارسی / English</p>
          </div>
          <button id="profile-lang-toggle" class="btn">EN</button>
        </div>

        <!-- Notifications -->
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <div style="display:flex;gap:12px;align-items:center;">
            Bell اعلان‌ها
            <p style="color:var(--text-secondary);font-size:13px;">هشدار قیمت</p>
          </div>
          <label style="position:relative;display:inline-block;width:56px;height:32px;">
            <input type="checkbox" id="notifications-toggle" style="opacity:0;width:0;height:0;">
            <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#333;border-radius:34px;transition:.3s;">
              <span style="position:absolute;content:'';height:26px;width:26px;left:3px;bottom:3px;background:white;border-radius:50%;transition:.3s;"></span>
            </span>
          </label>
        </div>

        <!-- Haptic -->
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="display:flex;gap:12px;align-items:center;">
            Zap لرزش دکمه‌ها
            <p style="color:var(--text-secondary);font-size:13px;">بازخورد لمسی</p>
          </div>
          <label style="position:relative;display:inline-block;width:56px;height:32px;">
            <input type="checkbox" id="haptic-toggle" checked style="opacity:0;width:0;height:0;">
            <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--primary);border-radius:34px;transition:.3s;">
              <span style="position:absolute;content:'';height:26px;width:26px;left:27px;bottom:3px;background:white;border-radius:50%;transition:.3s;"></span>
            </span>
          </label>
        </div>
      </div>

      <!-- Stats -->
      <div style="background:var(--card);border-radius:20px;margin:16px;padding:20px;box-shadow:var(--shadow);">
        <h3 style="font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
          Bar Chart آمار اپ
        </h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div style="background:var(--bubble);border-radius:16px;padding:16px;text-align:center;">
            <p id="stats-coins" style="font-size:24px;font-weight:700;color:var(--primary);">0</p>
            <p style="color:var(--text-secondary);font-size:12px;margin-top:4px;">تعداد ارزها</p>
          </div>
          <div style="background:var(--bubble);border-radius:16px;padding:16px;text-align:center;">
            <p id="stats-wallets" style="font-size:24px;font-weight:700;color:var(--success);">0</p>
            <p style="color:var(--text-secondary);font-size:12px;margin-top:4px;">کیف پول‌ها</p>
          </div>
          <div style="background:var(--bubble);border-radius:16px;padding:16px;text-align:center;">
            <p id="stats-alerts" style="font-size:24px;font-weight:700;color:var(--danger);">0</p>
            <p style="color:var(--text-secondary);font-size:12px;margin-top:4px;">هشدار فعال</p>
          </div>
          <div style="background:var(--bubble);border-radius:16px;padding:16px;text-align:center;">
            <p id="stats-total" style="font-size:24px;font-weight:700;color:#10B981;">$0</p>
            <p style="color:var(--text-secondary);font-size:12px;margin-top:4px;">کل موجودی</p>
          </div>
        </div>
      </div>

      <!-- About -->
      <div style="background:linear-gradient(135deg, #1a1a1a, #2a2a2a);border-radius:20px;margin:16px;padding:24px;text-align:center;box-shadow:var(--shadow);">
        <h3 style="font-weight:600;margin-bottom:12px;">درباره Shelby Bet</h3>
        <p style="color:var(--text-secondary);font-size:14px;line-height:1.6;">
          بهترین ابزار مدیریت کریپتو در تلگرام<br>
          با پشتیبانی از ETH، TON، TRON و USDT
        </p>
        <div style="display:flex;justify-content:center;gap:12px;margin:20px 0;">
          <a href="#" style="width:44px;height:44px;background:var(--bubble);border-radius:16px;display:flex;align-items:center;justify-content:center;">
            Github
          </a>
          <a href="#" style="width:44px;height:44px;background:var(--bubble);border-radius:16px;display:flex;align-items:center;justify-content:center;">
            Twitter
          </a>
          <button onclick="openTelegram()" style="width:44px;height:44px;background:var(--bubble);border-radius:16px;display:flex;align-items:center;justify-content:center;">
            Send
          </button>
        </div>
        <p style="color:var(--text-secondary);font-size:12px;">نسخه 3.0 - ۱۴۰۴</p>
      </div>
    </div>
    <script>
    // === STATE & CONSTANTS ===
    const CONFIG = {
      COINGECKO_API: 'https://api.coingecko.com/api/v3',
      ETHERSCAN_KEY: '5G4HJDG2TCMMI2V8GQM6GJ636NVEW1HJU1',
      UPDATE_INTERVAL: 120000,
      ALERT_CHECK_INTERVAL: 30000,
      CURRENCY: 'usd',
      PRICE_ALERT_THRESHOLD: 0.005,
    };

    let state = {
      markets: [],
      wallets: JSON.parse(localStorage.getItem('wallets') || '[]'),
      favorites: JSON.parse(localStorage.getItem('favorites') || '[]'),
      alerts: JSON.parse(localStorage.getItem('alerts') || '[]'),
      currentTab: 'markets',
      currentMarketTab: 'all',
      currentSort: 'market_cap_desc',
      page: 1,
      hasMore: true,
      loading: false,
      isDark: localStorage.getItem('theme') === 'dark',
      lang: localStorage.getItem('lang') || 'fa',
      notificationsEnabled: localStorage.getItem('notifications') === 'true',
      hapticEnabled: localStorage.getItem('haptic') !== 'false',
      user: null,
      totalBalance: 0,
      profilePhoto: null,
    };

    // === TRANSLATIONS ===
    const translations = {
      fa: {
        markets: 'بازارها', wallet: 'کیف پول', profile: 'پروفایل',
        search: 'جستجو در ارزها...', all: 'همه', favorites: 'علاقه‌مندی‌ها',
        gainers: 'بیشترین رشد', losers: 'بیشترین افت', volume: 'حجم بالا',
        marketCap: 'ارزش بازار (نزولی)', marketCapAsc: 'ارزش بازار (صعودی)',
        growth24h: 'رشد ۲۴ساعته', loss24h: 'افت ۲۴ساعته', volume24h: 'حجم معاملات',
        nameAsc: 'نام (الفبا)', noWallet: 'هیچ کیف پولی اضافه نشده',
        addWallet: 'افزودن کیف پول', export: 'خروجی', import: 'ورودی',
        balance: 'موجودی', usd: 'دلار', add: 'افزودن', cancel: 'لغو',
        delete: 'حذف', edit: 'ویرایش', copy: 'کپی شد!', qr: 'نمایش QR',
        chart: 'نمودار', alert: 'هشدار', theme: 'تم', language: 'زبان',
        notifications: 'اعلان‌ها', haptic: 'لرزش دکمه‌ها', stats: 'آمار اپ',
        coins: 'تعداد ارزها', wallets: 'کیف پول‌ها', alerts: 'هشدار فعال',
        totalBalance: 'کل موجودی', about: 'درباره ما', version: 'نسخه 3.0 - ۱۴۰۴',
        days7: '۷ روز', days30: '۳۰ روز', priceTarget: 'قیمت هدف (USD)',
        currentPrice: 'قیمت فعلی', alertSet: 'هشدار تنظیم شد',
        alertTriggered: 'هشدار فعال شد', copied: 'کپی شد',
        exportSuccess: 'فایل خروجی ایجاد شد', importSuccess: 'کیف پول وارد شد',
        invalidAddress: 'آدرس نامعتبر است', error: 'خطا',
        loading: 'در حال بارگذاری...', refresh: 'تازه‌سازی',
        noResults: 'موردی یافت نشد', loadMore: 'بارگذاری بیشتر',
        memberSince: 'عضو از', versionLabel: 'نسخه',
        eth: 'اتریوم', ton: 'تون', tron: 'ترون', usdt: 'تتر',
        balanceLoading: 'در حال بارگذاری...', balanceError: 'خطا',
        network: 'شبکه', address: 'آدرس', name: 'نام (اختیاری)',
        editWallet: 'ویرایش کیف پول', save: 'ذخیر',
        deleteConfirm: 'آیا مطمئن هستید؟', yes: 'بله', no: 'خیر',
        importFile: 'فایل JSON را انتخاب کنید', importError: 'فایل نامعتبر',
        selectName: 'نام خود را وارد کنید', selectNameDesc: 'برای نمایش در پروفایل',
      },
      en: {
        markets: 'Markets', wallet: 'Wallet', profile: 'Profile',
        search: 'Search coins...', all: 'All', favorites: 'Favorites',
        gainers: 'Top Gainers', losers: 'Top Losers', volume: 'High Volume',
        marketCap: 'Market Cap (Desc)', marketCapAsc: 'Market Cap (Asc)',
        growth24h: '24h Growth', loss24h: '24h Loss', volume24h: 'Volume',
        nameAsc: 'Name (A-Z)', noWallet: 'No wallet added',
        addWallet: 'Add Wallet', export: 'Export', import: 'Import',
        balance: 'Balance', usd: 'USD', add: 'Add', cancel: 'Cancel',
        delete: 'Delete', edit: 'Edit', copy: 'Copied!', qr: 'Show QR',
        chart: 'Chart', alert: 'Alert', theme: 'Theme', language: 'Language',
        notifications: 'Notifications', haptic: 'Haptic', stats: 'App Stats',
        coins: 'Coins', wallets: 'Wallets', alerts: 'Active Alerts',
        totalBalance: 'Total Balance', about: 'About', version: 'v3.0 - 2025',
        days7: '7 Days', days30: '30 Days', priceTarget: 'Target Price (USD)',
        currentPrice: 'Current Price', alertSet: 'Alert set',
        alertTriggered: 'Alert triggered', copied: 'Copied',
        exportSuccess: 'Export file created', importSuccess: 'Wallet imported',
        invalidAddress: 'Invalid address', error: 'Error',
        loading: 'Loading...', refresh: 'Refresh',
        noResults: 'No results found', loadMore: 'Load More',
        memberSince: 'Member since', versionLabel: 'Version',
        eth: 'Ethereum', ton: 'TON', tron: 'TRON', usdt: 'USDT',
        balanceLoading: 'Loading...', balanceError: 'Error',
        network: 'Network', address: 'Address', name: 'Name (optional)',
        editWallet: 'Edit Wallet', save: 'Save',
        deleteConfirm: 'Are you sure?', yes: 'Yes', no: 'No',
        importFile: 'Select JSON file', importError: 'Invalid file',
        selectName: 'Enter your name', selectNameDesc: 'For display in profile',
      }
    };

    const t = (key) => translations[state.lang][key] || key;

    // === TELEGRAM WEB APP INIT ===
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.enableClosingConfirmation();

    // === USER DATA FROM TELEGRAM ===
    function initUser() {
      const user = tg.initDataUnsafe?.user;
      if (user) {
        state.user = user;
        document.getElementById('profile-name').textContent = 
          user.first_name + (user.last_name ? ' ' + user.last_name : '');
        document.getElementById('profile-id').textContent = `ID: ${user.id}`;
        document.getElementById('profile-username').textContent = 
          user.username ? `@${user.username}` : '—';
        document.getElementById('profile-avatar').textContent = 
          (user.first_name?.[0] || 'S').toUpperCase();

        if (user.photo_url) {
          state.profilePhoto = user.photo_url;
          const avatar = document.getElementById('profile-avatar');
          avatar.innerHTML = `<img src="${user.photo_url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
        }
      } else {
        setTimeout(() => {
          if (!localStorage.getItem('customName')) openNameSelectionModal();
        }, 500);
      }

      const joined = new Date().toLocaleDateString(state.lang === 'fa' ? 'fa-IR' : 'en-US', { year: 'numeric', month: 'long' });
      document.getElementById('profile-joined').textContent = joined;
    }

    function openNameSelectionModal() {
      openModal(`
        <div style="text-align:center;">
          <h3 class="modal-title">User نام خود را وارد کنید</h3>
          <p style="color:var(--text-secondary);margin-bottom:16px;">${t('selectNameDesc')}</p>
          <input type="text" id="custom-name-input" placeholder="نام شما" style="width:100%;padding:14px 16px;background:var(--bubble);border:none;border-radius:16px;color:var(--text);margin-bottom:16px;">
          <div style="display:flex;gap:8px;">
            <button onclick="saveCustomName()" class="btn-primary" style="flex:1;">${t('save')}</button>
            <button onclick="closeModal()" style="flex:1;padding:14px;background:var(--bubble);color:var(--text);border:none;border-radius:16px;">${t('cancel')}</button>
          </div>
        </div>
      `);
    }

    window.saveCustomName = () => {
      const name = document.getElementById('custom-name-input').value.trim();
      if (!name) return;
      localStorage.setItem('customName', name);
      document.getElementById('profile-name').textContent = name;
      document.getElementById('profile-avatar').textContent = name[0].toUpperCase();
      closeModal();
    };

    // === HAPTIC FEEDBACK ===
    const haptic = (type = 'light') => {
      if (state.hapticEnabled && tg.HapticFeedback) {
        tg.HapticFeedback.impactOccurred(type);
      }
    };

    // === THEME & LANGUAGE ===
    function updateTheme() {
      state.isDark = localStorage.getItem('theme') === 'dark';
      document.documentElement.classList.toggle('dark', state.isDark);
      const icon = state.isDark ? 'Sun' : 'Moon';
      document.getElementById('theme-toggle').textContent = icon;
      document.getElementById('profile-theme-toggle').textContent = icon;
      localStorage.setItem('theme', state.isDark ? 'dark' : 'light');
    }

    function updateLanguage() {
      state.lang = localStorage.getItem('lang') || 'fa';
      const btnText = state.lang === 'fa' ? 'EN' : 'FA';
      document.getElementById('lang-toggle').textContent = btnText;
      document.getElementById('profile-lang-toggle').textContent = btnText;
      document.documentElement.dir = state.lang === 'fa' ? 'rtl' : 'ltr';
      document.documentElement.lang = state.lang;
      updateUIText();
      localStorage.setItem('lang', state.lang);
    }

    function updateUIText() {
      document.querySelector('[data-tab="markets"]').textContent = t('markets');
      document.querySelector('[data-tab="wallet"]').textContent = t('wallet');
      document.querySelector('[data-tab="profile"]').textContent = t('profile');
      document.getElementById('search').placeholder = t('search');
      document.querySelector('#page-wallet .empty-title').textContent = t('noWallet');
      document.querySelector('#page-wallet .empty-desc').textContent = 'برای شروع، یک کیف پول جدید اضافه کنید';
      document.querySelector('#page-wallet .btn-primary').textContent = t('addWallet');
    }

    // === TAB NAVIGATION ===
    document.querySelectorAll('[data-tab]').forEach(btn => {
      btn.onclick = () => {
        haptic('light');
        document.querySelectorAll('[data-tab]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
        const page = document.getElementById(`page-${btn.dataset.tab}`);
        if (page) page.classList.remove('hidden');
        state.currentTab = btn.dataset.tab;

        if (state.currentTab === 'markets') loadMarkets();
        else if (state.currentTab === 'wallet') renderWallets();
        else if (state.currentTab === 'profile') updateProfileStats();
      };
    });

    // Theme & Lang Buttons
    document.getElementById('theme-toggle').onclick = () => {
      haptic('light');
      state.isDark = !state.isDark;
      updateTheme();
    };

    document.getElementById('profile-theme-toggle').onclick = () => {
      haptic('light');
      state.isDark = !state.isDark;
      updateTheme();
    };

    document.getElementById('lang-toggle').onclick = () => {
      haptic('light');
      state.lang = state.lang === 'fa' ? 'en' : 'fa';
      updateLanguage();
    };

    document.getElementById('profile-lang-toggle').onclick = () => {
      haptic('light');
      state.lang = state.lang === 'fa' ? 'en' : 'fa';
      updateLanguage();
    };

    // Toggles
    document.getElementById('notifications-toggle').checked = state.notificationsEnabled;
    document.getElementById('notifications-toggle').onchange = (e) => {
      state.notificationsEnabled = e.target.checked;
      localStorage.setItem('notifications', state.notificationsEnabled);
    };

    document.getElementById('haptic-toggle').checked = state.hapticEnabled;
    document.getElementById('haptic-toggle').onchange = (e) => {
      state.hapticEnabled = e.target.checked;
      localStorage.setItem('haptic', state.hapticEnabled);
    };
// === SEARCH & FILTERS ===
    const searchInput = document.getElementById('search');
    let searchTimeout;

    searchInput.oninput = () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        state.page = 1;
        renderMarkets();
      }, 300);
    };

    // === MARKET TABS & SORTING ===
    document.querySelectorAll('[data-market-tab]').forEach(btn => {
      btn.onclick = () => {
        haptic('light');
        document.querySelectorAll('[data-market-tab]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.currentMarketTab = btn.dataset.marketTab;
        state.page = 1;
        state.hasMore = true;
        loadMarkets();
      };
    });

    document.getElementById('sort-select').onchange = (e) => {
      state.currentSort = e.target.value;
      state.page = 1;
      state.hasMore = true;
      loadMarkets();
    };

    document.getElementById('refresh-markets').onclick = () => {
      haptic('medium');
      state.page = 1;
      state.hasMore = true;
      loadMarkets();
    };

    // === MARKETS DATA LOADING ===
    async function loadMarkets() {
      if (state.loading) return;
      state.loading = true;

      const list = document.getElementById('markets-list');
      const skeleton = document.getElementById('skeleton');
      const loadMore = document.getElementById('load-more');

      if (state.page === 1) {
        skeleton.classList.remove('hidden');
        list.innerHTML = '';
        loadMore?.classList.add('hidden');

        // Show skeleton
        skeleton.innerHTML = Array(12).fill().map(() => `
          <div class="skeleton">
            <div style="display:flex;gap:12px;align-items:center;">
              <div style="width:44px;height:44px;background:#333;border-radius:50%;"></div>
              <div style="flex:1;">
                <div style="height:16px;background:#333;border-radius:8px;width:60%;margin-bottom:8px;"></div>
                <div style="height:12px;background:#333;border-radius:8px;width:40%;"></div>
              </div>
              <div style="text-align:right;">
                <div style="height:18px;background:#333;border-radius:8px;width:70px;margin-bottom:8px;"></div>
                <div style="height:12px;background:#333;border-radius:8px;width:50px;"></div>
              </div>
            </div>
          </div>
        `).join('');
      }

      try {
        let url = `${CONFIG.COINGECKO_API}/coins/markets?vs_currency=${CONFIG.CURRENCY}&order=${state.currentSort}&per_page=50&page=${state.page}&sparkline=false`;

        if (state.currentMarketTab === 'favorites' && state.favorites.length > 0) {
          url += `&ids=${state.favorites.join(',')}`;
        }

        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 10000);

        const res = await fetch(url, {
          signal: controller.signal,
          headers: { 'accept': 'application/json' }
        });

        clearTimeout(timeout);

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();

        // Special sorting for gainers/losers
        if (state.currentMarketTab === 'gainers') {
          data.sort((a, b) => (b.price_change_percentage_24h || 0) - (a.price_change_percentage_24h || 0));
        } else if (state.currentMarketTab === 'losers') {
          data.sort((a, b) => (a.price_change_percentage_24h || 0) - (b.price_change_percentage_24h || 0));
        }

        if (state.page === 1) state.markets = [];
        state.markets = state.markets.concat(data);
        state.hasMore = data.length === 50;

        renderMarkets();
        if (loadMore) loadMore.classList.toggle('hidden', !state.hasMore);
      } catch (err) {
        console.error('Market load error:', err);
        if (state.page === 1) {
          list.innerHTML = `
            <div style="text-align:center;padding:60px 20px;">
              <div style="width:80px;height:80px;background:var(--bubble);border-radius:50%;margin:0 auto 20px;display:flex;align-items:center;justify-content:center;font-size:36px;">
                Wifi Off
              </div>
              <p style="color:#EF4444;font-weight:600;margin-bottom:16px;">${t('error')}</p>
              <button onclick="loadMarkets()" style="padding:12px 32px;background:var(--primary);color:white;border:none;border-radius:16px;font-weight:600;">
                ${t('refresh')}
              </button>
            </div>
          `;
        }
      } finally {
        skeleton.classList.add('hidden');
        state.loading = false;
      }
    }

    // === RENDER MARKETS ===
    function renderMarkets() {
      const list = document.getElementById('markets-list');
      const search = searchInput.value.toLowerCase().trim();

      let filtered = state.markets;

      if (search) {
        filtered = filtered.filter(coin =>
          coin.name.toLowerCase().includes(search) ||
          coin.symbol.toLowerCase().includes(search)
        );
      }

      if (filtered.length === 0 && state.page === 1) {
        list.innerHTML = `
          <div style="text-align:center;padding:60px 20px;">
            <div style="width:80px;height:80px;background:var(--bubble);border-radius:50%;margin:0 auto 20px;display:flex;align-items:center;justify-content:center;font-size:36px;">
              Search
            </div>
            <p style="color:var(--text-secondary);">${t('noResults')}</p>
          </div>
        `;
        return;
      }

      const html = filtered.map(coin => {
        const isFav = state.favorites.includes(coin.id);
        const change = coin.price_change_percentage_24h || 0;
        const priceClass = change > 0 ? 'up' : change < 0 ? 'down' : '';
        const changeSign = change > 0 ? '+' : '';

        return `
          <div class="market-card" data-coin-id="${coin.id}">
            <div class="row">
              <div class="coin">
                <img src="${coin.image}" alt="${coin.name}">
                <div>
                  <div class="coin-name">${coin.name}</div>
                  <div class="coin-symbol">${coin.symbol.toUpperCase()}</div>
                </div>
              </div>
              <div class="price">
                <div class="price-main">$${coin.current_price?.toLocaleString() || '—'}</div>
                <div class="price-change ${priceClass}">
                  ${changeSign}${change.toFixed(2)}%
                </div>
              </div>
            </div>
            <div class="actions">
              <button onclick="toggleFavorite('${coin.id}')" style="color:${isFav ? '#FBBF24' : 'inherit'};">
                ${isFav ? 'Star Filled' : 'Star'}
              </button>
              <button onclick="openChart('${coin.id}', '${coin.name}')">Trending Up</button>
              <button onclick="openPriceAlertModal('${coin.id}', '${coin.name}', ${coin.current_price})">Bell</button>
            </div>
          </div>
        `;
      }).join('');

      if (state.page === 1) {
        list.innerHTML = html;
      } else {
        list.innerHTML += html;
      }
    }

    window.toggleFavorite = (id) => {
      haptic('light');
      const index = state.favorites.indexOf(id);
      if (index > -1) {
        state.favorites.splice(index, 1);
      } else {
        state.favorites.push(id);
      }
      localStorage.setItem('favorites', JSON.stringify(state.favorites));
      renderMarkets();
      if (state.currentMarketTab === 'favorites') {
        state.page = 1;
        loadMarkets();
      }
    };

    document.getElementById('load-more')?.addEventListener('click', () => {
      haptic('medium');
      state.page++;
      loadMarkets();
    });
 // === CHART MODAL ===
    let priceChart = null;

    window.openChart = async (id, name) => {
      haptic('medium');
      openModal(`
        <div style="text-align:center;">
          <h3 class="modal-title">Trending Up نمودار ${name}</h3>
          <div style="display:flex;gap:8px;justify-content:center;margin-bottom:16px;">
            <button id="chart-7d" class="btn-primary" style="padding:8px 16px;font-size:14px;">${t('days7')}</button>
            <button id="chart-30d" class="btn-primary" style="padding:8px 16px;font-size:14px;opacity:0.6;">${t('days30')}</button>
          </div>
          <canvas id="price-canvas" style="height:240px;margin:16px 0;"></canvas>
          <p style="color:var(--text-secondary);font-size:13px;">${t('loading')}...</p>
        </div>
      `);

      const ctx = document.getElementById('price-canvas').getContext('2d');
      if (priceChart) priceChart.destroy();

      priceChart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [{ data: [], borderColor: '#1DA1F2', tension: 0.4, fill: false }] },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { display: false },
            y: { display: true, ticks: { color: 'rgba(255,255,255,0.6)' } }
          }
        }
      });

      loadChartData(id, 7);

      document.getElementById('chart-7d').onclick = () => {
        document.getElementById('chart-7d').style.opacity = '1';
        document.getElementById('chart-30d').style.opacity = '0.6';
        loadChartData(id, 7);
      };

      document.getElementById('chart-30d').onclick = () => {
        document.getElementById('chart-30d').style.opacity = '1';
        document.getElementById('chart-7d').style.opacity = '0.6';
        loadChartData(id, 30);
      };
    };

    async function loadChartData(id, days) {
      try {
        const res = await fetch(`${CONFIG.COINGECKO_API}/coins/${id}/market_chart?vs_currency=usd&days=${days}`);
        const data = await res.json();
        const prices = data.prices;

        const labels = prices.map(p => new Date(p[0]).toLocaleDateString(state.lang === 'fa' ? 'fa-IR' : 'en-US', { month: 'short', day: 'numeric' }));
        const values = prices.map(p => p[1]);

        priceChart.data.labels = labels;
        priceChart.data.datasets[0].data = values;
        priceChart.update();

        document.querySelector('#modal-body p').textContent = '';
      } catch (err) {
        document.querySelector('#modal-body p').textContent = t('error');
      }
    }

    // === PRICE ALERT MODAL ===
    window.openPriceAlertModal = (id, name, currentPrice) => {
      haptic('medium');
      openModal(`
        <div>
          <h3 class="modal-title">Bell ${t('alert')} برای ${name}</h3>
          <div style="background:var(--bubble);border-radius:16px;padding:16px;margin-bottom:16px;">
            <p style="font-size:14px;color:var(--text-secondary);">${t('currentPrice')}: <span style="font-weight:700;color:var(--text);">$${currentPrice?.toLocaleString() || '—'}</span></p>
          </div>
          <div style="margin-bottom:16px;">
            <label style="display:block;font-size:14px;font-weight:600;margin-bottom:8px;">${t('priceTarget')}</label>
            <input type="number" id="alert-price" placeholder="مثلاً ۶۵۰۰۰" step="0.01" style="width:100%;padding:14px 16px;background:var(--card);border:1px solid var(--border);border-radius:16px;color:var(--text);">
          </div>
          <div style="display:flex;gap:8px;">
            <button onclick="setPriceAlert('${id}', '${name}')" class="btn-primary" style="flex:1;">${t('add')}</button>
            <button onclick="closeModal()" style="flex:1;padding:14px;background:var(--bubble);color:var(--text);border:none;border-radius:16px;">${t('cancel')}</button>
          </div>
        </div>
      `);
    };

    window.setPriceAlert = (id, name) => {
      const input = document.getElementById('alert-price');
      const price = parseFloat(input.value);
      if (!price || price <= 0) {
        input.style.borderColor = '#EF4444';
        return;
      }
      const alert = {
        id,
        name,
        price,
        active: true,
        created: Date.now(),
        notified: false
      };
      state.alerts.push(alert);
      localStorage.setItem('alerts', JSON.stringify(state.alerts));
      closeModal();
      showToast(`${t('alert')}`, `${name} در $${price.toLocaleString()} ${t('alertSet')}`);
      updateProfileStats();
    };

    function checkPriceAlerts() {
      if (!state.notificationsEnabled || state.markets.length === 0) return;

      state.alerts.forEach((alert, i) => {
        if (!alert.active || alert.notified) return;

        const coin = state.markets.find(c => c.id === alert.id);
        if (!coin) return;

        const diff = Math.abs(coin.current_price - alert.price) / alert.price;
        if (diff <= CONFIG.PRICE_ALERT_THRESHOLD) {
          showToast(`${t('alertTriggered')}!`, `${coin.name} به $${coin.current_price.toFixed(2)} رسید`);
          state.alerts[i].active = false;
          state.alerts[i].notified = true;
          localStorage.setItem('alerts', JSON.stringify(state.alerts));
          updateProfileStats();
        }
      });
    }

    // === WALLET MANAGEMENT ===
    window.openAddWallet = () => {
      haptic('medium');
      openModal(`
        <div>
          <h3 class="modal-title">Plus Circle ${t('addWallet')}</h3>
          <div style="space-y:16px;">
            <div>
              <label style="display:block;font-size:14px;font-weight:600;margin-bottom:8px;">${t('name')}</label>
              <input type="text" id="wallet-name" placeholder="مثلاً: کیف اصلی" style="width:100%;padding:14px 16px;background:var(--card);border:1px solid var(--border);border-radius:16px;color:var(--text);">
            </div>
            <div>
              <label style="display:block;font-size:14px;font-weight:600;margin-bottom:8px;">${t('network')}</label>
              <select id="wallet-network" style="width:100%;padding:14px 16px;background:var(--card);border:1px solid var(--border);border-radius:16px;color:var(--text);">
                <option value="eth">${t('eth')}</option>
                <option value="ton">${t('ton')}</option>
                <option value="tron">${t('tron')} (${t('usdt')})</option>
              </select>
            </div>
            <div>
              <label style="display:block;font-size:14px;font-weight:600;margin-bottom:8px;">${t('address')}</label>
              <input type="text" id="wallet-address" placeholder="0x..." style="width:100%;padding:14px 16px;background:var(--card);border:1px solid var(--border);border-radius:16px;color:var(--text);">
            </div>
          </div>
          <div style="display:flex;gap:8px;margin-top:16px;">
            <button onclick="addWallet()" class="btn-primary" style="flex:1;">${t('add')}</button>
            <button onclick="closeModal()" style="flex:1;padding:14px;background:var(--bubble);color:var(--text);border:none;border-radius:16px;">${t('cancel')}</button>
          </div>
        </div>
      `);
    };

    window.addWallet = () => {
      const name = document.getElementById('wallet-name').value.trim();
      const network = document.getElementById('wallet-network').value;
      const address = document.getElementById('wallet-address').value.trim();

      if (!address) {
        document.getElementById('wallet-address').style.borderColor = '#EF4444';
        return;
      }

      if (!validateAddress(address, network)) {
        showToast(t('error'), t('invalidAddress'));
        return;
      }

      const wallet = { name: name || address.slice(0, 8) + '...', network, address };
      state.wallets.push(wallet);
      localStorage.setItem('wallets', JSON.stringify(state.wallets));
      closeModal();
      renderWallets();
      updateProfileStats();
      showToast('موفقیت', `${wallet.name} اضافه شد`);
    };

    window.editWallet = (i) => {
      haptic('medium');
      const w = state.wallets[i];
      openModal(`
        <div>
          <h3 class="modal-title">Edit ${t('editWallet')}</h3>
          <div style="space-y:16px;">
            <div>
              <label style="display:block;font-size:14px;font-weight:600;margin-bottom:8px;">${t('name')}</label>
              <input type="text" id="edit-name" value="${w.name}" style="width:100%;padding:14px 16px;background:var(--card);border:1px solid var(--border);border-radius:16px;color:var(--text);">
            </div>
            <div>
              <label style="display:block;font-size:14px;font-weight:600;margin-bottom:8px;">${t('address')}</label>
              <input type="text" id="edit-address" value="${w.address}" style="width:100%;padding:14px 16px;background:var(--card);border:1px solid var(--border);border-radius:16px;color:var(--text);">
            </div>
          </div>
          <div style="display:flex;gap:8px;margin-top:16px;">
            <button onclick="saveEditedWallet(${i})" class="btn-primary" style="flex:1;">${t('save')}</button>
            <button onclick="closeModal()" style="flex:1;padding:14px;background:var(--bubble);color:var(--text);border:none;border-radius:16px;">${t('cancel')}</button>
          </div>
        </div>
      `);
    };

    window.saveEditedWallet = (i) => {
      const name = document.getElementById('edit-name').value.trim();
      const address = document.getElementById('edit-address').value.trim();

      if (!address || !validateAddress(address, state.wallets[i].network)) {
        showToast(t('error'), t('invalidAddress'));
        return;
      }

      state.wallets[i].name = name || address.slice(0, 8) + '...';
      state.wallets[i].address = address;
      localStorage.setItem('wallets', JSON.stringify(state.wallets));
      closeModal();
      renderWallets();
    };
 window.removeWallet = (i) => {
      haptic('heavy');
      const w = state.wallets[i];
      openModal(`
        <div style="text-align:center;">
          <div style="width:80px;height:80px;background:#EF4444;border-radius:50%;margin:0 auto 20px;display:flex;align-items:center;justify-content:center;font-size:36px;color:white;">
            Trash
          </div>
          <h3 class="modal-title">${t('deleteConfirm')}</h3>
          <p style="color:var(--text-secondary);margin-bottom:24px;">
            ${w.name} حذف شود؟
          </p>
          <div style="display:flex;gap:8px;">
            <button onclick="confirmRemoveWallet(${i})" class="btn-primary" style="flex:1;background:#EF4444;">${t('yes')}</button>
            <button onclick="closeModal()" style="flex:1;padding:14px;background:var(--bubble);color:var(--text);border:none;border-radius:16px;">${t('no')}</button>
          </div>
        </div>
      `);
    };

    window.confirmRemoveWallet = (i) => {
      state.wallets.splice(i, 1);
      localStorage.setItem('wallets', JSON.stringify(state.wallets));
      closeModal();
      renderWallets();
      updateProfileStats();
    };

    function validateAddress(address, network) {
      if (network === 'eth') return /^0x[a-fA-F0-9]{40}$/.test(address);
      if (network === 'ton') return /^[a-zA-Z0-9]{48}$/.test(address);
      if (network === 'tron') return /^T[a-zA-Z0-9]{33}$/.test(address);
      return false;
    }

    // === RENDER WALLETS ===
    function renderWallets() {
      const container = document.getElementById('page-wallet');
      const empty = container.querySelector('.empty');
      let list = container.querySelector('#wallet-list');

      if (!list) {
        list = document.createElement('div');
        list.id = 'wallet-list';
        container.insertBefore(list, empty);
      }

      if (state.wallets.length === 0) {
        empty.classList.remove('hidden');
        list.innerHTML = '';
        return;
      }

      empty.classList.add('hidden');
      list.innerHTML = state.wallets.map((w, i) => `
        <div class="market-card" style="position:relative;" data-wallet-index="${i}">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
            <div style="flex:1;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                <h4 style="font-weight:700;font-size:16px;">${w.name}</h4>
                <span style="background:var(--bubble);padding:4px 8px;border-radius:8px;font-size:12px;font-weight:600;">
                  ${getNetworkLabel(w.network)}
                </span>
              </div>
              <div style="display:flex;align-items:center;gap:8px;color:var(--text-secondary);font-size:13px;">
                <span class="truncate" style="max-width:180px;">${w.address}</span>
                <button onclick="copyToClipboard('${w.address}')" style="background:none;border:none;color:var(--primary);">
                  Copy
                </button>
              </div>
            </div>
            <div style="display:flex;gap:4px;">
              <button onclick="editWallet(${i})" style="width:36px;height:36px;background:var(--bubble);border-radius:12px;display:flex;align-items:center;justify-content:center;">
                Edit
              </button>
              <button onclick="removeWallet(${i})" style="width:36px;height:36px;background:#EF4444;color:white;border-radius:12px;display:flex;align-items:center;justify-content:center;">
                Trash
              </button>
            </div>
          </div>
          <div id="balance-${i}" style="display:flex;align-items:center;justify-content:space-between;">
            <span style="color:var(--text-secondary);font-size:13px;">${t('balanceLoading')}</span>
            <div style="width:16px;height:16px;border:2px solid #333;border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;"></div>
          </div>
          <button onclick="showQR('${w.address}', '${w.name}')" style="margin-top:12px;width:100%;padding:12px;background:var(--primary);color:white;border:none;border-radius:16px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:8px;">
            Qr Code نمایش QR
          </button>
        </div>
      `).join('');

      state.wallets.forEach((w, i) => fetchWalletBalance(w, i));
      calculateTotalBalance();
    }

    function getNetworkLabel(network) {
      return { eth: 'ETH', ton: 'TON', tron: 'USDT' }[network] || network.toUpperCase();
    }

    // === BALANCE FETCH ===
    async function fetchWalletBalance(wallet, index) {
      const el = document.getElementById(`balance-${index}`);
      if (!el) return;

      try {
        let balance = 0, usd = 0, symbol = '';

        if (wallet.network === 'eth') {
          const res = await fetch(`${CONFIG.ETH_API}?module=account&action=balance&address=${wallet.address}&tag=latest&apikey=${CONFIG.ETHERSCAN_KEY}`);
          const data = await res.json();
          if (data.status !== '1') throw new Error();
          balance = parseInt(data.result) / 1e18;
          const priceRes = await fetch(`${CONFIG.COINGECKO_API}/simple/price?ids=ethereum&vs_currencies=usd`);
          const priceData = await priceRes.json();
          usd = balance * priceData.ethereum.usd;
          symbol = 'ETH';
        } else if (wallet.network === 'ton') {
          const res = await fetch(`${CONFIG.TON_API}/getAddressInformation?address=${wallet.address}`);
          const data = await res.json();
          balance = data.balance / 1e9;
          usd = balance * 6.5; // تقریبی
          symbol = 'TON';
        } else if (wallet.network === 'tron') {
          const res = await fetch(`${CONFIG.TRON_API}/v1/accounts/${wallet.address}`);
          const data = await res.json();
          const usdt = data.data[0]?.trc20?.find(t => t.tokenName === 'Tether USDt' || t.tokenAbbr === 'USDT');
          balance = usdt ? usdt.balance / 1e6 : 0;
          usd = balance;
          symbol = 'USDT';
        }

        el.innerHTML = `
          <div>
            <p style="font-weight:700;font-size:16px;">${balance.toFixed(4)} ${symbol}</p>
            <p style="color:var(--text-secondary);font-size:13px;">≈ $${usd.toFixed(2)}</p>
          </div>
        `;
        calculateTotalBalance();
      } catch (e) {
        el.innerHTML = `<span style="color:#EF4444;font-size:13px;">${t('balanceError')}</span>`;
      }
    }

    function calculateTotalBalance() {
      let total = 0;
      document.querySelectorAll('[id^="balance-"]').forEach(el => {
        const text = el.innerText;
        const match = text.match(/\$([\d,]+\.?\d*)/);
        if (match) total += parseFloat(match[1].replace(/,/g, ''));
      });
      state.totalBalance = total;
      document.getElementById('stats-total').textContent = `$${total.toFixed(2)}`;
    }

    // === QR CODE MODAL ===
    window.showQR = (address, title) => {
      haptic('medium');
      openModal(`
        <div style="text-align:center;">
          <h3 class="modal-title">Qr Code QR کد ${title}</h3>
          <div style="background:var(--bubble);border-radius:20px;padding:24px;margin:16px 0;">
            <div id="qrcode" style="width:200px;height:200px;margin:0 auto;"></div>
          </div>
          <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:16px;">
            <p style="color:var(--text-secondary);font-size:13px;max-width:200px;word-break:break-all;">${address}</p>
            <button onclick="copyToClipboard('${address}')" style="background:none;border:none;color:var(--primary);">
              Copy
            </button>
          </div>
          <button onclick="closeModal()" style="width:100%;padding:14px;background:var(--primary);color:white;border:none;border-radius:16px;font-weight:600;">
            بستن
          </button>
        </div>
      `);

      document.getElementById('qrcode').innerHTML = '';
      new QRCode(document.getElementById('qrcode'), {
        text: address,
        width: 200,
        height: 200,
        colorDark: state.isDark ? '#ffffff' : '#000000',
        colorLight: state.isDark ? '#1f2937' : '#ffffff',
        correctLevel: QRCode.CorrectLevel.H
      });
    };

    // === COPY TO CLIPBOARD ===
    window.copyToClipboard = (text) => {
      haptic('light');
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
          showToast(t('copy'), t('copied'));
        }).catch(() => {
          fallbackCopy(text);
        });
      } else {
        fallbackCopy(text);
      }
    };

    function fallbackCopy(text) {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand('copy');
        showToast(t('copy'), t('copied'));
      } catch (err) {
        showToast(t('error'), 'کپی نشد');
      }
      document.body.removeChild(textarea);
    }

    // === EXPORT / IMPORT WALLETS ===
    window.exportWallets = () => {
      haptic('medium');
      if (state.wallets.length === 0) {
        showToast(t('error'), 'هیچ کیف پولی وجود ندارد');
        return;
      }
      const data = JSON.stringify(state.wallets, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `shelby-wallets-${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('موفقیت', t('exportSuccess'));
    };

    window.importWallets = () => {
      haptic('medium');
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          try {
            const imported = JSON.parse(ev.target.result);
            if (!Array.isArray(imported)) throw new Error();
            const valid = imported.filter(w => 
              w.address && ['eth','ton','tron'].includes(w.network) && validateAddress(w.address, w.network)
            );
            if (valid.length === 0) throw new Error();
            state.wallets = [...state.wallets, ...valid];
            localStorage.setItem('wallets', JSON.stringify(state.wallets));
            renderWallets();
            updateProfileStats();
            showToast('موفقیت', `${valid.length} ${t('importSuccess')}`);
          } catch {
            showToast(t('error'), t('importError'));
          }
        };
        reader.readAsText(file);
      };
      input.click();
    };
    // === AUTO UPDATE & ALERT CHECK ===
    let updateInterval, alertInterval;

    function startAutoUpdate() {
      clearInterval(updateInterval);
      clearInterval(alertInterval);

      updateInterval = setInterval(() => {
        if (state.currentTab === 'markets' && state.currentMarketTab !== 'favorites') {
          state.page = 1;
          state.hasMore = true;
          loadMarkets();
        }
      }, CONFIG.UPDATE_INTERVAL);

      alertInterval = setInterval(checkPriceAlerts, CONFIG.ALERT_CHECK_INTERVAL);
    }

    // === PROFILE STATS UPDATE ===
    function updateProfileStats() {
      document.getElementById('stats-coins').textContent = state.markets.length;
      document.getElementById('stats-wallets').textContent = state.wallets.length;
      document.getElementById('stats-alerts').textContent = state.alerts.filter(a => a.active).length;
      document.getElementById('stats-total').textContent = `$${state.totalBalance.toFixed(2)}`;
    }

    // === TELEGRAM LINK @ondbest ===
    window.openTelegram = () => {
      haptic('medium');
      tg.openTelegramLink('tg://msg?text=سلام%20Shelby%20Bet%20v3.0&to=ondbest');
      showToast('در حال باز شدن...', 'چت با @ondbest');
    };

    // === PWA SERVICE WORKER ===
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => {
            console.log('SW registered:', reg);
            reg.addEventListener('updatefound', () => {
              const newWorker = reg.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  showToast('به‌روزرسانی', 'نسخه جدید آماده است!');
                }
              });
            });
          })
          .catch(err => console.log('SW error:', err));
      });
    }

    // === GLOBAL ERROR HANDLING ===
    window.addEventListener('error', (e) => {
      console.error('Global error:', e.error);
      showToast(t('error'), 'مشکلی پیش آمد');
    });

    window.addEventListener('unhandledrejection', (e) => {
      console.error('Promise rejection:', e.reason);
      showToast(t('error'), 'درخواست ناموفق');
    });

    // === MEMORY & PERFORMANCE OPTIMIZATION ===
    setInterval(() => {
      if (state.markets.length > 500) {
        state.markets = state.markets.slice(0, 200);
      }
    }, 60000);

    // === RESIZE CHART ON ORIENTATION CHANGE ===
    window.addEventListener('resize', () => {
      if (priceChart) {
        setTimeout(() => priceChart.resize(), 100);
      }
    });

    // === HAPTIC ON ALL BUTTONS ===
    document.querySelectorAll('.haptic, .btn, button').forEach(el => {
      el.addEventListener('touchstart', () => haptic('light'));
    });

    // === CLOSE MODAL ON BACKDROP ===
    document.getElementById('modal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('modal')) {
        closeModal();
      }
    });

    // === INTERSECTION OBSERVER FOR LOAD MORE ===
    let loadMoreObserver;

    function initLoadMoreObserver() {
      const loadMore = document.getElementById('load-more');
      if (!loadMore || loadMoreObserver) return;

      loadMoreObserver = new IntersectionObserver(entries => {
        if (entries[0].isIntersecting && state.hasMore && !state.loading) {
          haptic('light');
          state.page++;
          loadMarkets();
        }
      }, { threshold: 0.1 });

      loadMoreObserver.observe(loadMore);
    }

    // === DEBOUNCE RENDER MARKETS ===
    let renderTimeout;
    const debouncedRenderMarkets = () => {
      clearTimeout(renderTimeout);
      renderTimeout = setTimeout(renderMarkets, 100);
    };

    // === CACHE BUSTING FOR API CALLS ===
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
      let url = args[0];
      if (typeof url === 'string' && url.includes('coingecko.com')) {
        const separator = url.includes('?') ? '&' : '?';
        url = `${url}${separator}_=${Date.now()}`;
        args[0] = url;
      }
      return originalFetch.apply(this, args);
    };

    // === CHART.JS GLOBAL CONFIG ===
    Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--text') || '#f5f5f5';
    Chart.defaults.borderColor = 'rgba(255,255,255,0.1)';

    // === QR CODE LIBRARY LOAD (Fallback) ===
    if (!window.QRCode) {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js';
      script.onload = () => console.log('QRCode loaded');
      script.onerror = () => console.log('QRCode failed');
      document.head.appendChild(script);
    }

    // === TON & TRON API ENDPOINTS ===
    Object.assign(CONFIG, {
      TON_API: 'https://toncenter.com/api/v2',
      TRON_API: 'https://api.trongrid.io'
    });

    // === INIT ON DOM READY ===
    document.addEventListener('DOMContentLoaded', () => {
      tg.ready();
      tg.expand();

      // Load saved settings
      updateTheme();
      updateLanguage();

      // Init user
      initUser();

      // Start with markets
      document.querySelector('[data-tab="markets"]').click();

      // Load initial data
      loadMarkets();
      renderWallets();
      updateProfileStats();

      // Start auto updates
      startAutoUpdate();

      // Init load more
      setTimeout(initLoadMoreObserver, 1000);

      // Show empty wallet if needed
      if (state.wallets.length === 0) {
        document.querySelector('#page-wallet .empty').classList.remove('hidden');
      }

      // Resize handler
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          if (priceChart) priceChart.resize();
        }, 250);
      });

      console.log('Shelby Bet v3.0 loaded successfully');
    });

    // === CLEANUP ON UNLOAD ===
    window.addEventListener('beforeunload', () => {
      if (priceChart) priceChart.destroy();
      if (loadMoreObserver) loadMoreObserver.disconnect();
      clearInterval(updateInterval);
      clearInterval(alertInterval);
    });
    <!-- Market Tabs & Sort -->
    <div style="margin:16px;display:flex;gap:8px;overflow-x:auto;padding-bottom:8px;">
      <button data-market-tab="all" class="tab active" style="flex:0 0 auto;padding:10px 16px;font-size:14px;min-width:80px;">${t('all')}</button>
      <button data-market-tab="favorites" class="tab" style="flex:0 0 auto;padding:10px 16px;font-size:14px;min-width:80px;">${t('favorites')}</button>
      <button data-market-tab="gainers" class="tab" style="flex:0 0 auto;padding:10px 16px;font-size:14px;min-width:80px;">${t('gainers')}</button>
      <button data-market-tab="losers" class="tab" style="flex:0 0 auto;padding:10px 16px;font-size:14px;min-width:80px;">${t('losers')}</button>
    </div>

    <div style="margin:0 16px 16px;display:flex;justify-content:space-between;align-items:center;">
      <select id="sort-select" style="padding:10px 14px;background:var(--card);border:1px solid var(--border);border-radius:16px;color:var(--text);font-size:14px;">
        <option value="market_cap_desc">${t('marketCap')}</option>
        <option value="market_cap_asc">${t('marketCapAsc')}</option>
        <option value="volume_desc">${t('volume24h')}</option>
        <option value="price_change_percentage_24h_desc">${t('growth24h')}</option>
        <option value="price_change_percentage_24h_asc">${t('loss24h')}</option>
        <option value="name">${t('nameAsc')}</option>
      </select>
      <button id="refresh-markets" style="padding:10px 14px;background:var(--primary);color:white;border:none;border-radius:16px;font-weight:600;display:flex;align-items:center;gap:8px;">
        Refresh تازه‌سازی
      </button>
    </div>

    <!-- Load More Button -->
    <div id="load-more" class="hidden" style="text-align:center;padding:16px;">
      <button style="padding:12px 32px;background:var(--bubble);color:var(--text);border:none;border-radius:16px;font-weight:600;">
        ${t('loadMore')}
      </button>
    </div>

    <!-- Wallet List Container -->
    <div id="wallet-list" style="margin:16px;"></div>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- QRCode.js CDN (Fallback in JS) -->
    <script>
      if (!window.QRCode) {
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js';
        s.onload = () => console.log('QRCode loaded');
        document.head.appendChild(s);
      }
    </script>

    <!-- Animation CSS -->
    <style>
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      .truncate {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .tab {
        background: var(--bubble);
        border-radius: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        white-space: nowrap;
      }
      .tab.active {
        background: var(--primary);
        color: white;
        box-shadow: 0 4px 12px rgba(29,161,242,0.4);
      }

      /* Smooth scroll */
      html { scroll-behavior: smooth; }

      /* Modal close animation */
      .modal-content {
        animation: modalIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
      @keyframes modalIn {
        from { transform: scale(0.8); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
      }

      /* Toast animation */
      .toast {
        animation: toastIn 0.3s ease;
      }
      @keyframes toastIn {
        from { transform: translateX(-50%) translateY(20px); opacity: 0; }
        to { transform: translateX(-50%) translateY(0); opacity: 1; }
      }

      /* Button press effect */
      button, .btn {
        transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
      button:active, .btn:active {
        transform: scale(0.95);
      }

      /* Input focus */
      input:focus, select:focus {
        outline: none;
        border-color: var(--primary) !important;
        box-shadow: 0 0 0 2px rgba(29,161,242,0.3);
      }

      /* Scrollbar (Webkit) */
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,0.2);
        border-radius: 3px;
      }
    </style>
  </div>

  <!-- Close Modal Helper -->
  <script>
    window.closeModal = () => {
      haptic('light');
      const modal = document.getElementById('modal');
      modal.classList.add('hidden');
      modal.querySelector('#modal-body').innerHTML = '';
      if (priceChart) {
        priceChart.destroy();
        priceChart = null;
      }
    };

    // Toast
    function showToast(title, message) {
      const toast = document.getElementById('toast');
      document.getElementById('toast-icon').textContent = title;
      document.getElementById('toast-msg').textContent = message;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    window.closeToast = () => {
      document.getElementById('toast').classList.add('hidden');
    };
  </script>
  <!-- Final Pages Structure -->
  <div id="page-markets" class="page">
    <div id="markets-list"></div>
    <div id="load-more" class="hidden" style="text-align:center;padding:16px;">
      <button style="padding:12px 32px;background:var(--bubble);color:var(--text);border:none;border-radius:16px;font-weight:600;">
        ${t('loadMore')}
      </button>
    </div>
  </div>

  <div id="page-wallet" class="page hidden">
    <div class="empty">
      <div class="empty-icon">Wallet</div>
      <p class="empty-title">${t('noWallet')}</p>
      <p class="empty-desc">برای شروع، یک کیف پول جدید اضافه کنید</p>
      <button class="btn-primary" onclick="openAddWallet()">${t('addWallet')}</button>
    </div>
    <div id="wallet-list"></div>
  </div>

  <div id="page-profile" class="page hidden">
    <!-- Profile Card -->
    <div class="profile-card" style="background:linear-gradient(135deg, var(--primary), #0d8bd9);border-radius:24px;margin:16px;padding:24px;color:white;position:relative;overflow:hidden;">
      <div style="position:absolute;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1), transparent 50%);opacity:0.5;"></div>
      <div style="position:relative;z-index:1;display:flex;gap:16px;align-items:center;">
        <div id="profile-avatar" style="width:72px;height:72px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:900;backdrop-filter:blur(8px);">
          S
        </div>
        <div>
          <h2 id="profile-name" style="font-size:20px;font-weight:700;">Shelby User</h2>
          <p id="profile-id" style="font-size:13px;opacity:0.9;">ID: ...</p>
          <p id="profile-username" style="font-size:12px;opacity:0.8;margin-top:4px;">@username</p>
        </div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:20px;font-size:12px;">
        <div>
          <p style="opacity:0.8;">${t('memberSince')}</p>
          <p id="profile-joined" style="font-weight:600;">۱۴۰۴</p>
        </div>
        <div>
          <p style="opacity:0.8;">${t('versionLabel')}</p>
          <p style="font-weight:600;">v3.0</p>
        </div>
      </div>
    </div>

    <!-- Settings Card -->
    <div class="settings-card" style="background:var(--card);border-radius:20px;margin:16px;padding:20px;box-shadow:var(--shadow);">
      <h3 style="font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
        Settings تنظیمات
      </h3>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <div style="display:flex;gap:12px;align-items:center;">
          Moon تم
          <p style="color:var(--text-secondary);font-size:13px;">تیره / روشن</p>
        </div>
        <button id="profile-theme-toggle" class="btn">Moon</button>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <div style="display:flex;gap:12px;align-items:center;">
          Globe زبان
          <p style="color:var(--text-secondary);font-size:13px;">فارسی / English</p>
        </div>
        <button id="profile-lang-toggle" class="btn">EN</button>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <div style="display:flex;gap:12px;align-items:center;">
          Bell اعلان‌ها
          <p style="color:var(--text-secondary);font-size:13px;">هشدار قیمت</p>
        </div>
        <label style="position:relative;display:inline-block;width:56px;height:32px;">
          <input type="checkbox" id="notifications-toggle" style="opacity:0;width:0;height:0;">
          <span class="switch"></span>
        </label>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="display:flex;gap:12px;align-items:center;">
          Zap لرزش دکمه‌ها
          <p style="color:var(--text-secondary);font-size:13px;">بازخورد لمسی</p>
        </div>
        <label style="position:relative;display:inline-block;width:56px;height:32px;">
          <input type="checkbox" id="haptic-toggle" checked style="opacity:0;width:0;height:0;">
          <span class="switch active"></span>
        </label>
      </div>
    </div>

    <!-- Stats Card -->
    <div class="stats-card" style="background:var(--card);border-radius:20px;margin:16px;padding:20px;box-shadow:var(--shadow);">
      <h3 style="font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
        Bar Chart ${t('stats')}
      </h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div style="background:var(--bubble);border-radius:16px;padding:16px;text-align:center;">
          <p id="stats-coins" style="font-size:24px;font-weight:700;color:var(--primary);">0</p>
          <p style="color:var(--text-secondary);font-size:12px;margin-top:4px;">${t('coins')}</p>
        </div>
        <div style="background:var(--bubble);border-radius:16px;padding:16px;text-align:center;">
          <p id="stats-wallets" style="font-size:24px;font-weight:700;color:var(--success);">0</p>
          <p style="color:var(--text-secondary);font-size:12px;margin-top:4px;">${t('wallets')}</p>
        </div>
        <div style="background:var(--bubble);border-radius:16px;padding:16px;text-align:center;">
          <p id="stats-alerts" style="font-size:24px;font-weight:700;color:var(--danger);">0</p>
          <p style="color:var(--text-secondary);font-size:12px;margin-top:4px;">${t('alerts')}</p>
        </div>
        <div style="background:var(--bubble);border-radius:16px;padding:16px;text-align:center;">
          <p id="stats-total" style="font-size:24px;font-weight:700;color:#10B981;">$0</p>
          <p style="color:var(--text-secondary);font-size:12px;margin-top:4px;">${t('totalBalance')}</p>
        </div>
      </div>
    </div>

    <!-- About Card -->
    <div class="about-card" style="background:linear-gradient(135deg, #1a1a1a, #2a2a2a);border-radius:20px;margin:16px;padding:24px;text-align:center;box-shadow:var(--shadow);">
      <h3 style="font-weight:600;margin-bottom:12px;">درباره Shelby Bet</h3>
      <p style="color:var(--text-secondary);font-size:14px;line-height:1.6;">
        بهترین ابزار مدیریت کریپتو در تلگرام<br>
        با پشتیبانی از ETH، TON، TRON و USDT
      </p>
      <div style="display:flex;justify-content:center;gap:12px;margin:20px 0;">
        <a href="https://github.com/ehsansaberizadeh2012-cmd/Tg_app" target="_blank" style="width:44px;height:44px;background:var(--bubble);border-radius:16px;display:flex;align-items:center;justify-content:center;">
          Github
        </a>
        <a href="https://x.com" target="_blank" style="width:44px;height:44px;background:var(--bubble);border-radius:16px;display:flex;align-items:center;justify-content:center;">
          Twitter
        </a>
        <button onclick="openTelegram()" style="width:44px;height:44px;background:var(--bubble);border-radius:16px;display:flex;align-items:center;justify-content:center;">
          Send
        </button>
      </div>
      <p style="color:var(--text-secondary);font-size:12px;">${t('version')} - ۱۴۰۴</p>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="hidden modal" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <button class="modal-close" onclick="closeModal()">Close</button>
      <div id="modal-body"></div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="hidden toast">
    <div id="toast-icon" class="toast-icon">Check</div>
    <div id="toast-msg">موفقیت!</div>
  </div>

  <!-- Service Worker File (Create Separately) -->
  <!-- File: sw.js -->
  <script>
    // Create sw.js content in memory if not exists
    if ('serviceWorker' in navigator && !navigator.serviceWorker.controller) {
      const swContent = `
        const CACHE = 'shelby-v3';
        const ASSETS = [
          '/', '/index.html',
          'https://telegram.org/js/telegram-web-app.js',
          'https://cdn.jsdelivr.net/npm/chart.js',
          'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js'
        ];

        self.addEventListener('install', e => {
          e.waitUntil(
            caches.open(CACHE).then(cache => cache.addAll(ASSETS))
          );
        });

        self.addEventListener('fetch', e => {
          if (e.request.url.includes('coingecko.com') || e.request.url.includes('etherscan.io')) {
            e.respondWith(
              caches.open(CACHE).then(cache => {
                return fetch(e.request).then(response => {
                  cache.put(e.request, response.clone());
                  return response;
                }).catch(() => cache.match(e.request))
              })
            );
          } else {
            e.respondWith(
              caches.match(e.request).then(response => response || fetch(e.request))
            );
          }
        });

        self.addEventListener('activate', e => {
          e.waitUntil(
            caches.keys().then(keys => {
              return Promise.all(
                keys.filter(key => key !== CACHE).map(key => caches.delete(key))
              );
            })
          );
        });
      `;

      const blob = new Blob([swContent], { type: 'application/javascript' });
      const url = URL.createObjectURL(blob);
      navigator.serviceWorker.register(url).catch(() => {});
    }
  </script>
  <!-- Final CSS -->
  <style>
    /* Switch Styles */
    .switch {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #333;
      border-radius: 34px;
      transition: .3s;
    }
    .switch::before {
      position: absolute;
      content: '';
      height: 26px; width: 26px;
      left: 3px; bottom: 3px;
      background: white;
      border-radius: 50%;
      transition: .3s;
    }
    input:checked + .switch {
      background: var(--primary);
    }
    input:checked + .switch::before {
      transform: translateX(24px);
    }

    /* Page Container */
    .page { display: none; }
    .page:not(.hidden) { display: block; }

    /* Skeleton Pulse */
    @keyframes pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }

    /* Card Hover */
    .market-card, .profile-card, .settings-card, .stats-card, .about-card {
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .market-card:active, .profile-card:active, .settings-card:active, .stats-card:active, .about-card:active {
      transform: scale(0.98);
    }

    /* Input & Select */
    input, select, textarea {
      font-family: inherit;
      font-size: 16px;
    }

    /* Focus Glow */
    input:focus, select:focus, textarea:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(29,161,242,0.3);
      border-color: var(--primary);
    }

    /* Toast Close */
    .toast::after {
      content: 'Close';
      position: absolute;
      top: 50%; right: 12px;
      transform: translateY(-50%);
      font-size: 18px;
      opacity: 0.6;
      cursor: pointer;
    }
    .toast:active::after {
      opacity: 1;
    }

    /* Responsive */
    @media (max-width: 480px) {
      .container { padding: 0 12px; }
      .header { padding: 12px; }
      .tabs { margin: 12px; }
      .search { margin: 12px; }
      .market-card { margin: 8px 12px; }
    }

    /* RTL Fixes */
    [dir="rtl"] .switch::before { left: auto; right: 3px; }
    [dir="rtl"] input:checked + .switch::before { transform: translateX(-24px); }
  </style>

  <!-- Closing Tags -->
  </div> <!-- .container -->

  <!-- Final Scripts -->
  <script>
    // === FINAL INIT CHECK ===
    window.addEventListener('load', () => {
      setTimeout(() => {
        document.body.style.opacity = '1';
        document.body.style.transition = 'opacity 0.3s ease';
      }, 100);

      // Force refresh if stuck
      if (!state.user && !localStorage.getItem('customName')) {
        setTimeout(() => {
          if (document.getElementById('profile-name').textContent === 'Shelby User') {
            openNameSelectionModal();
          }
        }, 1000);
      }

      // Final haptic test
      haptic('light');
    });

    // === DEBUG CONSOLE ===
    console.log('%c Shelby Bet v3.0 ', 'background:#1DA1F2;color:white;padding:8px 16px;border-radius:8px;font-weight:bold;');
    console.log('%c توسط: @ondbest ', 'color:#10B981;font-weight:bold;');
    console.log('%c GitHub: https://github.com/ehsansaberizadeh2012-cmd/Tg_app ', 'color:#FBBF24;');
  </script>

</body>
  </html>
