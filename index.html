<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no, user-scalable=no">
    <title>Shelby Bet - بازارها</title>
    <!-- Telegram Web App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom Font -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* تعریف متغیرهای تم تاریک و روشن */
        :root {
            --bg: #121212; --text: #EAECEF; --hint: #707A8A;
            --button: #2E81FF; --secondary-bg: #1E1E1E; --header-border: #2A2A2A;
            --positive: #00C853; --negative: #FF3B30;
        }
        .light-theme {
            --bg: #FFFFFF; --text: #1c1c1e; --hint: #8e8e93;
            --button: #007AFF; --secondary-bg: #F2F2F7; --header-border: #e5e5ea;
        }
        /* استایل‌های پایه */
        body { 
            font-family: 'Vazirmatn', sans-serif; 
            background-color: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 0; 
            padding-bottom: 70px; 
            transition: background-color 0.3s, color 0.3s; 
            -webkit-tap-highlight-color: transparent; 
        }
        .page { display: none; min-height: calc(100vh - 70px); }
        .page.active { display: block; }
        /* استایل نوار بالا و نوار پیمایش */
        .header { background-color: var(--bg); position: sticky; top: 0; z-index: 20; padding: 1rem; border-bottom: 1px solid var(--header-border); transition: background-color 0.3s, border-color 0.3s; }
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--secondary-bg); border-top: 1px solid var(--header-border); z-index: 30; display: flex; justify-content: space-around; padding-top: 0.5rem; height: 65px; transition: background-color 0.3s, border-color 0.3s; }
        .nav-button { flex: 1; text-align: center; padding: 0.25rem; color: var(--hint); cursor: pointer; transition: color 0.2s; }
        .nav-button.active { color: var(--button); }
        .nav-icon { height: 24px; width: 24px; margin: 0 auto 4px; stroke-width: 2; }
        /* استایل‌های لیست ارزها و اسکلتون لودینگ */
        .tab-button { border: 1px solid var(--header-border); }
        .tab-button.active { background-color: var(--button); color: white; border-color: var(--button); }
        .sort-button.active { color: var(--button); }
        .sparkline-path { stroke-width: 2; fill: none; }
        .skeleton { background-color: var(--secondary-bg); border-radius: 8px; animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        /* استایل‌های مدال */
        .modal-backdrop { position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); z-index: 40; backdrop-filter: blur(5px); }
        .modal { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--secondary-bg); z-index: 50; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 1.5rem; transform: translateY(100%); transition: transform 0.3s ease-out; max-height: 90vh; overflow-y: auto; }
        .modal.open { transform: translateY(0); }
        .toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 10px 20px; border-radius: 8px; z-index: 100; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .toast.show { opacity: 1; }
        /* لیست ارزها: برای اسکرول مجازی */
        #coin-list-container { overflow-y: scroll; -webkit-overflow-scrolling: touch; }
        .coin-row { transition: background-color 0.1s; }
        
        /* حالت ویژوال کیبوردی برای اینپوت‌های مدال */
        .modal input[type="text"], .modal select {
             background-color: var(--bg);
             border: 1px solid var(--header-border);
             color: var(--text);
             padding: 10px;
             border-radius: 8px;
             width: 100%;
             /* اطمینان از استایل‌دهی در حالت لایت مود */
             transition: background-color 0.3s, border-color 0.3s;
        }
        /* کلاس برای اطمینان از درست بودن جهت در موبایل */
        .rtl-flex-row-reverse { 
            display: flex;
            flex-direction: row-reverse;
        }
        .rtl-space-x-reverse > * + * {
            margin-right: 0.75rem; /* space-x-3 */
            margin-left: 0;
        }
    </style>
</head>
<body class="antialiased">

    <div id="markets-page" class="page active">
        <div class="header">
            <h1 data-i18n-key="marketHeader" class="text-xl font-bold text-center mb-4"></h1>
            <input type="text" id="search-input" data-i18n-placeholder="searchPlaceholder" class="w-full p-2.5 rounded-xl text-sm mb-3" style="background-color: var(--secondary-bg); border: 1px solid var(--header-border); color: var(--text);">
            <div class="flex items-center justify-between">
                 <div class="flex bg-[var(--secondary-bg)] rounded-xl p-1">
                    <button id="tab-all" class="tab-button active px-3 py-1.5 rounded-lg text-xs font-semibold" data-i18n-key="all"></button>
                    <button id="tab-watchlist" class="tab-button px-3 py-1.5 rounded-lg text-xs font-semibold" data-i18n-key="watchlist"></button>
                </div>
                 <div id="sort-controls" class="flex items-center space-x-1 space-x-reverse">
                    <button class="sort-button active text-xs px-2 py-1.5" data-sort="market_cap_desc" data-i18n-key="marketCap"></button>
                    <button class="sort-button text-xs px-2 py-1.5" data-sort="gainers" data-i18n-key="gainers"></button>
                    <button class="sort-button text-xs px-2 py-1.5" data-sort="losers" data-i18n-key="losers"></button>
                </div>
            </div>
        </div>
        <div id="summary-container" class="p-4 grid grid-cols-2 gap-3">
             <div class="h-16 skeleton rounded-xl"></div>
            <div class="h-16 skeleton rounded-xl"></div>
        </div>
        <div id="coin-list-container" class="h-[calc(100vh-230px)] overflow-y-auto">
            <div id="coin-list" class="relative">
                 <div class="p-4 space-y-2">${Array(10).fill('').map(() => `<div class="h-[68px] skeleton"></div>`).join('')}</div>
            </div>
        </div>
        <div id="message-container" class="hidden text-center p-10 text-[var(--hint)]"></div>
    </div>

    <div id="profile-page" class="page"></div>
    
    <div id="coming-soon-page" class="page"></div>

    <nav class="nav-bar">
        
        <button class="nav-button" data-page="coming-soon-page" data-page-key="wallet">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
            <span data-i18n-key="wallet" class="block text-xs"></span>
        </button>
        
        <button class="nav-button active" data-page="markets-page">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
            <span data-i18n-key="markets" class="block text-xs"></span>
        </button>
        
        <button class="nav-button" data-page="coming-soon-page" data-page-key="converter">
             <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            <span data-i18n-key="converter" class="block text-xs"></span>
        </button>
        
        <button class="nav-button" data-page="coming-soon-page" data-page-key="shop">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4m-1.5 5h11m-11 0a2 2 0 01-2-2v-5a2 2 0 012-2h11a2 2 0 012 2v5a2 2 0 01-2 2h-11z"></path></svg>
            <span data-i18n-key="shop" class="block text-xs"></span>
        </button>
        
        <button class="nav-button" data-page="profile-page">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
            <span data-i18n-key="profile" class="block text-xs"></span>
        </button>
        
    </nav>

    <div id="modal-backdrop" class="modal-backdrop hidden" onclick="closeModal()"></div>
    <div id="modal" class="modal"><div id="modal-content"></div></div>
    <div id="toast" class="toast"></div>

    <script type="module">
    // 🔥 Firebase Imports for Single File App (REQUIRED for persistence)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, query, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    // NOTE: setLogLevel is imported from firebase/app-check.js in original, but not used. Removing import for unused functions unless needed.

    //============== START OF FULL JAVASCRIPT CODE ==============
    
    // --- Global Firebase & Auth State ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let db, auth;
    let userId = '';
    let isAuthReady = false; 

    // متغیرهای گلوبال تلگرام وب‌اپ
    const tg = window.Telegram.WebApp;

    // --- I18N Translations (چهار زبان کامل) ---
    const translations = {
        en: { 
            markets: "Markets", profile: "Profile", converter: "Conversion", marketHeader: "Shelby Digital Currency Markets", searchPlaceholder: "Search coins...", all: "All", watchlist: "Watchlist", marketCap: "Market Cap", gainers: "Gainers", losers: "Losers", emailSaved: "Email saved!", walletSaved: "Wallet address saved!", walletDeleted: "Wallet deleted!", copied: "Copied!", settings: "Settings", theme: "Theme", dark: "Dark", light: "Light", language: "Language", userInfo: "User Info", name: "Name", username: "Username", userId: "User ID", emailOptional: "Email (Optional)", notSet: "Not set", wallets: "Wallets", walletsCount: "{count} saved wallets", tryAgain: "Try Again", errorFetchSummary: "Error fetching currency/gold rate. Using cached dollar price.", errorFetchCrypto: "Error fetching crypto list. Please check your connection.", noResults: "No coins found.", emptyWatchlist: "Your watchlist is empty.", rank: "Rank", editEmail: "Edit Email", enterEmail: "Enter your email", save: "Save", invalidEmail: "Invalid email address.", editWallets: "Wallet Addresses", noWallets: "No wallets added yet.", addNewWallet: "Add New Wallet", editWallet: "Edit Wallet", addWallet: "Add Wallet", selectCoin: "Select Coin", walletAddress: "Wallet Address...", back: "Back", confirmDelete: "Are you sure you want to delete {symbol} wallet?", cryptoAmount: "Coin Amount", usdEquivalent: "USD Equivalent", irtEquivalent: "Toman Equivalent", coinDetails: "Coin Details", price: "Price", change24h: "24h Change", high24h: "24h High", low24h: "24h Low", volume24h: "24h Volume", chartUnavailable: "Chart Unavailable", chart24h: "24h Price Chart", shop: "Shop", wallet: "Wallet", dollar: "Dollar/Tether", gold: "Gold (18k)", usingCachedPrice: "Using cached price", comingSoon: "Coming Soon!", comingSoonMessage: "This page ({pageName}) is under development and will be available soon.",
        },
        fa: { 
            markets: "بازارها", profile: "پروفایل", converter: "تبدیل", marketHeader: "بازار ارزهای دیجیتال شلبی", searchPlaceholder: "جستجوی ارز...", all: "همه", watchlist: "علاقه‌مندی‌ها", marketCap: "ارزش بازار", gainers: "بیشترین رشد", losers: "بیشترین افت", emailSaved: "ایمیل ذخیره شد!", walletSaved: "آدرس کیف پول ذخیره شد!", walletDeleted: "کیف پول حذف شد!", copied: "کپی شد!", settings: "تنظیمات", theme: "پوسته", dark: "تاریک", light: "روشن", language: "زبان", userInfo: "اطلاعات کاربر", name: "نام", username: "نام کاربری", userId: "شناسه کاربر", emailOptional: "ایمیل (اختیاری)", notSet: "تعیین نشده", wallets: "کیف پول‌ها", walletsCount: "{count} کیف پول ذخیره شده", tryAgain: "تلاش مجدد", errorFetchSummary: "خطا در دریافت نرخ ارز/طلا. از نرخ ذخیره شده دلار استفاده می‌شود.", errorFetchCrypto: "خطا در دریافت لیست ارزها. لطفاً اتصال خود را بررسی کنید.", noResults: "ارزی با این مشخصات یافت نشد.", emptyWatchlist: "هنوز ارزی به علاقه‌مندی‌ها اضافه نکرده‌اید.", rank: "رتبه", editEmail: "ویرایش ایمیل", enterEmail: "ایمیل خود را وارد کنید", save: "ذخیره", invalidEmail: "آدرس ایمیل نامعتبر است.", editWallets: "آدرس کیف پول", noWallets: "هنوز آدرسی اضافه نشده است.", addNewWallet: "افزودن آدرس جدید", editWallet: "ویرایش آدرس", addWallet: "افزودن آدرس", selectCoin: "انتخاب ارز", walletAddress: "آدرس کیف پول...", back: "بازگشت", confirmDelete: "آیا از حذف کیف پول {symbol} مطمئن هستید؟", cryptoAmount: "مقدار ارز", usdEquivalent: "معادل دلاری", irtEquivalent: "معادل تومانی", coinDetails: "جزئیات ارز", price: "قیمت", change24h: "تغییر ۲۴ ساعته", high24h: "بالاترین ۲۴ ساعته", low24h: "پایین‌ترین ۲۴ ساعته", volume24h: "حجم معاملات (۲۴ ساعته)", chartUnavailable: "نمودار موجود نیست", chart24h: "نمودار قیمت ۲۴ ساعته (نمادین)", shop: "فروشگاه", wallet: "کیف پول", dollar: "دلار/تتر", gold: "طلای ۱۸ عیار", usingCachedPrice: "استفاده از نرخ ذخیره شده قبلی", comingSoon: "به زودی!", comingSoonMessage: "این صفحه ({pageName}) در حال توسعه است و به زودی در دسترس خواهد بود.",
        },
        ar: { markets: "الأسواق", profile: "الملف الشخصي", converter: "تحويل", marketHeader: "أسواق العملات الرقمية شلبي", searchPlaceholder: "ابحث عن عملة...", all: "الكل", watchlist: "المفضلة", marketCap: "القيمة السوقية", gainers: "الأكثر ربحًا", losers: "الأكثر خسارة", emailSaved: "تم حفظ البريد الإلكتروني!", walletSaved: "تم حفظ عنوان المحفظة!", walletDeleted: "تم حذف عنوان المحفظة!", copied: "تم النسخ!", settings: "الإعدادات", theme: "مظهر التطبيق", dark: "داكن", light: "فاتح", language: "اللغة", userInfo: "معلومات المستخدم", name: "الاسم", username: "اسم المستخدم", userId: "معرف المستخدم", emailOptional: "البريد الإلكتروني (اختياري)", notSet: "لم يتم تعيينه", wallets: "عناوين المحفظة", walletsCount: "{count} عناوين محفوظة", tryAgain: "حاول مرة أخرى", errorFetchSummary: "خطأ في جلب سعر العملة/الذهب. باستخدام سعر الدولار المخزن مؤقتًا.", errorFetchCrypto: "خطأ في جلب قائمة العملات. يرجى التحقق من اتصالك.", noResults: "لم يتم العثور على نتائج.", emptyWatchlist: "قائمة المراقبة الخاصة بك فارغة.", rank: "مرتبة", editEmail: "تعديل البريد الإلكتروني", enterEmail: "أدخل بريدك الإلكتروني", save: "حفظ", invalidEmail: "عنوان البريد الإلكتروني غير صالح.", editWallets: "عناوين المحفظة", noWallets: "لم تتم إضافة أي عناوين بعد.", addNewWallet: "إضافة عنوان جديد", editWallet: "تعديل العنوان", addWallet: "إضافة عنوان", selectCoin: "اختر العملة", walletAddress: "عنوان المحفظة...", back: "رجوع", confirmDelete: "هل أنت متأكد من حذف محفظة {symbol}؟", cryptoAmount: "كمية العملة", usdEquivalent: "ما يعادل بالدولار", irtEquivalent: "ما يعادل بالتومان", coinDetails: "تفاصيل العملة", price: "السعر", change24h: "التغيير خلال 24 ساعة", high24h: "أعلى سعر خلال 24 ساعة", low24h: "أدنى سعر خلال 24 ساعة", volume24h: "حجم التداول (24 ساعة)", chartUnavailable: "الرسم البياني غير متوفر", chart24h: "الرسم البياني للسعر 24 ساعة", shop: "المتجر", wallet: "المحفظة", dollar: "الدولار/Tether", gold: "الذهب (18 قيراط)", usingCachedPrice: "استخدام السعر المخزن مؤقتًا", comingSoon: "قريبًا!", comingSoonMessage: "هذه الصفحة ({pageName}) قيد التطوير وستكون متاحة قريبًا.", },
        zh: { markets: "市场", profile: "个人资料", converter: "转换", marketHeader: "Shelby数字货币市场", searchPlaceholder: "搜索币种...", all: "全部", watchlist: "关注列表", marketCap: "市值", gainers: "涨幅榜", losers: "跌幅榜", emailSaved: "邮件已保存!", walletSaved: "钱包地址已保存!", walletDeleted: "钱包已删除!", copied: "已复制!", settings: "设置", theme: "主题", dark: "深色", light: "浅色", language: "语言", userInfo: "用户信息", name: "名称", username: "用户名", userId: "用户ID", emailOptional: "电子邮件 (可选)", notSet: "未设置", wallets: "钱包", walletsCount: "{count} 个已保存钱包", tryAgain: "重试", errorFetchSummary: "获取货币/黄金汇率错误。正在使用缓存美元价格。", errorFetchCrypto: "获取币种列表错误。请检查您的连接。", noResults: "未找到任何币种。", emptyWatchlist: "您的关注列表为空。", rank: "排名", editEmail: "编辑邮件", enterEmail: "输入您的电子邮件", save: "保存", invalidEmail: "无效的电子邮件地址。", editWallets: "钱包地址", noWallets: "尚未添加钱包地址。", addNewWallet: "添加新钱包", editWallet: "编辑钱包", addWallet: "添加钱包", selectCoin: "选择币种", walletAddress: "钱包地址...", back: "返回", confirmDelete: "确定删除 {symbol} 钱包吗？", cryptoAmount: "币种数量", usdEquivalent: "美元等值", irtEquivalent: "Toman等值", coinDetails: "币种详情", price: "价格", change24h: "24小时变化", high24h: "24小时最高", low24h: "24小时最低", volume24h: "24小时交易量", chartUnavailable: "图表不可用", chart24h: "24小时价格图表", shop: "商店", wallet: "钱包", dollar: "美元/Tether", gold: "黄金 (18k)", usingCachedPrice: "使用缓存价格", comingSoon: "即将推出!", comingSoonMessage: "此页面 ({pageName}) 正在开发中，即将推出。", },
    };
    
    let activeLanguage = localStorage.getItem('language_v10') || 'fa';
    let isRTL = ['fa', 'ar'].includes(activeLanguage); 
    
    // تابع ترجمه
    const i18n = (key, params = {}) => {
        let translation = translations[activeLanguage]?.[key] || translations.en[key] || key;
        for (const pKey in params) { translation = translation.replace(`{${pKey}}`, params[pKey]); }
        return translation;
    };
    
    // نام فارسی برای نمایش و جستجو
    const PERSIAN_NAMES = { 'bitcoin': 'بیت‌کوین', 'ethereum': 'اتریوم', 'tether': 'تتر', 'binancecoin': 'بایننس کوین', 'solana': 'سولانا', 'ripple': 'ریپل', 'dogecoin': 'دوج‌کوین', 'toncoin': 'تون‌کوین', 'cardano': 'کاردانو', 'shiba-inu': 'شیبا اینو', 'tron': 'ترون', 'notcoin': 'نات‌کوین', 'pepe': 'پپه', 'floki': 'فلوکی' };
    
    // آیدی ارزهای خاص که ممکن است در صفحه اول نباشند
    const EXTRA_COIN_IDS = 'toncoin,notcoin,dogecoin,shiba-inu,pepe,floki'; 

    const state = {
        allCoins: [], dollarPrice: 0, summaryData: null,
        watchlist: JSON.parse(localStorage.getItem('watchlist_v10')) || [], // Watchlist is local
        activeTab: localStorage.getItem('activeTab_v10') || 'all',
        currentSort: localStorage.getItem('currentSort_v10') || 'market_cap_desc',
        searchQuery: '',
        userEmail: '', // 💥 Now stored in Firestore
        wallets: {},   // 💥 Now stored in Firestore
        theme: localStorage.getItem('theme_v10') || 'dark',
        language: activeLanguage, 
        isLoading: { summary: true, crypto: true },
        errors: { summary: null, crypto: null },
        updateInterval: null,
        maxPages: 4, 
        loadedPages: 1, 
        isDataLoadedFromFirestore: false, // New flag for profile data readiness
    };
    
    // 📢 آدرس API جدید (حاجی وب‌سرویس) - دارای نرخ دلار و طلا
    const HAJI_API_URL = "https://haji-api.ir/arz/?license=X6AeD481PYBXAVd613617197375739822qgek";
    const CRYPTO_BASE_URL = "https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&per_page=250&sparkline=true&price_change_percentage=24h";

    // توابع کمکی
    const formatNum = (n, dec = 2) => new Intl.NumberFormat('en-US', { minimumFractionDigits: dec, maximumFractionDigits: dec, useGrouping: true }).format(n);
    const formatPercent = (p) => `${parseFloat(p||0) >= 0 ? '+' : ''}${formatNum(p||0)}%`;
    const getChangeClass = (p) => (parseFloat(p||0) >= 0 ? 'text-[var(--positive)]' : 'text-[var(--negative)]');
    const isValidEmail = (email) => /\S+@\S+\.\S+/.test(email);

    /**
     * تابع نمایش Toast Message (به جای alert)
     * @param {string} message 
     * @param {number} duration 
     */
    function showToast(message, duration = 2000) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), duration);
    }
    
    /**
     * اجرای fetch با timeout و retry (برای APIهایی که پایداری کمتری دارند)
     */
    async function fetchWithRetry(url, maxRetries = 3, initialDelay = 1000) {
        for (let i = 0; i < maxRetries; i++) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); 
            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`Server Error (${response.status})`);
                return response;
            } catch (error) {
                clearTimeout(timeoutId);
                if (i === maxRetries - 1) {
                    console.error(`Failed to fetch ${url} after ${maxRetries} attempts.`, error);
                    throw error;
                }
                const delay = initialDelay * Math.pow(2, i);
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
    }


    function render() {
        // ترجمه عمومی UI
        translateUI();
        // رندر خلاصه و لیست بعد از تغییر زبان یا داده
        renderSummary();
        renderCryptoList();
    }
    
    // تابع بارگذاری داده‌های خلاصه (قیمت دلار/تتر و طلا از Haji-API)
    async function loadSummaryData() {
        state.isLoading.summary = true; 
        state.errors.summary = null; 
        
        const lastDollarPriceToman = parseFloat(localStorage.getItem('lastDollarPrice_v10')) || 0; 
        state.dollarPrice = lastDollarPriceToman; 
        
        try {
            const response = await fetchWithRetry(HAJI_API_URL);
            const result = await response.json();
            
            let newDollarPriceToman = 0;
            let newGoldPriceToman = 0;
            let dollarChangePercent = 0;
            let goldChangePercent = 0;

            if (result && Array.isArray(result.arz)) {
                // تلاش برای یافتن نرخ تتر یا دلار
                const dollarData = result.arz.find(item => item.name && (item.name.includes('دلار') || item.name.includes('آمریکا') || item.name.includes('تتر')));
                const goldData = result.arz.find(item => item.name && item.name.includes('گرم طلا ۱۸ عیار')); 

                if (dollarData && dollarData.price) {
                    newDollarPriceToman = parseFloat(String(dollarData.price).replace(/,/g, '')) || 0; 
                    dollarChangePercent = parseFloat(dollarData.change_percent) || 0;
                }
                if (goldData && goldData.price) {
                    newGoldPriceToman = parseFloat(String(goldData.price).replace(/,/g, '')) || 0;
                    goldChangePercent = parseFloat(goldData.change_percent) || 0;
                }
            } else if (result && result.status === 'error') {
                 throw new Error(result.message || "Haji-API returned an error status.");
            }
            
            if (newDollarPriceToman > 0) {
                state.dollarPrice = newDollarPriceToman; 
                localStorage.setItem('lastDollarPrice_v10', newDollarPriceToman); 
            }

            state.summaryData = {
                dollar: { price: state.dollarPrice, change: dollarChangePercent },
                gold: { price: newGoldPriceToman, change: goldChangePercent } 
            };

        } catch (error) { 
            console.error("Summary (Haji-API) API Error:", error); 
            
            if (lastDollarPriceToman > 0) {
                state.dollarPrice = lastDollarPriceToman;
                // استفاده از نرخ ذخیره شده به عنوان خطا
                state.errors.summary = `${i18n('usingCachedPrice')} (${formatNum(lastDollarPriceToman, 0)} T)`;
            } else {
                state.dollarPrice = 0; 
                state.errors.summary = i18n('errorFetchSummary');
            }
            
            state.summaryData = {
                 dollar: { price: state.dollarPrice, change: 0 },
                 gold: { price: 0, change: 0 } 
            };
        } finally { 
            state.isLoading.summary = false; 
            renderSummary(); // رندر خلاصه را جداگانه فراخوانی می‌کنیم
        }
    }
    
    function renderSummary() {
        const container = document.getElementById('summary-container');
        
        if (state.isLoading.summary) {
            container.innerHTML = `<div class="h-16 skeleton rounded-xl"></div><div class="h-16 skeleton rounded-xl"></div>`;
            return;
        }

        const renderCard = (titleKey, price, change, symbol) => {
            const changeClass = getChangeClass(change);
            const formattedPrice = price > 0 ? formatNum(price, 0) : '---'; 
            
            // چک می‌کنیم اگر این کارت دلار باشد و خطای استفاده از کش داشته باشیم.
            const isCachedDollarError = state.errors.summary && titleKey === 'dollar' && price > 0 && state.errors.summary.includes(i18n('usingCachedPrice'));
            const errorClass = isCachedDollarError ? 'border-2 border-yellow-500/50' : '';
            
            return `
                <div class="bg-[var(--secondary-bg)] p-3 rounded-xl shadow-md flex justify-between items-center transition duration-200 ${errorClass}">
                    <div>
                        <div class="text-[var(--hint)] text-xs" data-i18n-key="${titleKey}">${i18n(titleKey)}</div>
                        <div class="font-bold text-lg">${formattedPrice} ${symbol}</div>
                    </div>
                    <div class="text-xs font-mono font-bold ${changeClass}">${price > 0 ? formatPercent(change) : '---'}</div>
                </div>
            `;
        };

        container.innerHTML = `
            ${renderCard('dollar', state.summaryData.dollar.price, state.summaryData.dollar.change, 'T')}
            ${renderCard('gold', state.summaryData.gold.price, state.summaryData.gold.change, 'T')}
        `;
        
        // نمایش پیام خطا/اطلاع‌رسانی (فقط برای دلار/تتر)
        if (state.errors.summary && state.dollarPrice === 0) {
            const errorEl = document.createElement('div');
            errorEl.className = 'col-span-full text-center text-sm p-3 text-red-500 bg-red-500/10 rounded-xl mt-1';
            errorEl.textContent = state.errors.summary;
            container.appendChild(errorEl);
        } else if (state.errors.summary && state.dollarPrice > 0) {
            // اگر از نرخ کش شده استفاده شده است، فقط متن را به‌روزرسانی کنید
            const cachedMsgEl = document.createElement('div');
            cachedMsgEl.className = 'col-span-full text-center text-xs p-1 text-yellow-500/90 rounded-xl mt-1';
            cachedMsgEl.textContent = state.errors.summary;
            container.appendChild(cachedMsgEl);
        }
        
        translateUI(); // برای به‌روزرسانی ترجمه‌های داخل کارت‌ها
    }
    
    async function loadCryptoData(isUpdate = false) {
        if (!isUpdate && state.loadedPages === 1) { 
            state.isLoading.crypto = true; 
            state.errors.crypto = null; 
            if (state.allCoins.length === 0) renderCryptoList(); 
        }
        
        // در صورت لودینگ مجدد یا به‌روزرسانی، فقط صفحه ۱ را لود می‌کنیم تا داده‌ها مرتب شوند
        const pageUrl = `${CRYPTO_BASE_URL}&page=1&order=market_cap_desc`; // همیشه بر اساس مارکت کپ لود می‌کنیم تا بتوانیم بعداً آن را مرتب کنیم.
        const extraCoinsUrl = `https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=${EXTRA_COIN_IDS}&sparkline=true&price_change_percentage=24h`;
        
        try {
            const fetchPromises = [fetchWithRetry(pageUrl).then(res => res.json())]; 

            if (state.loadedPages === 1) {
                 fetchPromises.push(fetchWithRetry(extraCoinsUrl).then(res => res.json()));
            }

            const [marketCapData, extraCoinsData] = await Promise.all(fetchPromises);
            
            if (!Array.isArray(marketCapData)) throw new Error("Invalid crypto data response");

            const marketCapIds = new Set(marketCapData.map(c => c.id));
            const uniqueExtraCoins = (extraCoinsData || []).filter(c => !marketCapIds.has(c.id));
            
            // ترکیب داده‌ها
            state.allCoins = uniqueExtraCoins.concat(marketCapData);
            state.errors.crypto = null;
            
        } catch (error) { 
            console.error("Crypto API Error:", error); 
            if (!isUpdate && state.allCoins.length === 0) {
                state.errors.crypto = i18n('errorFetchCrypto');
            }
        } finally { 
            if (!isUpdate) state.isLoading.crypto = false; 
            renderCryptoList(); 
        }
    }
    
    function renderCryptoList() {
        const container = document.getElementById('coin-list-container');
        const listEl = document.getElementById('coin-list');
        const messageEl = document.getElementById('message-container');
        
        if (state.isLoading.crypto && state.allCoins.length === 0) { 
            listEl.innerHTML = `<div class="p-4 space-y-2">${Array(10).fill('').map(() => `<div class="h-[68px] skeleton"></div>`).join('')}</div>`;
            messageEl.classList.add('hidden');
            return;
        }

        if (state.errors.crypto) { 
            container.style.display = 'none';
            messageEl.classList.remove('hidden');
            messageEl.innerHTML = `<div class="bg-red-500/20 text-red-400 rounded-xl p-4 text-center">
                <p>${state.errors.crypto}</p>
                <button id="retry-crypto" class="mt-3 bg-[var(--button)] px-4 py-2 rounded-xl text-sm font-bold">${i18n('tryAgain')}</button>
            </div>`;
            document.getElementById('retry-crypto').onclick = () => { state.loadedPages = 1; loadCryptoData(); };
            return;
        }
        
        container.style.display = 'block';

        let coinsToRender = state.allCoins.slice(); // کپی برای مرتب‌سازی و فیلتر
        
        // 1. فیلتر علاقه‌مندی‌ها
        if (state.activeTab === 'watchlist') {
            coinsToRender = coinsToRender.filter(c => state.watchlist.includes(c.id));
        }
        
        // 2. مرتب‌سازی
        if (state.currentSort === 'gainers') coinsToRender.sort((a, b) => (b.price_change_percentage_24h || -999) - (a.price_change_percentage_24h || -999));
        else if (state.currentSort === 'losers') coinsToRender.sort((a, b) => (a.price_change_percentage_24h || 999) - (b.price_change_percentage_24h || 999));
        else if (state.currentSort === 'market_cap_desc' || state.activeTab === 'all') coinsToRender.sort((a, b) => (a.market_cap_rank || 9999) - (b.market_cap_rank || 9999)); 

        // 3. فیلتر جستجو
        const query = state.searchQuery.toLowerCase().trim();
        if (query) {
            coinsToRender = coinsToRender.filter(c => c.name.toLowerCase().includes(query) || c.symbol.toLowerCase().includes(query) || (PERSIAN_NAMES[c.id] && PERSIAN_NAMES[c.id].toLowerCase().includes(query)));
        }
        
        // نمایش پیام نبود نتیجه
        messageEl.classList.add('hidden');
        if (coinsToRender.length === 0) {
            messageEl.textContent = i18n(state.activeTab === 'watchlist' ? 'emptyWatchlist' : 'noResults');
            messageEl.classList.remove('hidden');
        }

        // منطق Virtual Scrolling
        const ROW_HEIGHT = 68; 
        const containerHeight = container.clientHeight;
        const totalHeight = coinsToRender.length * ROW_HEIGHT;
        const scrollTop = container.scrollTop;
        
        const startIndex = Math.max(0, Math.floor(scrollTop / ROW_HEIGHT) - 2); 
        const endIndex = Math.min(coinsToRender.length, startIndex + Math.ceil(containerHeight / ROW_HEIGHT) + 4); 

        listEl.style.height = `${totalHeight}px`; 

        const fragment = document.createDocumentFragment();
        for (let i = startIndex; i < endIndex; i++) {
            const coin = coinsToRender[i];
            const row = document.createElement('div');
            row.className = 'coin-row absolute w-full';
            row.style.top = `${i * ROW_HEIGHT}px`;
            row.dataset.coinId = coin.id;
            row.innerHTML = renderCoinRow(coin);
            fragment.appendChild(row);
        }
        listEl.innerHTML = ''; 
        listEl.appendChild(fragment);
    }
    
    function renderCoinRow(coin) {
        const isWatched = state.watchlist.includes(coin.id);
        
        const tomanPriceNum = state.dollarPrice > 0 ? coin.current_price * state.dollarPrice : 0;
        const usdDecimal = coin.current_price < 0.01 ? 5 : 2;
        const tomanPrice = tomanPriceNum > 0 ? formatNum(tomanPriceNum, 0) : '---';

        let nativeName = '';
        if (state.language === 'fa') {
            nativeName = PERSIAN_NAMES[coin.id.toLowerCase()] ? ` | ${PERSIAN_NAMES[coin.id.toLowerCase()]}` : '';
        } 
        
        const priceUSD = formatNum(coin.current_price, usdDecimal);
        const changePercent = formatPercent(coin.price_change_percentage_24h);
        
        // تعیین کلاس‌های جهت برای RTL
        const directionClass = isRTL ? 'rtl-flex-row-reverse rtl-space-x-reverse' : 'space-x-3';
        const symbolDir = isRTL ? 'text-right' : 'text-left';
        
        return `
            <div class="flex items-center px-4 h-full cursor-pointer transition duration-150 hover:bg-[var(--header-border)]">
                <div class="flex-1 flex items-center ${directionClass} min-w-0">
                    <img src="${coin.image}" alt="${coin.name}" class="w-9 h-9 rounded-full shadow-md">
                    <div class="truncate ${symbolDir}">
                        <div class="font-bold text-sm truncate">${coin.symbol.toUpperCase()}${nativeName}</div>
                        <div class="text-xs text-[var(--hint)]">${i18n('rank')} #${coin.market_cap_rank || '?'}</div>
                    </div>
                </div>
                
                <div class="text-right font-mono pr-2">
                    <div class="font-bold text-sm" data-price-usd>$${priceUSD}</div>
                    <div class="text-[var(--hint)] text-xs">${tomanPrice} T</div>
                </div>
                
                <div class="w-20 text-center font-bold text-sm ${getChangeClass(coin.price_change_percentage_24h)} ml-4">${changePercent}</div>
                
                <div class="w-10 text-center text-2xl star-icon cursor-pointer text-[var(--hint)] hover:text-yellow-400" data-watched="${isWatched}" aria-label="${isWatched ? 'Remove from Watchlist' : 'Add to Watchlist'}">${isWatched ? '<span style="color: #FFC107;">★</span>' : '☆'}</div>
            </div>`;
    }
    
    function generateSparkline(data, change, w = 300, h = 160) {
        if (!data || data.length < 2) return `<div class="text-[var(--hint)] text-center w-full">${i18n('chartUnavailable')}</div>`;
        
        const max = Math.max(...data), min = Math.min(...data);
        const range = max - min;
        
        if (range === 0) return `<div class="text-[var(--hint)] text-center w-full">${i18n('chartUnavailable')}</div>`; 
        
        const points = data.map((price, i) => {
            const x = (i / (data.length - 1)) * w;
            const y = h - ((price - min) / range) * h;
            return `${x},${y}`;
        }).join(' ');

        const color = parseFloat(change) >= 0 ? 'var(--positive)' : 'var(--negative)';
        const lastPointY = h - ((data[data.length - 1] - min) / range) * h;

        return `
            <svg viewBox="0 0 ${w} ${h}" width="100%" height="100%" preserveAspectRatio="none">
                <polyline class="sparkline-path" points="${points}" stroke="${color}" />
                <circle cx="${w}" cy="${lastPointY}" r="3" fill="${color}" />
            </svg>
        `;
    }

    function handleStarClick(starEl, coinId) {
        if (state.watchlist.includes(coinId)) {
            state.watchlist = state.watchlist.filter(id => id !== coinId);
        } else {
            state.watchlist.push(coinId);
        }
        localStorage.setItem('watchlist_v10', JSON.stringify(state.watchlist));
        renderCryptoList(); 
    }

    function setupUI() {
        document.querySelectorAll('.nav-button').forEach(btn => {
            btn.onclick = (e) => {
                const pageId = e.currentTarget.dataset.page;
                const pageKey = e.currentTarget.dataset.pageKey;
                
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
                e.currentTarget.classList.add('active');
                
                if (pageId === 'profile-page') renderProfilePage();
                else if (pageId === 'coming-soon-page') renderComingSoonPage(pageKey);
                else if (pageId === 'markets-page') render();
            };
        });

        document.querySelectorAll('.tab-button').forEach(btn => btn.addEventListener('click', e => {
            document.querySelector('.tab-button.active').classList.remove('active');
            e.currentTarget.classList.add('active');
            state.activeTab = e.currentTarget.id.replace('tab-', '');
            localStorage.setItem('activeTab_v10', state.activeTab);
            state.loadedPages = 1; 
            renderCryptoList(); // فقط رندر را فراخوانی می‌کنیم چون داده‌ها در allCoins موجود است
        }));
        
        document.querySelectorAll('.sort-button').forEach(btn => btn.addEventListener('click', e => {
            document.querySelector('.sort-button.active').classList.remove('active');
            e.currentTarget.classList.add('active');
            state.currentSort = e.currentTarget.dataset.sort;
            localStorage.setItem('currentSort_v10', state.currentSort);
            state.loadedPages = 1; 
            renderCryptoList(); // فقط رندر را فراخوانی می‌کنیم چون داده‌ها در allCoins موجود است
        }));
        
        let searchTimeout;
        document.getElementById('search-input').addEventListener('input', e => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => { 
                state.searchQuery = e.target.value; 
                state.loadedPages = 1; 
                renderCryptoList(); 
            }, 300);
        });
        
        document.getElementById('coin-list').addEventListener('click', e => {
            const star = e.target.closest('.star-icon');
            const row = e.target.closest('.coin-row');
            if (row) {
                if (star) { e.stopPropagation(); handleStarClick(star, row.dataset.coinId); } 
                else { openDetailsModal(state.allCoins.find(c => c.id === row.dataset.coinId)); }
            }
        });
    }
    
    function setupInfiniteScroll() {
        const container = document.getElementById('coin-list-container');
        container.addEventListener('scroll', () => {
            renderCryptoList(); 

            // منطق لود بیشتر (حذف شد زیرا فقط صفحه 1 از کوین‌گکو به دلیل محدودیت API در این محیط لود می‌شود، اما اگر نیاز بود می‌توان آن را فعال کرد)
            /*
            if (container.scrollHeight - container.scrollTop <= container.clientHeight * 1.5) {
                if (!state.isLoading.crypto && state.loadedPages < state.maxPages && state.activeTab === 'all' && !state.searchQuery) {
                    state.loadedPages++;
                    loadCryptoData(true);
                }
            }
            */
        });
    }

    function renderComingSoonPage(pageKey) {
        const page = document.getElementById('coming-soon-page');
        const pageName = i18n(pageKey) || pageKey;
        page.innerHTML = `
            <div class="p-8 text-center flex flex-col items-center justify-center h-full min-h-[50vh]">
                <h1 class="text-4xl font-extrabold mb-4 text-[var(--button)]" data-i18n-key="comingSoon">${i18n('comingSoon')}</h1>
                <p class="text-[var(--hint)] text-lg">${i18n('comingSoonMessage', { pageName })}</p>
                <div class="mt-8 text-6xl">🚧</div>
            </div>`;
        translateUI();
    }
    
    function setLanguage(lang) {
        state.language = lang; localStorage.setItem('language_v10', lang);
        const newIsRTL = ['fa', 'ar'].includes(lang);
        document.documentElement.lang = lang; 
        document.documentElement.dir = newIsRTL ? 'rtl' : 'ltr';
        isRTL = newIsRTL; 

        const activeNavButton = document.querySelector('.nav-button.active');
        const pageId = activeNavButton?.dataset.page;
        const pageKey = activeNavButton?.dataset.pageKey;

        // به‌روزرسانی صفحه فعال
        if (pageId === 'profile-page') renderProfilePage();
        else if (pageId === 'coming-soon-page') renderComingSoonPage(pageKey);
        else render();
    }
    
    function translateUI() {
        document.querySelectorAll('[data-i18n-key]').forEach(el => {
            const key = el.dataset.i18nKey;
            el.textContent = i18n(key);
        });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
            const key = el.dataset.i18nPlaceholder;
            el.placeholder = i18n(key);
        });
        document.querySelectorAll('[data-i18n-key-count]').forEach(el => {
            const key = el.dataset.i18nKeyCount;
            const count = el.dataset.count;
            el.textContent = i18n(key, { count });
        });
    }
    
    function setTheme(theme) {
        state.theme = theme; localStorage.setItem('theme_v10', theme);
        document.body.classList.toggle('light-theme', theme === 'light');
        try {
            // تلگرام وب‌اپ را نیز به‌روزرسانی می‌کنیم
            tg.isDark = (theme === 'dark');
            tg.setHeaderColor(theme === 'dark' ? '#1E1E1E' : '#FFFFFF');
            tg.setBackgroundColor(theme === 'dark' ? '#121212' : '#FFFFFF');
        } catch(e) { /* ignore if not in TG environment */ }

        if (document.getElementById('profile-page').classList.contains('active')) {
            renderProfilePage();
        }
        render(); 
    }
    
    function openDetailsModal(coin) {
        if (!coin) return;
        
        const price = formatNum(coin.current_price, coin.current_price < 0.01 ? 5 : 2);
        const priceToman = formatNum(coin.current_price * state.dollarPrice, 0);
        const changeClass = getChangeClass(coin.price_change_percentage_24h);
        const change = formatPercent(coin.price_change_percentage_24h);
        
        const chartHtml = generateSparkline(coin.sparkline_in_7d.price, coin.price_change_percentage_24h);
        
        const detailsHtml = `
            <div class="flex items-center space-x-4 ${isRTL ? 'space-x-reverse' : ''} mb-6">
                <img src="${coin.image}" alt="${coin.name}" class="w-12 h-12 rounded-full shadow-md">
                <div>
                    <h2 class="text-xl font-bold">${coin.name} (${coin.symbol.toUpperCase()})</h2>
                    <p class="text-[var(--hint)] text-sm">${i18n('rank')} #${coin.market_cap_rank || '?'}</p>
                </div>
            </div>
            
            <div class="flex justify-between items-center mb-6">
                <div>
                    <p class="text-3xl font-bold">$${price}</p>
                    <p class="text-xl font-bold text-[var(--hint)]">${priceToman} T</p>
                </div>
                <div class="text-right">
                    <p class="text-lg font-bold ${changeClass}">${change} (24h)</p>
                </div>
            </div>
            
            <div class="mb-6">
                 <h3 class="font-bold text-lg mb-3" data-i18n-key="chart24h">${i18n('chart24h')}</h3>
                 <div class="h-40 flex items-center justify-center p-2 bg-[var(--bg)] rounded-xl border border-[var(--header-border)]">
                    ${chartHtml}
                </div>
            </div>

            <div class="space-y-3">
                <h3 class="font-bold text-lg mb-3" data-i18n-key="coinDetails">${i18n('coinDetails')}</h3>
                ${renderDetailRow('high24h', `$${formatNum(coin.high_24h, coin.high_24h < 0.01 ? 5 : 2)}`)}
                ${renderDetailRow('low24h', `$${formatNum(coin.low_24h, coin.low_24h < 0.01 ? 5 : 2)}`)}
                ${renderDetailRow('volume24h', `$${formatNum(coin.total_volume, 0)}`)}
                ${renderDetailRow('marketCap', `$${formatNum(coin.market_cap, 0)}`)}
            </div>
            
            <button onclick="closeModal()" class="w-full bg-[var(--button)] text-white p-3 rounded-xl mt-6 font-bold" data-i18n-key="back">${i18n('back')}</button>
        `;
        openModal(detailsHtml);
    }
    
    function openModal(contentHtml) {
        document.getElementById('modal-content').innerHTML = contentHtml;
        document.getElementById('modal-backdrop').classList.remove('hidden');
        document.getElementById('modal').classList.add('open');
        translateUI();
    }
    
    function closeModal() {
        document.getElementById('modal-backdrop').classList.add('hidden');
        document.getElementById('modal').classList.remove('open');
        setTimeout(() => document.getElementById('modal-content').innerHTML = '', 300);
    }

    function renderDetailRow(key, value) {
        return `
            <div class="flex justify-between items-center pb-2 border-b border-[var(--header-border)]">
                <span class="text-[var(--hint)] text-sm" data-i18n-key="${key}">${i18n(key)}</span>
                <span class="font-bold text-sm">${value}</span>
            </div>
        `;
    }

    // --- Profile & Firestore Logic ---
    
    const PROFILE_COLLECTION = 'shelby_profile';
    const PROFILE_DOC_ID = 'user_data';

    /**
     * مسیردهی به داکیومنت اختصاصی کاربر در Firestore
     * @returns {DocumentReference}
     */
    function getUserProfileDocRef() {
        return doc(db, 'artifacts', appId, 'users', userId, PROFILE_COLLECTION, PROFILE_DOC_ID);
    }

    /**
     * ذخیره داده‌های پروفایل در Firestore
     * @param {object} updates - شیء حاوی فیلدهایی که باید به‌روزرسانی شوند.
     */
    async function saveProfileData(updates) {
        if (!isAuthReady) return console.error("Firestore not ready.");
        
        try {
            await setDoc(getUserProfileDocRef(), updates, { merge: true });
            console.log("Profile updated successfully.");
        } catch (e) {
            console.error("Error updating profile:", e);
            showToast("Error saving data. Please try again.");
        }
    }

    /**
     * باز کردن مدال برای ویرایش ایمیل
     */
    function openEditEmailModal() {
        const emailModalHtml = `
            <h2 class="text-xl font-bold mb-6 text-center" data-i18n-key="editEmail">${i18n('editEmail')}</h2>
            <input type="text" id="email-input" placeholder="${i18n('enterEmail')}" value="${state.userEmail}" class="mb-4">
            <button onclick="saveEmail()" class="w-full bg-[var(--button)] text-white p-3 rounded-xl font-bold" data-i18n-key="save">${i18n('save')}</button>
            <button onclick="closeModal()" class="w-full text-[var(--hint)] p-3 mt-2 font-bold" data-i18n-key="back">${i18n('back')}</button>
        `;
        openModal(emailModalHtml);
    }
    
    /**
     * ذخیره ایمیل کاربر در Firestore
     */
    async function saveEmail() {
        const emailInput = document.getElementById('email-input');
        const email = emailInput.value.trim();
        
        if (email && !isValidEmail(email)) {
            emailInput.style.border = '1px solid var(--negative)';
            return showToast(i18n('invalidEmail'));
        }
        
        emailInput.style.border = '1px solid var(--header-border)';
        
        try {
            await saveProfileData({ email: email });
            closeModal();
            showToast(i18n('emailSaved'));
        } catch (e) {
            // Error handling is in saveProfileData
        }
    }

    /**
     * باز کردن مدال برای مدیریت کیف پول‌ها
     */
    function openEditWalletsModal() {
        const walletsArray = Object.values(state.wallets);
        const walletListHtml = walletsArray.map(w => `
            <div class="flex items-center justify-between p-3 bg-[var(--bg)] rounded-xl mb-3">
                <div class="flex-1 min-w-0">
                    <p class="font-bold text-sm">${w.symbol.toUpperCase()}</p>
                    <p class="text-xs text-[var(--hint)] truncate">${w.address}</p>
                    ${w.amount > 0 ? `<p class="text-xs text-[var(--hint)]">${i18n('cryptoAmount')}: ${formatNum(w.amount, 4)}</p>` : ''}
                </div>
                <div class="flex space-x-2 ${isRTL ? 'space-x-reverse' : ''} ml-3">
                    <button onclick="openAddWalletModal('${w.id}')" class="text-sm text-[var(--button)]">✏️</button>
                    <button onclick="promptDeleteWallet('${w.id}', '${w.symbol}')" class="text-sm text-[var(--negative)]">🗑️</button>
                </div>
            </div>
        `).join('');

        const modalHtml = `
            <h2 class="text-xl font-bold mb-6 text-center" data-i18n-key="editWallets">${i18n('editWallets')}</h2>
            <div id="wallet-list-container">
                ${walletsArray.length === 0 ? `<p class="text-center text-[var(--hint)]">${i18n('noWallets')}</p>` : walletListHtml}
            </div>
            <button onclick="openAddWalletModal()" class="w-full bg-[var(--positive)] text-white p-3 rounded-xl mt-6 font-bold" data-i18n-key="addNewWallet">${i18n('addNewWallet')}</button>
            <button onclick="closeModal()" class="w-full text-[var(--hint)] p-3 mt-2 font-bold" data-i18n-key="back">${i18n('back')}</button>
        `;
        openModal(modalHtml);
    }
    
    /**
     * باز کردن مدال افزودن/ویرایش کیف پول
     * @param {string} [walletId] - شناسه کیف پول برای ویرایش (اختیاری)
     */
    function openAddWalletModal(walletId) {
        const isEditing = !!walletId;
        const wallet = isEditing ? state.wallets[walletId] : {};
        
        // لیست تمام ارزها برای Dropdown
        const allSymbols = state.allCoins.map(c => c.symbol.toUpperCase());
        const uniqueSymbols = [...new Set(allSymbols)].sort();

        const symbolOptions = uniqueSymbols.map(sym => 
            `<option value="${sym}" ${wallet.symbol === sym ? 'selected' : ''}>${sym}</option>`
        ).join('');
        
        const titleKey = isEditing ? 'editWallet' : 'addWallet';
        const buttonKey = 'save';
        const backKey = 'back';

        const modalHtml = `
            <h2 class="text-xl font-bold mb-6 text-center" data-i18n-key="${titleKey}">${i18n(titleKey)}</h2>
            <form id="wallet-form" onsubmit="event.preventDefault(); saveWallet('${walletId || ''}')">
                <label class="block text-sm font-medium mb-1" data-i18n-key="selectCoin">${i18n('selectCoin')}</label>
                <select id="wallet-symbol" class="mb-4" ${isEditing ? 'disabled' : ''}>
                    <option value="">-- ${i18n('selectCoin')} --</option>
                    ${symbolOptions}
                </select>
                
                <label class="block text-sm font-medium mb-1" data-i18n-key="walletAddress">${i18n('walletAddress')}</label>
                <input type="text" id="wallet-address" placeholder="${i18n('walletAddress')}" value="${wallet.address || ''}" class="mb-4">
                
                <label class="block text-sm font-medium mb-1" data-i18n-key="cryptoAmount">${i18n('cryptoAmount')}</label>
                <input type="text" id="wallet-amount" placeholder="0.00" value="${wallet.amount || ''}" class="mb-4">
                
                <button type="submit" class="w-full bg-[var(--button)] text-white p-3 rounded-xl font-bold" data-i18n-key="${buttonKey}">${i18n(buttonKey)}</button>
                <button type="button" onclick="openEditWalletsModal()" class="w-full text-[var(--hint)] p-3 mt-2 font-bold" data-i18n-key="${backKey}">${i18n(backKey)}</button>
            </form>
        `;
        openModal(modalHtml);
        
        // اگر در حال افزودن هستیم، مطمئن می‌شویم که اولین کوین به‌طور پیش‌فرض انتخاب نمی‌شود.
        if (!isEditing) {
            document.getElementById('wallet-symbol').value = '';
        }
    }

    window.saveWallet = async function(walletId) {
        const symbolSelect = document.getElementById('wallet-symbol');
        const symbol = symbolSelect.value;
        const addressInput = document.getElementById('wallet-address');
        const address = addressInput.value.trim();
        const amountInput = document.getElementById('wallet-amount');
        const amount = parseFloat(amountInput.value) || 0;
        
        let isValid = true;
        
        if (!symbol) {
             symbolSelect.style.border = '1px solid var(--negative)';
             isValid = false;
        } else {
             symbolSelect.style.border = '1px solid var(--header-border)';
        }
        
        if (address.length < 10) {
            addressInput.style.border = '1px solid var(--negative)';
            isValid = false;
        } else {
            addressInput.style.border = '1px solid var(--header-border)';
        }
        
        if (!isValid) {
            return showToast("لطفاً ارز و آدرس را بررسی کنید.");
        }

        const newWalletId = walletId || crypto.randomUUID();
        
        const newWallets = { ...state.wallets, [newWalletId]: { id: newWalletId, symbol, address, amount } };

        try {
            await saveProfileData({ wallets: newWallets });
            closeModal();
            showToast(i18n('walletSaved'));
        } catch (e) {
             // Error handling is in saveProfileData
        }
    }
    
    window.promptDeleteWallet = function(id, symbol) {
        const confirmationHtml = `
            <h2 class="text-xl font-bold mb-6 text-center">${i18n('confirmDelete', { symbol })}</h2>
            <button onclick="deleteWallet('${id}')" class="w-full bg-[var(--negative)] text-white p-3 rounded-xl font-bold mb-3">حذف</button>
            <button onclick="openEditWalletsModal()" class="w-full text-[var(--hint)] p-3 font-bold" data-i18n-key="back">${i18n('back')}</button>
        `;
        openModal(confirmationHtml);
    }
    
    window.deleteWallet = async function(walletId) {
        const newWallets = { ...state.wallets };
        delete newWallets[walletId];
        
        try {
            await saveProfileData({ wallets: newWallets });
            closeModal();
            showToast(i18n('walletDeleted'));
        } catch (e) {
            // Error handling is in saveProfileData
        }
    }

    /**
     * رندر صفحه پروفایل
     */
    function renderProfilePage() {
        // اطلاعات تلگرام
        const user = tg.initDataUnsafe.user || { first_name: i18n('name'), username: i18n('notSet'), id: 'AnonUser' };
        const profilePage = document.getElementById('profile-page');
        const walletCount = Object.keys(state.wallets).length;
        
        // اگر هنوز اطلاعات از Firestore لود نشده، اسکلتون نمایش بده
        if (!state.isDataLoadedFromFirestore) {
            profilePage.innerHTML = `<div class="p-4 space-y-4">
                <div class="flex items-center space-x-4 ${isRTL ? 'space-x-reverse' : ''} mb-6">
                     <div class="w-20 h-20 rounded-full skeleton"></div>
                     <div class="space-y-2"><div class="h-5 w-40 skeleton"></div><div class="h-3 w-32 skeleton"></div></div>
                </div>
                <div class="h-60 skeleton rounded-xl"></div>
            </div>`;
            return;
        }

        // محاسبه مجموع دارایی‌های دلاری
        let totalUSDValue = 0;
        Object.values(state.wallets).forEach(wallet => {
            if (wallet.amount > 0) {
                const coin = state.allCoins.find(c => c.symbol.toUpperCase() === wallet.symbol.toUpperCase());
                if (coin) {
                    totalUSDValue += wallet.amount * coin.current_price;
                }
            }
        });
        const totalTomanValue = totalUSDValue * state.dollarPrice;

        const totalValueHtml = totalUSDValue > 0 ? `
            <div class="bg-[var(--button)] text-white p-4 rounded-xl text-center mb-6">
                <p class="text-sm font-light" data-i18n-key="usdEquivalent">${i18n('usdEquivalent')}</p>
                <p class="text-2xl font-bold mb-1">$${formatNum(totalUSDValue, 2)}</p>
                <p class="text-sm font-light" data-i18n-key="irtEquivalent">${i18n('irtEquivalent')}</p>
                <p class="text-lg font-bold">${formatNum(totalTomanValue, 0)} T</p>
            </div>
        ` : '';

        profilePage.innerHTML = `
            <div class="p-4">
                ${totalValueHtml}
                 <div class="flex items-center space-x-4 ${isRTL ? 'space-x-reverse' : ''} mb-6">
                    <img src="${user.photo_url || 'https://placehold.co/80x80/2E81FF/EAECEF?text=User'}" onerror="this.style.display='none'" class="w-20 h-20 rounded-full bg-[var(--secondary-bg)]">
                    <div>
                        <h1 class="text-xl font-bold">${user.first_name || i18n('name')} ${user.last_name || ''}</h1>
                        <p class="text-[var(--hint)] text-sm">@${user.username || i18n('notSet')}</p>
                        <p class="text-[var(--hint)] text-xs font-mono mt-1 select-all">ID: ${userId}</p>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="bg-[var(--secondary-bg)] p-4 rounded-xl">
                        <h2 data-i18n-key="userInfo" class="font-bold mb-3 text-lg">${i18n('userInfo')}</h2>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center py-1"><span class="text-[var(--hint)]" data-i18n-key="userId">${i18n('userId')}</span><span class="font-mono text-left truncate text-sm select-all">${userId}</span></div>
                            <div class="flex justify-between items-center py-1 cursor-pointer hover:bg-[var(--bg)] p-2 rounded-lg -m-2" onclick="openEditEmailModal()">
                                <span class="text-[var(--hint)]" data-i18n-key="emailOptional">${i18n('emailOptional')}</span>
                                <span class="font-mono text-left truncate text-sm">${state.userEmail || i18n('notSet')} <span class="text-[var(--button)] mr-2">✏️</span></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-[var(--secondary-bg)] p-4 rounded-xl">
                        <h2 data-i18n-key="wallets" class="font-bold mb-3 text-lg">${i18n('wallets')}</h2>
                        <div class="flex justify-between items-center py-1 cursor-pointer hover:bg-[var(--bg)] p-2 rounded-lg -m-2" onclick="openEditWalletsModal()">
                            <span class="text-[var(--hint)]" data-i18n-key="walletsCount" data-count="${walletCount}">${i18n('walletsCount', { count: walletCount })}</span>
                            <span class="text-sm text-[var(--button)]">${i18n('editWallets')}</span>
                        </div>
                    </div>
                    
                    <div class="bg-[var(--secondary-bg)] p-4 rounded-xl">
                        <h2 data-i18n-key="settings" class="font-bold mb-3 text-lg">${i18n('settings')}</h2>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center"><span class="text-[var(--hint)]" data-i18n-key="theme">${i18n('theme')}</span><div class="flex bg-[var(--bg)] rounded-xl p-1"><button class="theme-btn px-3 py-1 rounded-lg text-sm ${state.theme === 'dark' ? 'bg-[var(--button)] text-white' : ''}" data-theme="dark" data-i18n-key="dark">${i18n('dark')}</button><button class="theme-btn px-3 py-1 rounded-lg text-sm ${state.theme === 'light' ? 'bg-[var(--button)] text-white' : ''}" data-theme="light" data-i18n-key="light">${i18n('light')}</button></div></div>
                            <div class="flex justify-between items-center"><span class="text-[var(--hint)]" data-i18n-key="language">${i18n('language')}</span>
                                <select id="lang-select" class="bg-[var(--bg)] p-2 rounded-xl text-sm text-[var(--text)] border border-[var(--header-border)]">
                                    <option value="fa" ${state.language === 'fa' ? 'selected' : ''}>فارسی</option>
                                    <option value="en" ${state.language === 'en' ? 'selected' : ''}>English</option>
                                    <option value="ar" ${state.language === 'ar' ? 'selected' : ''}>العربية</option>
                                    <option value="zh" ${state.language === 'zh' ? 'selected' : ''}>中文</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        document.querySelectorAll('.theme-btn').forEach(btn => btn.onclick = (e) => setTheme(e.currentTarget.dataset.theme));
        document.getElementById('lang-select').onchange = (e) => setLanguage(e.target.value);
        translateUI();
        
        // Expose functions globally for modal buttons
        window.openEditEmailModal = openEditEmailModal;
        window.openEditWalletsModal = openEditWalletsModal;
    }

    // --- Firebase Initialization and Listeners ---

    async function initializeFirebase() {
        if (!firebaseConfig) {
            console.error("Firebase config is missing.");
            return;
        }
        
        // setLogLevel('Debug'); // Enable for debugging
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // Sign in using custom token or anonymously
        try {
            if (initialAuthToken) {
                const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                userId = userCredential.user.uid;
            } else {
                const userCredential = await signInAnonymously(auth);
                userId = userCredential.user.uid;
            }
        } catch (e) {
            console.error("Firebase Auth Error:", e);
            userId = 'guest_' + crypto.randomUUID(); // Fallback ID
        } finally {
            isAuthReady = true;
            console.log("Firebase initialized. User ID:", userId);
            setupProfileListener();
        }
    }
    
    function setupProfileListener() {
        if (!db || !userId) return;
        
        // مسیر داده‌ی اختصاصی کاربر: /artifacts/{appId}/users/{userId}/shelby_profile/user_data
        const profileRef = getUserProfileDocRef();

        onSnapshot(profileRef, (doc) => {
            if (doc.exists()) {
                const data = doc.data();
                state.userEmail = data.email || '';
                state.wallets = data.wallets || {};
                
                // Ensure wallets have unique IDs
                let shouldUpdateFirestore = false;
                const updatedWallets = {};
                
                Object.entries(data.wallets).forEach(([key, w]) => {
                    if (typeof w === 'object' && w !== null) {
                         if (!w.id) {
                            w.id = key; 
                            shouldUpdateFirestore = true;
                         }
                         updatedWallets[key] = w;
                    }
                });

                if (shouldUpdateFirestore) {
                    state.wallets = updatedWallets;
                    // Try to update Firestore silently to add missing IDs
                    setDoc(profileRef, { wallets: updatedWallets }, { merge: true }).catch(console.error);
                } else {
                    state.wallets = data.wallets || {};
                }

            } else {
                // If the document doesn't exist, set initial empty data
                state.userEmail = '';
                state.wallets = {};
                console.log("Profile document created.");
                // Create the document with default empty values
                setDoc(profileRef, { email: '', wallets: {} }).catch(console.error);
            }
            
            state.isDataLoadedFromFirestore = true;
            // اگر کاربر در صفحه پروفایل بود، آن را به‌روزرسانی کن
            if (document.getElementById('profile-page').classList.contains('active')) {
                 renderProfilePage();
            }
        }, (error) => {
            console.error("Error listening to profile data:", error);
            showToast("Failed to load user profile data.");
        });
    }


    document.addEventListener('DOMContentLoaded', async () => {
        try { 
            tg.ready(); 
            tg.expand();
            tg.BackButton.hide();
        } catch (e) { 
            console.warn("TG script not loaded. Running standalone."); 
        }
        
        // 1. Firebase Initialization (Async)
        await initializeFirebase();
        
        // 2. Initial Setup
        setTheme(state.theme);
        setLanguage(state.language); 
        setupUI();
        setupInfiniteScroll(); 
        
        // 3. Start data loading
        // ابتدا داده‌های رمزنگاری را لود می‌کنیم تا بتوانیم مجموع دارایی را محاسبه کنیم
        await loadCryptoData(); 
        await loadSummaryData();
        
        // 4. Set auto refresh
        if (state.updateInterval) clearInterval(state.updateInterval);
        state.updateInterval = setInterval(() => {
            // به‌روزرسانی در پس‌زمینه
            loadCryptoData(true);
            loadSummaryData(); 
        }, 30000);
        
        // Expose functions globally for HTML calls
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.saveEmail = saveEmail;
        window.openAddWalletModal = openAddWalletModal;
        window.saveWallet = saveWallet;
        window.deleteWallet = deleteWallet;
        window.promptDeleteWallet = promptDeleteWallet;
    });
    //============== END OF FULL JAVASCRIPT CODE ==============
    </script>
</body>
</html>

